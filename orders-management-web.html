<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sheeka Orders Management</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script type="text/javascript"
        src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js">
    </script>
    <style>
        /* Custom styles to override or extend Tailwind if needed */
        body {
            font-family: "Inter", sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f8fafc; /* A lighter gray (slate-50) for better contrast */
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        /* Style for the custom message box (snackbar replacement) */
        #messageBox {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #333;
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        #messageBox.show {
            opacity: 1;
        }
        #messageBox.error {
            background-color: #dc2626; /* Red-600 */
        }
        #messageBox.success {
            background-color: #16a34a; /* Green-600 */
        }

        /* Modal styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
        }
        .modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            background-color: white;
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3);
            max-width: 90%;
            max-height: 90%;
            overflow-y: auto;
            transform: translateY(-20px);
            transition: transform 0.3s ease-in-out;
        }
        .modal-overlay.show .modal-content {
            transform: translateY(0);
        }

        /* Specific styles for text inputs to match Flutter's black background */
        .text-input-dark {
            background-color: #f3f4f6; /* gray-100 */
            color: #111827; /* gray-900 */
            border-radius: 0.5rem; /* rounded-lg */
            border: 1px solid #d1d5db; /* gray-300 */
            padding: 0.75rem 1rem; /* py-3 px-4 */
        }
        .text-input-dark::placeholder {
            color: #6b7280; /* gray-500 */
        }
        .text-input-dark:focus {
            outline: 2px solid #4f46e5; /* indigo-600 */
            outline-offset: 2px;
            border-color: #4f46e5;
        }

        /* Styles for dropdowns to match Flutter's appearance */
        .dropdown-dark {
            background-color: #f3f4f6; /* gray-100 */
            color: #111827; /* gray-900 */
            border-radius: 0.5rem; /* rounded-lg */
            border: 1px solid #d1d5db; /* gray-300 */
            padding: 0.75rem 1rem; /* py-3 px-4 */
            appearance: none; /* Remove default arrow */
            -webkit-appearance: none;
            -moz-appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20' fill='black'%3E%3Cpath fill-rule='evenodd' d='M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z' clip-rule='evenodd' /%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 1.5em 1.5em;
        }
        .dropdown-dark:focus {
            outline: 2px solid #4f46e5; /* indigo-600 */
            outline-offset: 2px;
        }
        .dropdown-dark option {
            background-color: #fff; /* white background for options */
            color: #111827; /* dark text for options */
        }

        /* Custom styles for agent notes input */
        .notes-input {
            background-color: #f9fafb; /* gray-50 */
            color: #1f2937; /* gray-800 */
            border-radius: 0.5rem;
            border: 1px solid #d1d5db; /* gray-300 */
            padding: 0.75rem 1rem;
        }
        .notes-input:focus {
            outline: 2px solid #6366f1; /* Indigo-400 */
            outline-offset: 2px;
            border-color: #6366f1;
        }
        .notes-input::placeholder {
            color: #9ca3af; /* gray-400 */
        }
    </style>
</head>
<body class="flex flex-col min-h-screen bg-gray-50">

    <div id="messageBox" class="hidden">
        <span id="messageIcon"></span>
        <span id="messageText"></span>
    </div>

    <!-- Removed Splash Screen -->

    <div id="loginPage" class="hidden flex-1 flex flex-row">
        <div class="hidden md:flex flex-1 bg-gray-200 items-center justify-center">
            <i class="fa-solid fa-bag-shopping text-gray-800 text-9xl"></i>
        </div>
        <div class="flex-1 flex items-center justify-center p-8 md:p-10 lg:p-16">
            <div class="w-full max-w-md">
                <h2 class="text-3xl md:text-4xl font-bold text-gray-800 mb-8">Login</h2>
                <form id="loginForm" class="space-y-6">
                    <div>
                        <label for="email" class="block text-sm font-medium text-gray-700 sr-only">Email</label>
                        <input type="email" id="email" name="email" placeholder="Email" class="text-input-dark w-full" required>
                    </div>
                    <div>
                        <label for="password" class="block text-sm font-medium text-gray-700 sr-only">Password</label>
                        <input type="password" id="password" name="password" placeholder="Password" class="text-input-dark w-full" required>
                    </div>
                    <div class="flex items-center justify-between text-sm">
                        <div class="flex items-center">
                            <input id="rememberMe" name="rememberMe" type="checkbox" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
                            <label for="rememberMe" class="ml-2 block text-gray-900">Remember me</label>
                        </div>
                        <a href="#" class="font-medium text-gray-800 hover:text-gray-600">Forgot Password?</a>
                    </div>
                    <div>
                        <button type="submit" id="loginButton" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-lg shadow-sm text-lg font-medium text-white bg-gray-800 hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 transition-all duration-200">
                            Login
                        </button>
                    </div>
                    <div class="text-center text-sm">
                        <a href="#" class="font-medium text-gray-800 hover:text-gray-600">Don't have an account? Register</a>
                    </div>
                    <div id="loginMessage" class="text-red-600 text-center text-base mt-5 hidden"></div>
                </form>
            </div>
        </div>
    </div>

    <div id="contactSupportPage" class="hidden flex-1 flex flex-col items-center justify-center p-6 bg-gradient-to-br from-white to-gray-100">
        <div class="text-center p-8 max-w-lg w-full">
            <i class="fa-solid fa-lock text-red-600 text-8xl mb-8"></i>
            <h2 class="text-3xl font-bold text-gray-800 mb-4">System Access Restricted</h2>
            <p id="supportMessage" class="text-xl font-semibold text-gray-700 mb-6">Your system is off. Please contact support.</p>
            <p class="text-gray-600 mb-10">We apologize for the inconvenience. Your account access has been restricted. Please reach out to our support team for assistance.</p>
            <div class="space-y-4">
                <div class="bg-white rounded-xl shadow-md p-4 flex items-center hover:shadow-lg transition-shadow duration-200 cursor-pointer" onclick="window.location.href='mailto:support@sheeka.com?subject=System Access Issue - Request for Support&body=Dear Support Team,%0A%0AI am writing to report an issue with my account access. My system is currently off. Please assist me in resolving this. %0A%0AThank you.'">
                    <i class="fa-solid fa-envelope text-gray-800 text-2xl mr-4"></i>
                    <div>
                        <h3 class="text-lg font-semibold text-gray-800">Email Support</h3>
                        <p class="text-gray-600">support@sheeka.com</p>
                    </div>
                    <i class="fa-solid fa-chevron-right text-gray-400 ml-auto"></i>
                </div>
                <div class="bg-white rounded-xl shadow-md p-4 flex items-center hover:shadow-lg transition-shadow duration-200 cursor-pointer" onclick="window.location.href='tel:+213558904032'">
                    <i class="fa-solid fa-phone text-gray-800 text-2xl mr-4"></i>
                    <div>
                        <h3 class="text-lg font-semibold text-gray-800">Call Support</h3>
                        <p class="text-gray-600">+213 558 90 40 32</p>
                    </div>
                    <i class="fa-solid fa-chevron-right text-gray-400 ml-auto"></i>
                </div>
                <div class="bg-white rounded-xl shadow-md p-4 flex items-center hover:shadow-lg transition-shadow duration-200 cursor-pointer" onclick="window.open('https://www.sheeka.com/support', '_blank')">
                    <i class="fa-solid fa-globe text-gray-800 text-2xl mr-4"></i>
                    <div>
                        <h3 class="text-lg font-semibold text-gray-800">Visit Support Website</h3>
                        <p class="text-gray-600">www.sheeka.com/support</p>
                    </div>
                    <i class="fa-solid fa-chevron-right text-gray-400 ml-auto"></i>
                </div>
            </div>
        </div>
    </div>


    <div id="ordersScreen" class="hidden flex-1 flex flex-col">
        <header class="bg-white shadow-md p-4 flex items-center justify-between">
            <h1 class="text-xl font-bold text-gray-800">Orders Management</h1>
            <div class="flex items-center space-x-2">
                <button id="yalitecSettingsBtn" class="p-2 rounded-full hover:bg-gray-100 transition-colors duration-200" title="Yalitec API Settings">
                    <i class="fa-solid fa-gear text-gray-500 text-lg"></i>
                </button>
                <button id="generatePdfBtn" class="p-2 rounded-full hover:bg-gray-100 transition-colors duration-200" title="Generate PDF of Filtered Orders">
                    <i class="fa-solid fa-file-pdf text-red-600 text-lg"></i>
                </button>
                <button id="viewReportBtn" class="p-2 rounded-full hover:bg-gray-100 transition-colors duration-200" title="View Report Summary">
                    <i class="fa-solid fa-chart-bar text-blue-600 text-lg"></i>
                </button>
                <button id="agentReportBtn" class="p-2 rounded-full hover:bg-gray-100 transition-colors duration-200" title="View Agent Performance Report">
                    <i class="fa-solid fa-users text-purple-600 text-lg"></i>
                </button>
                <button id="importShopifyBtn" class="p-2 rounded-full hover:bg-gray-100 transition-colors duration-200" title="Import from Shopify">
                    <i id="importShopifyIcon" class="fa-solid fa-cloud-arrow-down text-green-600 text-lg"></i>
                </button>
            </div>
        </header>

        <main class="flex-1 p-4 overflow-y-auto">
            <div class="mb-4">
                <input type="text" id="searchInput" placeholder="Search by Phone Number or Name or Order ID" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-400">
            </div>

            <div class="mb-4 overflow-x-auto whitespace-nowrap pb-2">
                <div class="inline-flex space-x-2">
                    <button data-filter-type="date" data-filter-value="allTime" class="filter-button bg-gray-200 text-gray-800 px-4 py-2 rounded-lg font-semibold hover:bg-gray-300 transition-colors duration-200 active">All Time</button>
                    <button data-filter-type="date" data-filter-value="today" class="filter-button bg-gray-200 text-gray-800 px-4 py-2 rounded-lg font-semibold hover:bg-gray-300 transition-colors duration-200">Today</button>
                    <button data-filter-type="date" data-filter-value="thisWeek" class="filter-button bg-gray-200 text-gray-800 px-4 py-2 rounded-lg font-semibold hover:bg-gray-300 transition-colors duration-200">This Week</button>
                    <button data-filter-type="date" data-filter-value="thisMonth" class="filter-button bg-gray-200 text-gray-800 px-4 py-2 rounded-lg font-semibold hover:bg-gray-300 transition-colors duration-200">This Month</button>
                    <button data-filter-type="date" data-filter-value="custom" id="customDateRangeBtn" class="filter-button bg-gray-200 text-gray-800 px-4 py-2 rounded-lg font-semibold hover:bg-gray-300 transition-colors duration-200">Custom Range</button>
                    <button id="clearCustomDateBtn" class="hidden bg-red-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-red-700 transition-colors duration-200">Clear Custom</button>
                </div>
            </div>

            <div class="mb-4 overflow-x-auto whitespace-nowrap pb-2">
                <div class="inline-flex space-x-2">
                    <button data-filter-type="status" data-filter-value="pending" class="filter-button bg-gray-800 text-white px-4 py-2 rounded-lg font-semibold hover:bg-gray-700 transition-colors duration-200 active">New (<span id="count-pending">0</span>)</button>
                    <button data-filter-type="status" data-filter-value="all" class="filter-button bg-gray-200 text-gray-800 px-4 py-2 rounded-lg font-semibold hover:bg-gray-300 transition-colors duration-200">All (<span id="count-all">0</span>)</button>
                    <button data-filter-type="status" data-filter-value="confirmed" class="filter-button bg-gray-200 text-gray-800 px-4 py-2 rounded-lg font-semibold hover:bg-gray-300 transition-colors duration-200">Confirmed (<span id="count-confirmed">0</span>)</button>
                    <button data-filter-type="status" data-filter-value="cancelled" class="filter-button bg-gray-200 text-gray-800 px-4 py-2 rounded-lg font-semibold hover:bg-gray-300 transition-colors duration-200">Cancelled (<span id="count-cancelled">0</span>)</button>
                    <button data-filter-type="status" data-filter-value="tentative" class="filter-button bg-gray-200 text-gray-800 px-4 py-2 rounded-lg font-semibold hover:bg-gray-300 transition-colors duration-200">Tentative (<span id="count-tentative">0</span>)</button>
                    <button data-filter-type="status" data-filter-value="dispatched" class="filter-button bg-gray-200 text-gray-800 px-4 py-2 rounded-lg font-semibold hover:bg-gray-300 transition-colors duration-200">Dispatched (<span id="count-dispatched">0</span>)</button>
                    <!-- New Status Buttons -->
                    <button data-filter-type="status" data-filter-value="delivered" class="filter-button bg-gray-200 text-gray-800 px-4 py-2 rounded-lg font-semibold hover:bg-gray-300 transition-colors duration-200">Delivered (<span id="count-delivered">0</span>)</button>
                    <button data-filter-type="status" data-filter-value="backs" class="filter-button bg-gray-200 text-gray-800 px-4 py-2 rounded-lg font-semibold hover:bg-gray-300 transition-colors duration-200">Backs (<span id="count-backs">0</span>)</button>
                </div>
            </div>

            <div id="loadingIndicator" class="flex justify-center items-center py-8 hidden">
                <div class="w-12 h-12 border-4 border-t-4 border-indigo-500 border-solid rounded-full animate-spin"></div>
            </div>

            <div id="ordersList" class="space-y-4">
            </div>

            <div id="noOrdersMessage" class="hidden text-center text-gray-600 text-lg py-8">
                No orders found for the current filters.
            </div>
        </main>
    </div>

    <div id="yalitecSettingsModal" class="modal-overlay">
        <div class="modal-content w-full max-w-md">
            <h3 class="text-xl font-bold mb-4">Enter Yalitec API Credentials</h3>
            <div class="space-y-4">
                <input type="text" id="yalitecApiIdInput" placeholder="Yalitec API ID" class="w-full p-2 border rounded-lg">
                <input type="password" id="yalitecApiTokenInput" placeholder="Yalitec API Token" class="w-full p-2 border rounded-lg">
            </div>
            <div class="mt-6 flex justify-end space-x-2">
                <button id="cancelYalitecSettings" class="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">Cancel</button>
                <button id="saveYalitecSettings" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Save & Continue</button>
            </div>
        </div>
    </div>

    <div id="shopifySettingsModal" class="modal-overlay">
        <div class="modal-content w-full max-w-md">
            <h3 class="text-xl font-bold mb-4">Enter Shopify API Credentials</h3>
            <div class="space-y-4">
                <input type="text" id="shopifyStoreNameInput" placeholder="Store Name (without .myshopify.com)" class="w-full p-2 border rounded-lg">
                <input type="text" id="shopifyApiKeyInput" placeholder="API Key" class="w-full p-2 border rounded-lg">
                <input type="password" id="shopifyApiPasswordInput" placeholder="API Password" class="w-full p-2 border rounded-lg">
            </div>
            <div class="mt-6 flex justify-end space-x-2">
                <button id="cancelShopifySettings" class="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">Cancel</button>
                <button id="saveShopifySettings" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Save & Continue</button>
            </div>
        </div>
    </div>

    <div id="editOrderModal" class="modal-overlay">
        <div class="modal-content w-full max-w-lg">
            <h3 class="text-xl font-bold mb-4">Edit Order Details</h3>
            <form id="editOrderForm" class="space-y-4">
                <input type="hidden" id="editOrderId">
                <input type="text" id="editFullName" placeholder="Full Name" class="w-full p-2 border rounded-lg">
                <input type="text" id="editPhoneNumber" placeholder="Phone Number" class="w-full p-2 border rounded-lg">
                <input type="text" id="editWilaya" placeholder="Wilaya" class="w-full p-2 border rounded-lg">
                <input type="text" id="editCommune" placeholder="Commune" class="w-full p-2 border rounded-lg">
                <input type="text" id="editAddress" placeholder="Address" class="w-full p-2 border rounded-lg"> <!-- Added Address field -->
                <textarea id="editNotes" placeholder="Agent Notes" class="w-full p-2 border rounded-lg h-24 notes-input"></textarea>
                <div id="assignedToDropdownContainer" class="hidden">
                    <label for="editAssignedTo" class="block text-sm font-medium text-gray-700 mb-1">Assigned Agent</label>
                    <select id="editAssignedTo" class="w-full p-2 border rounded-lg dropdown-dark">
                        <option value="">None</option>
                        </select>
                </div>
                <div class="mt-6 flex justify-end space-x-2">
                    <button type="button" id="cancelEditOrder" class="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">Cancel</button>
                    <button type="submit" id="saveEditOrder" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Save</button>
                </div>
            </form>
        </div>
    </div>

    <div id="confirmDeleteModal" class="modal-overlay">
        <div class="modal-content w-full max-w-sm">
            <h3 class="text-xl font-bold mb-4">Confirm Deletion</h3>
            <p class="text-gray-700 mb-6">Are you sure you want to delete this order? This action cannot be undone.</p>
            <div class="flex justify-end space-x-2">
                <button id="cancelDelete" class="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">Cancel</button>
                <button id="confirmDelete" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">Delete</button>
            </div>
        </div>
    </div>

    <div id="orderReportModal" class="modal-overlay">
        <div class="modal-content w-full max-w-2xl">
            <h3 class="text-xl font-bold mb-4 text-center">Order Summary Report</h3>
            <p class="text-center text-gray-600 text-sm mb-6" id="reportDateRange"></p>
            <div class="space-y-4">
                <div class="bg-white rounded-xl shadow-md p-4">
                    <div class="flex items-center mb-2">
                        <i class="fa-solid fa-chart-bar text-blue-600 text-2xl mr-3"></i>
                        <span class="text-lg font-medium">Total Orders (within filter)</span>
                        <span id="reportTotal" class="ml-auto text-xl font-bold text-blue-600">0</span>
                    </div>
                    <div class="flex items-center mb-2">
                        <i class="fa-solid fa-hourglass-half text-orange-600 text-2xl mr-3"></i>
                        <span class="text-lg font-medium">Pending Orders</span>
                        <span id="reportPending" class="ml-auto text-xl font-bold text-orange-600">0</span>
                    </div>
                    <div class="flex items-center mb-2">
                        <i class="fa-solid fa-circle-check text-green-600 text-2xl mr-3"></i>
                        <span class="text-lg font-medium">Confirmed Orders</span>
                        <span id="reportConfirmed" class="ml-auto text-xl font-bold text-green-600">0</span>
                    </div>
                    <div class="flex items-center mb-2">
                        <i class="fa-solid fa-circle-question text-deep-orange-600 text-2xl mr-3"></i>
                        <span class="text-lg font-medium">Tentative Orders</span>
                        <span id="reportTentative" class="ml-auto text-xl font-bold text-deep-orange-600">0</span>
                    </div>
                    <div class="flex items-center mb-2">
                        <i class="fa-solid fa-circle-xmark text-red-600 text-2xl mr-3"></i>
                        <span class="text-lg font-medium">Cancelled Orders</span>
                        <span id="reportCancelled" class="ml-auto text-xl font-bold text-red-600">0</span>
                    </div>
                    <div class="flex items-center mb-2">
                        <i class="fa-solid fa-truck-fast text-blue-600 text-2xl mr-3"></i>
                        <span class="text-lg font-medium">Dispatched Orders</span>
                        <span id="reportDispatched" class="ml-auto text-xl font-bold text-blue-600">0</span>
                    </div>
                    <!-- New Report Fields -->
                    <div class="flex items-center mb-2">
                        <i class="fa-solid fa-box-open text-teal-600 text-2xl mr-3"></i>
                        <span class="text-lg font-medium">Delivered Orders</span>
                        <span id="reportDelivered" class="ml-auto text-xl font-bold text-teal-600">0</span>
                    </div>
                    <div class="flex items-center">
                        <i class="fa-solid fa-undo-alt text-purple-600 text-2xl mr-3"></i>
                        <span class="text-lg font-medium">Returned (Backs) Orders</span>
                        <span id="reportBacks" class="ml-auto text-xl font-bold text-purple-600">0</span>
                    </div>
                </div>
            </div>
            <p class="text-center text-gray-500 text-sm italic mt-6">This report provides a summary based on the currently applied date filters in the Orders Management screen.</p>
            <div class="mt-6 flex justify-end">
                <button id="closeReportModal" class="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">Close</button>
            </div>
        </div>
    </div>

    <div id="agentReportModal" class="modal-overlay">
        <div class="modal-content w-full max-w-2xl">
            <h3 class="text-xl font-bold mb-4 text-center">Agent Performance Report</h3>
            <p class="text-center text-gray-600 text-sm mb-6" id="agentReportDateRange"></p>
            <div id="agentStatsContainer" class="space-y-4">
            </div>
            <div id="noAgentStatsMessage" class="hidden text-center text-gray-600 text-lg py-8">
                No agents found with assigned orders for the current filters.
            </div>
            <div class="mt-6 flex justify-end">
                <button id="closeAgentReportModal" class="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">Close</button>
            </div>
        </div>
    </div>

    <script>
        // --- Global State Variables ---
        let allOrders = [];
        let filteredOrders = [];
        let isLoading = false;
        let currentFilter = 'pending'; // Default status filter
        let orderNotes = {}; // Local storage for unsaved notes
        let pollingTimer;
        let lastFetchedOrderIds = new Set();
        let availableAgents = [];
        let currentUserRole = 'guest';
        let currentUserId = null;
        let yalitecApiId = null;
        let yalitecApiToken = null;
        let areYalitecApiCredentialsLoaded = false;
        let isImportingFromShopify = false;

        let currentDateFilter = 'allTime'; // Default date filter
        let customStartDate = null;
        let customEndDate = null;

        const shopOriginWilayaName = 'Batna';
        const shopOriginWilayaId = 5; // Unused in JS version, but kept for context

        // --- DOM Elements ---
        // The splashScreen element is removed from HTML, so this will be null.
        const splashScreen = document.getElementById('splashScreen'); 
        const loginPage = document.getElementById('loginPage');
        const contactSupportPage = document.getElementById('contactSupportPage');
        const ordersScreen = document.getElementById('ordersScreen');
        const loginForm = document.getElementById('loginForm');
        const loginButton = document.getElementById('loginButton');
        const loginMessage = document.getElementById('loginMessage');
        const searchInput = document.getElementById('searchInput');
        const ordersList = document.getElementById('ordersList');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const noOrdersMessage = document.getElementById('noOrdersMessage');

        // Modals
        const yalitecSettingsModal = document.getElementById('yalitecSettingsModal');
        const yalitecApiIdInput = document.getElementById('yalitecApiIdInput');
        const yalitecApiTokenInput = document.getElementById('yalitecApiTokenInput');
        const cancelYalitecSettings = document.getElementById('cancelYalitecSettings');
        const saveYalitecSettings = document.getElementById('saveYalitecSettings');

        const shopifySettingsModal = document.getElementById('shopifySettingsModal');
        const shopifyStoreNameInput = document.getElementById('shopifyStoreNameInput');
        const shopifyApiKeyInput = document.getElementById('shopifyApiKeyInput');
        const shopifyApiPasswordInput = document.getElementById('shopifyApiPasswordInput');
        const cancelShopifySettings = document.getElementById('cancelShopifySettings');
        const saveShopifySettings = document.getElementById('saveShopifySettings');

        const editOrderModal = document.getElementById('editOrderModal');
        const editOrderForm = document.getElementById('editOrderForm');
        const editOrderId = document.getElementById('editOrderId');
        const editFullName = document.getElementById('editFullName');
        const editPhoneNumber = document.getElementById('editPhoneNumber');
        const editWilaya = document.getElementById('editWilaya');
        const editCommune = document.getElementById('editCommune');
        const editAddress = document.getElementById('editAddress'); // Get the new address field
        const editNotes = document.getElementById('editNotes');
        const assignedToDropdownContainer = document.getElementById('assignedToDropdownContainer');
        const editAssignedTo = document.getElementById('editAssignedTo');
        const cancelEditOrder = document.getElementById('cancelEditOrder');
        const saveEditOrder = document.getElementById('saveEditOrder');

        const confirmDeleteModal = document.getElementById('confirmDeleteModal');
        const cancelDelete = document.getElementById('cancelDelete');
        const confirmDelete = document.getElementById('confirmDelete');

        const orderReportModal = document.getElementById('orderReportModal');
        const reportTotal = document.getElementById('reportTotal');
        const reportPending = document.getElementById('reportPending');
        const reportConfirmed = document.getElementById('reportConfirmed');
        const reportTentative = document.getElementById('reportTentative');
        const reportCancelled = document.getElementById('reportCancelled');
        const reportDispatched = document.getElementById('reportDispatched');
        const reportDelivered = document.getElementById('reportDelivered'); // New report element
        const reportBacks = document.getElementById('reportBacks');       // New report element
        const reportDateRange = document.getElementById('reportDateRange');
        const closeReportModal = document.getElementById('closeReportModal');

        const agentReportModal = document.getElementById('agentReportModal');
        const agentStatsContainer = document.getElementById('agentStatsContainer');
        const noAgentStatsMessage = document.getElementById('noAgentStatsMessage');
        const agentReportDateRange = document.getElementById('agentReportDateRange');
        const closeAgentReportModal = document.getElementById('closeAgentReportModal');

        // Buttons in AppBar
        const yalitecSettingsBtn = document.getElementById('yalitecSettingsBtn');
        const generatePdfBtn = document.getElementById('generatePdfBtn');
        const viewReportBtn = document.getElementById('viewReportBtn');
        const agentReportBtn = document.getElementById('agentReportBtn');
        const importShopifyBtn = document.getElementById('importShopifyBtn');
        const importShopifyIcon = document.getElementById('importShopifyIcon');

        // Message Box elements
        const messageBox = document.getElementById('messageBox');
        const messageIcon = document.getElementById('messageIcon');
        const messageText = document.getElementById('messageText');

        // --- Utility Functions ---

        /**
         * Displays a snackbar-like message.
         * @param {string} message The message to display.
         * @param {boolean} isError True if it's an error message, false for success.
         */
        function showMessage(message, isError = false) {
            messageText.textContent = message;
            messageBox.classList.remove('hidden', 'error', 'success');
            messageBox.classList.add('show');
            if (isError) {
                messageBox.classList.add('error');
                messageIcon.innerHTML = '<i class="fa-solid fa-circle-exclamation text-white"></i>';
            } else {
                messageBox.classList.add('success');
                messageIcon.innerHTML = '<i class="fa-solid fa-circle-check text-white"></i>';
            }

            setTimeout(() => {
                messageBox.classList.remove('show');
                messageBox.classList.add('hidden');
            }, 3000); // Hide after 3 seconds
        }

        /**
         * Shows a modal overlay.
         * @param {HTMLElement} modalElement The modal div element.
         */
        function showModal(modalElement) {
            modalElement.classList.remove('hidden');
            modalElement.classList.add('show');
        }

        /**
         * Hides a modal overlay.
         * @param {HTMLElement} modalElement The modal div element.
         */
        function hideModal(modalElement) {
            modalElement.classList.remove('show');
            modalElement.classList.add('hidden');
        }

        /**
         * Gets the appropriate text color for an order status.
         * @param {string} status The order status.
         * @returns {string} Tailwind CSS text color class.
         */
        function getStatusColorClass(status) {
            switch (status) {
                case 'confirmed': return 'text-green-800';
                case 'cancelled': return 'text-red-800';
                case 'tentative': return 'text-orange-800';
                case 'pending': return 'text-indigo-800';
                case 'dispatched': return 'text-blue-800';
                case 'delivered': return 'text-teal-800'; // New color for delivered
                case 'backs': return 'text-purple-800';   // New color for backs
                default: return 'text-gray-800';
            }
        }

        /**
         * Gets the appropriate background color for an order status badge.
         * @param {string} status The order status.
         * @returns {string} Tailwind CSS background color class.
         */
        function getStatusBgColorClass(status) {
            switch (status) {
                case 'confirmed': return 'bg-green-100';
                case 'cancelled': return 'bg-red-100';
                case 'tentative': return 'bg-orange-100';
                case 'pending': return 'bg-indigo-100';
                case 'dispatched': return 'bg-blue-100';
                case 'delivered': return 'bg-teal-100'; // New background for delivered
                case 'backs': return 'bg-purple-100';   // New background for backs
                default: return 'bg-gray-100';
            }
        }

        /**
         * Formats a date string to 'YYYY-MM-DD HH:MM'.
         * @param {string} dateString The ISO date string.
         * @returns {string} Formatted date and time.
         */
        function formatDateTime(dateString) {
            try {
                const date = new Date(dateString);
                if (isNaN(date.getTime())) {
                    return 'N/A';
                }
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                const hours = String(date.getHours()).padStart(2, '0');
                const minutes = String(date.getMinutes()).padStart(2, '0');
                return `${year}-${month}-${day} ${hours}:${minutes}`;
            } catch (e) {
                console.error("Error formatting date:", dateString, e);
                return 'N/A';
            }
        }

        // --- Authentication and User Management ---

        /**
         * Loads current user role and ID from localStorage.
         */
        function loadCurrentUserRole() {
            currentUserRole = localStorage.getItem('role') || 'guest';
            currentUserId = localStorage.getItem('id');
            console.log(`DEBUG: Loaded current user role: ${currentUserRole}, ID: ${currentUserId}`);

            // Show/hide admin-specific elements
            if (currentUserRole === 'admin') {
                assignedToDropdownContainer.classList.remove('hidden');
            } else {
                assignedToDropdownContainer.classList.add('hidden');
            }
        }

        /**
         * Fetches JWT token from localStorage.
         * @returns {string | null} The JWT token or null.
         */
        function getTokenFromPrefs() {
            return localStorage.getItem('token');
        }

        /**
         * Handles unauthorized access by clearing user data and navigating to login.
         */
        function handleUnauthorizedAccess() {
            showMessage('Your session has expired or is invalid. Please log in again.', true);
            localStorage.clear(); // Clear all user-related data
            showScreen('loginPage');
        }

        // --- Yalitec API Credentials Management ---

        /**
         * Loads Yalitec API credentials from localStorage.
         */
        function loadYalitecApiCredentials() {
            yalitecApiId = localStorage.getItem('yalitec_api_id');
            yalitecApiToken = localStorage.getItem('yalitec_api_token');
            areYalitecApiCredentialsLoaded = (yalitecApiId !== null && yalitecApiToken !== null && yalitecApiId.length > 0 && yalitecApiToken.length > 0);
            if (areYalitecApiCredentialsLoaded) {
                console.log('DEBUG: Yalitec API credentials loaded successfully from localStorage.');
            } else {
                console.log('DEBUG: Yalitec API credentials not found or incomplete in localStorage.');
            }
        }

        /**
         * Saves Yalitec API credentials to localStorage.
         * @param {string} apiId
         * @param {string} apiToken
         */
        function saveYalitecApiCredentials(apiId, apiToken) {
            localStorage.setItem('yalitec_api_id', apiId);
            localStorage.setItem('yalitec_api_token', apiToken);
            yalitecApiId = apiId;
            yalitecApiToken = apiToken;
            areYalitecApiCredentialsLoaded = true;
            showMessage('Yalitec API credentials saved successfully!', false);
        }

        /**
         * Prompts the user to enter Yalitec API credentials.
         * @returns {Promise<boolean>} True if credentials were successfully entered, false otherwise.
         */
        async function promptForYalitecCredentials() {
            yalitecApiIdInput.value = yalitecApiId || '';
            yalitecApiTokenInput.value = yalitecApiToken || '';
            showModal(yalitecSettingsModal);

            return new Promise(resolve => {
                const saveHandler = async () => {
                    if (yalitecApiIdInput.value.trim() && yalitecApiTokenInput.value.trim()) {
                        await saveYalitecApiCredentials(yalitecApiIdInput.value.trim(), yalitecApiTokenInput.value.trim());
                        hideModal(yalitecSettingsModal);
                        resolve(true);
                    } else {
                        showMessage('Both API ID and API Token are required.', true);
                    }
                };
                const cancelHandler = () => {
                    hideModal(yalitecSettingsModal);
                    resolve(false);
                };

                saveYalitecSettings.onclick = saveHandler;
                cancelYalitecSettings.onclick = cancelHandler;
            });
        }

        // --- Shopify API Credentials Management ---

        /**
         * Loads Shopify API credentials from localStorage.
         */
        function loadShopifyApiCredentials() {
            ShopifyApiHelper.storeName = localStorage.getItem('shopify_store_name');
            ShopifyApiHelper.apiKey = localStorage.getItem('shopify_api_key');
            ShopifyApiHelper.apiPassword = localStorage.getItem('shopify_api_password');
        }

        /**
         * Saves Shopify API credentials to localStorage.
         * @param {string} storeName
         * @param {string} apiKey
         * @param {string} password
         */
        async function saveShopifyCredentials(storeName, apiKey, password) {
            localStorage.setItem('shopify_store_name', storeName);
            localStorage.setItem('shopify_api_key', apiKey);
            localStorage.setItem('shopify_api_password', password);
            ShopifyApiHelper.storeName = storeName;
            ShopifyApiHelper.apiKey = apiKey;
            ShopifyApiHelper.apiPassword = password;
            showMessage('Shopify API credentials saved successfully!', false);
        }

        /**
         * Prompts the user to enter Shopify API credentials.
         * @returns {Promise<boolean>} True if credentials were successfully entered, false otherwise.
         */
        async function promptForShopifyCredentials() {
            shopifyStoreNameInput.value = localStorage.getItem('shopify_store_name') || '';
            shopifyApiKeyInput.value = localStorage.getItem('shopify_api_key') || '';
            shopifyApiPasswordInput.value = localStorage.getItem('shopify_api_password') || '';
            showModal(shopifySettingsModal);

            return new Promise(resolve => {
                const saveHandler = async () => {
                    if (shopifyStoreNameInput.value.trim() && shopifyApiKeyInput.value.trim() && shopifyApiPasswordInput.value.trim()) {
                        await saveShopifyCredentials(shopifyStoreNameInput.value.trim(), shopifyApiKeyInput.value.trim(), shopifyApiPasswordInput.value.trim());
                        hideModal(shopifySettingsModal);
                        resolve(true);
                    } else {
                        showMessage('All Shopify fields are required.', true);
                    }
                };
                const cancelHandler = () => {
                    hideModal(shopifySettingsModal);
                    resolve(false);
                };

                saveShopifySettings.onclick = saveHandler;
                cancelShopifySettings.onclick = cancelHandler;
            });
        }

        // --- Shopify API Helper (Simplified for client-side) ---
        const ShopifyApiHelper = {
            storeName: null,
            apiKey: null,
            apiPassword: null,

            async fetchShopifyOrders({ createdAtMin = null, createdAtMax = null, status = null } = {}) {
                if (!this.storeName || !this.apiKey || !this.apiPassword) {
                    throw new Error('Shopify API credentials are not set.');
                }

                let url = `https://${this.storeName}.myshopify.com/admin/api/2023-10/orders.json?status=any`;

                if (createdAtMin) {
                    url += `&created_at_min=${createdAtMin.toISOString()}`;
                }
                if (createdAtMax) {
                    url += `&created_at_max=${createdAtMax.toISOString()}`;
                }
                if (status && status !== 'all') {
                    // Shopify status mapping might be different, simplify for example
                    // For example, 'pending' in your app might map to 'unfulfilled' or 'pending' financial status in Shopify
                    // This is a simplification; a real integration would need careful mapping.
                    if (status === 'confirmed') url += '&fulfillment_status=fulfilled';
                    else if (status === 'cancelled') url += '&financial_status=refunded'; // Or 'voided'
                    else if (status === 'pending') url += '&financial_status=pending'; // Or 'unfulfilled'
                }

                // Basic Auth header for Shopify Private App (Legacy)
                // For modern Shopify apps, you'd use OAuth or a proxy.
                const headers = new Headers();
                headers.set('Authorization', 'Basic ' + btoa(`${this.apiKey}:${this.apiPassword}`));
                headers.set('Content-Type', 'application/json');

                console.log("Fetching Shopify orders from URL:", url);

                const response = await fetch(url, { headers: headers });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Shopify API error: ${response.status} - ${errorText}`);
                }

                return await response.json();
            }
        };

        /**
         * Converts Shopify order format to your app's format.
         * @param {Array<Object>} shopifyOrders
         * @returns {Array<Object>} Converted orders.
         */
        function convertShopifyOrders(shopifyOrders) {
            return shopifyOrders.map(shopifyOrder => {
                const fullName = `${shopifyOrder.customer?.first_name || ''} ${shopifyOrder.customer?.last_name || ''}`.trim();
                const phoneNumber = shopifyOrder.customer?.phone || shopifyOrder.shipping_address?.phone || '';
                const address = shopifyOrder.shipping_address?.address1 || '';
                const commune = shopifyOrder.shipping_address?.city || '';
                const wilaya = shopifyOrder.shipping_address?.province || '';
                const totalPrice = parseFloat(shopifyOrder.total_price || '0.00').toFixed(2);
                const createdAt = shopifyOrder.created_at || new Date().toISOString();

                return {
                    _id: shopifyOrder.id.toString(),
                    fullName: fullName,
                    phoneNumber: phoneNumber,
                    address: address,
                    commune: commune,
                    wilaya: wilaya,
                    status: mapShopifyStatus(shopifyOrder.fulfillment_status || shopifyOrder.financial_status || 'pending'),
                    totalPrice: totalPrice,
                    createdAt: createdAt,
                    products: (shopifyOrder.line_items || []).map(item => ({
                        name: item.name,
                        quantity: item.quantity,
                        price: item.price,
                        color: item.variant_title || 'N/A',
                        size: 'N/A', // You might need to parse this from variant_title
                    })),
                };
            });
        }

        /**
         * Maps Shopify status to your app's status.
         * @param {string} shopifyStatus
         * @returns {string} Your app's status.
         */
        function mapShopifyStatus(shopifyStatus) {
            switch (shopifyStatus?.toLowerCase()) {
                case 'paid':
                case 'fulfilled':
                    return 'confirmed';
                case 'pending':
                    return 'pending';
                case 'cancelled':
                    return 'cancelled';
                case 'partially_fulfilled':
                    return 'tentative';
                default:
                    return 'pending';
            }
        }

        /**
         * Imports orders from Shopify.
         */
        async function importFromShopify() {
            const hasCredentials = localStorage.getItem('shopify_api_key') && localStorage.getItem('shopify_api_password');

            if (!hasCredentials) {
                const credentialsEntered = await promptForShopifyCredentials();
                if (!credentialsEntered) return;
            }

            isImportingFromShopify = true;
            importShopifyIcon.classList.remove('fa-cloud-arrow-down');
            importShopifyIcon.classList.add('fa-spinner', 'fa-spin');

            try {
                let startDate = null;
                let endDate = new Date();

                if (currentDateFilter === 'today') {
                    startDate = new Date();
                    startDate.setDate(startDate.getDate() - 1); // Shopify uses created_at_min
                } else if (currentDateFilter === 'thisWeek') {
                    startDate = new Date();
                    startDate.setDate(startDate.getDate() - 7);
                } else if (currentDateFilter === 'thisMonth') {
                    startDate = new Date();
                    startDate.setDate(startDate.getDate() - 30);
                } else if (currentDateFilter === 'custom' && customStartDate) {
                    startDate = customStartDate;
                    endDate = customEndDate || new Date();
                }

                const shopifyOrders = await ShopifyApiHelper.fetchShopifyOrders({
                    createdAtMin: startDate,
                    createdAtMax: endDate,
                    status: currentFilter === 'all' ? null : currentFilter,
                });

                const convertedOrders = convertShopifyOrders(shopifyOrders.orders);

                // Simple merge: add new orders, avoid duplicates by ID
                const existingOrderIds = new Set(allOrders.map(o => o._id));
                const newUniqueOrders = convertedOrders.filter(o => !existingOrderIds.has(o._id));

                allOrders = [...allOrders, ...newUniqueOrders];
                applyAllFilters();

                showMessage(`Successfully imported ${newUniqueOrders.length} new orders from Shopify!`, false);
            } catch (e) {
                showMessage(`Error importing from Shopify: ${e.message}`, true);
                console.error("Shopify Import Error:", e);
            } finally {
                isImportingFromShopify = false;
                importShopifyIcon.classList.remove('fa-spinner', 'fa-spin');
                importShopifyIcon.classList.add('fa-cloud-arrow-down');
            }
        }


        // --- Order Data Management ---

        /**
         * Loads order notes from localStorage.
         */
        function loadOrderNotes() {
            const notesJson = localStorage.getItem('orderNotes');
            if (notesJson) {
                try {
                    orderNotes = JSON.parse(notesJson);
                } catch (e) {
                    console.error("Error parsing order notes from localStorage:", e);
                    orderNotes = {};
                }
            }
        }

        /**
         * Saves local order notes to localStorage.
         */
        function saveOrderNotes() {
            localStorage.setItem('orderNotes', JSON.stringify(orderNotes));
        }

        /**
         * Fetches all orders from the API.
         */
        async function fetchOrders() {
            isLoading = true;
            loadingIndicator.classList.remove('hidden');
            ordersList.innerHTML = ''; // Clear current orders
            noOrdersMessage.classList.add('hidden');

            try {
                const response = await fetch('https://sheeka.onrender.com/orders');
                if (!response.ok) {
                    if (response.status === 401) {
                        handleUnauthorizedAccess();
                        return;
                    }
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const fetchedOrders = await response.json();

                // Process totalPrice for each order. Prioritize 'tradingPrice' if available.
                fetchedOrders.forEach(order => {
                    if (order.tradingPrice && typeof order.tradingPrice === 'number' && order.tradingPrice > 0) {
                        // Use the tradingPrice from the backend if it's a valid number
                        order.totalPrice = order.tradingPrice.toFixed(2);
                    } else {
                        // Otherwise, calculate it from the products array as a fallback
                        let calculatedTotalPrice = 0.0;
                        if (order.products && Array.isArray(order.products)) {
                            order.products.forEach(productItem => {
                                // *** FIX STARTS HERE ***
                                // Add a check to ensure productItem is not null
                                if (productItem) { 
                                    const price = parseFloat(productItem.price || '0.0') || 0.0;
                                    const quantity = parseInt(productItem.quantity || '0') || 0;
                                    calculatedTotalPrice += price * quantity;
                                }
                                // *** FIX ENDS HERE ***
                            });
                        }
                        order.totalPrice = calculatedTotalPrice.toFixed(2);
                    }
                });

                // Sort by createdAt descending (newest first)
                fetchedOrders.sort((a, b) => {
                    const dateA = new Date(a.createdAt || '1970-01-01T00:00:00Z').getTime();
                    const dateB = new Date(b.createdAt || '1970-01-01T00:00:00Z').getTime();
                    return dateB - dateA;
                });

                allOrders = fetchedOrders;
                lastFetchedOrderIds = new Set(allOrders.map(order => order._id.toString()));
                applyAllFilters();
            } catch (e) {
                showMessage(`Error fetching orders. Check your connection: ${e.message}`, true);
                console.error('Error fetching orders:', e);
            } finally {
                isLoading = false;
                loadingIndicator.classList.add('hidden');
            }
        }

        /**
         * Applies all active filters (date, status, search, and role-based assignment)
         * and updates the displayed orders and status counts.
         */
        function applyAllFilters() {
            let currentProcessedOrders = [...allOrders];

            const now = new Date();
            const todayUtcStart = new Date(Date.UTC(now.getFullYear(), now.getMonth(), now.getDate()));
            const thisWeekUtcStart = new Date(Date.UTC(now.getFullYear(), now.getMonth(), now.getDate() - (now.getUTCDay() === 0 ? 6 : now.getUTCDay() - 1))); // Monday start
            const thisMonthUtcStart = new Date(Date.UTC(now.getFullYear(), now.getMonth(), 1));

            currentProcessedOrders = currentProcessedOrders.filter(order => {
                let createdAt;
                try {
                    const createdAtString = order.createdAt?.toString();
                    if (createdAtString && createdAtString.length > 0) {
                        createdAt = new Date(createdAtString);
                    } else {
                        createdAt = new Date(0); // Epoch start if invalid
                        console.warn(`Warning: createdAt is null or empty for order: ${order._id || 'unknown_id'}. Treating as epoch 0.`);
                    }
                } catch (e) {
                    createdAt = new Date(0); // Epoch start on parse error
                    console.error(`Error parsing createdAt date: ${e} for order: ${order._id || 'unknown_id'}. Treating as epoch 0.`);
                }

                let matchesDateRange = true;
                if (currentDateFilter === 'today') {
                    matchesDateRange = createdAt.getTime() >= todayUtcStart.getTime() &&
                                       createdAt.getTime() < todayUtcStart.getTime() + (24 * 60 * 60 * 1000);
                } else if (currentDateFilter === 'thisWeek') {
                    matchesDateRange = createdAt.getTime() >= thisWeekUtcStart.getTime() &&
                                       createdAt.getTime() < thisWeekUtcStart.getTime() + (7 * 24 * 60 * 60 * 1000);
                } else if (currentDateFilter === 'thisMonth') {
                    const nextMonthUtcStart = new Date(Date.UTC(now.getFullYear(), now.getMonth() + 1, 1));
                    matchesDateRange = createdAt.getTime() >= thisMonthUtcStart.getTime() &&
                                       createdAt.getTime() < nextMonthUtcStart.getTime();
                } else if (currentDateFilter === 'custom') {
                    if (customStartDate && customEndDate) {
                        const customStartUtc = new Date(Date.UTC(customStartDate.getFullYear(), customStartDate.getMonth(), customStartDate.getDate()));
                        const customEndUtc = new Date(Date.UTC(customEndDate.getFullYear(), customEndDate.getMonth(), customEndDate.getDate()));
                        matchesDateRange = createdAt.getTime() >= customStartUtc.getTime() &&
                                           createdAt.getTime() < customEndUtc.getTime() + (24 * 60 * 60 * 1000);
                    } else {
                        matchesDateRange = false;
                    }
                }
                return matchesDateRange;
            });

            if (currentUserRole === 'confirmation' && currentUserId) {
                currentProcessedOrders = currentProcessedOrders.filter(order => {
                    return order.assignedTo && order.assignedTo._id === currentUserId;
                });
                console.log(`DEBUG: Applying agent filter for user ID: ${currentUserId}. Current processed count: ${currentProcessedOrders.length}`);
            } else if (currentUserRole === 'admin') {
                console.log('DEBUG: Current user is admin, showing all relevant orders.');
            }

            // Update counts
            document.getElementById('count-all').textContent = currentProcessedOrders.length;
            document.getElementById('count-pending').textContent = currentProcessedOrders.filter(order => order.status === 'pending').length;
            document.getElementById('count-confirmed').textContent = currentProcessedOrders.filter(order => order.status === 'confirmed').length;
            document.getElementById('count-cancelled').textContent = currentProcessedOrders.filter(order => order.status === 'cancelled').length;
            document.getElementById('count-tentative').textContent = currentProcessedOrders.filter(order => order.status === 'tentative').length;
            document.getElementById('count-dispatched').textContent = currentProcessedOrders.filter(order => order.status === 'dispatched').length;
            document.getElementById('count-delivered').textContent = currentProcessedOrders.filter(order => order.status === 'delivered').length; // New count
            document.getElementById('count-backs').textContent = currentProcessedOrders.filter(order => order.status === 'backs').length;       // New count

            if (currentFilter !== 'all') {
                filteredOrders = currentProcessedOrders.filter(order => order.status === currentFilter);
            } else {
                filteredOrders = currentProcessedOrders;
            }

            const searchTerm = searchInput.value.toLowerCase();
            if (searchTerm.length > 0) {
                filteredOrders = filteredOrders.filter(order => {
                    const phoneNumber = order.phoneNumber?.toString().toLowerCase() || '';
                    const fullName = order.fullName?.toString().toLowerCase() || '';
                    const orderId = order._id?.toString().toLowerCase() || '';
                    return phoneNumber.includes(searchTerm) || fullName.includes(searchTerm) || orderId.includes(searchTerm);
                });
            }

            renderOrders();
            sendOrderCountToBackend(filteredOrders.length);
        }

        /**
         * Renders the filtered orders into the DOM.
         */
        function renderOrders() {
            ordersList.innerHTML = ''; // Clear existing cards
            if (filteredOrders.length === 0) {
                noOrdersMessage.classList.remove('hidden');
            } else {
                noOrdersMessage.classList.add('hidden');
                filteredOrders.forEach(order => {
                    ordersList.appendChild(createOrderCard(order));
                });
            }
        }

        /**
         * Creates an HTML element for a single order card.
         * @param {Object} order The order data.
         * @returns {HTMLElement} The created order card element.
         */
        function createOrderCard(order) {
            const card = document.createElement('div');
            card.id = `order-card-${order._id}`;
            card.className = 'bg-white rounded-xl shadow-lg border border-gray-200 p-4 sm:p-6 mb-4 transition-shadow duration-200 hover:shadow-xl';

            const formattedTime = formatDateTime(order.createdAt);
            const statusColorClass = getStatusColorClass(order.status);
            const statusBgClass = getStatusBgColorClass(order.status);

            const assignedToHtml = order.assignedTo && order.assignedTo.name
                ? `<div class="flex items-center text-sm text-gray-600 mt-1">
                                <i class="fa-solid fa-user-check fa-fw mr-2 text-teal-600"></i>
                                <span class="font-medium">Assigned To:</span>
                                <span class="ml-1">${order.assignedTo.name}</span>
                            </div>`
                : '';

            const productsHtml = order.products && Array.isArray(order.products) && order.products.length > 0
                ? order.products.map(p => `
                    <div class="flex justify-between items-center py-1">
                        <div class="text-gray-700">
                            <span>${p.name || 'N/A'}</span>
                            <span class="text-gray-500 text-xs ml-2">(x${p.quantity || 'N/A'})</span>
                        </div>
                        <div class="text-gray-500 text-sm">
                            ${p.color && p.color !== 'N/A' ? `<span class="mr-2">Color: ${p.color}</span>` : ''}
                            ${p.size && p.size !== 'N/A' ? `<span>Size: ${p.size}</span>` : ''}
                        </div>
                    </div>
                `).join('')
                : '<p class="text-gray-500 text-sm">No products listed.</p>';

            const notesValue = orderNotes[order._id] || order.notes || '';

            card.innerHTML = `
                <div class="flex flex-col sm:flex-row justify-between items-start gap-4">
                    <div class="flex-1">
                        <div class="flex items-center gap-3">
                            <p class="font-bold text-lg text-gray-800">${order.fullName || 'N/A'}</p>
                            <div class="px-3 py-1 ${statusBgClass} ${statusColorClass} rounded-full text-xs font-semibold capitalize">
                                ${order.status || 'N/A'}
                            </div>
                        </div>
                        <p class="text-gray-500 text-sm mt-1">
                            <i class="fa-solid fa-phone fa-fw mr-1"></i>${order.phoneNumber || 'N/A'}
                        </p>
                        <p class="text-gray-500 text-sm mt-1">
                            <i class="fa-solid fa-hashtag fa-fw mr-1"></i>Order ID: ${order._id || 'N/A'}
                        </p>
                    </div>
                    <div class="text-left sm:text-right flex-shrink-0">
                        <p class="text-gray-600 text-sm font-medium">
                           <i class="fa-solid fa-clock fa-fw mr-1"></i>${formattedTime}
                        </p>
                        <p class="font-bold text-lg text-indigo-600 mt-1">DZD ${order.totalPrice || 'N/A'}</p>
                    </div>
                </div>
                
                <div class="text-center mt-2">
                    <button class="expand-toggle-btn text-gray-500 hover:text-indigo-600 transition-colors duration-200 p-2">
                        <i class="fa-solid fa-chevron-down text-sm"></i>
                    </button>
                </div>

                <div class="collapsible-content hidden pt-4 mt-4 border-t border-gray-200">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <h4 class="font-semibold text-gray-700 mb-2">Shipping Details</h4>
                            <div class="text-gray-600 text-sm space-y-1">
                                <p><i class="fa-solid fa-location-dot fa-fw mr-2"></i>${order.wilaya || 'N/A'} - ${order.commune || 'N/A'}</p>
                                <p><i class="fa-solid fa-map-marker-alt fa-fw mr-2"></i>${order.address || 'N/A'}</p> <!-- Display address here -->
                                ${assignedToHtml}
                            </div>
                        </div>
                        <div>
                            <h4 class="font-semibold text-gray-700 mb-2">Products</h4>
                            <div class="text-gray-600 text-sm space-y-1">
                                ${productsHtml}
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-4">
                        <label for="notes-${order._id}" class="block text-sm font-medium text-gray-700 mb-1">Agent Notes</label>
                        <textarea id="notes-${order._id}" class="w-full p-2 notes-input h-20" placeholder="Enter notes here...">${notesValue}</textarea>
                    </div>

                    ${currentFilter !== 'dispatched' && currentFilter !== 'delivered' && currentFilter !== 'backs' ? `
                    <div class="flex flex-wrap justify-between items-center mt-4 gap-2">
                        <div class="flex space-x-2">
                            <button data-order-id="${order._id}" class="edit-btn px-3 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-100 transition-colors duration-200 text-sm flex items-center">
                                <i class="fa-solid fa-edit mr-1 text-base"></i> Edit
                            </button>
                            <button data-order-id="${order._id}" class="delete-btn px-3 py-2 bg-red-50 border border-red-200 text-red-700 rounded-lg hover:bg-red-100 transition-colors duration-200 text-sm flex items-center">
                                <i class="fa-solid fa-trash-alt mr-1 text-base"></i> Delete
                            </button>
                        </div>
                        <div class="flex space-x-2 flex-wrap justify-end gap-2">
                            ${((order.status === 'pending' || order.status === 'tentative') && (currentUserRole === 'admin' || (currentUserId && order.assignedTo?._id === currentUserId && currentUserRole === 'confirmation'))) ? `
                            <button data-order-id="${order._id}" data-status="confirmed" class="status-update-btn px-3 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors duration-200 text-sm">Confirm</button>
                            ` : ''}
                            ${(order.status !== 'cancelled' && (currentUserRole === 'admin' || (currentUserId && order.assignedTo?._id === currentUserId && currentUserRole === 'confirmation'))) ? `
                            <button data-order-id="${order._id}" data-status="cancelled" class="status-update-btn px-3 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors duration-200 text-sm">Cancel</button>
                            ` : ''}
                            ${(order.status !== 'tentative' && (currentUserRole === 'admin' || (currentUserId && order.assignedTo?._id === currentUserId && currentUserRole === 'confirmation'))) ? `
                            <button data-order-id="${order._id}" data-status="tentative" class="status-update-btn px-3 py-2 bg-orange-500 text-white rounded-lg hover:bg-orange-600 transition-colors duration-200 text-sm">Tentative</button>
                            ` : ''}
                            ${(order.status === 'confirmed' && (currentUserRole === 'admin' || (currentUserId && order.assignedTo?._id === currentUserId && currentUserRole === 'confirmation'))) ? `
                            <button data-order-id="${order._id}" class="dispatch-btn px-3 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors duration-200 text-sm">Dispatch</button>
                            ` : ''}
                            <!-- New Status Update Buttons -->
                            ${(order.status === 'dispatched' && (currentUserRole === 'admin' || (currentUserId && order.assignedTo?._id === currentUserId && currentUserRole === 'confirmation'))) ? `
                            <button data-order-id="${order._id}" data-status="delivered" class="status-update-btn px-3 py-2 bg-teal-600 text-white rounded-lg hover:bg-teal-700 transition-colors duration-200 text-sm">Delivered</button>
                            <button data-order-id="${order._id}" data-status="backs" class="status-update-btn px-3 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors duration-200 text-sm">Backs</button>
                            ` : ''}
                        </div>
                    </div>
                    ` : ''}
                </div>
            `;

            // Add event listeners
            card.querySelector('.expand-toggle-btn').addEventListener('click', (e) => {
                const content = card.querySelector('.collapsible-content');
                const icon = e.currentTarget.querySelector('i');
                content.classList.toggle('hidden');
                icon.classList.toggle('fa-chevron-down');
                icon.classList.toggle('fa-chevron-up');
            });

            card.querySelector(`#notes-${order._id}`).addEventListener('input', (e) => {
                orderNotes[order._id] = e.target.value;
                saveOrderNotes();
            });

            card.querySelectorAll('.status-update-btn').forEach(button => {
                button.addEventListener('click', () => updateStatus(order._id, button.dataset.status));
            });
            card.querySelectorAll('.edit-btn').forEach(button => {
                button.addEventListener('click', () => editOrder(order));
            });
            card.querySelectorAll('.delete-btn').forEach(button => {
                button.addEventListener('click', () => deleteOrder(order._id));
            });
            card.querySelectorAll('.dispatch-btn').forEach(button => {
                button.addEventListener('click', () => dispatchOrder(order));
            });

            return card;
        }

        /**
         * Updates the status of a specific order on the backend.
         * @param {string} orderId
         * @param {string} status
         * @param {string | null} assignedToId
         */
        async function updateStatus(orderId, status, assignedToId = null) {
            console.log(`DEBUG: updateStatus called for Order ID: ${orderId}, new Status: ${status}`);
            const currentNotes = orderNotes[orderId] || '';
            const requestBody = {
                status: status,
                notes: currentNotes
            };

            if (assignedToId !== null) {
                requestBody.assignedTo = assignedToId;
            } else if (['pending', 'tentative', 'cancelled'].includes(status)) {
                requestBody.assignedTo = null; // Unassign if status is reset
            }

            const token = getTokenFromPrefs();
            if (!token) {
                showMessage('Authentication token not found. Please log in.', true);
                return;
            }

            try {
                const response = await fetch(`https://sheeka.onrender.com/orders/${orderId}/status`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) {
                    if (response.status === 401) {
                        handleUnauthorizedAccess();
                        return;
                    }
                    const errorBody = await response.json();
                    throw new Error(errorBody.message || `Failed to update status: ${response.status}`);
                }

                const backendUpdatedOrder = (await response.json()).order;
                console.log(`DEBUG: Backend updated order after status change: ${backendUpdatedOrder.status}`);
                updateLocalOrderAndFilter(backendUpdatedOrder);
                showMessage(`Order status updated to ${status}`, false);
                delete orderNotes[orderId]; // Clear local note after successful update
                saveOrderNotes();
            } catch (e) {
                showMessage(`Error updating status: ${e.message}`, true);
                console.error('Exception in updateStatus:', e);
            }
        }

        /**
         * Handles editing an order's details, including assigning an agent.
         * @param {Object} order The order data to edit.
         */
        async function editOrder(order) {
            editOrderId.value = order._id;
            editFullName.value = order.fullName || '';
            editPhoneNumber.value = order.phoneNumber || '';
            editWilaya.value = order.wilaya || '';
            editCommune.value = order.commune || '';
            editAddress.value = order.address || ''; // Populate the new address field
            editNotes.value = orderNotes[order._id] || order.notes || '';

            // Log the address value when opening the modal
            console.log(`DEBUG: Edit Order Modal opened for Order ID: ${order._id}, current address: "${order.address}"`);

            // Populate assigned agents dropdown
            editAssignedTo.innerHTML = '<option value="">None</option>';
            availableAgents.forEach(agent => {
                const option = document.createElement('option');
                option.value = agent.id;
                option.textContent = agent.name;
                editAssignedTo.appendChild(option);
            });
            editAssignedTo.value = order.assignedTo?._id || ''; // Set current assigned agent

            showModal(editOrderModal);
        }

        editOrderForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            hideModal(editOrderModal);

            const orderId = editOrderId.value;
            const updatedData = {
                fullName: editFullName.value,
                phoneNumber: editPhoneNumber.value,
                wilaya: editWilaya.value,
                commune: editCommune.value,
                address: editAddress.value, // Include the new address field in updatedData
                notes: editNotes.value,
                assignedTo: editAssignedTo.value || null, // Send null if 'None' is selected
            };

            // Log the address value being sent on save
            console.log(`DEBUG: Saving Order ID: ${orderId}, updated address being sent: "${updatedData.address}"`);

            const token = getTokenFromPrefs();
            if (!token) {
                showMessage('Authentication token not found. Please log in.', true);
                return;
            }

            try {
                const response = await fetch(`https://sheeka.onrender.com/orders/${orderId}`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(updatedData)
                });

                if (!response.ok) {
                    if (response.status === 401) {
                        handleUnauthorizedAccess();
                        return;
                    }
                    const errorBody = await response.json();
                    throw new Error(errorBody.message || `Failed to update order: ${response.status}`);
                }

                const backendUpdatedOrder = (await response.json()).order;
                updateLocalOrderAndFilter(backendUpdatedOrder);
                showMessage('Order details updated successfully!', false);
            } catch (e) {
                showMessage(`Error updating order: ${e.message}`, true);
                console.error('Error updating order:', e);
            }
        });

        cancelEditOrder.addEventListener('click', () => hideModal(editOrderModal));

        /**
         * Handles deleting an order after user confirmation.
         * @param {string} orderId
         */
        async function deleteOrder(orderId) {
            showModal(confirmDeleteModal);

            confirmDelete.onclick = async () => {
                hideModal(confirmDeleteModal);
                const token = getTokenFromPrefs();
                if (!token) {
                    showMessage('Authentication token not found. Please log in.', true);
                    return;
                }
                try {
                    const response = await fetch(`https://sheeka.onrender.com/orders/${orderId}`, {
                        method: 'DELETE',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });

                    if (!response.ok) {
                        if (response.status === 401) {
                            handleUnauthorizedAccess();
                            return;
                        }
                        const errorBody = await response.json();
                        throw new Error(errorBody.message || `Failed to delete order: ${response.status}`);
                    }

                    // Remove order from local lists
                    allOrders = allOrders.filter(order => order._id !== orderId);
                    delete orderNotes[orderId];
                    saveOrderNotes();
                    applyAllFilters(); // Re-render
                    showMessage('Order deleted successfully!', false);
                } catch (e) {
                    showMessage(`Error deleting order: ${e.message}`, true);
                    console.error('Error deleting order:', e);
                }
            };
            cancelDelete.onclick = () => hideModal(confirmDeleteModal);
        }

        /**
         * Dispatches a confirmed order to Yalitec API to create a parcel.
         * @param {Object} order The order to dispatch.
         */
        async function dispatchOrder(order) {
            console.log(`DEBUG: Starting dispatch process for order ${order._id}, address received: "${order.address}"`); // Added log here

            // 1. Check Yalitec API credentials
            if (!areYalitecApiCredentialsLoaded) {
                console.warn('DEBUG: Yalitec API credentials not loaded. Prompting user.');
                const credentialsEntered = await promptForYalitecCredentials();
                if (!credentialsEntered) {
                    showMessage("Dispatch cancelled: Yalitec credentials not provided.", true);
                    return false;
                }
                console.log('DEBUG: Yalitec API credentials successfully provided.');
            }

            // 2. Check order status
            if (order.status !== 'confirmed') {
                showMessage("Order must be 'confirmed' before dispatching.", true);
                console.warn(`DEBUG: Dispatch aborted. Order status is '${order.status}', but must be 'confirmed'.`);
                return false;
            }

            // 3. Validate required fields (address is now explicitly required again)
            const missingFields = [];
            const requiredFields = {
                '_id': 'Order ID',
                'fullName': 'Customer Name',
                'phoneNumber': 'Phone Number',
                'wilaya': 'Wilaya',
                'commune': 'Commune',
                'products': 'Products'
            };

            Object.keys(requiredFields).forEach(field => {
                if (!order[field] || 
                    (Array.isArray(order[field]) && order[field].length === 0)) {
                    missingFields.push(requiredFields[field]);
                }
            });

            if (missingFields.length > 0) {
                showMessage(` Missing data: ${missingFields.join(', ')}`, true);
                console.error(`DEBUG: Dispatch aborted. Missing required fields: ${missingFields.join(', ')}`);
                return false;
            }

            // 4. Validate phone number format
            const phoneRegex = /^0\d{9}$/;
            if (!phoneRegex.test(order.phoneNumber)) {
                showMessage(" Phone number must start with 0 and be 10 digits long (e.g., 0551234567).", true);
                console.error(`DEBUG: Dispatch aborted. Invalid phone number format: ${order.phoneNumber}`);
                return false;
            }

            // 5. Check for products
            if (!order.products || order.products.length === 0) {
                showMessage(" Order must contain at least one product.", true);
                console.error('DEBUG: Dispatch aborted. No products found in order.');
                return false;
            }

            isLoading = true;
            loadingIndicator.classList.remove('hidden');

            try {
                // Prepare parcel data for Yalitec
                const nameParts = order.fullName.split(' ');
                const firstName = nameParts[0] || '';
                const familyName = nameParts.slice(1).join(' ') || 'N/A';

                const productList = order.products.map(p => {
                    const details = `${p.name || 'Unknown Product'} x${p.quantity || 1}`;
                    const color = p.color && p.color !== 'N/A' ? ` (Color: ${p.color})` : '';
                    const size = p.size && p.size !== 'N/A' ? ` (Size: ${p.size})` : '';
                    return details + color + size;
                }).join(', ');

                const price = Math.floor(parseFloat(order.totalPrice) || 0);

                const parcelData = {
                    order_id: order._id,
                    from_wilaya_name: shopOriginWilayaName,
                    firstname: firstName,
                    familyname: familyName,
                    contact_phone: order.phoneNumber,
                    address: "no", // Pass address as is (now required by validation)
                    to_commune_name: order.commune,
                    to_wilaya_name: order.wilaya,
                    product_list: productList,
                    price: price,
                    do_insurance: false,
                    declared_value: price,
                    height: 30,
                    width: 20,
                    length: 10,
                    weight: 1,
                    freeshipping: order.deliveryFee === 0,
                    is_stopdesk: false,
                    has_exchange: false
                };

                console.log('DEBUG: Prepared parcel data for Yalitec API:', JSON.stringify([parcelData], null, 2));

                // Send request to Yalitec - UPDATED ENDPOINT HERE
                const response = await fetch('https://api.yalitec.me/v1/parcels', {
                    method: 'POST',
                    headers: {
                        'X-API-ID': yalitecApiId,
                        'X-API-TOKEN': yalitecApiToken,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify([parcelData])
                });

                const responseData = await response.json();
                console.log('DEBUG: Raw response from Yalitec API:', responseData);

                if (!response.ok) {
                    const errorMessage = responseData.message || `Server responded with status: ${response.status}`;
                    throw new Error(`Yalitec API error: ${errorMessage}`);
                }

                const orderResponse = responseData.find(item => item.order_id === order._id);
                if (!orderResponse || !orderResponse.success) {
                    throw new Error(orderResponse?.message || 'Yalitec dispatch failed for unknown reason.');
                }

                // Update order status locally and on your backend
                const orderIndex = allOrders.findIndex(o => o._id === order._id);
                if (orderIndex !== -1) {
                    allOrders[orderIndex].status = 'dispatched';
                    allOrders[orderIndex].trackingNumber = orderResponse.tracking;
                    allOrders[orderIndex].dispatchedAt = new Date().toISOString();
                    // Also update on your backend
                    await updateStatus(order._id, 'dispatched', order.assignedTo?._id);
                }

                showMessage(` Parcel dispatched successfully! Tracking Number: ${orderResponse.tracking}`, false);
                applyAllFilters();
                return true;

            } catch (error) {
                console.error('DEBUG: Dispatch Error:', error);
                
                let userErrorMessage = error.message;
                if (error.message.includes('Failed to fetch')) {
                    userErrorMessage = 'Could not connect to Yalitec server. Please check your internet connection and API endpoint.';
                } else if (error.message.includes('401')) {
                    userErrorMessage = 'Invalid Yalitec API credentials. Please check your API ID and Token in settings.';
                } else if (error.message.includes('400')) {
                    userErrorMessage = `Bad request to Yalitec: ${error.message}. Please check order data.`;
                }

                showMessage(` Parcel dispatch failed: ${userErrorMessage}`, true);
                return false;
            } finally {
                isLoading = false;
                loadingIndicator.classList.add('hidden');
            }
        }

        /**
         * Helper to update the local order list and re-apply all filters after backend operations.
         * @param {Object} updatedOrder
         */
        function updateLocalOrderAndFilter(updatedOrder) {
            console.log(`DEBUG: updateLocalOrderAndFilter called for order ${updatedOrder._id} with status ${updatedOrder.status}`);
            const index = allOrders.findIndex(order => order._id === updatedOrder._id);
            if (index !== -1) {
                allOrders[index] = updatedOrder;
                // Re-sort the entire list to maintain newest-first order
                allOrders.sort((a, b) => {
                    const dateA = new Date(a.createdAt || '1970-01-01T00:00:00Z').getTime();
                    const dateB = new Date(b.createdAt || '1970-01-01T00:00:00Z').getTime();
                    return dateB - dateA; // Sort descending (newest first)
                });
                console.log(`DEBUG: Local allOrders updated for ${updatedOrder._id} to status ${updatedOrder.status}`);
                applyAllFilters();
            } else {
                console.log(`DEBUG: Order ${updatedOrder._id} not found in local allOrders. Refetching all orders.`);
                fetchOrders();
            }
        }

        /**
         * Sends the current filtered order count to the backend.
         * @param {number} count
         */
        async function sendOrderCountToBackend(count) {
            const token = getTokenFromPrefs();
            if (!token) {
                console.warn('Warning: No authentication token found. Not sending order count to backend.');
                return;
            }

            try {
                const response = await fetch('https://sheeka.onrender.com/countorder/order-counts', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`,
                    },
                    body: JSON.stringify({
                        count: count,
                        timestamp: new Date().toISOString(),
                        userId: currentUserId,
                        dateFilter: currentDateFilter,
                        statusFilter: currentFilter,
                    }),
                });

                if (response.status === 201) {
                    console.log(`Successfully sent filtered order count to backend: ${count}`);
                } else {
                    console.warn(`Failed to send order count. Status: ${response.status}, Body: ${await response.text()}`);
                }
            } catch (e) {
                console.error('Error sending order count to backend:', e);
            }
        }

        /**
         * Fetches users with the 'confirmation' role (agents) from the backend.
         */
        async function fetchAdmins() {
            try {
                const response = await fetch('https://sheeka.onrender.com/auth/users');
                if (response.status === 200) {
                    const fetchedUsers = await response.json();
                    availableAgents = fetchedUsers
                        .filter(user => user.role === 'confirmation')
                        .map(user => ({
                            id: user._id.toString(),
                            name: user.name.toString(),
                        }));
                } else if (response.status === 401) {
                    handleUnauthorizedAccess();
                } else {
                    console.error('Failed to load admins:', response.status);
                }
            } catch (e) {
                console.error('Error fetching admins:', e);
            }
        }

        /**
         * Starts a periodic timer to poll for new orders from the backend.
         */
        function startPollingForNewOrders() {
            pollingTimer = setInterval(pollAndNotifyForNewOrders, 30000); // Every 30 seconds
        }

        /**
         * Polls the backend for new orders and notifies the user if any are found.
         */
        async function pollAndNotifyForNewOrders() {
            try {
                const response = await fetch('https://sheeka.onrender.com/orders');
                if (!response.ok) {
                    if (response.status === 401) {
                        handleUnauthorizedAccess();
                        return;
                    }
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const currentOrders = await response.json();

                currentOrders.sort((a, b) => {
                    const dateA = new Date(a.createdAt || '1970-01-01T00:00:00Z').getTime();
                    const dateB = new Date(b.createdAt || '1970-01-01T00:00:00Z').getTime();
                    return dateB - dateA;
                });

                const currentOrderIds = new Set(currentOrders.map(order => order._id.toString()));
                const newOrderIds = [...currentOrderIds].filter(id => !lastFetchedOrderIds.has(id));

                if (newOrderIds.length > 0) {
                    console.log(`DEBUG: New orders detected! Count: ${newOrderIds.length}`);
                    showMessage(' New order received! Refreshing data...', false);
                    allOrders = currentOrders;
                    applyAllFilters();

                    for (const order of currentOrders) {
                        if (newOrderIds.has(order._id.toString())) {
                            const customerName = order.fullName || 'N/A';
                            const orderId = order._id || 'N/A';
                            const totalPrice = order.totalPrice || '0.00';
                            console.log(`Desktop Notification: New Order Arrived! Order #${orderId} from ${customerName} (Total: DZD${totalPrice})`);
                            sendEmailWithEmailJS(order); // Send email via EmailJS
                        }
                    }
                } else {
                    console.log('DEBUG: No new orders detected.');
                }
                lastFetchedOrderIds = currentOrderIds;
            } catch (e) {
                console.error('Error polling for new orders:', e);
            }
        }
        
        /**
         * Sends an email notification for a new order using EmailJS.
         * @param {Object} order The order data.
         */
        function sendEmailWithEmailJS(order) {
            const serviceID = 'service_va30odk'; // Replace with your EmailJS Service ID
            const templateID = 'template_49nz2wu'; // Replace with your EmailJS Template ID

            let productsSummary = '';
            if (order.products && Array.isArray(order.products) && order.products.length > 0) {
                productsSummary = order.products.map(p => {
                    const pName = p.name || 'Unknown Product';
                    const pQuantity = parseInt(p.quantity || '1') || 1;
                    const pColor = p.color || '';
                    const pSize = p.size || '';
                    let details = `${pName} x${pQuantity}`;
                    if (pColor && pColor !== 'N/A') details += ` (Color: ${pColor})`;
                    if (pSize && pSize !== 'N/A') details += ` (Size: ${p.size})`;
                    return details;
                }).join('<br>- ');
                productsSummary = `- ${productsSummary}`;
            } else {
                productsSummary = 'No products listed.';
            }

            const templateParams = {
                to_email: 'sheekaoff@gmail.com',
                order_id: order._id || 'N/A',
                customer_name: order.fullName || 'N/A',
                phone_number: order.phoneNumber || 'N/A',
                address: `${order.address || 'N/A'}, ${order.commune || 'N/A'}, ${order.wilaya || 'N/A'}`,
                total_price: order.totalPrice || '0.00',
                products_summary: productsSummary,
                notes: order.notes || 'No notes.',
                created_at: formatDateTime(order.createdAt || new Date().toISOString())
            };

            emailjs.send(serviceID, templateID, templateParams)
                .then(function(response) {
                   console.log('SUCCESS! Email sent for new order.', response.status, response.text);
                   showMessage('New order email notification sent!', false);
                }, function(error) {
                   console.log('FAILED to send email...', error);
                   showMessage('Failed to send new order email notification.', true);
                });
        }


        // --- Report Generation ---

        /**
         * Generates and displays the order summary report.
         * Includes new 'delivered' and 'backs' statuses.
         */
        function generateAndShowReport() {
            const totalOrders = filteredOrders.length;
            const pendingOrders = filteredOrders.filter(o => o.status === 'pending').length;
            const confirmedOrders = filteredOrders.filter(o => o.status === 'confirmed').length;
            const tentativeOrders = filteredOrders.filter(o => o.status === 'tentative').length;
            const cancelledOrders = filteredOrders.filter(o => o.status === 'cancelled').length;
            const dispatchedOrders = filteredOrders.filter(o => o.status === 'dispatched').length;
            const deliveredOrders = filteredOrders.filter(o => o.status === 'delivered').length; // New
            const backsOrders = filteredOrders.filter(o => o.status === 'backs').length;       // New

            reportTotal.textContent = totalOrders;
            reportPending.textContent = pendingOrders;
            reportConfirmed.textContent = confirmedOrders;
            reportTentative.textContent = tentativeOrders;
            reportCancelled.textContent = cancelledOrders;
            reportDispatched.textContent = dispatchedOrders;
            reportDelivered.textContent = deliveredOrders; // Update new element
            reportBacks.textContent = backsOrders;       // Update new element

            let dateRangeText;
            const now = new Date();
            if (currentDateFilter === 'allTime') {
                dateRangeText = 'All Time';
            } else if (currentDateFilter === 'today') {
                dateRangeText = `Today (${new Date().toLocaleDateString()})`;
            } else if (currentDateFilter === 'thisWeek') {
                dateRangeText = 'This Week';
            } else if (currentDateFilter === 'thisMonth') {
                dateRangeText = `This Month (${now.toLocaleString('default', { month: 'long' })})`;
            } else if (currentDateFilter === 'custom' && customStartDate && customEndDate) {
                dateRangeText = `Custom Range: ${customStartDate.toLocaleDateString()} to ${customEndDate.toLocaleDateString()}`;
            } else {
                dateRangeText = 'Unknown Date Range';
            }
            reportDateRange.textContent = dateRangeText;

            showModal(orderReportModal);
        }
        closeReportModal.addEventListener('click', () => hideModal(orderReportModal));

        /**
         * Generates and displays a report of order statistics per assigned agent.
         * Includes new 'delivered' and 'backs' statuses.
         */
        function generateAgentStatsReport() {
            const agentStats = {};

            // Initialize stats for all available agents
            availableAgents.forEach(agent => {
                agentStats[agent.id] = {
                    agentName: agent.name,
                    pending: 0,
                    confirmed: 0,
                    cancelled: 0,
                    tentative: 0,
                    dispatched: 0,
                    delivered: 0, // New
                    backs: 0,       // New
                    totalAssigned: 0,
                };
            });

            // Filter orders by date range before processing for agents
            let ordersForReport = [...allOrders];
            const now = new Date();
            const todayUtcStart = new Date(Date.UTC(now.getFullYear(), now.getMonth(), now.getDate()));
            const thisWeekUtcStart = new Date(Date.UTC(now.getFullYear(), now.getMonth(), now.getDate() - (now.getUTCDay() === 0 ? 6 : now.getUTCDay() - 1))); // Monday start
            const thisMonthUtcStart = new Date(Date.UTC(now.getFullYear(), now.getMonth(), 1));

            ordersForReport = ordersForReport.filter(order => {
                let createdAt;
                try {
                    const createdAtString = order.createdAt?.toString();
                    if (createdAtString && createdAtString.length > 0) {
                        createdAt = new Date(createdAtString);
                    } else {
                        createdAt = new Date(0);
                    }
                } catch (e) {
                    createdAt = new Date(0);
                    console.error(`Error parsing createdAt date for agent report: ${e} for order: ${order._id || 'unknown_id'}. Treating as epoch 0.`);
                }

                let matchesDateRange = true;
                if (currentDateFilter === 'today') {
                    matchesDateRange = createdAt.getTime() >= todayUtcStart.getTime() &&
                                       createdAt.getTime() < todayUtcStart.getTime() + (24 * 60 * 60 * 1000);
                } else if (currentDateFilter === 'thisWeek') {
                    matchesDateRange = createdAt.getTime() >= thisWeekUtcStart.getTime() &&
                                       createdAt.getTime() < thisWeekUtcStart.getTime() + (7 * 24 * 60 * 60 * 1000);
                } else if (currentDateFilter === 'thisMonth') {
                    const nextMonthUtcStart = new Date(Date.UTC(now.getFullYear(), now.getMonth() + 1, 1));
                    matchesDateRange = createdAt.getTime() >= thisMonthUtcStart.getTime() &&
                                       createdAt.getTime() < nextMonthUtcStart.getTime();
                } else if (currentDateFilter === 'custom') {
                    if (customStartDate && customEndDate) {
                        const customStartUtc = new Date(Date.UTC(customStartDate.getFullYear(), customStartDate.getMonth(), customStartDate.getDate()));
                        const customEndUtc = new Date(Date.UTC(customEndDate.getFullYear(), customEndDate.getMonth(), customEndDate.getDate()));
                        matchesDateRange = createdAt.getTime() >= customStartUtc.getTime() &&
                                           createdAt.getTime() < customEndUtc.getTime() + (24 * 60 * 60 * 1000);
                    } else {
                        matchesDateRange = false;
                    }
                }
                return matchesDateRange;
            });

            for (const order of ordersForReport) {
                if (order.assignedTo && order.assignedTo._id) {
                    const agentId = order.assignedTo._id.toString();
                    const agentName = order.assignedTo.name || 'Unknown Agent';

                    if (!agentStats[agentId]) {
                        agentStats[agentId] = {
                            agentName: agentName,
                            pending: 0,
                            confirmed: 0,
                            cancelled: 0,
                            tentative: 0,
                            dispatched: 0,
                            delivered: 0, // New
                            backs: 0,       // New
                            totalAssigned: 0,
                        };
                    }

                    agentStats[agentId].totalAssigned++;

                    switch (order.status) {
                        case 'pending': agentStats[agentId].pending++; break;
                        case 'confirmed': agentStats[agentId].confirmed++; break;
                        case 'cancelled': agentStats[agentId].cancelled++; break;
                        case 'tentative': agentStats[agentId].tentative++; break;
                        case 'dispatched': agentStats[agentId].dispatched++; break;
                        case 'delivered': agentStats[agentId].delivered++; break; // New
                        case 'backs': agentStats[agentId].backs++; break;       // New
                    }
                }
            }

            let dateRangeText;
            if (currentDateFilter === 'allTime') {
                dateRangeText = 'All Time';
            } else if (currentDateFilter === 'today') {
                dateRangeText = `Today (${new Date().toLocaleDateString()})`;
            } else if (currentDateFilter === 'thisWeek') {
                dateRangeText = `This Week (starting ${new Date(now.setDate(now.getDate() - (now.getDay() === 0 ? 6 : now.getDay() - 1))).toLocaleDateString()})`;
            } else if (currentDateFilter === 'thisMonth') {
                dateRangeText = `This Month (${now.toLocaleString('default', { month: 'long' })})`;
            } else if (currentDateFilter === 'custom' && customStartDate && customEndDate) {
                dateRangeText = `Custom: ${customStartDate.toLocaleDateString()} to ${customEndDate.toLocaleDateString()}`;
            } else {
                dateRangeText = 'Current Filters';
            }
            agentReportDateRange.textContent = dateRangeText;

            agentStatsContainer.innerHTML = '';
            const agentEntries = Object.values(agentStats);
            if (agentEntries.length === 0) {
                noAgentStatsMessage.classList.remove('hidden');
            } else {
                noAgentStatsMessage.classList.add('hidden');
                agentEntries.forEach(stats => {
                    const agentCard = document.createElement('div');
                    agentCard.className = 'bg-white rounded-xl shadow-md p-4 mb-4';
                    agentCard.innerHTML = `
                        <h4 class="text-lg font-bold text-blue-gray-700 mb-2">Agent: ${stats.agentName}</h4>
                        <hr class="my-2">
                        <div class="flex justify-between items-center py-1">
                            <span class="text-gray-800">Total Assigned</span>
                            <span class="font-bold text-blue-600">${stats.totalAssigned}</span>
                        </div>
                        <div class="flex justify-between items-center py-1">
                            <span class="text-gray-800">Confirmed</span>
                            <span class="font-bold text-green-600">${stats.confirmed}</span>
                        </div>
                        <div class="flex justify-between items-center py-1">
                            <span class="text-gray-800">Pending</span>
                            <span class="font-bold text-indigo-600">${stats.pending}</span>
                        </div>
                        <div class="flex justify-between items-center py-1">
                            <span class="text-gray-800">Tentative</span>
                            <span class="font-bold text-orange-600">${stats.tentative}</span>
                        </div>
                        <div class="flex justify-between items-center py-1">
                            <span class="text-gray-800">Dispatched</span>
                            <span class="font-bold text-blue-600">${stats.dispatched}</span>
                        </div>
                        <div class="flex justify-between items-center py-1">
                            <span class="text-gray-800">Delivered</span>
                            <span class="font-bold text-teal-600">${stats.delivered}</span>
                        </div>
                        <div class="flex justify-between items-center py-1">
                            <span class="text-gray-800">Returned (Backs)</span>
                            <span class="font-bold text-purple-600">${stats.backs}</span>
                        </div>
                    `;
                    agentStatsContainer.appendChild(agentCard);
                });
            }
            showModal(agentReportModal);
        }
        closeAgentReportModal.addEventListener('click', () => hideModal(agentReportModal));

        // --- Initial Load and Event Listeners ---
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize EmailJS with your Public Key
            emailjs.init('alok19p0pP9NFJsDL'); // <-- IMPORTANT: REPLACE WITH YOUR PUBLIC KEY

            // Directly check login status without splash screen
            checkLoginStatus();
            
            // Login Form Submission
            loginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                loginButton.disabled = true;
                loginButton.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Loading...';
                loginMessage.classList.add('hidden');

                const email = document.getElementById('email').value;
                const password = document.getElementById('password').value;

                try {
                    const response = await fetch('https://sheeka.onrender.com/auth/login', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email, password })
                    });

                    const data = await response.json();

                    if (response.ok) {
                        localStorage.setItem('token', data.token);
                        localStorage.setItem('role', data.user.role);
                        localStorage.setItem('id', data.user.id);
                        localStorage.setItem('index', data.user.index); // Store the index

                        if (data.user.index === 1) {
                            document.getElementById('supportMessage').textContent = 'Your system is off. Please contact support.';
                            showScreen('contactSupportPage');
                        } else {
                            showScreen('ordersScreen');
                            fetchAdmins(); // Fetch admins for assignment dropdown
                            fetchOrders(); // Fetch orders for the main screen
                            startPollingForNewOrders(); // Start polling
                        }
                    } else {
                        loginMessage.textContent = data.message || 'Login failed';
                        loginMessage.classList.remove('hidden');
                    }
                } catch (error) {
                    loginMessage.textContent = `Error connecting to the server: ${error.message}`;
                    loginMessage.classList.remove('hidden');
                } finally {
                    loginButton.disabled = false;
                    loginButton.innerHTML = 'Login';
                }
            });

            // Filter button event listeners
            document.querySelectorAll('.filter-button').forEach(button => {
                button.addEventListener('click', (e) => {
                    const filterType = e.target.dataset.filterType;
                    const filterValue = e.target.dataset.filterValue;

                    // Deactivate all buttons of the same type
                    document.querySelectorAll(`.filter-button[data-filter-type="${filterType}"]`).forEach(btn => {
                        btn.classList.remove('active', 'bg-black', 'text-white');
                        btn.classList.add('bg-gray-200', 'text-gray-800');
                    });

                    // Activate clicked button
                    e.target.classList.add('active');
                    if (filterType === 'status') {
                        e.target.classList.remove('bg-gray-200', 'text-gray-800');
                        e.target.classList.add('bg-black', 'text-white'); // Black for status buttons
                    } else {
                        e.target.classList.remove('bg-gray-200', 'text-gray-800');
                        e.target.classList.add('bg-black', 'text-white'); // Black for date buttons
                    }


                    if (filterType === 'status') {
                        currentFilter = filterValue;
                    } else {
                        currentDateFilter = filterValue;
                        if (filterValue !== 'custom') {
                            customStartDate = null;
                            customEndDate = null;
                            document.getElementById('clearCustomDateBtn').classList.add('hidden');
                            document.getElementById('customDateRangeBtn').textContent = 'Custom Range';
                        }
                    }
                    applyAllFilters();
                });
            });

            // Custom Date Range Picker
            document.getElementById('customDateRangeBtn').addEventListener('click', async () => {
                // For a real web app, you'd use a robust date picker library.
                // Here, we'll use simple prompt for demonstration.
                const startInput = prompt("Enter start date (YYYY-MM-DD):", customStartDate ? customStartDate.toISOString().split('T')[0] : '');
                if (startInput) {
                    const startDateObj = new Date(startInput + 'T00:00:00Z'); // Ensure UTC for consistent parsing
                    if (isNaN(startDateObj.getTime())) {
                        showMessage('Invalid start date format. Please use YYYY-MM-DD.', true);
                        return;
                    }

                    const endInput = prompt("Enter end date (YYYY-MM-DD):", customEndDate ? customEndDate.toISOString().split('T')[0] : '');
                    if (endInput) {
                        const endDateObj = new Date(endInput + 'T00:00:00Z'); // Ensure UTC
                        if (isNaN(endDateObj.getTime())) {
                            showMessage('Invalid end date format. Please use YYYY-MM-DD.', true);
                            return;
                        }

                        if (startDateObj.getTime() > endDateObj.getTime()) {
                            showMessage('Start date cannot be after end date.', true);
                            return;
                        }

                        customStartDate = startDateObj;
                        customEndDate = endDateObj;
                        currentDateFilter = 'custom';

                        // Update button text
                        document.getElementById('customDateRangeBtn').textContent = `Custom: ${customStartDate.toLocaleDateString()} to ${customEndDate.toLocaleDateString()}`;
                        document.getElementById('clearCustomDateBtn').classList.remove('hidden');

                        // Update active state for date filter buttons
                        document.querySelectorAll(`.filter-button[data-filter-type="date"]`).forEach(btn => {
                            btn.classList.remove('active', 'bg-black', 'text-white');
                            btn.classList.add('bg-gray-200', 'text-gray-800');
                        });
                        document.getElementById('customDateRangeBtn').classList.add('active', 'bg-black', 'text-white');

                        applyAllFilters();
                    }
                }
            });

            document.getElementById('clearCustomDateBtn').addEventListener('click', () => {
                customStartDate = null;
                customEndDate = null;
                currentDateFilter = 'allTime';
                document.getElementById('clearCustomDateBtn').classList.add('hidden');
                document.getElementById('customDateRangeBtn').textContent = 'Custom Range';

                // Reset active state to 'All Time'
                document.querySelectorAll(`.filter-button[data-filter-type="date"]`).forEach(btn => {
                    btn.classList.remove('active', 'bg-black', 'text-white');
                    btn.classList.add('bg-gray-200', 'text-gray-800');
                });
                document.querySelector('.filter-button[data-filter-type="date"][data-filter-value="allTime"]').classList.add('active', 'bg-black', 'text-white');

                applyAllFilters();
            });

            searchInput.addEventListener('input', applyAllFilters);

            // AppBar Button Event Listeners
            yalitecSettingsBtn.addEventListener('click', promptForYalitecCredentials);
            generatePdfBtn.addEventListener('click', () => showMessage('PDF generation is not supported in this web demo.', true)); // Placeholder
            viewReportBtn.addEventListener('click', generateAndShowReport);
            agentReportBtn.addEventListener('click', generateAgentStatsReport);
            importShopifyBtn.addEventListener('click', importFromShopify);

            // Initial loads
            loadCurrentUserRole();
            loadYalitecApiCredentials();
            loadShopifyApiCredentials();
            loadOrderNotes();
        });

        /**
         * Determines which screen to show based on login status or system index.
         * @param {string} screenId The ID of the screen to show ('loginPage', 'contactSupportPage', 'ordersScreen').
         * @param {string} message Optional message for login page.
         */
        function showScreen(screenId, message = '') {
            loginPage.classList.add('hidden');
            contactSupportPage.classList.add('hidden');
            ordersScreen.classList.add('hidden');

            if (screenId === 'loginPage') {
                loginPage.classList.remove('hidden');
                if (message) {
                    loginMessage.textContent = message;
                    loginMessage.classList.remove('hidden');
                } else {
                    loginMessage.classList.add('hidden');
                }
            } else if (screenId === 'contactSupportPage') {
                contactSupportPage.classList.remove('hidden');
                document.getElementById('supportMessage').textContent = message || 'Your system is off. Please contact support.';
            } else if (screenId === 'ordersScreen') {
                ordersScreen.classList.remove('hidden');
            }
        }

        /**
         * Checks login status from localStorage and navigates to the appropriate screen.
         */
        async function checkLoginStatus() {
            const token = localStorage.getItem('token');
            const userId = localStorage.getItem('id');
            const systemIndex = parseInt(localStorage.getItem('index') || '0'); // Default to 0 if not found

            if (token && userId) {
                // In a real app, you'd verify the token with your backend here.
                // For this demo, we'll assume it's valid if present.
                // Also, re-fetch the latest index from the server to be sure.
                try {
                    const response = await fetch(`https://sheeka.onrender.com/auth/ausers/${userId}/index`, {
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        }
                    });

                    let fetchedIndex = systemIndex; // Fallback to local storage
                    if (response.ok) {
                        const data = await response.json();
                        fetchedIndex = parseInt(data.index || '0');
                        localStorage.setItem('index', fetchedIndex); // Update local storage
                    } else {
                        console.warn(`Failed to fetch latest index from server: ${response.status}. Falling back to local storage.`);
                    }

                    if (fetchedIndex === 1) {
                        showScreen('contactSupportPage');
                    } else {
                        showScreen('ordersScreen');
                        fetchAdmins();
                        fetchOrders();
                        startPollingForNewOrders();
                    }
                } catch (e) {
                    console.error('Error during session validation:', e);
                    showScreen('loginPage', 'An error occurred during session validation. Please log in again.');
                }
            } else {
                showScreen('loginPage');
            }
        }
    </script>
</body>
</html>
