<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts - Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Chart.js CDN for charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Markdown-it for rendering AI response -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/markdown-it/12.3.2/markdown-it.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            height: 100vh;
            overflow-y: hidden;
        }
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        /* Remove default date picker icon and add custom one */
        input[type="date"]::-webkit-calendar-picker-indicator {
            display: none;
            -webkit-appearance: none;
        }
        input[type="date"] {
            -webkit-appearance: none;
            appearance: none;
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>') no-repeat right 10px center;
            background-size: 20px;
            padding-right: 40px; /* Space for the icon */
        }

        /* --- Modern Sidebar Styles --- */
        .sidebar {
            position: fixed;
            top: 0;
            left: 0;
            z-index: 40;
            width: 250px;
            flex-shrink: 0;
            background-color: #111827; /* Tailwind gray-900 */
            color: #d1d5db; /* Tailwind gray-300 */
            height: 100vh;
            display: flex;
            flex-direction: column;
            padding: 1rem 0;
            box-shadow: 2px 0 10px rgba(0,0,0,0.2);
            transition: transform 0.3s ease-in-out;
            transform: translateX(-100%);
        }

        @media (min-width: 768px) {
            .sidebar {
                transform: translateX(0);
            }
        }

        .sidebar.open {
            transform: translateX(0);
        }

        .sidebar-header {
            padding: 1rem 1.5rem;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
        }

        .sidebar-header .logo-icon {
            background-color: #4f46e5;
            color: white;
            padding: 0.5rem;
            border-radius: 0.5rem;
            margin-right: 0.75rem;
        }

        .sidebar-header h2 {
            font-size: 1.25rem;
            font-weight: 700;
            color: white;
        }

        .sidebar nav {
            flex-grow: 1;
            padding: 0 1rem;
            overflow-y: auto;
        }
        
        .sidebar-button {
            display: flex;
            align-items: center;
            width: 100%;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            background-color: transparent;
            color: #d1d5db;
            font-weight: 500;
            transition: background-color 0.2s ease, color 0.2s ease;
            position: relative;
        }

        .sidebar-button:hover {
            background-color: #1f2937;
            color: white;
        }

        .sidebar-button.active {
            background-color: #374151;
            color: white;
            font-weight: 600;
        }
        
        .sidebar-button.active::before {
            content: '';
            position: absolute;
            left: -1rem;
            top: 20%;
            height: 60%;
            width: 4px;
            background-color: #4f46e5;
            border-top-right-radius: 4px;
            border-bottom-right-radius: 4px;
        }
        
        .logout-button:hover {
            background-color: #991b1b;
            color: white;
        }

        .sidebar-footer {
            padding: 1rem;
            margin-top: auto;
            border-top: 1px solid #374151;
        }

        .dashboard-card {
            transition: transform 0.3s ease-in-out, box-shadow 0.3s ease-in-out;
            border: 1px solid #e5e7eb;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }
        .dashboard-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 15px 30px rgba(0,0,0,0.2);
        }

        .filter-button {
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out, background-color 0.2s ease-in-out;
        }
        .filter-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .filter-button.active {
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        /* Styles for AI analysis card content */
        #ai-analysis-content h3 {
            font-size: 1.125rem;
            font-weight: 600;
            color: #1f2937;
            margin-top: 0.75rem;
        }
        #ai-analysis-content ul {
            list-style-type: none;
            padding-left: 0;
        }
        #ai-analysis-content li {
            margin-bottom: 0.5rem;
            color: #4b5563;
        }
        #ai-analysis-content strong {
            color: #111827;
        }
    </style>
</head>
<body class="min-h-screen">
    <aside id="sidebar" class="sidebar">
        <div class="sidebar-header">
            <div class="logo-icon">
                <i class="fas fa-shield-alt"></i>
            </div>
            <h2 class="text-xl font-bold text-white">Admin</h2>
        </div>
        <nav class="flex-1 space-y-2">
            <button id="dashboard-nav-btn" class="sidebar-button active">
                <i class="fas fa-tachometer-alt fa-fw mr-3"></i>
                <span>Dashboard</span>
            </button>
            <button id="orders-button" class="sidebar-button">
                <i class="fas fa-clipboard-list fa-fw mr-3"></i>
                <span>Orders</span>
            </button>
            <button id="add-product-nav-btn" class="sidebar-button">
                <i class="fas fa-box-open fa-fw mr-3"></i>
                <span>Add Product</span>
            </button>
            <button id="all-products-nav-btn" class="sidebar-button">
                <i class="fas fa-boxes fa-fw mr-3"></i>
                <span>All Products</span>
            </button>
            <button id="admins-nav-btn" class="sidebar-button">
                <i class="fas fa-user-shield fa-fw mr-3"></i>
                <span>Admins</span>
            </button>
            <button id="stock-nav-btn" class="sidebar-button">
                <i class="fas fa-warehouse fa-fw mr-3"></i>
                <span>Stock</span>
            </button>
            <button id="pixels-nav-btn" class="sidebar-button">
                <i class="fas fa-image fa-fw mr-3"></i>
                <span>Pixels</span>
            </button>
            <button id="fees-delivery-nav-btn" class="sidebar-button">
                <i class="fas fa-dollar-sign fa-fw mr-3"></i>
                <span>Fees Delivery</span>
            </button>
            <button id="site-config-nav-btn" class="sidebar-button">
                <i class="fas fa-cog fa-fw mr-3"></i>
                <span>Site Config</span>
            </button>
            <button id="facture-nav-btn" class="sidebar-button">
                <i class="fas fa-file-invoice fa-fw mr-3"></i>
                <span>Facture</span>
            </button>
            <button id="charges-nav-btn" class="sidebar-button">
                <i class="fas fa-bolt fa-fw mr-3"></i>
                <span>Charges</span>
            </button>
        </nav>
        <div class="sidebar-footer space-y-2">
            <button id="language-toggle" class="sidebar-button">
                <i class="fas fa-language fa-fw mr-3"></i>
                <span id="language-text">English</span>
            </button>
            <button id="logout-button" class="sidebar-button logout-button">
                <i class="fas fa-sign-out-alt fa-fw mr-3"></i>
                <span id="logout-text">Logout</span>
            </button>
        </div>
    </aside>

    <div class="flex flex-col transition-all duration-300 ease-in-out md:ml-[250px] h-screen overflow-y-auto">
        <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-30 hidden md:hidden"></div>
        
        <header class="bg-white shadow-sm p-4 flex justify-between items-center rounded-b-lg sticky top-0 z-20">
            <button id="menu-toggle" class="md:hidden text-gray-600 hover:text-gray-800 focus:outline-none">
                <i class="fas fa-bars text-2xl"></i>
            </button>
            <div class="flex-grow"></div>
        </header>

        <main class="flex-1 flex flex-col p-4">
            <section class="bg-gray-50 p-6 rounded-xl shadow-md mb-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 id="filter-orders-title" class="text-2xl font-bold text-gray-800">Filter Orders</h2>
                    <i class="fas fa-filter text-3xl text-gray-700"></i>
                </div>
                <div class="flex flex-wrap gap-3">
                    <button id="filter-today" class="filter-button bg-gray-200 text-gray-800 px-5 py-3 rounded-lg shadow-sm hover:bg-gray-300 transition duration-300 flex items-center space-x-2">
                        <i class="fas fa-calendar-day"></i>
                        <span class="filter-label">Today</span>
                    </button>
                    <button id="filter-month" class="filter-button bg-indigo-600 text-white px-5 py-3 rounded-lg shadow-md hover:bg-indigo-700 transition duration-300 flex items-center space-x-2">
                        <i class="fas fa-calendar-alt"></i>
                        <span class="filter-label">This Month</span>
                    </button>
                    <button id="filter-custom" class="filter-button bg-gray-200 text-gray-800 px-5 py-3 rounded-lg shadow-sm hover:bg-gray-300 transition duration-300 flex items-center space-x-2">
                        <i class="fas fa-calendar-days"></i>
                        <span class="filter-label">Custom Range</span>
                    </button>
                    <button id="filter-all" class="filter-button bg-gray-200 text-gray-800 px-5 py-3 rounded-lg shadow-sm hover:bg-gray-300 transition duration-300 flex items-center space-x-2">
                        <i class="fas fa-globe"></i>
                        <span class="filter-label">All Orders</span>
                    </button>
                </div>
                <div id="custom-date-range" class="mt-4 hidden flex-col sm:flex-row gap-4 items-center">
                    <div class="flex items-center space-x-2 w-full sm:w-auto">
                        <label for="start-date" class="text-gray-700 font-medium">From:</label>
                        <input type="date" id="start-date" class="p-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500 w-full sm:w-auto">
                    </div>
                    <div class="flex items-center space-x-2 w-full sm:w-auto">
                        <label for="end-date" class="text-gray-700 font-medium">To:</label>
                        <input type="date" id="end-date" class="p-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500 w-full sm:w-auto">
                    </div>
                    <p id="selected-date-range" class="text-sm text-gray-700 mt-2 sm:mt-0"></p>
                </div>
            </section>

            <hr class="border-gray-300 mb-6">

            <section id="dashboard-grid" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6 flex-1">
                <div id="order-summary-card" class="dashboard-card bg-white p-6 rounded-xl shadow-lg flex flex-col">
                    <div class="flex items-center mb-4">
                        <i class="fas fa-list-alt text-3xl text-gray-800"></i>
                        <h3 class="text-2xl font-bold text-gray-800 ml-3">Order Summary</h3>
                    </div>
                    <div id="order-summary-content" class="flex-1 flex items-center justify-center"></div>
                </div>

                <div id="order-distribution-card" class="dashboard-card bg-white p-6 rounded-xl shadow-lg flex flex-col">
                    <div class="flex items-center mb-4">
                        <i class="fas fa-chart-pie text-3xl text-gray-800"></i>
                        <h3 class="text-2xl font-bold text-gray-800 ml-3">Order Distribution</h3>
                    </div>
                    <div id="order-distribution-content" class="flex-1 flex items-center justify-center">
                        <canvas id="orderPieChart"></canvas>
                    </div>
                </div>

                <div id="real-stock-info-card" class="dashboard-card bg-white p-6 rounded-xl shadow-lg flex flex-col">
                    <div class="flex items-center mb-4">
                        <i class="fas fa-boxes-stacked text-3xl text-gray-800"></i>
                        <h3 class="text-2xl font-bold text-gray-800 ml-3">Real Stock Info</h3>
                    </div>
                    <div class="mb-4">
                        <input type="text" id="real-stock-search" placeholder="Search stock..." class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 bg-gray-50 text-gray-800">
                    </div>
                    <hr class="border-gray-300 mb-4">
                    <div id="real-stock-info-content" class="flex-1 overflow-y-auto"></div>
                </div>
                
                <div id="ai-analysis-card" class="dashboard-card bg-white p-6 rounded-xl shadow-lg flex flex-col md:col-span-2 xl:col-span-3">
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center">
                            <i class="fas fa-robot text-3xl text-indigo-600"></i>
                            <h3 id="ai-analysis-title" class="text-2xl font-bold text-gray-800 ml-3">AI Performance Analysis</h3>
                        </div>
                        <button id="regenerate-ai-analysis" class="bg-indigo-100 text-indigo-700 px-3 py-1 rounded-lg text-sm font-semibold hover:bg-indigo-200 transition-colors">
                            <i class="fas fa-sync-alt mr-2"></i>
                            <span id="regenerate-text">Regenerate</span>
                        </button>
                    </div>
                    <div id="ai-analysis-content" class="flex-1 space-y-4"></div>
                </div>

                <!-- Daily Orders Bar Chart - MOVED -->
                <div id="daily-orders-card" class="dashboard-card bg-white p-6 rounded-xl shadow-lg flex flex-col md:col-span-2 xl:col-span-3">
                    <div class="flex items-center mb-4">
                        <i class="fas fa-chart-bar text-3xl text-gray-800"></i>
                        <h3 id="daily-orders-title" class="text-2xl font-bold text-gray-800 ml-3">Daily Orders</h3>
                    </div>
                    <div id="daily-orders-content" class="flex-1 flex items-center justify-center">
                        <canvas id="dailyOrdersBarChart"></canvas>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <script>
        const appState = {
            products: [],
            realStockInfos: [],
            totalOrders: 0,
            pendingOrders: 0,
            confirmedOrders: 0,
            tentativeOrders: 0,
            cancelledOrders: 0,
            dailyOrderCounts: [], // NEW: For bar chart
            isOrdersLoading: true,
            isStockLoading: true,
            orderErrorMessage: null,
            stockErrorMessage: null,
            selectedFilter: 'month',
            customStartDate: null,
            customEndDate: null,
            isEnglish: true,
            stockFilter: '',
            realStockFilter: '',
            orderPieChartInstance: null,
            dailyOrdersBarChartInstance: null, // NEW: Bar chart instance
            activeSidebarButton: 'dashboard-nav-btn',
            isAIAnalysisLoading: true,
            aiAnalysisResult: null,
            aiAnalysisError: null,
        };

        const translations = {
            'en': {
                'adminPanelTitle': 'Admin Panel', 'filterOrders': 'Filter Orders', 'today': 'Today', 'thisMonth': 'This Month', 'customRange': 'Custom Range', 'allOrders': 'All Orders', 'ordersButton': 'Orders', 'dashboardButton': 'Dashboard', 'addProductButton': 'Add Product', 'allProductsButton': 'All Products', 'adminsButton': 'Admins', 'stockButton': 'Stock', 'pixelsButton': 'Pixels', 'feesDeliveryButton': 'Fees Delivery', 'siteConfigButton': 'Site Config', 'factureButton': 'Invoice', 'charges': 'Charges', 'logoutButton': 'Logout', 'selected': 'Selected', 'orderSummary': 'Order Summary', 'totalOrders': 'Total Orders', 'pending': 'Pending', 'confirmed': 'Confirmed', 'tentative': 'Tentative', 'cancelled': 'Cancelled', 'orderDistribution': 'Order Distribution', 'realStockInfo': 'Real Stock Info', 'searchHint': 'Search...', 'searchStockHint': 'Search stock...', 'noDataChart': 'No data available to show the chart.', 'failedToLoadOrders': 'Failed to load orders:', 'failedToLoadStock': 'Failed to load stock:', 'errorFetchingOrders': 'Error fetching orders:', 'errorFetchingStock': 'Error fetching stock:', 'retry': 'Retry', 'role': 'Role', 'unknown': 'Unknown', 'language': 'English', 'From': 'From', 'To': 'To', 'noStockFound': 'No stock items found matching your search.', 'loadingStock': 'Loading stock info...',
                'aiPerformanceAnalysis': 'AI Performance Analysis', 'regenerate': 'Regenerate', 'loadingAnalysis': 'Generating AI analysis...', 'errorAnalysis': 'Could not generate AI analysis.',
                'dailyOrders': 'Daily Orders', 'weekdays': ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'],
            },
            'ar': {
                'adminPanelTitle': 'لوحة التحكم', 'filterOrders': 'تصفية الطلبات', 'today': 'اليوم', 'thisMonth': 'هذا الشهر', 'customRange': 'نطاق مخصص', 'allOrders': 'جميع الطلبات', 'ordersButton': 'الطلبات', 'dashboardButton': 'لوحة القيادة', 'addProductButton': 'إضافة منتج', 'allProductsButton': 'جميع المنتجات', 'adminsButton': 'المسؤولون', 'stockButton': 'المخزون', 'pixelsButton': 'البكسلات', 'feesDeliveryButton': 'رسوم التوصيل', 'siteConfigButton': 'إعدادات الموقع', 'factureButton': 'فاتورة', 'charges': 'الرسوم', 'logoutButton': 'تسجيل الخروج', 'selected': 'المحدد', 'orderSummary': 'ملخص الطلبات', 'totalOrders': 'إجمالي الطلبات', 'pending': 'معلقة', 'confirmed': 'مؤكدة', 'tentative': 'مؤقتة', 'cancelled': 'ملغاة', 'orderDistribution': 'توزيع الطلبات', 'realStockInfo': 'معلومات المخزون الحقيقي', 'searchHint': 'بحث...', 'searchStockHint': 'بحث في المخزون...', 'noDataChart': 'لا توجد بيانات لعرض الرسم البياني.', 'failedToLoadOrders': 'فشل تحميل الطلبات:', 'failedToLoadStock': 'فشل تحميل المخزون:', 'errorFetchingOrders': 'خطأ في جلب الطلبات:', 'errorFetchingStock': 'خطأ في جلب المخزون:', 'retry': 'إعادة المحاولة', 'role': 'الدور', 'unknown': 'غير معروف', 'language': 'العربية', 'From': 'من', 'To': 'إلى', 'noStockFound': 'لم يتم العثور على عناصر مخزون مطابقة لبحثك.', 'loadingStock': 'جاري تحميل معلومات المخزون...',
                'aiPerformanceAnalysis': 'تحليل الأداء بالذكاء الاصطناعي', 'regenerate': 'إعادة إنشاء', 'loadingAnalysis': 'جاري إنشاء تحليل الذكاء الاصطناعي...', 'errorAnalysis': 'تعذر إنشاء تحليل الذكاء الاصطناعي.',
                'dailyOrders': 'الطلبات اليومية', 'weekdays': ['الأحد', 'الإثنين', 'الثلاثاء', 'الأربعاء', 'الخميس', 'الجمعة', 'السبت'],
            },
        };

        function getTranslatedString(key) {
            return translations[appState.isEnglish ? 'en' : 'ar'][key] || key;
        }

        async function fetchAllDataAndAnalyze() {
            appState.isOrdersLoading = true;
            appState.isStockLoading = true;
            appState.isAIAnalysisLoading = true;
            renderAllCards();

            await Promise.all([fetchOrders(), fetchRealStockData()]);

            if (!appState.orderErrorMessage && !appState.stockErrorMessage) {
                await fetchAIAnalysis();
            } else {
                appState.isAIAnalysisLoading = false;
                appState.aiAnalysisError = getTranslatedString('errorAnalysis');
                renderAIAnalysisCard();
            }
        }

        async function fetchOrders() {
            appState.isOrdersLoading = true;
            appState.orderErrorMessage = null;
            try {
                const response = await fetch('https://sheeka.onrender.com/orders');
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const fetchedOrders = await response.json();
                processOrderData(fetchedOrders);
                processDailyOrderData(fetchedOrders); // NEW: Process data for bar chart
            } catch (e) {
                appState.orderErrorMessage = `${getTranslatedString('errorFetchingOrders')} ${e.message}`;
                console.error('Error fetching orders:', e);
            } finally {
                appState.isOrdersLoading = false;
                renderOrderSummaryCard();
                renderOrderPieChartCard();
                renderDailyOrdersBarChartCard(); // NEW: Render bar chart
            }
        }

        async function fetchRealStockData() {
            appState.isStockLoading = true;
            appState.stockErrorMessage = null;
            try {
                const response = await fetch('https://sheeka.onrender.com/products'); 
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const fetchedProducts = await response.json();
                appState.realStockInfos = fetchedProducts.map(p => ({
                    name: p.name,
                    quantity: p.quantity,
                    lastUpdated: p.updatedAt ? new Date(p.updatedAt).toLocaleDateString() : 'N/A'
                }));
            } catch (e) {
                appState.stockErrorMessage = `${getTranslatedString('errorFetchingStock')} ${e.message}`;
                console.error('Error fetching real stock info:', e);
            } finally {
                appState.isStockLoading = false;
                renderRealStockInfoCard();
            }
        }

        async function fetchAIAnalysis() {
            appState.isAIAnalysisLoading = true;
            appState.aiAnalysisError = null;
            appState.aiAnalysisResult = null;
            renderAIAnalysisCard();

            const stockSummary = appState.realStockInfos
                .sort((a, b) => b.quantity - a.quantity)
                .slice(0, 5)
                .map(p => `- ${p.name} (Quantity: ${p.quantity})`)
                .join('\n');
            
            let filterPeriod;
            if (appState.selectedFilter === 'custom' && appState.customStartDate && appState.customEndDate) {
                const start = appState.customStartDate.toLocaleDateString();
                const end = appState.customEndDate.toLocaleDateString();
                filterPeriod = `Custom Range from ${start} to ${end}`;
            } else {
                filterPeriod = getTranslatedString(appState.selectedFilter);
            }

            const prompt = `
                You are a professional e-commerce business analyst. Analyze the following sales and stock data for an online store and provide actionable advice to improve sales.
                The analysis is for the period: ${filterPeriod}.
                Current Language for response: ${appState.isEnglish ? 'English' : 'Arabic'}.

                Data Summary:
                - Total Orders: ${appState.totalOrders}
                - Confirmed Orders: ${appState.confirmedOrders}
                - Pending Orders: ${appState.pendingOrders}
                - Cancelled Orders: ${appState.cancelledOrders}
                - Top 5 products with the most stock:\n${stockSummary || 'N/A'}

                Based on this data, provide a concise analysis with 3 key actionable recommendations.
                Structure your response in Markdown EXACTLY as follows:

                ### Key Observation
                A brief, one-sentence observation about the overall situation.

                ### Actionable Recommendations
                - **Recommendation Title 1:** A short, actionable recommendation text.
                - **Recommendation Title 2:** A short, actionable recommendation text.
                - **Recommendation Title 3:** A short, actionable recommendation text.

                Keep the language clear, direct, and professional. Do not add any extra comments.
            `;
            
            try {
                const chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
                const payload = { contents: chatHistory };
                const apiKey = ""; 
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorBody = await response.text();
                    throw new Error(`API error! status: ${response.status}, body: ${errorBody}`);
                }

                const result = await response.json();
                
                if (result.candidates && result.candidates.length > 0 && result.candidates[0].content) {
                    const text = result.candidates[0].content.parts[0].text;
                    appState.aiAnalysisResult = text;
                } else {
                    throw new Error("No content received from AI. Response might be blocked.");
                }

            } catch (e) {
                console.error("Error fetching AI analysis:", e);
                appState.aiAnalysisError = `${getTranslatedString('errorAnalysis')}`;
            } finally {
                appState.isAIAnalysisLoading = false;
                renderAIAnalysisCard();
            }
        }

        function processOrderData(ordersList) {
            let pending = 0, confirmed = 0, tentative = 0, cancelled = 0;
            const nowUtc = new Date();
            const todayUtcStart = new Date(Date.UTC(nowUtc.getUTCFullYear(), nowUtc.getUTCMonth(), nowUtc.getUTCDate()));
            const thisMonthUtcStart = new Date(Date.UTC(nowUtc.getUTCFullYear(), nowUtc.getUTCMonth(), 1));

            const filteredOrders = ordersList.filter(order => {
                let createdAt;
                try {
                    createdAt = new Date(order['createdAt']?.toString());
                    if (isNaN(createdAt.getTime())) throw new Error('Invalid date');
                } catch {
                    return false;
                }

                switch (appState.selectedFilter) {
                    case 'today':
                        return createdAt >= todayUtcStart;
                    case 'month':
                        return createdAt >= thisMonthUtcStart;
                    case 'custom':
                        if (appState.customStartDate && appState.customEndDate) {
                            const start = appState.customStartDate;
                            const end = new Date(Date.UTC(appState.customEndDate.getUTCFullYear(), appState.customEndDate.getUTCMonth(), appState.customEndDate.getUTCDate(), 23, 59, 59, 999));
                            return createdAt >= start && createdAt <= end;
                        }
                        return false;
                    case 'all':
                        return true;
                    default:
                        return false;
                }
            });

            filteredOrders.forEach(order => {
                const status = (order['status'] || 'unknown').toLowerCase();
                if (status === 'pending') pending++;
                else if (status === 'confirmed') confirmed++;
                else if (status === 'tentative') tentative++;
                else if (status === 'cancelled') cancelled++;
            });

            appState.totalOrders = filteredOrders.length;
            appState.pendingOrders = pending;
            appState.confirmedOrders = confirmed;
            appState.tentativeOrders = tentative;
            appState.cancelledOrders = cancelled;
        }

        // NEW: Function to process data for the daily orders bar chart
        function processDailyOrderData(ordersList) {
            const dailyCounts = Array(7).fill(0); // 0 for Sun, 1 for Mon, etc.
            const today = new Date();
            const sevenDaysAgo = new Date(today);
            sevenDaysAgo.setDate(today.getDate() - 6);
            sevenDaysAgo.setHours(0, 0, 0, 0);

            ordersList.forEach(order => {
                let createdAt;
                try {
                    createdAt = new Date(order['createdAt']?.toString());
                    if (isNaN(createdAt.getTime())) return;
                } catch {
                    return;
                }

                if (createdAt >= sevenDaysAgo) {
                    const dayIndex = createdAt.getDay();
                    dailyCounts[dayIndex]++;
                }
            });
            appState.dailyOrderCounts = dailyCounts;
        }

        function renderAllCards() {
            renderOrderSummaryCard();
            renderOrderPieChartCard();
            renderDailyOrdersBarChartCard();
            renderRealStockInfoCard();
            renderAIAnalysisCard();
        }

        function renderApp() {
            document.documentElement.lang = appState.isEnglish ? 'en' : 'ar';
            document.documentElement.dir = appState.isEnglish ? 'ltr' : 'rtl';

            document.getElementById('language-text').textContent = getTranslatedString('language');
            document.getElementById('logout-text').textContent = getTranslatedString('logoutButton');
            document.getElementById('filter-orders-title').textContent = getTranslatedString('filterOrders');
            document.getElementById('orders-button').querySelector('span').textContent = getTranslatedString('ordersButton');
            document.getElementById('dashboard-nav-btn').querySelector('span').textContent = getTranslatedString('dashboardButton');
            document.getElementById('add-product-nav-btn').querySelector('span').textContent = getTranslatedString('addProductButton');
            document.getElementById('all-products-nav-btn').querySelector('span').textContent = getTranslatedString('allProductsButton');
            document.getElementById('admins-nav-btn').querySelector('span').textContent = getTranslatedString('adminsButton');
            document.getElementById('stock-nav-btn').querySelector('span').textContent = getTranslatedString('stockButton');
            document.getElementById('pixels-nav-btn').querySelector('span').textContent = getTranslatedString('pixelsButton');
            document.getElementById('fees-delivery-nav-btn').querySelector('span').textContent = getTranslatedString('feesDeliveryButton');
            document.getElementById('site-config-nav-btn').querySelector('span').textContent = getTranslatedString('siteConfigButton');
            document.getElementById('facture-nav-btn').querySelector('span').textContent = getTranslatedString('factureButton');
            document.getElementById('charges-nav-btn').querySelector('span').textContent = getTranslatedString('charges');
            document.querySelector('#filter-today .filter-label').textContent = getTranslatedString('today');
            document.querySelector('#filter-month .filter-label').textContent = getTranslatedString('thisMonth');
            document.querySelector('#filter-custom .filter-label').textContent = getTranslatedString('customRange');
            document.querySelector('#filter-all .filter-label').textContent = getTranslatedString('allOrders');
            document.querySelector('#custom-date-range label[for="start-date"]').textContent = getTranslatedString('From') + ':';
            document.querySelector('#custom-date-range label[for="end-date"]').textContent = getTranslatedString('To') + ':';
            document.querySelector('#order-summary-card h3').textContent = getTranslatedString('orderSummary');
            document.querySelector('#order-distribution-card h3').textContent = getTranslatedString('orderDistribution');
            document.querySelector('#real-stock-info-card h3').textContent = getTranslatedString('realStockInfo');
            document.querySelector('#daily-orders-card h3').textContent = getTranslatedString('dailyOrders');
            document.querySelector('#ai-analysis-card h3').textContent = getTranslatedString('aiPerformanceAnalysis');
            document.getElementById('real-stock-search').placeholder = getTranslatedString('searchStockHint');
            document.querySelector('#regenerate-ai-analysis #regenerate-text').textContent = getTranslatedString('regenerate');

            updateSidebarActiveState(appState.activeSidebarButton);
            updateFilterButtons();
            renderAllCards();
            updateCustomDateRangeDisplay();
        }

        function updateFilterButtons() {
            document.querySelectorAll('.filter-button').forEach(button => {
                const filterId = button.id.replace('filter-', '');
                button.classList.toggle('bg-indigo-600', filterId === appState.selectedFilter);
                button.classList.toggle('text-white', filterId === appState.selectedFilter);
                button.classList.toggle('bg-gray-200', filterId !== appState.selectedFilter);
                button.classList.toggle('text-gray-800', filterId !== appState.selectedFilter);
            });
            document.getElementById('custom-date-range').classList.toggle('hidden', appState.selectedFilter !== 'custom');
        }

        function renderOrderSummaryCard() {
            const contentDiv = document.getElementById('order-summary-content');
            if (appState.isOrdersLoading) {
                contentDiv.innerHTML = `<div class="flex flex-col items-center justify-center"><div class="animate-spin rounded-full h-12 w-12 border-4 border-indigo-500 border-t-transparent"></div><p class="mt-4 text-gray-600">Loading orders...</p></div>`;
            } else if (appState.orderErrorMessage) {
                contentDiv.innerHTML = `<div class="flex flex-col items-center justify-center text-red-500 p-4 text-center"><i class="fas fa-exclamation-triangle text-4xl mb-2"></i><p class="text-lg">${appState.orderErrorMessage}</p><button id="retry-orders-summary" class="mt-4 bg-blue-500 text-white px-4 py-2 rounded-lg shadow hover:bg-blue-600 transition duration-300"><i class="fas fa-sync-alt mr-2"></i>${getTranslatedString('retry')}</button></div>`;
                document.getElementById('retry-orders-summary').onclick = fetchAllDataAndAnalyze;
            } else {
                contentDiv.innerHTML = `<div class="w-full">${buildStatusRow(getTranslatedString('totalOrders'), appState.totalOrders, 'teal-700', true)}<hr class="my-4 border-gray-200">${buildStatusRow(getTranslatedString('pending'), appState.pendingOrders, 'indigo-600', false)}<hr class="my-4 border-gray-200">${buildStatusRow(getTranslatedString('confirmed'), appState.confirmedOrders, 'green-600', false)}<hr class="my-4 border-gray-200">${buildStatusRow(getTranslatedString('tentative'), appState.tentativeOrders, 'orange-600', false)}<hr class="my-4 border-gray-200">${buildStatusRow(getTranslatedString('cancelled'), appState.cancelledOrders, 'red-600', false)}</div>`;
            }
        }

        function buildStatusRow(label, count, colorClass, isTotal) {
            return `<div class="flex items-center py-2"><div class="w-4 h-4 rounded-md bg-${colorClass}"></div><span class="ml-3 flex-1 ${isTotal ? 'text-lg font-semibold' : 'text-base font-medium'} text-gray-800">${label}</span><span class="${isTotal ? 'text-lg' : 'text-base'} font-bold text-${colorClass}">${count}</span></div>`;
        }

        const statusColors = { 'Pending': 'rgb(67, 56, 202)', 'Confirmed': 'rgb(22, 163, 74)', 'Tentative': 'rgb(234, 88, 12)', 'Cancelled': 'rgb(220, 38, 38)', 'Unknown': 'rgb(156, 163, 175)' };

        function renderOrderPieChartCard() {
            const contentDiv = document.getElementById('order-distribution-content');
            if (appState.orderPieChartInstance) {
                appState.orderPieChartInstance.destroy();
                appState.orderPieChartInstance = null;
            }
            if (appState.isOrdersLoading) {
                contentDiv.innerHTML = `<div class="flex flex-col items-center justify-center"><div class="animate-spin rounded-full h-12 w-12 border-4 border-indigo-500 border-t-transparent"></div><p class="mt-4 text-gray-600">Loading chart data...</p></div>`;
                return;
            }
            if (appState.orderErrorMessage) {
                contentDiv.innerHTML = `<div class="flex flex-col items-center justify-center text-red-500 p-4 text-center"><i class="fas fa-exclamation-triangle text-4xl mb-2"></i><p class="text-lg">${appState.orderErrorMessage}</p></div>`;
                return;
            }

            const dataMap = {};
            if (appState.pendingOrders > 0) dataMap[getTranslatedString('pending')] = appState.pendingOrders;
            if (appState.confirmedOrders > 0) dataMap[getTranslatedString('confirmed')] = appState.confirmedOrders;
            if (appState.tentativeOrders > 0) dataMap[getTranslatedString('tentative')] = appState.tentativeOrders;
            if (appState.cancelledOrders > 0) dataMap[getTranslatedString('cancelled')] = appState.cancelledOrders;

            if (appState.totalOrders === 0 || Object.keys(dataMap).length === 0) {
                contentDiv.innerHTML = `<div class="bg-gray-100 p-8 rounded-xl shadow-inner text-center"><i class="fas fa-info-circle text-4xl text-gray-500 mb-3"></i><p class="text-lg text-gray-700">${getTranslatedString('noDataChart')}</p></div>`;
                return;
            }

            let canvas = document.getElementById('orderPieChart');
            if (!canvas || !document.body.contains(canvas)) {
                contentDiv.innerHTML = '<canvas id="orderPieChart"></canvas>';
                canvas = document.getElementById('orderPieChart');
            }
            const ctx = canvas.getContext('2d');
            const labels = Object.keys(dataMap);
            const data = Object.values(dataMap);
            const colors = labels.map(label => {
                const originalKey = Object.keys(translations.en).find(key => getTranslatedString(key) === label);
                const capitalizedKey = originalKey ? originalKey.charAt(0).toUpperCase() + originalKey.slice(1) : 'Unknown';
                return statusColors[capitalizedKey] || statusColors.Unknown;
            });

            appState.orderPieChartInstance = new Chart(ctx, {
                type: 'doughnut', data: { labels, datasets: [{ data, backgroundColor: colors, borderColor: '#ffffff', borderWidth: 2 }] },
                options: { responsive: true, maintainAspectRatio: false, cutout: '70%', plugins: { legend: { position: 'bottom', labels: { font: { size: 14, weight: '500' }, color: '#333', usePointStyle: true, } }, title: { display: true, text: `${getTranslatedString('totalOrders')}: ${appState.totalOrders}`, font: { size: 18, weight: 'bold' }, color: '#1a202c' }, tooltip: { callbacks: { label: c => `${c.label}: ${c.parsed} (${(c.parsed/c.dataset.data.reduce((s,v)=>s+v, 0)*100).toFixed(1)}%)` } } } }
            });
        }

        // NEW: Function to render the daily orders bar chart
        function renderDailyOrdersBarChartCard() {
            const contentDiv = document.getElementById('daily-orders-content');
            if (appState.dailyOrdersBarChartInstance) {
                appState.dailyOrdersBarChartInstance.destroy();
                appState.dailyOrdersBarChartInstance = null;
            }

            if (appState.isOrdersLoading) {
                contentDiv.innerHTML = `<div class="flex flex-col items-center justify-center"><div class="animate-spin rounded-full h-12 w-12 border-4 border-indigo-500 border-t-transparent"></div><p class="mt-4 text-gray-600">Loading daily data...</p></div>`;
                return;
            }
             if (appState.orderErrorMessage) {
                contentDiv.innerHTML = `<div class="flex flex-col items-center justify-center text-red-500 p-4 text-center"><i class="fas fa-exclamation-triangle text-4xl mb-2"></i><p class="text-lg">Data unavailable</p></div>`;
                return;
            }

            let canvas = document.getElementById('dailyOrdersBarChart');
             if (!canvas || !document.body.contains(canvas)) {
                contentDiv.innerHTML = '<canvas id="dailyOrdersBarChart"></canvas>';
                canvas = document.getElementById('dailyOrdersBarChart');
            }
            const ctx = canvas.getContext('2d');
            
            const weekdays = getTranslatedString('weekdays');
            const todayIndex = new Date().getDay();
            const labels = [...weekdays.slice(todayIndex + 1), ...weekdays.slice(0, todayIndex + 1)];
            const data = [...appState.dailyOrderCounts.slice(todayIndex + 1), ...appState.dailyOrderCounts.slice(0, todayIndex + 1)];

            appState.dailyOrdersBarChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: getTranslatedString('totalOrders'),
                        data: data,
                        backgroundColor: 'rgba(79, 70, 229, 0.8)',
                        borderColor: 'rgba(67, 56, 202, 1)',
                        borderWidth: 1,
                        borderRadius: 4,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        title: {
                            display: true,
                            text: 'Last 7 Days',
                            font: { size: 16, weight: '600'},
                            color: '#374151'
                        }
                    }
                }
            });
        }

        function renderRealStockInfoCard() {
            const contentDiv = document.getElementById('real-stock-info-content');
            if (appState.isStockLoading) {
                contentDiv.innerHTML = `<div class="flex flex-col items-center justify-center h-full text-gray-600"><div class="animate-spin rounded-full h-12 w-12 border-4 border-indigo-500 border-t-transparent"></div><p class="mt-4">${getTranslatedString('loadingStock')}</p></div>`;
                return;
            }
            if (appState.stockErrorMessage) {
                contentDiv.innerHTML = `<div class="text-center text-red-500 p-4"><i class="fas fa-exclamation-circle text-4xl mb-2"></i><p>${getTranslatedString('failedToLoadStock')} ${appState.stockErrorMessage}</p><button id="retry-stock" class="mt-4 bg-blue-500 text-white px-4 py-2 rounded-lg shadow hover:bg-blue-600 transition duration-300"><i class="fas fa-sync-alt mr-2"></i>${getTranslatedString('retry')}</button></div>`;
                document.getElementById('retry-stock').onclick = fetchAllDataAndAnalyze;
                return;
            }
            const filteredStock = appState.realStockInfos.filter(item => item.name?.toLowerCase().includes(appState.realStockFilter.toLowerCase()));
            if (filteredStock.length === 0) {
                contentDiv.innerHTML = `<div class="flex flex-col items-center justify-center h-full text-gray-600"><i class="fas fa-info-circle text-4xl mb-3"></i><p>${getTranslatedString('noStockFound')}</p></div>`;
                return;
            }
            contentDiv.innerHTML = `<div class="w-full text-left">${filteredStock.map(item => `<div class="bg-white p-3 rounded-lg shadow-sm mb-3 flex items-center justify-between"><div><h4 class="font-semibold text-gray-900">${item.name}</h4><p class="text-sm text-gray-600">Quantity: ${item.quantity}</p><p class="text-xs text-gray-500">Last Updated: ${item.lastUpdated}</p></div><i class="fas fa-cubes text-blue-500 text-2xl"></i></div>`).join('')}</div>`;
        }

        function renderAIAnalysisCard() {
            const contentDiv = document.getElementById('ai-analysis-content');
            const md = window.markdownit();
            if (appState.isAIAnalysisLoading) {
                contentDiv.innerHTML = `<div class="flex flex-col items-center justify-center h-full"><div class="animate-spin rounded-full h-10 w-10 border-4 border-indigo-500 border-t-transparent"></div><p class="mt-3 text-gray-600">${getTranslatedString('loadingAnalysis')}</p></div>`;
            } else if (appState.aiAnalysisError) {
                contentDiv.innerHTML = `<div class="text-center text-red-500 p-4"><i class="fas fa-exclamation-circle text-3xl mb-2"></i><p>${appState.aiAnalysisError}</p></div>`;
            } else if (appState.aiAnalysisResult) {
                contentDiv.innerHTML = md.render(appState.aiAnalysisResult);
            } else {
                contentDiv.innerHTML = `<div class="text-center text-gray-500 p-4"><i class="fas fa-info-circle text-3xl mb-2"></i><p>No analysis available. Click Regenerate.</p></div>`;
            }
        }

        function updateCustomDateRangeDisplay() {
            const selectedDateRangeText = document.getElementById('selected-date-range');
            if (appState.selectedFilter === 'custom' && appState.customStartDate && appState.customEndDate) {
                const options = { month: 'short', day: 'numeric', year: 'numeric' };
                const startDateFormatted = new Intl.DateTimeFormat(appState.isEnglish ? 'en-US' : 'ar-EG', options).format(appState.customStartDate);
                const endDateFormatted = new Intl.DateTimeFormat(appState.isEnglish ? 'en-US' : 'ar-EG', options).format(appState.customEndDate);
                selectedDateRangeText.textContent = `${getTranslatedString('selected')}: ${startDateFormatted} - ${endDateFormatted}`;
                selectedDateRangeText.classList.remove('hidden');
            } else {
                selectedDateRangeText.classList.add('hidden');
            }
        }

        function updateSidebarActiveState(activeButtonId) {
            document.querySelectorAll('.sidebar-button').forEach(button => {
                button.classList.remove('active');
            });
            const activeButton = document.getElementById(activeButtonId);
            if (activeButton) {
                activeButton.classList.add('active');
                appState.activeSidebarButton = activeButtonId;
            }
        }

        // --- Event Listeners ---
        document.addEventListener('DOMContentLoaded', () => {
            renderApp();
            fetchAllDataAndAnalyze();

            const menuToggle = document.getElementById('menu-toggle');
            const sidebar = document.getElementById('sidebar');
            const sidebarOverlay = document.getElementById('sidebar-overlay');

            menuToggle.addEventListener('click', () => {
                sidebar.classList.toggle('open');
                sidebarOverlay.classList.toggle('hidden');
            });
            sidebarOverlay.addEventListener('click', () => {
                sidebar.classList.remove('open');
                sidebarOverlay.classList.add('hidden');
            });

            document.getElementById('language-toggle').addEventListener('click', () => {
                appState.isEnglish = !appState.isEnglish;
                renderApp();
                fetchAllDataAndAnalyze();
            });
            
            document.getElementById('logout-button').addEventListener('click', () => {
                localStorage.clear();
                sessionStorage.clear();
                window.location.href = 'index.html';
            });
            
            document.getElementById('orders-button').addEventListener('click', () => { window.location.href = 'orders-management-web.html'; });
            document.getElementById('dashboard-nav-btn').addEventListener('click', () => { updateSidebarActiveState('dashboard-nav-btn'); });
            document.getElementById('add-product-nav-btn').addEventListener('click', () => { window.location.href = 'addproduct.html'; });
            document.getElementById('all-products-nav-btn').addEventListener('click', () => { window.location.href = 'products.html'; });
            document.getElementById('admins-nav-btn').addEventListener('click', () => { window.location.href = 'admins.html'; });
            document.getElementById('stock-nav-btn').addEventListener('click', () => { window.location.href = 'stock.html'; });
            document.getElementById('pixels-nav-btn').addEventListener('click', () => { window.location.href = 'pixels.html'; });
            document.getElementById('fees-delivery-nav-btn').addEventListener('click', () => { window.location.href = 'fees.html'; });
            document.getElementById('site-config-nav-btn').addEventListener('click', () => { window.location.href = 'siteconfig.html'; });
            document.getElementById('facture-nav-btn').addEventListener('click', () => { window.location.href = 'facture.html'; });
            document.getElementById('charges-nav-btn').addEventListener('click', () => { window.location.href = 'charges.html'; });


            document.getElementById('regenerate-ai-analysis').addEventListener('click', fetchAIAnalysis);

            document.querySelectorAll('.filter-button').forEach(button => {
                button.addEventListener('click', () => {
                    const filter = button.id.replace('filter-', '');
                    appState.selectedFilter = filter;
                    updateFilterButtons();
                    if (filter !== 'custom' || (appState.customStartDate && appState.customEndDate)) {
                        fetchAllDataAndAnalyze();
                    }
                });
            });

            const startDateInput = document.getElementById('start-date');
            const endDateInput = document.getElementById('end-date');
            const dateChangeHandler = () => {
                const localStart = startDateInput.value ? new Date(startDateInput.value + 'T00:00:00Z') : null;
                const localEnd = endDateInput.value ? new Date(endDateInput.value + 'T00:00:00Z') : null;
                
                appState.customStartDate = localStart;
                appState.customEndDate = localEnd;
                
                if (appState.customStartDate && appState.customEndDate) {
                    if(appState.customStartDate > appState.customEndDate) {
                        endDateInput.value = startDateInput.value;
                        appState.customEndDate = appState.customStartDate;
                    }
                    fetchAllDataAndAnalyze();
                }
                updateCustomDateRangeDisplay();
            };
            startDateInput.addEventListener('change', dateChangeHandler);
            endDateInput.addEventListener('change', dateChangeHandler);

            document.getElementById('real-stock-search').addEventListener('input', (e) => {
                appState.realStockFilter = e.target.value;
                renderRealStockInfoCard();
            });
        });
    </script>
</body>
</html>
