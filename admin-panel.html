<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts - Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Chart.js CDN for charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            /* To prevent the whole page from scrolling, we can constrain its height */
            height: 100vh;
            overflow-y: hidden;
        }
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        /* Remove default date picker icon and add custom one */
        input[type="date"]::-webkit-calendar-picker-indicator {
            display: none;
            -webkit-appearance: none;
        }
        input[type="date"] {
            -webkit-appearance: none;
            appearance: none;
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>') no-repeat right 10px center;
            background-size: 20px;
            padding-right: 40px; /* Space for the icon */
        }

        /* --- Modern Sidebar Styles --- */
        .sidebar {
            position: fixed; /* This is the key property. It keeps the sidebar fixed on the screen */
            top: 0;
            left: 0;
            z-index: 40;
            width: 250px;
            flex-shrink: 0;
            background-color: #111827; /* Tailwind gray-900 */
            color: #d1d5db; /* Tailwind gray-300 */
            height: 100vh;
            display: flex;
            flex-direction: column;
            padding: 1rem 0; /* Vertical padding only */
            box-shadow: 2px 0 10px rgba(0,0,0,0.2);
            transition: transform 0.3s ease-in-out; /* Added for smooth transition */
            transform: translateX(-100%); /* Hide sidebar by default on mobile */
        }

        /* Show sidebar on medium screens and up */
        @media (min-width: 768px) {
            .sidebar {
                transform: translateX(0);
            }
        }

        /* This class will be toggled with JS to show the sidebar on mobile */
        .sidebar.open {
            transform: translateX(0);
        }

        .sidebar-header {
            padding: 1rem 1.5rem;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
        }

        .sidebar-header .logo-icon {
            background-color: #4f46e5; /* Indigo-600 */
            color: white;
            padding: 0.5rem;
            border-radius: 0.5rem;
            margin-right: 0.75rem;
        }

        .sidebar-header h2 {
            font-size: 1.25rem; /* text-xl */
            font-weight: 700; /* bold */
            color: white;
        }

        .sidebar nav {
            flex-grow: 1;
            padding: 0 1rem; /* Horizontal padding for nav items */
            overflow-y: auto; /* Add scroll for sidebar if content overflows */
        }
        
        .sidebar-button {
            display: flex;
            align-items: center;
            width: 100%;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            background-color: transparent;
            color: #d1d5db; /* gray-300 */
            font-weight: 500;
            transition: background-color 0.2s ease, color 0.2s ease;
            position: relative; /* For the active indicator */
        }

        .sidebar-button:hover {
            background-color: #1f2937; /* gray-800 */
            color: white;
        }

        .sidebar-button.active {
            background-color: #374151; /* gray-700 */
            color: white;
            font-weight: 600; /* semi-bold */
        }
        
        /* Active indicator bar */
        .sidebar-button.active::before {
            content: '';
            position: absolute;
            left: -1rem; /* Position outside the button's padding */
            top: 20%;
            height: 60%;
            width: 4px;
            background-color: #4f46e5; /* Indigo-600 */
            border-top-right-radius: 4px;
            border-bottom-right-radius: 4px;
        }
        
        .logout-button:hover {
            background-color: #991b1b; /* red-800 */
            color: white;
        }

        .sidebar-footer {
            padding: 1rem;
            margin-top: auto;
            border-top: 1px solid #374151; /* gray-700 */
        }

        /* Enhanced dashboard card styling */
        .dashboard-card {
            transition: transform 0.3s ease-in-out, box-shadow 0.3s ease-in-out;
            border: 1px solid #e5e7eb;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }
        .dashboard-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 15px 30px rgba(0,0,0,0.2);
        }

        /* Filter buttons hover effect */
        .filter-button {
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out, background-color 0.2s ease-in-out;
        }
        .filter-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .filter-button.active {
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body class="min-h-screen">
    <!-- 
      PAGE STRUCTURE TEMPLATE:
      To have a consistent sidebar on every page, you should use this same basic HTML structure for all your admin pages (e.g., orders.html, products.html, etc.).

      1. Copy this entire file to create a new page (e.g., `products.html`).
      2. Keep the <head>, <body>, <aside id="sidebar">, and the main <div> wrapper with the class "md:ml-[250px]".
      3. Keep the <header> (the app bar).
      4. **REPLACE THE CONTENT** inside the `<main>` tag with the specific content for your new page.
      5. Keep the entire <script> block at the end, but you might need to modify the `DOMContentLoaded` event listener to fetch data relevant to the new page.
    -->

    <!-- Sidebar -->
    <aside id="sidebar" class="sidebar">
        <div class="sidebar-header">
            <div class="logo-icon">
                <i class="fas fa-shield-alt"></i>
            </div>
            <h2 class="text-xl font-bold text-white">Admin</h2>
        </div>
        <nav class="flex-1 space-y-2">
            <button id="dashboard-nav-btn" class="sidebar-button active">
                <i class="fas fa-tachometer-alt fa-fw mr-3"></i>
                <span>Dashboard</span>
            </button>
            <button id="orders-button" class="sidebar-button">
                <i class="fas fa-clipboard-list fa-fw mr-3"></i>
                <span>Orders</span>
            </button>
            <button id="add-product-nav-btn" class="sidebar-button">
                <i class="fas fa-box-open fa-fw mr-3"></i>
                <span>Add Product</span>
            </button>
            <button id="all-products-nav-btn" class="sidebar-button">
                <i class="fas fa-boxes fa-fw mr-3"></i>
                <span>All Products</span>
            </button>
            <button id="admins-nav-btn" class="sidebar-button">
                <i class="fas fa-user-shield fa-fw mr-3"></i>
                <span>Admins</span>
            </button>
            <button id="stock-nav-btn" class="sidebar-button">
                <i class="fas fa-warehouse fa-fw mr-3"></i>
                <span>Stock</span>
            </button>
            <button id="pixels-nav-btn" class="sidebar-button">
                <i class="fas fa-image fa-fw mr-3"></i>
                <span>Pixels</span>
            </button>
            <button id="fees-delivery-nav-btn" class="sidebar-button">
                <i class="fas fa-dollar-sign fa-fw mr-3"></i>
                <span>Fees Delivery</span>
            </button>
            <button id="site-config-nav-btn" class="sidebar-button">
                <i class="fas fa-cog fa-fw mr-3"></i>
                <span>Site Config</span>
            </button>
            <button id="facture-nav-btn" class="sidebar-button">
                <i class="fas fa-file-invoice fa-fw mr-3"></i>
                <span>Facture</span>
            </button>
            <button id="charges-nav-btn" class="sidebar-button">
                <i class="fas fa-bolt fa-fw mr-3"></i>
                <span>Charges</span>
            </button>
        </nav>
        <div class="sidebar-footer space-y-2">
            <button id="language-toggle" class="sidebar-button">
                <i class="fas fa-language fa-fw mr-3"></i>
                <span id="language-text">English</span>
            </button>
            <button id="logout-button" class="sidebar-button logout-button">
                <i class="fas fa-sign-out-alt fa-fw mr-3"></i>
                <span id="logout-text">Logout</span>
            </button>
        </div>
    </aside>

    <!-- Main Content Area -->
    <!-- CHANGE: Added h-screen and overflow-y-auto to make this container the scrolling element, not the body. -->
    <div class="flex flex-col transition-all duration-300 ease-in-out md:ml-[250px] h-screen overflow-y-auto">
        <!-- Overlay for mobile when sidebar is open -->
        <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-30 hidden md:hidden"></div>
        
        <!-- App Bar -->
        <!-- The 'sticky' class will now work relative to this scrolling container -->
        <header class="bg-white shadow-sm p-4 flex justify-between items-center rounded-b-lg sticky top-0 z-20">
             <!-- Hamburger Menu (visible on mobile) -->
            <button id="menu-toggle" class="md:hidden text-gray-600 hover:text-gray-800 focus:outline-none">
                <i class="fas fa-bars text-2xl"></i>
            </button>
             <!-- Spacer to allow content on the right -->
            <div class="flex-grow"></div>
             <!-- Header content can go here, like user profile, notifications etc. -->
        </header>

        <!-- CHANGE: Removed overflow-y-auto from main, as the parent now handles scrolling. -->
        <main class="flex-1 flex flex-col p-4">
            <!-- Filter Section -->
            <section class="bg-gray-50 p-6 rounded-xl shadow-md mb-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 id="filter-orders-title" class="text-2xl font-bold text-gray-800">Filter Orders</h2>
                    <i class="fas fa-filter text-3xl text-gray-700"></i>
                </div>
                <div class="flex flex-wrap gap-3">
                    <button id="filter-today" class="filter-button bg-gray-200 text-gray-800 px-5 py-3 rounded-lg shadow-sm hover:bg-gray-300 transition duration-300 flex items-center space-x-2">
                        <i class="fas fa-calendar-day"></i>
                        <span class="filter-label">Today</span>
                    </button>
                    <button id="filter-month" class="filter-button bg-indigo-600 text-white px-5 py-3 rounded-lg shadow-md hover:bg-indigo-700 transition duration-300 flex items-center space-x-2">
                        <i class="fas fa-calendar-alt"></i>
                        <span class="filter-label">This Month</span>
                    </button>
                    <button id="filter-custom" class="filter-button bg-gray-200 text-gray-800 px-5 py-3 rounded-lg shadow-sm hover:bg-gray-300 transition duration-300 flex items-center space-x-2">
                        <i class="fas fa-calendar-days"></i>
                        <span class="filter-label">Custom Range</span>
                    </button>
                    <button id="filter-all" class="filter-button bg-gray-200 text-gray-800 px-5 py-3 rounded-lg shadow-sm hover:bg-gray-300 transition duration-300 flex items-center space-x-2">
                        <i class="fas fa-globe"></i>
                        <span class="filter-label">All Orders</span>
                    </button>
                </div>
                <div id="custom-date-range" class="mt-4 hidden flex-col sm:flex-row gap-4 items-center">
                    <div class="flex items-center space-x-2 w-full sm:w-auto">
                        <label for="start-date" class="text-gray-700 font-medium">From:</label>
                        <input type="date" id="start-date" class="p-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500 w-full sm:w-auto">
                    </div>
                    <div class="flex items-center space-x-2 w-full sm:w-auto">
                        <label for="end-date" class="text-gray-700 font-medium">To:</label>
                        <input type="date" id="end-date" class="p-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500 w-full sm:w-auto">
                    </div>
                    <p id="selected-date-range" class="text-sm text-gray-700 mt-2 sm:mt-0"></p>
                </div>
            </section>

            <hr class="border-gray-300 mb-6">

            <!-- Main Content Grid -->
            <section id="dashboard-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-2 xl:grid-cols-3 gap-6 flex-1">
                <!-- Order Summary Card -->
                <div id="order-summary-card" class="dashboard-card bg-white p-6 rounded-xl shadow-lg flex flex-col">
                    <div class="flex items-center mb-4">
                        <i class="fas fa-list-alt text-3xl text-gray-800"></i>
                        <h3 class="text-2xl font-bold text-gray-800 ml-3">Order Summary</h3>
                    </div>
                    <div id="order-summary-content" class="flex-1 flex items-center justify-center">
                        <!-- Content will be loaded here -->
                    </div>
                </div>

                <!-- Order Distribution Card (Pie Chart) -->
                <div id="order-distribution-card" class="dashboard-card bg-white p-6 rounded-xl shadow-lg flex flex-col">
                    <div class="flex items-center mb-4">
                        <i class="fas fa-chart-pie text-3xl text-gray-800"></i>
                        <h3 class="text-2xl font-bold text-gray-800 ml-3">Order Distribution</h3>
                    </div>
                    <div id="order-distribution-content" class="flex-1 flex items-center justify-center">
                        <canvas id="orderPieChart"></canvas>
                    </div>
                </div>

                <!-- Real Stock Info Card -->
                <div id="real-stock-info-card" class="dashboard-card bg-white p-6 rounded-xl shadow-lg flex flex-col">
                    <div class="flex items-center mb-4">
                        <i class="fas fa-boxes-stacked text-3xl text-gray-800"></i>
                        <h3 class="text-2xl font-bold text-gray-800 ml-3">Real Stock Info</h3>
                    </div>
                    <div class="mb-4">
                        <input type="text" id="real-stock-search" placeholder="Search stock..." class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 bg-gray-50 text-gray-800">
                    </div>
                    <hr class="border-gray-300 mb-4">
                    <div id="real-stock-info-content" class="flex-1 overflow-y-auto">
                        <!-- Real stock info will be loaded here -->
                    </div>
                </div>
            </section>
        </main>
    </div>

    <script>
        // Global state management
        const appState = {
            products: [],
            realStockInfos: [], // For the new real stock info
            totalOrders: 0,
            pendingOrders: 0,
            confirmedOrders: 0,
            tentativeOrders: 0,
            cancelledOrders: 0,
            isOrdersLoading: true,
            isStockLoading: true, // Loading state for real stock
            orderErrorMessage: null,
            stockErrorMessage: null, // Error message for real stock
            selectedFilter: 'month', // 'today', 'month', 'custom', 'all'
            customStartDate: null,
            customEndDate: null,
            isEnglish: true, // Default language
            stockFilter: '',
            realStockFilter: '', // Filter for the new stock card
            orderPieChartInstance: null, // To store Chart.js instance
            activeSidebarButton: 'dashboard-nav-btn', // Keep track of the active button
        };

        // Translations map
        const translations = {
            'en': {
                'adminPanelTitle': 'Admin Panel',
                'filterOrders': 'Filter Orders',
                'today': 'Today',
                'thisMonth': 'This Month',
                'customRange': 'Custom Range',
                'allOrders': 'All Orders',
                'ordersButton': 'Orders',
                'dashboardButton': 'Dashboard',
                'addProductButton': 'Add Product',
                'allProductsButton': 'All Products',
                'adminsButton': 'Admins',
                'stockButton': 'Stock',
                'pixelsButton': 'Pixels',
                'feesDeliveryButton': 'Fees Delivery',
                'siteConfigButton': 'Site Config',
                'factureButton': 'Invoice',
                'charges': 'Charges',
                'logoutButton': 'Logout',
                'selected': 'Selected',
                'orderSummary': 'Order Summary',
                'totalOrders': 'Total Orders',
                'pending': 'Pending',
                'confirmed': 'Confirmed',
                'tentative': 'Tentative',
                'cancelled': 'Cancelled',
                'orderDistribution': 'Order Distribution',
                'realStockInfo': 'Real Stock Info', // New translation
                'searchHint': 'Search...',
                'searchStockHint': 'Search stock...', // New translation
                'noDataChart': 'No data available to show the chart.',
                'failedToLoadOrders': 'Failed to load orders:',
                'failedToLoadStock': 'Failed to load stock:', // New translation
                'errorFetchingOrders': 'Error fetching orders:',
                'errorFetchingStock': 'Error fetching stock:', // New translation
                'retry': 'Retry',
                'role': 'Role',
                'unknown': 'Unknown',
                'language': 'English',
                'From': 'From',
                'To': 'To',
                'noStockFound': 'No stock items found matching your search.',
                'loadingStock': 'Loading stock info...'
            },
            'ar': {
                'adminPanelTitle': 'لوحة التحكم',
                'filterOrders': 'تصفية الطلبات',
                'today': 'اليوم',
                'thisMonth': 'هذا الشهر',
                'customRange': 'نطاق مخصص',
                'allOrders': 'جميع الطلبات',
                'ordersButton': 'الطلبات',
                'dashboardButton': 'لوحة القيادة',
                'addProductButton': 'إضافة منتج',
                'allProductsButton': 'جميع المنتجات',
                'adminsButton': 'المسؤولون',
                'stockButton': 'المخزون',
                'pixelsButton': 'البكسلات',
                'feesDeliveryButton': 'رسوم التوصيل',
                'siteConfigButton': 'إعدادات الموقع',
                'factureButton': 'فاتورة',
                'charges': 'الرسوم',
                'logoutButton': 'تسجيل الخروج',
                'selected': 'المحدد',
                'orderSummary': 'ملخص الطلبات',
                'totalOrders': 'إجمالي الطلبات',
                'pending': 'معلقة',
                'confirmed': 'مؤكدة',
                'tentative': 'مؤقتة',
                'cancelled': 'ملغاة',
                'orderDistribution': 'توزيع الطلبات',
                'realStockInfo': 'معلومات المخزون الحقيقي', // New translation
                'searchHint': 'بحث...',
                'searchStockHint': 'بحث في المخزون...', // New translation
                'noDataChart': 'لا توجد بيانات لعرض الرسم البياني.',
                'failedToLoadOrders': 'فشل تحميل الطلبات:',
                'failedToLoadStock': 'فشل تحميل المخزون:', // New translation
                'errorFetchingOrders': 'خطأ في جلب الطلبات:',
                'errorFetchingStock': 'خطأ في جلب المخزون:', // New translation
                'retry': 'إعادة المحاولة',
                'role': 'الدور',
                'unknown': 'غير معروف',
                'language': 'العربية',
                'From': 'من',
                'To': 'إلى',
                'noStockFound': 'لم يتم العثور على عناصر مخزون مطابقة لبحثك.',
                'loadingStock': 'جاري تحميل معلومات المخزون...'
            },
        };

        // Helper to get translated string
        function getTranslatedString(key) {
            return translations[appState.isEnglish ? 'en' : 'ar'][key] || key;
        }

        // Function to update sidebar active states
        function updateSidebarActiveState(activeButtonId) {
            document.querySelectorAll('.sidebar-button').forEach(button => {
                button.classList.remove('active');
            });
            const activeButton = document.getElementById(activeButtonId);
            if (activeButton) {
                activeButton.classList.add('active');
                appState.activeSidebarButton = activeButtonId; // Update state
            }
        }

        // Function to toggle language
        function toggleLanguage() {
            appState.isEnglish = !appState.isEnglish;
            renderApp(); // Re-render the entire app
            fetchOrders(); // Re-fetch orders to apply date formatting if needed
            fetchRealStockData(); // Re-fetch stock info
        }

        // --- API Fetching Functions ---

        async function fetchOrders() {
            appState.isOrdersLoading = true;
            appState.orderErrorMessage = null;
            renderOrderSummaryCard(); // Show loading state
            renderOrderPieChartCard(); // Show loading state

            try {
                const response = await fetch('https://sheeka.onrender.com/orders');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const fetchedOrders = await response.json();
                processOrderData(fetchedOrders);
                appState.isOrdersLoading = false;
            } catch (e) {
                appState.orderErrorMessage = `${getTranslatedString('errorFetchingOrders')} ${e.message}`;
                appState.isOrdersLoading = false;
                console.error('Error fetching orders:', e);
            } finally {
                renderOrderSummaryCard(); // Update with data or error
                renderOrderPieChartCard(); // Update with data or error
            }
        }

        async function fetchRealStockData() {
            appState.isStockLoading = true;
            appState.stockErrorMessage = null;
            renderRealStockInfoCard(); // Show loading state

            try {
                // Replace with your actual API endpoint for stock
                const response = await fetch('https://sheeka.onrender.com/products'); 
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const fetchedProducts = await response.json();
                // We'll map the product data to a simpler structure for the stock card
                appState.realStockInfos = fetchedProducts.map(p => ({
                    name: p.name,
                    quantity: p.quantity,
                    lastUpdated: p.updatedAt ? new Date(p.updatedAt).toLocaleDateString() : 'N/A'
                }));
                appState.isStockLoading = false;
            } catch (e) {
                appState.stockErrorMessage = `${getTranslatedString('errorFetchingStock')} ${e.message}`;
                appState.isStockLoading = false;
                console.error('Error fetching real stock info:', e);
            } finally {
                renderRealStockInfoCard(); // Update with data or error
            }
        }

        // --- Order Processing and Filtering ---

        function processOrderData(ordersList) {
            let pending = 0;
            let confirmed = 0;
            let tentative = 0;
            let cancelled = 0;
            let filteredOrders = [];

            const nowUtc = new Date();
            // Normalize filter boundaries to start of day in UTC
            const todayUtcStart = new Date(Date.UTC(nowUtc.getUTCFullYear(), nowUtc.getUTCMonth(), nowUtc.getUTCDate()));
            const thisMonthUtcStart = new Date(Date.UTC(nowUtc.getUTCFullYear(), nowUtc.getUTCMonth(), 1));

            for (const order of ordersList) {
                let createdAt;
                try {
                    const createdAtString = order['createdAt']?.toString();
                    if (createdAtString) {
                        createdAt = new Date(createdAtString); // Date.parse handles ISO 8601
                        if (isNaN(createdAt.getTime())) { // Check for invalid date
                            throw new Error('Invalid date string');
                        }
                    } else {
                        createdAt = new Date(0); // Epoch 0 UTC
                        console.warn(`Warning: createdAt is not a valid string or is null for order: ${order['_id'] || 'unknown_id'}. Treating as UTC epoch 0.`);
                    }
                } catch (e) {
                    createdAt = new Date(0); // Epoch 0 UTC
                    console.error(`Error parsing createdAt date: ${e} for order: ${order['_id'] || 'unknown_id'}. Treating as UTC epoch 0.`);
                }

                let matchesFilter = false;
                switch (appState.selectedFilter) {
                    case 'today':
                        matchesFilter = createdAt.getUTCDate() === todayUtcStart.getUTCDate() &&
                                        createdAt.getUTCMonth() === todayUtcStart.getUTCMonth() &&
                                        createdAt.getUTCFullYear() === todayUtcStart.getUTCFullYear();
                        break;
                    case 'month':
                        matchesFilter = createdAt.getUTCMonth() === thisMonthUtcStart.getUTCMonth() &&
                                        createdAt.getUTCFullYear() === thisMonthUtcStart.getUTCFullYear();
                        break;
                    case 'custom':
                        if (appState.customStartDate && appState.customEndDate) {
                            // Ensure custom dates are also treated as UTC start/end of day for comparison
                            const customStartUtc = new Date(Date.UTC(appState.customStartDate.getFullYear(), appState.customStartDate.getMonth(), appState.customStartDate.getDate()));
                            const customEndUtc = new Date(Date.UTC(appState.customEndDate.getFullYear(), appState.customEndDate.getMonth(), appState.customEndDate.getDate(), 23, 59, 59, 999));

                            matchesFilter = (createdAt.getTime() >= customStartUtc.getTime() && createdAt.getTime() <= customEndUtc.getTime());
                        }
                        break;
                    case 'all':
                        matchesFilter = true;
                        break;
                }

                if (matchesFilter) {
                    filteredOrders.push(order);
                    const status = (order['status'] || 'unknown').toLowerCase();
                    switch (status) {
                        case 'pending':
                            pending++;
                            break;
                        case 'confirmed':
                            confirmed++;
                            break;
                        case 'tentative':
                            tentative++;
                            break;
                        case 'cancelled':
                            cancelled++;
                            break;
                    }
                }
            }

            appState.totalOrders = filteredOrders.length;
            appState.pendingOrders = pending;
            appState.confirmedOrders = confirmed;
            appState.tentativeOrders = tentative;
            appState.cancelledOrders = cancelled;
        }

        // --- UI Rendering Functions ---

        function renderApp() {
            // Update language toggle button text
            document.getElementById('language-text').textContent = getTranslatedString('language');
            document.getElementById('logout-text').textContent = getTranslatedString('logoutButton'); // Translate logout button
            document.getElementById('filter-orders-title').textContent = getTranslatedString('filterOrders');

            // Update sidebar button labels
            document.getElementById('orders-button').querySelector('span').textContent = getTranslatedString('ordersButton');
            document.getElementById('dashboard-nav-btn').querySelector('span').textContent = getTranslatedString('dashboardButton');
            document.getElementById('add-product-nav-btn').querySelector('span').textContent = getTranslatedString('addProductButton');
            document.getElementById('all-products-nav-btn').querySelector('span').textContent = getTranslatedString('allProductsButton');
            document.getElementById('admins-nav-btn').querySelector('span').textContent = getTranslatedString('adminsButton');
            document.getElementById('stock-nav-btn').querySelector('span').textContent = getTranslatedString('stockButton');
            document.getElementById('pixels-nav-btn').querySelector('span').textContent = getTranslatedString('pixelsButton');
            document.getElementById('fees-delivery-nav-btn').querySelector('span').textContent = getTranslatedString('feesDeliveryButton');
            document.getElementById('site-config-nav-btn').querySelector('span').textContent = getTranslatedString('siteConfigButton');
            document.getElementById('facture-nav-btn').querySelector('span').textContent = getTranslatedString('factureButton');
            document.getElementById('charges-nav-btn').querySelector('span').textContent = getTranslatedString('charges');

            // Update filter button labels
            document.querySelector('#filter-today .filter-label').textContent = getTranslatedString('today');
            document.querySelector('#filter-month .filter-label').textContent = getTranslatedString('thisMonth');
            document.querySelector('#filter-custom .filter-label').textContent = getTranslatedString('customRange');
            document.querySelector('#filter-all .filter-label').textContent = getTranslatedString('allOrders');

            // Update custom date range labels
            document.querySelector('#custom-date-range label[for="start-date"]').textContent = getTranslatedString('From') + ':';
            document.querySelector('#custom-date-range label[for="end-date"]').textContent = getTranslatedString('To') + ':';

            // Update card titles
            document.querySelector('#order-summary-card h3').textContent = getTranslatedString('orderSummary');
            document.querySelector('#order-distribution-card h3').textContent = getTranslatedString('orderDistribution');
            document.querySelector('#real-stock-info-card h3').textContent = getTranslatedString('realStockInfo');

            // Update search hints
            document.getElementById('real-stock-search').placeholder = getTranslatedString('searchStockHint');

            // Apply active state to the currently selected sidebar button
            updateSidebarActiveState(appState.activeSidebarButton);

            // Re-render all dynamic content
            updateFilterButtons();
            renderOrderSummaryCard();
            renderOrderPieChartCard();
            renderRealStockInfoCard(); // Call to render new stock info card
            updateCustomDateRangeDisplay();
        }

        function updateFilterButtons() {
            document.querySelectorAll('.filter-button').forEach(button => {
                const filterId = button.id.replace('filter-', '');
                if (filterId === appState.selectedFilter) {
                    button.classList.remove('bg-gray-200', 'text-gray-800', 'hover:bg-gray-300');
                    button.classList.add('bg-indigo-600', 'text-white', 'hover:bg-indigo-700');
                } else {
                    button.classList.remove('bg-indigo-600', 'text-white', 'hover:bg-indigo-700');
                    button.classList.add('bg-gray-200', 'text-gray-800', 'hover:bg-gray-300');
                }
            });

            const customDateRangeDiv = document.getElementById('custom-date-range');
            if (appState.selectedFilter === 'custom') {
                customDateRangeDiv.classList.remove('hidden');
            } else {
                customDateRangeDiv.classList.add('hidden');
            }
        }

        function renderOrderSummaryCard() {
            const contentDiv = document.getElementById('order-summary-content');
            if (appState.isOrdersLoading) {
                contentDiv.innerHTML = `
                    <div class="flex flex-col items-center justify-center">
                        <div class="animate-spin rounded-full h-12 w-12 border-4 border-indigo-500 border-t-transparent"></div>
                        <p class="mt-4 text-gray-600">Loading orders...</p>
                    </div>
                `;
            } else if (appState.orderErrorMessage) {
                contentDiv.innerHTML = `
                    <div class="flex flex-col items-center justify-center text-red-500 p-4 text-center">
                        <i class="fas fa-exclamation-triangle text-4xl mb-2"></i>
                        <p class="text-lg">${appState.orderErrorMessage}</p>
                        <button id="retry-orders-summary" class="mt-4 bg-blue-500 text-white px-4 py-2 rounded-lg shadow hover:bg-blue-600 transition duration-300">
                            <i class="fas fa-sync-alt mr-2"></i>${getTranslatedString('retry')}
                        </button>
                    </div>
                `;
                document.getElementById('retry-orders-summary').onclick = fetchOrders;
            } else {
                contentDiv.innerHTML = `
                    <div class="w-full">
                        ${buildStatusRow(getTranslatedString('totalOrders'), appState.totalOrders, 'teal-700', true)}
                        <hr class="my-4 border-gray-200">
                        ${buildStatusRow(getTranslatedString('pending'), appState.pendingOrders, 'indigo-600', false)}
                        <hr class="my-4 border-gray-200">
                        ${buildStatusRow(getTranslatedString('confirmed'), appState.confirmedOrders, 'green-600', false)}
                        <hr class="my-4 border-gray-200">
                        ${buildStatusRow(getTranslatedString('tentative'), appState.tentativeOrders, 'orange-600', false)}
                        <hr class="my-4 border-gray-200">
                        ${buildStatusRow(getTranslatedString('cancelled'), appState.cancelledOrders, 'red-600', false)}
                    </div>
                `;
            }
        }

        function buildStatusRow(label, count, colorClass, isTotal) {
            const textColor = `text-${colorClass}`;
            const fontWeight = isTotal ? 'font-semibold' : 'font-medium';
            const fontSize = isTotal ? 'text-lg' : 'text-base';
            const countFontSize = isTotal ? 'text-lg' : 'text-base';

            return `
                <div class="flex items-center py-2">
                    <div class="w-4 h-4 rounded-md bg-${colorClass}"></div>
                    <span class="ml-3 flex-1 ${fontSize} ${fontWeight} text-gray-800">${label}</span>
                    <span class="${countFontSize} font-bold ${textColor}">${count}</span>
                </div>
            `;
        }

        const statusColors = {
            'Pending': 'rgb(67, 56, 202)', // indigo-600
            'Confirmed': 'rgb(22, 163, 74)', // green-600
            'Tentative': 'rgb(234, 88, 12)', // orange-600
            'Cancelled': 'rgb(220, 38, 38)', // red-600
            'Unknown': 'rgb(156, 163, 175)', // gray-400
        };

        function renderOrderPieChartCard() {
            const contentDiv = document.getElementById('order-distribution-content');
            let canvas = document.getElementById('orderPieChart');

            if (appState.isOrdersLoading) {
                contentDiv.innerHTML = `
                    <div class="flex flex-col items-center justify-center">
                        <div class="animate-spin rounded-full h-12 w-12 border-4 border-indigo-500 border-t-transparent"></div>
                        <p class="mt-4 text-gray-600">Loading chart data...</p>
                    </div>
                `;
                if (appState.orderPieChartInstance) {
                    appState.orderPieChartInstance.destroy();
                    appState.orderPieChartInstance = null;
                }
                return;
            } else if (appState.orderErrorMessage) {
                contentDiv.innerHTML = `
                    <div class="flex flex-col items-center justify-center text-red-500 p-4 text-center">
                        <i class="fas fa-exclamation-triangle text-4xl mb-2"></i>
                        <p class="text-lg">${appState.orderErrorMessage}</p>
                        <button id="retry-orders-chart" class="mt-4 bg-blue-500 text-white px-4 py-2 rounded-lg shadow hover:bg-blue-600 transition duration-300">
                            <i class="fas fa-sync-alt mr-2"></i>${getTranslatedString('retry')}
                        </button>
                    </div>
                `;
                document.getElementById('retry-orders-chart').onclick = fetchOrders;
                if (appState.orderPieChartInstance) {
                    appState.orderPieChartInstance.destroy();
                    appState.orderPieChartInstance = null;
                }
                return;
            }

            const dataMap = {};
            if (appState.pendingOrders > 0) dataMap[getTranslatedString('pending')] = appState.pendingOrders;
            if (appState.confirmedOrders > 0) dataMap[getTranslatedString('confirmed')] = appState.confirmedOrders;
            if (appState.tentativeOrders > 0) dataMap[getTranslatedString('tentative')] = appState.tentativeOrders;
            if (appState.cancelledOrders > 0) dataMap[getTranslatedString('cancelled')] = appState.cancelledOrders;

            if (appState.totalOrders === 0 || Object.keys(dataMap).length === 0) {
                contentDiv.innerHTML = `
                    <div class="bg-gray-100 p-8 rounded-xl shadow-inner text-center">
                        <i class="fas fa-info-circle text-4xl text-gray-500 mb-3"></i>
                        <p class="text-lg text-gray-700">${getTranslatedString('noDataChart')}</p>
                    </div>
                `;
                if (appState.orderPieChartInstance) {
                    appState.orderPieChartInstance.destroy();
                    appState.orderPieChartInstance = null;
                }
                return;
            }

            // Ensure canvas is present and get its context
            if (!canvas || !document.body.contains(canvas)) { // Check if canvas exists and is in DOM
                contentDiv.innerHTML = '<canvas id="orderPieChart"></canvas>';
                canvas = document.getElementById('orderPieChart');
            }
            const ctx = canvas.getContext('2d');

            const labels = Object.keys(dataMap);
            const data = Object.values(dataMap);
            const colors = labels.map(label => {
                // Map translated label back to original key for color lookup
                const originalKey = Object.keys(translations['en']).find(key => translations['en'][key] === label || translations['ar'][key] === label);
                if (originalKey) {
                    // Normalize key to match statusColors (e.g., "pending" -> "Pending")
                    const capitalizedKey = originalKey.charAt(0).toUpperCase() + originalKey.slice(1);
                    return statusColors[capitalizedKey] || statusColors['Unknown'];
                }
                return statusColors['Unknown']; // Fallback
            });

            if (appState.orderPieChartInstance) {
                appState.orderPieChartInstance.data.labels = labels;
                appState.orderPieChartInstance.data.datasets[0].data = data;
                appState.orderPieChartInstance.data.datasets[0].backgroundColor = colors;
                appState.orderPieChartInstance.options.plugins.title.text = `${getTranslatedString('totalOrders')}: ${appState.totalOrders}`;
                appState.orderPieChartInstance.update();
            } else {
                appState.orderPieChartInstance = new Chart(ctx, {
                    type: 'doughnut', // Use doughnut for the ring effect
                    data: {
                        labels: labels,
                        datasets: [{
                            data: data,
                            backgroundColor: colors,
                            borderColor: '#ffffff',
                            borderWidth: 2,
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        cutout: '70%', // Controls the size of the inner hole for doughnut chart
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    font: {
                                        size: 14,
                                        weight: '500',
                                    },
                                    color: '#333',
                                    usePointStyle: true, // Use circle for legend items
                                },
                            },
                            title: {
                                display: true,
                                text: `${getTranslatedString('totalOrders')}: ${appState.totalOrders}`,
                                font: {
                                    size: 18,
                                    weight: 'bold',
                                },
                                color: '#1a202c', // Dark gray
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        let label = context.label || '';
                                        if (label) {
                                            label += ': ';
                                        }
                                        if (context.parsed !== null) {
                                            label += new Intl.NumberFormat('en-US', { style: 'decimal' }).format(context.parsed);
                                            const total = context.dataset.data.reduce((sum, val) => sum + val, 0);
                                            const percentage = (context.parsed / total * 100).toFixed(1);
                                            label += ` (${percentage}%)`;
                                        }
                                        return label;
                                    }
                                }
                            }
                        }
                    }
                });
            }
        }

        function renderRealStockInfoCard() {
            const contentDiv = document.getElementById('real-stock-info-content');
            if (appState.isStockLoading) {
                contentDiv.innerHTML = `
                    <div class="flex flex-col items-center justify-center h-full text-gray-600">
                        <div class="animate-spin rounded-full h-12 w-12 border-4 border-indigo-500 border-t-transparent"></div>
                        <p class="mt-4">${getTranslatedString('loadingStock')}</p>
                    </div>
                `;
                return;
            }

            if (appState.stockErrorMessage) {
                contentDiv.innerHTML = `
                    <div class="text-center text-red-500 p-4">
                        <i class="fas fa-exclamation-circle text-4xl mb-2"></i>
                        <p>${getTranslatedString('failedToLoadStock')} ${appState.stockErrorMessage}</p>
                        <button id="retry-stock" class="mt-4 bg-blue-500 text-white px-4 py-2 rounded-lg shadow hover:bg-blue-600 transition duration-300">
                            <i class="fas fa-sync-alt mr-2"></i>${getTranslatedString('retry')}
                        </button>
                    </div>
                `;
                document.getElementById('retry-stock').onclick = fetchRealStockData;
                return;
            }

            const filteredStock = appState.realStockInfos.filter(item => {
                const name = item.name ? item.name.toLowerCase() : '';
                const filter = appState.realStockFilter.toLowerCase();
                return name.includes(filter);
            });

            if (filteredStock.length === 0) {
                contentDiv.innerHTML = `
                    <div class="flex flex-col items-center justify-center h-full text-gray-600">
                        <i class="fas fa-info-circle text-4xl mb-3"></i>
                        <p>${getTranslatedString('noStockFound')}</p>
                    </div>
                `;
                return;
            }

            contentDiv.innerHTML = `
                <div class="w-full text-left">
                    ${filteredStock.map(item => `
                        <div class="bg-white p-3 rounded-lg shadow-sm mb-3 flex items-center justify-between">
                            <div>
                                <h4 class="font-semibold text-gray-900">${item.name}</h4>
                                <p class="text-sm text-gray-600">Quantity: ${item.quantity}</p>
                                <p class="text-xs text-gray-500">Last Updated: ${item.lastUpdated}</p>
                            </div>
                            <i class="fas fa-cubes text-blue-500 text-2xl"></i>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function updateCustomDateRangeDisplay() {
            const selectedDateRangeText = document.getElementById('selected-date-range');
            if (appState.selectedFilter === 'custom' && appState.customStartDate && appState.customEndDate) {
                const startDateFormatted = new Intl.DateTimeFormat(appState.isEnglish ? 'en-US' : 'ar-EG', { month: 'short', day: 'numeric', year: 'numeric' }).format(appState.customStartDate);
                const endDateFormatted = new Intl.DateTimeFormat(appState.isEnglish ? 'en-US' : 'ar-EG', { month: 'short', day: 'numeric', year: 'numeric' }).format(appState.customEndDate);
                selectedDateRangeText.textContent = `${getTranslatedString('selected')}: ${startDateFormatted} - ${endDateFormatted}`;
                selectedDateRangeText.classList.remove('hidden');
            } else {
                selectedDateRangeText.classList.add('hidden');
            }
        }

        // --- Event Listeners ---

        document.addEventListener('DOMContentLoaded', () => {
            // Initial render and data fetch
            renderApp();
            fetchOrders();
            fetchRealStockData();

            // Responsive Sidebar Toggle
            const menuToggle = document.getElementById('menu-toggle');
            const sidebar = document.getElementById('sidebar');
            const sidebarOverlay = document.getElementById('sidebar-overlay');

            if (menuToggle && sidebar && sidebarOverlay) {
                menuToggle.addEventListener('click', () => {
                    sidebar.classList.toggle('open');
                    sidebarOverlay.classList.toggle('hidden');
                });

                sidebarOverlay.addEventListener('click', () => {
                    sidebar.classList.remove('open');
                    sidebarOverlay.classList.add('hidden');
                });
            }

            // Language Toggle
            document.getElementById('language-toggle').addEventListener('click', toggleLanguage);

            // Logout Button
            document.getElementById('logout-button').addEventListener('click', () => {
                // Clear any stored session data (the web equivalent of SharedPreferences)
                localStorage.clear();
                sessionStorage.clear(); // Also clear session storage for good measure

                console.log('Logging out and clearing stored data...');

                // Redirect to a login page (assuming one exists)
                window.location.href = 'index.html';
            });

            // --- Sidebar Navigation ---
            // This setup uses window.location.href to navigate. 
            // For this to work, EACH target HTML file must have the same sidebar and header structure.
            document.getElementById('orders-button').addEventListener('click', () => {
                window.location.href = 'orders-management-web.html';
            });
            document.getElementById('dashboard-nav-btn').addEventListener('click', () => {
                // Already on the dashboard, no navigation needed, but we ensure the state is correct.
                updateSidebarActiveState('dashboard-nav-btn');
            });
            document.getElementById('add-product-nav-btn').addEventListener('click', () => {
                window.location.href = 'addproduct.html';
            });
            document.getElementById('all-products-nav-btn').addEventListener('click', () => {
                window.location.href = 'products.html';
            });
            document.getElementById('admins-nav-btn').addEventListener('click', () => {
                window.location.href = 'admins.html';
            });
            document.getElementById('stock-nav-btn').addEventListener('click', () => {
                window.location.href = 'stock.html';
            });
            document.getElementById('pixels-nav-btn').addEventListener('click', () => {
                window.location.href = 'pixels.html';
            });
            document.getElementById('fees-delivery-nav-btn').addEventListener('click', () => {
                window.location.href = 'fees.html';
            });
            document.getElementById('site-config-nav-btn').addEventListener('click', () => {
                window.location.href = 'siteconfig.html';
            });
            document.getElementById('facture-nav-btn').addEventListener('click', () => {
                window.location.href = 'facture.html';
            });
            document.getElementById('charges-nav-btn').addEventListener('click', () => {
                window.location.href = 'charges.html';
            });

            // Filter Buttons
            document.getElementById('filter-today').addEventListener('click', () => {
                appState.selectedFilter = 'today';
                appState.customStartDate = null;
                appState.customEndDate = null;
                updateFilterButtons();
                fetchOrders();
            });

            document.getElementById('filter-month').addEventListener('click', () => {
                appState.selectedFilter = 'month';
                appState.customStartDate = null;
                appState.customEndDate = null;
                updateFilterButtons();
                fetchOrders();
            });

            document.getElementById('filter-custom').addEventListener('click', () => {
                appState.selectedFilter = 'custom';
                updateFilterButtons();
                // If custom dates are already set, re-fetch. Otherwise, wait for user input.
                if (appState.customStartDate && appState.customEndDate) {
                    fetchOrders();
                }
            });

            document.getElementById('filter-all').addEventListener('click', () => {
                appState.selectedFilter = 'all';
                appState.customStartDate = null;
                appState.customEndDate = null;
                updateFilterButtons();
                fetchOrders();
            });

            // Custom Date Range Inputs
            const startDateInput = document.getElementById('start-date');
            const endDateInput = document.getElementById('end-date');

            startDateInput.addEventListener('change', (e) => {
                // Parse as local date first to avoid timezone issues with date input
                const localDate = new Date(e.target.value);
                appState.customStartDate = new Date(Date.UTC(localDate.getFullYear(), localDate.getMonth(), localDate.getDate())); // Convert to UTC start of day
                
                if (appState.customEndDate && appState.customStartDate.getTime() > appState.customEndDate.getTime()) {
                    // Adjust end date if it's before start date
                    appState.customEndDate = appState.customStartDate;
                    // Format back to YYYY-MM-DD for input field
                    const adjustedEndDate = new Date(appState.customEndDate.getTime());
                    endDateInput.value = adjustedEndDate.toISOString().split('T')[0];
                }
                updateCustomDateRangeDisplay();
                if (appState.customStartDate && appState.customEndDate) {
                    fetchOrders();
                }
            });

            endDateInput.addEventListener('change', (e) => {
                // Parse as local date first
                const localDate = new Date(e.target.value);
                appState.customEndDate = new Date(Date.UTC(localDate.getFullYear(), localDate.getMonth(), localDate.getDate(), 23, 59, 59, 999)); // Convert to UTC end of day
                
                if (appState.customStartDate && appState.customEndDate.getTime() < appState.customStartDate.getTime()) {
                    // Adjust start date if it's after end date
                    appState.customStartDate = appState.customEndDate;
                    // Format back to YYYY-MM-DD for input field
                    const adjustedStartDate = new Date(appState.customStartDate.getTime());
                    startDateInput.value = adjustedStartDate.toISOString().split('T')[0];
                }
                updateCustomDateRangeDisplay();
                if (appState.customStartDate && appState.customEndDate) {
                    fetchOrders();
                }
            });

            // Stock Search
            document.getElementById('real-stock-search').addEventListener('input', (e) => {
                appState.realStockFilter = e.target.value;
                renderRealStockInfoCard();
            });
        });
    </script>
</body>
</html>
