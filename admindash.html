<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts - Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Chart.js CDN for charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* Light gray background */
        }
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        /* Hide the default date picker icon for custom styling */
        input[type="date"]::-webkit-calendar-picker-indicator {
            display: none;
        }
        input[type="date"] {
            -webkit-appearance: none;
            appearance: none;
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>') no-repeat right 10px center;
            background-size: 20px;
            padding-right: 40px; /* Space for the icon */
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">
    <!-- App Bar -->
    <header class="bg-white shadow-sm p-4 flex justify-end items-center rounded-b-lg">
        <button id="language-toggle" class="flex items-center space-x-2 bg-indigo-600 text-white px-4 py-2 rounded-lg shadow-md hover:bg-indigo-700 transition duration-300">
            <i class="fas fa-language"></i>
            <span id="language-text">English</span>
        </button>
    </header>

    <main class="flex-1 flex flex-col p-4">
        <!-- Filter Section -->
        <section class="bg-gray-50 p-6 rounded-xl shadow-md mb-6">
            <div class="flex justify-between items-center mb-4">
                <h2 id="filter-orders-title" class="text-2xl font-bold text-gray-800">Filter Orders</h2>
                <i class="fas fa-filter text-3xl text-gray-700"></i>
            </div>
            <div class="flex flex-wrap gap-3">
                <button id="filter-today" class="filter-button bg-gray-200 text-gray-800 px-5 py-3 rounded-lg shadow-sm hover:bg-gray-300 transition duration-300 flex items-center space-x-2">
                    <i class="fas fa-calendar-day"></i>
                    <span class="filter-label">Today</span>
                </button>
                <button id="filter-month" class="filter-button bg-indigo-600 text-white px-5 py-3 rounded-lg shadow-md hover:bg-indigo-700 transition duration-300 flex items-center space-x-2">
                    <i class="fas fa-calendar-alt"></i>
                    <span class="filter-label">This Month</span>
                </button>
                <button id="filter-custom" class="filter-button bg-gray-200 text-gray-800 px-5 py-3 rounded-lg shadow-sm hover:bg-gray-300 transition duration-300 flex items-center space-x-2">
                    <i class="fas fa-calendar-days"></i>
                    <span class="filter-label">Custom Range</span>
                </button>
                <button id="filter-all" class="filter-button bg-gray-200 text-gray-800 px-5 py-3 rounded-lg shadow-sm hover:bg-gray-300 transition duration-300 flex items-center space-x-2">
                    <i class="fas fa-globe"></i>
                    <span class="filter-label">All Orders</span>
                </button>
            </div>
            <div id="custom-date-range" class="mt-4 hidden flex-col sm:flex-row gap-4 items-center">
                <div class="flex items-center space-x-2 w-full sm:w-auto">
                    <label for="start-date" class="text-gray-700 font-medium">From:</label>
                    <input type="date" id="start-date" class="p-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500 w-full sm:w-auto">
                </div>
                <div class="flex items-center space-x-2 w-full sm:w-auto">
                    <label for="end-date" class="text-gray-700 font-medium">To:</label>
                    <input type="date" id="end-date" class="p-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500 w-full sm:w-auto">
                </div>
                <p id="selected-date-range" class="text-sm text-gray-700 mt-2 sm:mt-0"></p>
            </div>
        </section>

        <hr class="border-gray-300 mb-6">

        <!-- Main Content Grid -->
        <section id="dashboard-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 flex-1">
            <!-- Order Summary Card -->
            <div id="order-summary-card" class="dashboard-card bg-white p-6 rounded-xl shadow-lg flex flex-col">
                <div class="flex items-center mb-4">
                    <i class="fas fa-list-alt text-3xl text-gray-800"></i>
                    <h3 class="text-2xl font-bold text-gray-800 ml-3">Order Summary</h3>
                </div>
                <div id="order-summary-content" class="flex-1 flex items-center justify-center">
                    <!-- Content will be loaded here -->
                </div>
            </div>

            <!-- Order Distribution Card (Pie Chart) -->
            <div id="order-distribution-card" class="dashboard-card bg-white p-6 rounded-xl shadow-lg flex flex-col">
                <div class="flex items-center mb-4">
                    <i class="fas fa-chart-pie text-3xl text-gray-800"></i>
                    <h3 class="text-2xl font-bold text-gray-800 ml-3">Order Distribution</h3>
                </div>
                <div id="order-distribution-content" class="flex-1 flex items-center justify-center">
                    <canvas id="orderPieChart"></canvas>
                </div>
            </div>

            <!-- Admins Card -->
            <div id="admins-card" class="dashboard-card bg-white p-6 rounded-xl shadow-lg flex flex-col">
                <div class="flex items-center mb-4">
                    <i class="fas fa-user-shield text-3xl text-gray-800"></i>
                    <h3 class="text-2xl font-bold text-gray-800 ml-3">Admins</h3>
                </div>
                <div class="mb-4">
                    <input type="text" id="admin-search" placeholder="Search..." class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 bg-gray-50 text-gray-800">
                </div>
                <hr class="border-gray-300 mb-4">
                <div id="admins-content" class="flex-1 overflow-y-auto">
                    <!-- Content will be loaded here -->
                </div>
            </div>

            <!-- Stock Info Card -->
            <div id="stock-info-card" class="dashboard-card bg-white p-6 rounded-xl shadow-lg flex flex-col">
                <div class="flex items-center mb-4">
                    <i class="fas fa-store text-3xl text-gray-800"></i>
                    <h3 class="text-2xl font-bold text-gray-800 ml-3">Stock Info</h3>
                </div>
                <div class="mb-4">
                    <input type="text" id="stock-search" placeholder="Search..." class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 bg-gray-50 text-gray-800">
                </div>
                <hr class="border-gray-300 mb-4">
                <div id="stock-info-content" class="flex-1 flex items-center justify-center text-gray-800 text-lg">
                    Stock Information Placeholder
                </div>
            </div>
        </section>
    </main>

    <script>
        // Global state management
        const appState = {
            products: [],
            admins: [],
            stockInfos: [],
            totalOrders: 0,
            pendingOrders: 0,
            confirmedOrders: 0,
            tentativeOrders: 0,
            cancelledOrders: 0,
            isOrdersLoading: true,
            orderErrorMessage: null,
            selectedFilter: 'month', // 'today', 'month', 'custom', 'all'
            customStartDate: null,
            customEndDate: null,
            isEnglish: true, // Default language
            adminFilter: '',
            stockFilter: '',
            orderPieChartInstance: null, // To store Chart.js instance
        };

        // Translations map
        const translations = {
            'en': {
                'adminPanelTitle': 'Admin Panel',
                'filterOrders': 'Filter Orders',
                'today': 'Today',
                'thisMonth': 'This Month',
                'customRange': 'Custom Range',
                'allOrders': 'All Orders',
                'selected': 'Selected',
                'orderSummary': 'Order Summary',
                'totalOrders': 'Total Orders',
                'pending': 'Pending',
                'confirmed': 'Confirmed',
                'tentative': 'Tentative',
                'cancelled': 'Cancelled',
                'orderDistribution': 'Order Distribution',
                'admins': 'Admins',
                'stockInfo': 'Stock Info',
                'searchHint': 'Search...',
                'noDataChart': 'No data available to show the chart.',
                'failedToLoadOrders': 'Failed to load orders:',
                'errorFetchingOrders': 'Error fetching orders:',
                'retry': 'Retry',
                'role': 'Role',
                'unknown': 'Unknown',
                'stockInformation': 'Stock Information Placeholder',
                'language': 'English',
                'From': 'From',
                'To': 'To',
            },
            'ar': {
                'adminPanelTitle': 'لوحة التحكم',
                'filterOrders': 'تصفية الطلبات',
                'today': 'اليوم',
                'thisMonth': 'هذا الشهر',
                'customRange': 'نطاق مخصص',
                'allOrders': 'جميع الطلبات',
                'selected': 'المحدد',
                'orderSummary': 'ملخص الطلبات',
                'totalOrders': 'إجمالي الطلبات',
                'pending': 'معلقة',
                'confirmed': 'مؤكدة',
                'tentative': 'مؤقتة',
                'cancelled': 'ملغاة',
                'orderDistribution': 'توزيع الطلبات',
                'admins': 'المسؤولون',
                'stockInfo': 'معلومات المخزون',
                'searchHint': 'بحث...',
                'noDataChart': 'لا توجد بيانات لعرض الرسم البياني.',
                'failedToLoadOrders': 'فشل تحميل الطلبات:',
                'errorFetchingOrders': 'خطأ في جلب الطلبات:',
                'retry': 'إعادة المحاولة',
                'role': 'الدور',
                'unknown': 'غير معروف',
                'stockInformation': 'معلومات المخزون',
                'language': 'العربية',
                'From': 'من',
                'To': 'إلى',
            },
        };

        // Helper to get translated string
        function getTranslatedString(key) {
            return translations[appState.isEnglish ? 'en' : 'ar'][key] || key;
        }

        // Function to toggle language
        function toggleLanguage() {
            appState.isEnglish = !appState.isEnglish;
            renderApp(); // Re-render the entire app
            fetchOrders(); // Re-fetch orders to apply date formatting if needed
        }

        // --- API Fetching Functions ---

        async function fetchAdmins() {
            try {
                const response = await fetch('https://sheeka.onrender.com/auth/users');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                appState.admins = await response.json();
                renderAdminsCard(); // Re-render admins card after fetching
            } catch (e) {
                console.error('Error fetching admins:', e);
                // Optionally display an error message in the admins card
                document.getElementById('admins-content').innerHTML = `
                    <div class="text-center text-red-500 p-4">
                        <i class="fas fa-exclamation-circle text-4xl mb-2"></i>
                        <p>Failed to load admins. Please try again.</p>
                    </div>
                `;
            }
        }

        async function fetchOrders() {
            appState.isOrdersLoading = true;
            appState.orderErrorMessage = null;
            renderOrderSummaryCard(); // Show loading state
            renderOrderPieChartCard(); // Show loading state

            try {
                const response = await fetch('https://sheeka.onrender.com/orders');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const fetchedOrders = await response.json();
                processOrderData(fetchedOrders);
                appState.isOrdersLoading = false;
            } catch (e) {
                appState.orderErrorMessage = `${getTranslatedString('errorFetchingOrders')} ${e.message}`;
                appState.isOrdersLoading = false;
                console.error('Error fetching orders:', e);
            } finally {
                renderOrderSummaryCard(); // Update with data or error
                renderOrderPieChartCard(); // Update with data or error
            }
        }

        // --- Order Processing and Filtering ---

        function processOrderData(ordersList) {
            let pending = 0;
            let confirmed = 0;
            let tentative = 0;
            let cancelled = 0;
            let filteredOrders = [];

            const nowUtc = new Date();
            // Normalize filter boundaries to start of day in UTC
            const todayUtcStart = new Date(Date.UTC(nowUtc.getUTCFullYear(), nowUtc.getUTCMonth(), nowUtc.getUTCDate()));
            const thisMonthUtcStart = new Date(Date.UTC(nowUtc.getUTCFullYear(), nowUtc.getUTCMonth(), 1));

            for (const order of ordersList) {
                let createdAt;
                try {
                    const createdAtString = order['createdAt']?.toString();
                    if (createdAtString) {
                        createdAt = new Date(createdAtString); // Date.parse handles ISO 8601
                        if (isNaN(createdAt.getTime())) { // Check for invalid date
                            throw new Error('Invalid date string');
                        }
                    } else {
                        createdAt = new Date(0); // Epoch 0 UTC
                        console.warn(`Warning: createdAt is not a valid string or is null for order: ${order['_id'] || 'unknown_id'}. Treating as UTC epoch 0.`);
                    }
                } catch (e) {
                    createdAt = new Date(0); // Epoch 0 UTC
                    console.error(`Error parsing createdAt date: ${e} for order: ${order['_id'] || 'unknown_id'}. Treating as UTC epoch 0.`);
                }

                let matchesFilter = false;
                switch (appState.selectedFilter) {
                    case 'today':
                        matchesFilter = createdAt.getUTCDate() === todayUtcStart.getUTCDate() &&
                                        createdAt.getUTCMonth() === todayUtcStart.getUTCMonth() &&
                                        createdAt.getUTCFullYear() === todayUtcStart.getUTCFullYear();
                        break;
                    case 'month':
                        matchesFilter = createdAt.getUTCMonth() === thisMonthUtcStart.getUTCMonth() &&
                                        createdAt.getUTCFullYear() === thisMonthUtcStart.getUTCFullYear();
                        break;
                    case 'custom':
                        if (appState.customStartDate && appState.customEndDate) {
                            const customStartUtc = new Date(Date.UTC(appState.customStartDate.getFullYear(), appState.customStartDate.getMonth(), appState.customStartDate.getDate()));
                            const customEndUtc = new Date(Date.UTC(appState.customEndDate.getFullYear(), appState.customEndDate.getMonth(), appState.customEndDate.getDate(), 23, 59, 59, 999));

                            matchesFilter = (createdAt.getTime() >= customStartUtc.getTime() && createdAt.getTime() <= customEndUtc.getTime());
                        }
                        break;
                    case 'all':
                        matchesFilter = true;
                        break;
                }

                if (matchesFilter) {
                    filteredOrders.push(order);
                    const status = (order['status'] || 'unknown').toLowerCase();
                    switch (status) {
                        case 'pending':
                            pending++;
                            break;
                        case 'confirmed':
                            confirmed++;
                            break;
                        case 'tentative':
                            tentative++;
                            break;
                        case 'cancelled':
                            cancelled++;
                            break;
                    }
                }
            }

            appState.totalOrders = filteredOrders.length;
            appState.pendingOrders = pending;
            appState.confirmedOrders = confirmed;
            appState.tentativeOrders = tentative;
            appState.cancelledOrders = cancelled;
        }

        // --- UI Rendering Functions ---

        function renderApp() {
            // Update language toggle button text
            document.getElementById('language-text').textContent = getTranslatedString('language');
            document.getElementById('filter-orders-title').textContent = getTranslatedString('filterOrders');

            // Update filter button labels
            document.querySelector('#filter-today .filter-label').textContent = getTranslatedString('today');
            document.querySelector('#filter-month .filter-label').textContent = getTranslatedString('thisMonth');
            document.querySelector('#filter-custom .filter-label').textContent = getTranslatedString('customRange');
            document.querySelector('#filter-all .filter-label').textContent = getTranslatedString('allOrders');

            // Update custom date range labels
            document.querySelector('#custom-date-range label[for="start-date"]').textContent = getTranslatedString('From') + ':';
            document.querySelector('#custom-date-range label[for="end-date"]').textContent = getTranslatedString('To') + ':';

            // Update card titles
            document.querySelector('#order-summary-card h3').textContent = getTranslatedString('orderSummary');
            document.querySelector('#order-distribution-card h3').textContent = getTranslatedString('orderDistribution');
            document.querySelector('#admins-card h3').textContent = getTranslatedString('admins');
            document.querySelector('#stock-info-card h3').textContent = getTranslatedString('stockInfo');

            // Update search hints
            document.getElementById('admin-search').placeholder = getTranslatedString('searchHint');
            document.getElementById('stock-search').placeholder = getTranslatedString('searchHint');

            document.getElementById('stock-info-content').textContent = getTranslatedString('stockInformation');

            // Re-render all dynamic content
            updateFilterButtons();
            renderOrderSummaryCard();
            renderOrderPieChartCard();
            renderAdminsCard();
            updateCustomDateRangeDisplay();
        }

        function updateFilterButtons() {
            document.querySelectorAll('.filter-button').forEach(button => {
                const filterId = button.id.replace('filter-', '');
                if (filterId === appState.selectedFilter) {
                    button.classList.remove('bg-gray-200', 'text-gray-800', 'hover:bg-gray-300');
                    button.classList.add('bg-indigo-600', 'text-white', 'hover:bg-indigo-700');
                } else {
                    button.classList.remove('bg-indigo-600', 'text-white', 'hover:bg-indigo-700');
                    button.classList.add('bg-gray-200', 'text-gray-800', 'hover:bg-gray-300');
                }
            });

            const customDateRangeDiv = document.getElementById('custom-date-range');
            if (appState.selectedFilter === 'custom') {
                customDateRangeDiv.classList.remove('hidden');
            } else {
                customDateRangeDiv.classList.add('hidden');
            }
        }

        function renderOrderSummaryCard() {
            const contentDiv = document.getElementById('order-summary-content');
            if (appState.isOrdersLoading) {
                contentDiv.innerHTML = `
                    <div class="flex flex-col items-center justify-center">
                        <div class="animate-spin rounded-full h-12 w-12 border-4 border-indigo-500 border-t-transparent"></div>
                        <p class="mt-4 text-gray-600">Loading orders...</p>
                    </div>
                `;
            } else if (appState.orderErrorMessage) {
                contentDiv.innerHTML = `
                    <div class="flex flex-col items-center justify-center text-red-500 p-4 text-center">
                        <i class="fas fa-exclamation-triangle text-4xl mb-2"></i>
                        <p class="text-lg">${appState.orderErrorMessage}</p>
                        <button id="retry-orders-summary" class="mt-4 bg-blue-500 text-white px-4 py-2 rounded-lg shadow hover:bg-blue-600 transition duration-300">
                            <i class="fas fa-sync-alt mr-2"></i>${getTranslatedString('retry')}
                        </button>
                    </div>
                `;
                document.getElementById('retry-orders-summary').onclick = fetchOrders;
            } else {
                contentDiv.innerHTML = `
                    <div class="w-full">
                        ${buildStatusRow(getTranslatedString('totalOrders'), appState.totalOrders, 'teal-700', true)}
                        <hr class="my-4 border-gray-200">
                        ${buildStatusRow(getTranslatedString('pending'), appState.pendingOrders, 'indigo-600', false)}
                        <hr class="my-4 border-gray-200">
                        ${buildStatusRow(getTranslatedString('confirmed'), appState.confirmedOrders, 'green-600', false)}
                        <hr class="my-4 border-gray-200">
                        ${buildStatusRow(getTranslatedString('tentative'), appState.tentativeOrders, 'orange-600', false)}
                        <hr class="my-4 border-gray-200">
                        ${buildStatusRow(getTranslatedString('cancelled'), appState.cancelledOrders, 'red-600', false)}
                    </div>
                `;
            }
        }

        function buildStatusRow(label, count, colorClass, isTotal) {
            const textColor = `text-${colorClass}`;
            const fontWeight = isTotal ? 'font-semibold' : 'font-medium';
            const fontSize = isTotal ? 'text-lg' : 'text-base';
            const countFontSize = isTotal ? 'text-lg' : 'text-base';

            return `
                <div class="flex items-center py-2">
                    <div class="w-4 h-4 rounded-md bg-${colorClass}"></div>
                    <span class="ml-3 flex-1 ${fontSize} ${fontWeight} text-gray-800">${label}</span>
                    <span class="${countFontSize} font-bold ${textColor}">${count}</span>
                </div>
            `;
        }

        const statusColors = {
            'Pending': 'rgb(67, 56, 202)', // indigo-600
            'Confirmed': 'rgb(22, 163, 74)', // green-600
            'Tentative': 'rgb(234, 88, 12)', // orange-600
            'Cancelled': 'rgb(220, 38, 38)', // red-600
            'Unknown': 'rgb(156, 163, 175)', // gray-400
        };

        function renderOrderPieChartCard() {
            const contentDiv = document.getElementById('order-distribution-content');
            const canvas = document.getElementById('orderPieChart');

            if (appState.isOrdersLoading) {
                contentDiv.innerHTML = `
                    <div class="flex flex-col items-center justify-center">
                        <div class="animate-spin rounded-full h-12 w-12 border-4 border-indigo-500 border-t-transparent"></div>
                        <p class="mt-4 text-gray-600">Loading chart data...</p>
                    </div>
                `;
                if (appState.orderPieChartInstance) {
                    appState.orderPieChartInstance.destroy();
                    appState.orderPieChartInstance = null;
                }
                return;
            } else if (appState.orderErrorMessage) {
                contentDiv.innerHTML = `
                    <div class="flex flex-col items-center justify-center text-red-500 p-4 text-center">
                        <i class="fas fa-exclamation-triangle text-4xl mb-2"></i>
                        <p class="text-lg">${appState.orderErrorMessage}</p>
                        <button id="retry-orders-chart" class="mt-4 bg-blue-500 text-white px-4 py-2 rounded-lg shadow hover:bg-blue-600 transition duration-300">
                            <i class="fas fa-sync-alt mr-2"></i>${getTranslatedString('retry')}
                        </button>
                    </div>
                `;
                document.getElementById('retry-orders-chart').onclick = fetchOrders;
                if (appState.orderPieChartInstance) {
                    appState.orderPieChartInstance.destroy();
                    appState.orderPieChartInstance = null;
                }
                return;
            }

            const dataMap = {};
            if (appState.pendingOrders > 0) dataMap[getTranslatedString('pending')] = appState.pendingOrders;
            if (appState.confirmedOrders > 0) dataMap[getTranslatedString('confirmed')] = appState.confirmedOrders;
            if (appState.tentativeOrders > 0) dataMap[getTranslatedString('tentative')] = appState.tentativeOrders;
            if (appState.cancelledOrders > 0) dataMap[getTranslatedString('cancelled')] = appState.cancelledOrders;

            if (appState.totalOrders === 0 || Object.keys(dataMap).length === 0) {
                contentDiv.innerHTML = `
                    <div class="bg-gray-100 p-8 rounded-xl shadow-inner text-center">
                        <i class="fas fa-info-circle text-4xl text-gray-500 mb-3"></i>
                        <p class="text-lg text-gray-700">${getTranslatedString('noDataChart')}</p>
                    </div>
                `;
                if (appState.orderPieChartInstance) {
                    appState.orderPieChartInstance.destroy();
                    appState.orderPieChartInstance = null;
                }
                return;
            }

            // Ensure canvas is visible if it was hidden by an error/empty message
            if (contentDiv.querySelector('canvas') === null) {
                contentDiv.innerHTML = '<canvas id="orderPieChart"></canvas>';
            }
            const ctx = document.getElementById('orderPieChart').getContext('2d');

            const labels = Object.keys(dataMap);
            const data = Object.values(dataMap);
            const colors = labels.map(label => {
                // Map translated label back to original key for color lookup
                const originalKey = Object.keys(translations['en']).find(key => translations['en'][key] === label || translations['ar'][key] === label);
                if (originalKey) {
                    // Normalize key to match statusColors (e.g., "pending" -> "Pending")
                    const capitalizedKey = originalKey.charAt(0).toUpperCase() + originalKey.slice(1);
                    return statusColors[capitalizedKey] || statusColors['Unknown'];
                }
                return statusColors['Unknown']; // Fallback
            });

            if (appState.orderPieChartInstance) {
                appState.orderPieChartInstance.data.labels = labels;
                appState.orderPieChartInstance.data.datasets[0].data = data;
                appState.orderPieChartInstance.data.datasets[0].backgroundColor = colors;
                appState.orderPieChartInstance.options.plugins.title.text = `${getTranslatedString('totalOrders')}: ${appState.totalOrders}`;
                appState.orderPieChartInstance.update();
            } else {
                appState.orderPieChartInstance = new Chart(ctx, {
                    type: 'doughnut', // Use doughnut for the ring effect
                    data: {
                        labels: labels,
                        datasets: [{
                            data: data,
                            backgroundColor: colors,
                            borderColor: '#ffffff',
                            borderWidth: 2,
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        cutout: '70%', // Controls the size of the inner hole for doughnut chart
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    font: {
                                        size: 14,
                                        weight: '500',
                                    },
                                    color: '#333',
                                    usePointStyle: true, // Use circle for legend items
                                },
                            },
                            title: {
                                display: true,
                                text: `${getTranslatedString('totalOrders')}: ${appState.totalOrders}`,
                                font: {
                                    size: 18,
                                    weight: 'bold',
                                },
                                color: '#1a202c', // Dark gray
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        let label = context.label || '';
                                        if (label) {
                                            label += ': ';
                                        }
                                        if (context.parsed !== null) {
                                            label += new Intl.NumberFormat('en-US', { style: 'decimal' }).format(context.parsed);
                                            const total = context.dataset.data.reduce((sum, val) => sum + val, 0);
                                            const percentage = (context.parsed / total * 100).toFixed(1);
                                            label += ` (${percentage}%)`;
                                        }
                                        return label;
                                    }
                                }
                            }
                        }
                    }
                });
            }
        }

        function renderAdminsCard() {
            const contentDiv = document.getElementById('admins-content');
            const filteredAdmins = appState.admins.filter(admin => {
                const name = admin.name ? admin.name.toLowerCase() : '';
                const role = admin.role ? admin.role.toLowerCase() : '';
                const filter = appState.adminFilter.toLowerCase();
                return name.includes(filter) || role.includes(filter);
            });

            if (appState.admins.length === 0) {
                contentDiv.innerHTML = `
                    <div class="flex flex-col items-center justify-center h-full text-gray-600">
                        <div class="animate-spin rounded-full h-12 w-12 border-4 border-indigo-500 border-t-transparent"></div>
                        <p class="mt-4">Loading admins...</p>
                    </div>
                `;
                return;
            }

            contentDiv.innerHTML = filteredAdmins.map(admin => `
                <div class="bg-white p-3 rounded-lg shadow-sm mb-3 flex items-center">
                    <div class="w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center mr-3">
                        <i class="fas fa-user text-blue-600"></i>
                    </div>
                    <div>
                        <h4 class="font-semibold text-gray-900">${admin.name || getTranslatedString('unknown')}</h4>
                        <p class="text-sm text-gray-600">${getTranslatedString('role')}: ${admin.role || getTranslatedString('unknown')}</p>
                    </div>
                </div>
            `).join('');

            if (filteredAdmins.length === 0 && appState.adminFilter !== '') {
                 contentDiv.innerHTML = `
                    <div class="flex flex-col items-center justify-center h-full text-gray-600">
                        <i class="fas fa-info-circle text-4xl mb-3"></i>
                        <p>No admins found matching your search.</p>
                    </div>
                `;
            }
        }

        function updateCustomDateRangeDisplay() {
            const selectedDateRangeText = document.getElementById('selected-date-range');
            if (appState.selectedFilter === 'custom' && appState.customStartDate && appState.customEndDate) {
                const startDateFormatted = new Intl.DateTimeFormat(appState.isEnglish ? 'en-US' : 'ar-EG', { month: 'short', day: 'numeric', year: 'numeric' }).format(appState.customStartDate);
                const endDateFormatted = new Intl.DateTimeFormat(appState.isEnglish ? 'en-US' : 'ar-EG', { month: 'short', day: 'numeric', year: 'numeric' }).format(appState.customEndDate);
                selectedDateRangeText.textContent = `${getTranslatedString('selected')}: ${startDateFormatted} - ${endDateFormatted}`;
                selectedDateRangeText.classList.remove('hidden');
            } else {
                selectedDateRangeText.classList.add('hidden');
            }
        }

        // --- Event Listeners ---

        document.addEventListener('DOMContentLoaded', () => {
            // Initial render and data fetch
            renderApp();
            fetchAdmins();
            fetchOrders();

            // Language Toggle
            document.getElementById('language-toggle').addEventListener('click', toggleLanguage);

            // Filter Buttons
            document.getElementById('filter-today').addEventListener('click', () => {
                appState.selectedFilter = 'today';
                appState.customStartDate = null;
                appState.customEndDate = null;
                updateFilterButtons();
                fetchOrders();
            });

            document.getElementById('filter-month').addEventListener('click', () => {
                appState.selectedFilter = 'month';
                appState.customStartDate = null;
                appState.customEndDate = null;
                updateFilterButtons();
                fetchOrders();
            });

            document.getElementById('filter-custom').addEventListener('click', () => {
                appState.selectedFilter = 'custom';
                updateFilterButtons();
                // If custom dates are already set, re-fetch. Otherwise, wait for user input.
                if (appState.customStartDate && appState.customEndDate) {
                    fetchOrders();
                }
            });

            document.getElementById('filter-all').addEventListener('click', () => {
                appState.selectedFilter = 'all';
                appState.customStartDate = null;
                appState.customEndDate = null;
                updateFilterButtons();
                fetchOrders();
            });

            // Custom Date Range Inputs
            const startDateInput = document.getElementById('start-date');
            const endDateInput = document.getElementById('end-date');

            startDateInput.addEventListener('change', (e) => {
                appState.customStartDate = new Date(e.target.value + 'T00:00:00Z'); // Ensure UTC start of day
                if (appState.customEndDate && appState.customStartDate.getTime() > appState.customEndDate.getTime()) {
                    appState.customEndDate = appState.customStartDate; // Adjust end date if it's before start date
                    endDateInput.value = e.target.value;
                }
                updateCustomDateRangeDisplay();
                if (appState.customStartDate && appState.customEndDate) {
                    fetchOrders();
                }
            });

            endDateInput.addEventListener('change', (e) => {
                appState.customEndDate = new Date(e.target.value + 'T23:59:59.999Z'); // Ensure UTC end of day
                if (appState.customStartDate && appState.customEndDate.getTime() < appState.customStartDate.getTime()) {
                    appState.customStartDate = appState.customEndDate; // Adjust start date if it's after end date
                    startDateInput.value = e.target.value;
                }
                updateCustomDateRangeDisplay();
                if (appState.customStartDate && appState.customEndDate) {
                    fetchOrders();
                }
            });

            // Admin Search
            document.getElementById('admin-search').addEventListener('input', (e) => {
                appState.adminFilter = e.target.value;
                renderAdminsCard();
            });

            // Stock Search (placeholder for now)
            document.getElementById('stock-search').addEventListener('input', (e) => {
                appState.stockFilter = e.target.value;
                // No actual filtering for stock info yet, but this keeps the state in sync
                // If stock info was a list, you'd call a renderStockInfoCard() here
            });
        });
    </script>
</body>
</html>
