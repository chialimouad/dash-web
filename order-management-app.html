<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Order Management</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- jsPDF for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* Equivalent to bg-gray-100 */
        }
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #e0e0e0;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1000; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            max-width: 90%;
            width: 500px; /* Max width for larger screens */
            animation: fadeIn 0.3s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #333;
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
            z-index: 1001;
        }
        .toast.show {
            opacity: 1;
        }
        .toast.error {
            background-color: #dc2626; /* red-600 */
        }
        .toast.success {
            background-color: #16a34a; /* green-600 */
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <!-- App Bar -->
    <header class="bg-white shadow-md p-4 flex items-center justify-between">
        <h1 class="text-black text-2xl font-bold">Orders Management</h1>
        <div class="flex space-x-2">
            <button id="yalitec-settings-btn" class="p-2 rounded-full hover:bg-gray-100 transition-colors duration-200" title="Yalitec API Settings">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-700" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                </svg>
            </button>
            <button id="generate-pdf-btn" class="p-2 rounded-full hover:bg-gray-100 transition-colors duration-200" title="Generate PDF of Filtered Orders">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-red-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                </svg>
            </button>
            <button id="view-report-btn" class="p-2 rounded-full hover:bg-gray-100 transition-colors duration-200" title="View Report Summary">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0h.01M9 19H7a2 2 0 01-2-2v-6a2 2 0 012-2h2m3 0h.01M12 7v3m0 0l3-3m-3 3l-3-3m-3 3v6a2 2 0 002 2h2a2 2 0 002-2v-6a2 2 0 00-2-2z" />
                </svg>
            </button>
            <button id="agent-report-btn" class="p-2 rounded-full hover:bg-gray-100 transition-colors duration-200" title="View Agent Performance Report">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-purple-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M17 20h2a2 2 0 002-2V4a2 2 0 00-2-2H5a2 2 0 00-2 2v14a2 2 0 002 2h2m4-10h2m4 0h2m-10 4h2m4 0h2m-10 4h2m4 0h2" />
                </svg>
            </button>
        </div>
    </header>

    <main class="flex-1 p-4 overflow-auto">
        <!-- Search Bar -->
        <div class="mb-4">
            <input type="text" id="search-input" placeholder="Search by Phone Number or Name or Order ID"
                           class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-400 text-gray-900 placeholder-gray-500">
        </div>

        <!-- Date Filters -->
        <div class="mb-4 overflow-x-auto whitespace-nowrap pb-2">
            <div id="date-filters" class="flex space-x-2">
                <!-- Date filter buttons will be rendered here by JS -->
            </div>
        </div>

        <!-- Status Filters -->
        <div class="mb-4 overflow-x-auto whitespace-nowrap pb-2">
            <div id="status-filters" class="flex space-x-2">
                <!-- Status filter buttons will be rendered here by JS -->
            </div>
        </div>

        <!-- Loading Indicator -->
        <div id="loading-indicator" class="flex justify-center items-center h-48 hidden">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-500"></div>
        </div>

        <!-- No Orders Message -->
        <div id="no-orders-message" class="text-center text-gray-700 text-lg py-10 hidden">
            No orders found for the current filters.
        </div>

        <!-- Orders List -->
        <div id="orders-list" class="space-y-4">
            <!-- Order cards will be rendered here by JS -->
        </div>

        <!-- Order Report Page (Hidden by default) -->
        <div id="order-report-page" class="hidden fixed inset-0 bg-gray-100 z-50 overflow-auto p-4">
            <div class="max-w-3xl mx-auto bg-white p-6 rounded-lg shadow-lg">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-3xl font-bold text-indigo-800">Order Summary Report</h2>
                    <button id="close-report-btn" class="p-2 rounded-full hover:bg-gray-200">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-700" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
                <div id="report-content">
                    <!-- Report details will be generated here by JS -->
                </div>
                <p class="text-sm text-gray-600 text-center mt-8 italic">
                    This report provides a summary based on the currently applied date filters in the Orders Management screen.
                </p>
            </div>
        </div>

        <!-- Agent Performance Report (Hidden by default) -->
        <div id="agent-report-page" class="hidden fixed inset-0 bg-gray-100 z-50 overflow-auto p-4">
            <div class="max-w-3xl mx-auto bg-white p-6 rounded-lg shadow-lg">
                <div class="flex justify-between items-center mb-6">
                    <h2 id="agent-report-title" class="text-3xl font-bold text-purple-800">Agent Performance Report</h2>
                    <button id="close-agent-report-btn" class="p-2 rounded-full hover:bg-gray-200">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-700" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
                <div id="agent-report-content">
                    <!-- Agent report details will be generated here by JS -->
                </div>
            </div>
        </div>

    </main>

    <!-- Global Message Toast -->
    <div id="toast-message" class="toast"></div>

    <!-- Modals -->
    <div id="yalitec-modal" class="modal">
        <div class="modal-content">
            <h3 class="text-xl font-bold mb-4 text-gray-900">Enter Yalitec API Credentials</h3>
            <input type="text" id="yalitec-api-id" placeholder="Yalitec API ID" class="w-full p-2 border border-gray-300 rounded-md mb-3 text-gray-900">
            <input type="password" id="yalitec-api-token" placeholder="Yalitec API Token" class="w-full p-2 border border-gray-300 rounded-md mb-4 text-gray-900">
            <div class="flex justify-end space-x-2">
                <button id="cancel-yalitec-btn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">Cancel</button>
                <button id="save-yalitec-btn" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">Save & Continue</button>
            </div>
        </div>
    </div>

    <div id="edit-order-modal" class="modal">
        <div class="modal-content">
            <h3 class="text-xl font-bold mb-4 text-gray-900">Edit Order Details</h3>
            <input type="text" id="edit-fullName" placeholder="Full Name" class="w-full p-2 border border-gray-300 rounded-md mb-3 text-gray-900">
            <input type="text" id="edit-phoneNumber" placeholder="Phone Number" class="w-full p-2 border border-gray-300 rounded-md mb-3 text-gray-900">
            <input type="text" id="edit-wilaya" placeholder="Wilaya" class="w-full p-2 border border-gray-300 rounded-md mb-3 text-gray-900">
            <input type="text" id="edit-commune" placeholder="Commune" class="w-full p-2 border border-gray-300 rounded-md mb-3 text-gray-900">
            <textarea id="edit-notes" placeholder="Agent Notes" rows="3" class="w-full p-2 border border-gray-300 rounded-md mb-4 text-gray-900"></textarea>
            <div id="assigned-agent-dropdown-container" class="mb-4 hidden">
                <label for="edit-assignedTo" class="block text-sm font-medium text-gray-700 mb-1">Assigned Agent</label>
                <select id="edit-assignedTo" class="w-full p-2 border border-gray-300 rounded-md text-gray-900">
                    <!-- Options will be populated by JS -->
                </select>
            </div>
            <div class="flex justify-end space-x-2">
                <button id="cancel-edit-btn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">Cancel</button>
                <button id="save-edit-btn" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">Save</button>
            </div>
        </div>
    </div>

    <div id="confirm-delete-modal" class="modal">
        <div class="modal-content">
            <h3 class="text-xl font-bold mb-4 text-gray-900">Confirm Deletion</h3>
            <p class="mb-4 text-gray-700">Are you sure you want to delete this order? This action cannot be undone.</p>
            <div class="flex justify-end space-x-2">
                <button id="cancel-delete-btn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">Cancel</button>
                <button id="confirm-delete-btn" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700">Delete</button>
            </div>
        </div>
    </div>

    <script>
        // Global State Variables (mimicking Flutter's StatefulWidget state)
        let _allOrders = [];
        let _filteredOrders = [];
        let isLoading = false;
        let _currentFilter = 'pending';
        let _orderNotes = {}; // Local notes, not persisted to backend in this mock
        let _allOrdersCount = 0;
        let _pendingOrdersCount = 0;
        let _confirmedOrdersCount = 0;
        let _cancelledOrdersCount = 0;
        let _tentativeOrdersCount = 0;
        let _dispatchedOrdersCount = 0;
        let _currentDateFilter = 'allTime';
        let _customStartDate = null;
        let _customEndDate = null;
        let _pollingTimer = null;
        let _lastFetchedOrderIds = new Set();
        let _availableAgents = [];
        let _currentUserRole = 'admin'; // Default to admin for testing
        let _currentUserId = 'admin123'; // Default admin ID
        let _yalitecApiId = null;
        let _yalitecApiToken = null;
        let _areYalitecApiCredentialsLoaded = false;

        const _shopOriginWilayaName = 'Batna';
        const _shopOriginWilayaId = 5; // Not directly used in Yalitec API payload, but kept for context

        // DOM Elements
        const searchInput = document.getElementById('search-input');
        const dateFiltersContainer = document.getElementById('date-filters');
        const statusFiltersContainer = document.getElementById('status-filters');
        const loadingIndicator = document.getElementById('loading-indicator');
        const noOrdersMessage = document.getElementById('no-orders-message');
        const ordersListContainer = document.getElementById('orders-list');
        const toastMessage = document.getElementById('toast-message');

        // Modal Elements
        const yalitecModal = document.getElementById('yalitec-modal');
        const yalitecApiIdInput = document.getElementById('yalitec-api-id');
        const yalitecApiTokenInput = document.getElementById('yalitec-api-token');
        const saveYalitecBtn = document.getElementById('save-yalitec-btn');
        const cancelYalitecBtn = document.getElementById('cancel-yalitec-btn');

        const editOrderModal = document.getElementById('edit-order-modal');
        const editFullNameInput = document.getElementById('edit-fullName');
        const editPhoneNumberInput = document.getElementById('edit-phoneNumber');
        const editWilayaInput = document.getElementById('edit-wilaya');
        const editCommuneInput = document.getElementById('edit-commune');
        const editNotesInput = document.getElementById('edit-notes');
        const assignedAgentDropdownContainer = document.getElementById('assigned-agent-dropdown-container');
        const editAssignedToSelect = document.getElementById('edit-assignedTo');
        const saveEditBtn = document.getElementById('save-edit-btn');
        const cancelEditBtn = document.getElementById('cancel-edit-btn');
        let currentEditingOrderId = null; // To store the ID of the order being edited

        const confirmDeleteModal = document.getElementById('confirm-delete-modal');
        const cancelDeleteBtn = document.getElementById('cancel-delete-btn');
        const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
        let currentDeletingOrderId = null; // To store the ID of the order being deleted

        // Report Page Elements
        const orderReportPage = document.getElementById('order-report-page');
        const closeReportBtn = document.getElementById('close-report-btn');
        const reportContent = document.getElementById('report-content');

        // Agent Report Page Elements
        const agentReportPage = document.getElementById('agent-report-page');
        const closeAgentReportBtn = document.getElementById('close-agent-report-btn');
        const agentReportContent = document.getElementById('agent-report-content');
        const agentReportTitle = document.getElementById('agent-report-title');


        // --- Utility Functions ---

        /**
         * Displays a toast message at the bottom of the screen.
         * @param {string} message - The message to display.
         * @param {boolean} isError - True if it's an error message, false for success.
         */
        function _showMessage(message, isError = false) {
            toastMessage.textContent = message;
            toastMessage.classList.remove('error', 'success');
            toastMessage.classList.add(isError ? 'error' : 'success');
            toastMessage.classList.add('show');
            setTimeout(() => {
                toastMessage.classList.remove('show');
            }, 3000);
        }

        /**
         * Helper function to get a status-specific color (Tailwind CSS class).
         * @param {string} status - The order status.
         * @returns {string} Tailwind CSS text color class.
         */
        function _getStatusColorClass(status) {
            switch (status) {
                case 'confirmed': return 'text-green-700'; // Darker green
                case 'cancelled': return 'text-red-700';   // Darker red
                case 'tentative': return 'text-orange-700'; // Darker orange
                case 'pending': return 'text-indigo-700'; // Darker indigo
                case 'dispatched': return 'text-blue-700'; // Darker blue
                default: return 'text-gray-700';
            }
        }

        /**
         * Helper function to get a status-specific background color (Tailwind CSS class).
         * @param {string} status - The order status.
         * @returns {string} Tailwind CSS background color class.
         */
        function _getStatusBgColorClass(status) {
            switch (status) {
                case 'confirmed': return 'bg-green-100 border-green-500';
                case 'cancelled': return 'bg-red-100 border-red-500';
                case 'tentative': return 'bg-orange-100 border-orange-500';
                case 'pending': return 'bg-indigo-100 border-indigo-500';
                case 'dispatched': return 'bg-blue-100 border-blue-500';
                default: return 'bg-gray-100 border-gray-500';
            }
        }

        /**
         * Fetches the JWT token from localStorage.
         * @returns {string|null} The token string or null if not found.
         */
        function _getTokenFromPrefs() {
            return localStorage.getItem('token');
        }

        /**
         * Saves the JWT token to localStorage.
         * @param {string} token - The token to save.
         */
        function _saveTokenToPrefs(token) {
            localStorage.setItem('token', token);
        }

        /**
         * Loads the current user's role and ID from localStorage.
         */
        function _loadCurrentUserRole() {
            _currentUserRole = localStorage.getItem('role') || 'guest';
            _currentUserId = localStorage.getItem('id');
            console.log(`DEBUG: Loaded current user role: ${_currentUserRole}, ID: ${_currentUserId}`);
        }

        /**
         * Loads Yalitec API credentials from localStorage.
         */
        function _loadYalitecApiCredentials() {
            _yalitecApiId = localStorage.getItem('yalitec_api_id');
            _yalitecApiToken = localStorage.getItem('yalitec_api_token');
            _areYalitecApiCredentialsLoaded = (_yalitecApiId !== null && _yalitecApiId !== '' && _yalitecApiToken !== null && _yalitecApiToken !== '');
            if (!_areYalitecApiCredentialsLoaded) {
                console.log('DEBUG: Yalitec API credentials not found in localStorage.');
            }
        }

        /**
         * Saves Yalitec API credentials to localStorage.
         * @param {string} apiId - The Yalitec API ID.
         * @param {string} apiToken - The Yalitec API Token.
         */
        async function _saveYalitecApiCredentials(apiId, apiToken) {
            localStorage.setItem('yalitec_api_id', apiId);
            localStorage.setItem('yalitec_api_token', apiToken);
            _yalitecApiId = apiId;
            _yalitecApiToken = apiToken;
            _areYalitecApiCredentialsLoaded = true;
            _showMessage('Yalitec API credentials saved successfully!', false);
        }

        /**
         * Handles unauthorized access by clearing user data and simulating a logout.
         */
        function _handleUnauthorizedAccess() {
            _showMessage('Your session has expired or is invalid. Please log in again.', true);
            localStorage.clear(); // Clear all user-related data
            // In a real app, you would redirect to a login page.
            // For this simulation, we'll just reset the user role.
            _currentUserRole = 'guest';
            _currentUserId = null;
            renderApp(); // Re-render to reflect logout state
        }

        /**
         * Formats a date string to 'yyyy-MM-dd HH:mm'.
         * @param {string} dateString - The date string to format.
         * @returns {string} Formatted date string.
         */
        function _formatDate(dateString) {
            try {
                const date = new Date(dateString);
                if (isNaN(date)) {
                    return 'Invalid Date';
                }
                return new Intl.DateTimeFormat('en-US', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    hour12: false
                }).format(date);
            } catch (e) {
                console.error("Error formatting date:", e);
                return 'Invalid Date';
            }
        }

        // --- Core Logic Functions ---

        /**
         * Fetches all orders from the API and calculates total prices.
         */
        async function fetchOrders() {
            isLoading = true;
            renderApp(); // Show loading indicator

            try {
                const response = await fetch('https://sheeka.onrender.com/orders');
                if (!response.ok) {
                    if (response.status === 401) {
                        _handleUnauthorizedAccess();
                    } else {
                        throw new Error(`Failed to fetch orders: ${response.status}`);
                    }
                }
                const fetchedOrders = await response.json();

                _allOrders = fetchedOrders.map(order => {
                    let totalPrice = 0.0;
                    if (order.products && Array.isArray(order.products)) {
                        for (const productItem of order.products) {
                            const price = parseFloat(productItem.price) || 0.0;
                            const quantity = parseInt(productItem.quantity) || 0;
                            totalPrice += price * quantity;
                        }
                    }
                    return { ...order, totalPrice: totalPrice.toFixed(2) };
                });

                // Sort orders by creation date (newest first)
                _allOrders.sort((a, b) => {
                    const dateA = new Date(a.createdAt || '1970-01-01T00:00:00Z');
                    const dateB = new Date(b.createdAt || '1970-01-01T00:00:00Z');
                    return dateB.getTime() - dateA.getTime();
                });

                _lastFetchedOrderIds = new Set(_allOrders.map(order => order._id));
                _applyAllFilters(); // Re-apply filters after fetching new data
            } catch (e) {
                console.error('Error fetching orders:', e);
                _showMessage(`Error fetching orders: ${e.message}`, true);
            } finally {
                isLoading = false;
                renderApp(); // Hide loading indicator
            }
        }

        /**
         * Applies all active filters (date, status, search, and role-based assignment)
         * and updates the displayed orders and status counts.
         */
        function _applyAllFilters() {
            let currentProcessedOrders = [..._allOrders];

            const now = new Date();
            const todayUtcStart = new Date(Date.UTC(now.getFullYear(), now.getMonth(), now.getDate()));
            const thisWeekUtcStart = new Date(Date.UTC(now.getFullYear(), now.getMonth(), now.getDate() - (now.getDay() === 0 ? 6 : now.getDay() - 1))); // Monday start
            const thisMonthUtcStart = new Date(Date.UTC(now.getFullYear(), now.getMonth(), 1));

            currentProcessedOrders = currentProcessedOrders.filter(order => {
                let createdAt;
                try {
                    const createdAtString = order.createdAt?.toString();
                    if (createdAtString && createdAtString.length > 0) {
                        createdAt = new Date(createdAtString);
                    } else {
                        createdAt = new Date(0); // Epoch start
                        console.warn(`Warning: createdAt is null or empty for order: ${order._id || 'unknown_id'}. Treating as UTC epoch 0.`);
                    }
                } catch (e) {
                    createdAt = new Date(0);
                    console.error(`Error parsing createdAt date: ${e} for order: ${order._id || 'unknown_id'}. Treating as UTC epoch 0.`);
                }

                let matchesDateRange = true;
                if (_currentDateFilter === 'today') {
                    matchesDateRange = createdAt.getTime() >= todayUtcStart.getTime() &&
                                       createdAt.getTime() < new Date(todayUtcStart.getTime() + 24 * 60 * 60 * 1000).getTime();
                } else if (_currentDateFilter === 'thisWeek') {
                    matchesDateRange = createdAt.getTime() >= thisWeekUtcStart.getTime() &&
                                       createdAt.getTime() < new Date(thisWeekUtcStart.getTime() + 7 * 24 * 60 * 60 * 1000).getTime();
                } else if (_currentDateFilter === 'thisMonth') {
                    matchesDateRange = createdAt.getTime() >= thisMonthUtcStart.getTime() &&
                                       createdAt.getTime() < new Date(Date.UTC(now.getFullYear(), now.getMonth() + 1, 1)).getTime();
                } else if (_currentDateFilter === 'custom') {
                    if (_customStartDate && _customEndDate) {
                        const customStartUtc = new Date(Date.UTC(_customStartDate.getFullYear(), _customStartDate.getMonth(), _customStartDate.getDate()));
                        const customEndUtc = new Date(Date.UTC(_customEndDate.getFullYear(), _customEndDate.getMonth(), _customEndDate.getDate()));
                        matchesDateRange = (createdAt.getTime() >= customStartUtc.getTime() &&
                                            createdAt.getTime() < new Date(customEndUtc.getTime() + 24 * 60 * 60 * 1000).getTime());
                    } else {
                        matchesDateRange = false;
                    }
                }
                return matchesDateRange;
            });

            if (_currentUserRole === 'confirmation' && _currentUserId !== null) {
                currentProcessedOrders = currentProcessedOrders.filter(order => {
                    return order.assignedTo && order.assignedTo._id === _currentUserId;
                });
                console.log(`DEBUG: Applying agent filter for user ID: ${_currentUserId}. Current processed count: ${currentProcessedOrders.length}`);
            } else if (_currentUserRole === 'admin') {
                console.log('DEBUG: Current user is admin, showing all relevant orders.');
            }

            _allOrdersCount = currentProcessedOrders.length;
            _pendingOrdersCount = currentProcessedOrders.filter(order => order.status === 'pending').length;
            _confirmedOrdersCount = currentProcessedOrders.filter(order => order.status === 'confirmed').length;
            _cancelledOrdersCount = currentProcessedOrders.filter(order => order.status === 'cancelled').length;
            _tentativeOrdersCount = currentProcessedOrders.filter(order => order.status === 'tentative').length;
            _dispatchedOrdersCount = currentProcessedOrders.filter(order => order.status === 'dispatched').length;

            if (_currentFilter !== 'all') {
                _filteredOrders = currentProcessedOrders.filter(order => order.status === _currentFilter);
            } else {
                _filteredOrders = currentProcessedOrders;
            }

            const searchTerm = searchInput.value.toLowerCase();
            if (searchTerm.length > 0) {
                _filteredOrders = _filteredOrders.filter(order => {
                    const phoneNumber = order.phoneNumber?.toString().toLowerCase() || '';
                    const fullName = order.fullName?.toString().toLowerCase() || '';
                    const orderId = order._id?.toString().toLowerCase() || '';
                    return phoneNumber.includes(searchTerm) || fullName.includes(searchTerm) || orderId.includes(searchTerm);
                });
            }
            _sendOrderCountToBackend(_allOrdersCount);
            renderApp(); // Re-render the UI with updated filters
        }

        /**
         * Sends the current _allOrdersCount to the Node.js backend.
         * @param {number} count - The total number of orders.
         */
        async function _sendOrderCountToBackend(count) {
            const token = _getTokenFromPrefs();
            if (!token) {
                console.warn('Warning: No authentication token found. Not sending order count to backend.');
                return;
            }

            try {
                const response = await fetch('https://sheeka.onrender.com/countorder/order-counts', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`,
                    },
                    body: JSON.stringify({
                        count: count,
                        timestamp: new Date().toISOString(),
                        userId: _currentUserId,
                        dateFilter: _currentDateFilter,
                        statusFilter: _currentFilter,
                    }),
                });

                if (response.status === 201) {
                    console.log(`Successfully sent _allOrdersCount to backend: ${count}`);
                } else {
                    const errorBody = await response.json();
                    console.error(`Failed to send _allOrdersCount. Status: ${response.status}, Body:`, errorBody);
                }
            } catch (e) {
                console.error(`Error sending _allOrdersCount to backend: ${e}`);
            }
        }

        /**
         * Starts a periodic timer to poll for new orders from the backend.
         */
        function _startPollingForNewOrders() {
            if (_pollingTimer) {
                clearInterval(_pollingTimer);
            }
            _pollingTimer = setInterval(_pollAndNotifyForNewOrders, 30000); // Poll every 30 seconds
        }

        /**
         * Polls the backend for new orders and notifies the user if any are found.
         */
        async function _pollAndNotifyForNewOrders() {
            try {
                const response = await fetch('https://sheeka.onrender.com/orders');
                if (!response.ok) {
                    if (response.status === 401) {
                        _handleUnauthorizedAccess();
                    }
                    return;
                }
                const currentOrders = await response.json();

                // Sort orders by creation date (newest first)
                currentOrders.sort((a, b) => {
                    const dateA = new Date(a.createdAt || '1970-01-01T00:00:00Z');
                    const dateB = new Date(b.createdAt || '1970-01-01T00:00:00Z');
                    return dateB.getTime() - dateA.getTime();
                });

                const currentOrderIds = new Set(currentOrders.map(order => order._id.toString()));
                const newOrderIds = new Set([...currentOrderIds].filter(id => !_lastFetchedOrderIds.has(id)));

                if (newOrderIds.size > 0) {
                    console.log(`DEBUG: New orders detected! Count: ${newOrderIds.size}`);
                    _showMessage('üîî New order received! Refreshing data...', false);
                    _allOrders = currentOrders.map(order => {
                        let totalPrice = 0.0;
                        if (order.products && Array.isArray(order.products)) {
                            for (const productItem of order.products) {
                                const price = parseFloat(productItem.price) || 0.0;
                                const quantity = parseInt(productItem.quantity) || 0;
                                totalPrice += price * quantity;
                            }
                        }
                        return { ...order, totalPrice: totalPrice.toFixed(2) };
                    });
                    _applyAllFilters();
                } else {
                    console.log('DEBUG: No new orders detected.');
                }
                _lastFetchedOrderIds = currentOrderIds;
            } catch (e) {
                console.error('Error polling for new orders:', e);
            }
        }

        /**
         * Fetches users with the 'confirmation' role (agents) from the backend.
         */
        async function fetchAdmins() {
            try {
                const response = await fetch('https://sheeka.onrender.com/auth/users');
                if (response.status === 200) {
                    const fetchedUsers = await response.json();
                    _availableAgents = fetchedUsers.filter(user => user.role === 'confirmation').map(user => ({
                        id: user._id.toString(),
                        name: user.name.toString(),
                    }));
                    renderApp(); // Re-render to update dropdowns if needed
                } else if (response.status === 401) {
                    _handleUnauthorizedAccess();
                } else {
                    console.error(`Failed to load admins: ${response.status}`);
                }
            } catch (e) {
                console.error('Error fetching admins:', e);
            }
        }

        /**
         * Updates the status of a specific order on the backend.
         * @param {string} orderId - The ID of the order to update.
         * @param {string} status - The new status.
         * @param {string|null} assignedToId - The ID of the agent to assign, or null to unassign.
         */
        async function updateStatus(orderId, status, assignedToId = null) {
            console.log(`DEBUG: updateStatus called for Order ID: ${orderId}, new Status: ${status}`);
            const currentNotes = _orderNotes[orderId] || '';
            const requestBody = {
                status: status,
                notes: currentNotes
            };

            if (assignedToId !== null) {
                requestBody.assignedTo = assignedToId;
            } else if (['pending', 'tentative', 'cancelled'].includes(status)) {
                requestBody.assignedTo = null; // Unassign if status is reset
            }

            const token = _getTokenFromPrefs();
            if (!token) {
                _showMessage('Authentication token not found. Please log in.', true);
                return;
            }

            try {
                const response = await fetch(`https://sheeka.onrender.com/orders/${orderId}/status`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`,
                    },
                    body: JSON.stringify(requestBody),
                });

                if (response.ok) {
                    _showMessage(`Order status updated to ${status}`, false);
                    delete _orderNotes[orderId]; // Clear local note after saving to backend
                    // Assuming the backend returns the updated order
                    const responseData = await response.json();
                    const backendUpdatedOrder = responseData.order;
                    console.log('DEBUG: Backend updated order after status change:', backendUpdatedOrder.status);
                    _updateLocalOrderAndFilter(backendUpdatedOrder);
                } else if (response.status === 401) {
                    _handleUnauthorizedAccess();
                } else {
                    const errorBody = await response.json();
                    console.error('DEBUG: Failed to update status:', errorBody.message || response.status);
                    _showMessage(`Failed to update status: ${errorBody.message || response.status}`, true);
                }
            } catch (e) {
                console.error('DEBUG: Exception in updateStatus:', e);
                _showMessage(`Error updating status. Check your connection: ${e.message}`, true);
            }
        }

        /**
         * Prompts the user to enter Yalitec API credentials via a modal.
         * @returns {Promise<boolean>} True if credentials were successfully entered, false otherwise.
         */
        async function _promptForYalitecCredentials() {
            yalitecApiIdInput.value = _yalitecApiId || '';
            yalitecApiTokenInput.value = _yalitecApiToken || '';
            yalitecModal.style.display = 'flex'; // Show modal

            return new Promise(resolve => {
                const saveHandler = async () => {
                    const apiId = yalitecApiIdInput.value.trim();
                    const apiToken = yalitecApiTokenInput.value.trim();
                    if (apiId && apiToken) {
                        await _saveYalitecApiCredentials(apiId, apiToken);
                        yalitecModal.style.display = 'none';
                        saveYalitecBtn.removeEventListener('click', saveHandler);
                        cancelYalitecBtn.removeEventListener('click', cancelHandler);
                        resolve(true);
                    } else {
                        _showMessage('Both API ID and API Token are required.', true);
                    }
                };

                const cancelHandler = () => {
                    yalitecModal.style.display = 'none';
                    saveYalitecBtn.removeEventListener('click', saveHandler);
                    cancelYalitecBtn.removeEventListener('click', cancelHandler);
                    resolve(false);
                };

                saveYalitecBtn.addEventListener('click', saveHandler);
                cancelYalitecBtn.addEventListener('click', cancelHandler);
            });
        }

        /**
         * Dispatches a confirmed order to Yalitec API to create a parcel.
         * @param {object} order - The order object to dispatch.
         */
        async function _dispatchOrder(order) {
            console.log(`DEBUG: _dispatchOrder called for Order ID: ${order._id}`);

            if (!_areYalitecApiCredentialsLoaded) {
                _loadYalitecApiCredentials(); // Try loading from localStorage first
                if (!_areYalitecApiCredentialsLoaded) {
                    const credentialsEntered = await _promptForYalitecCredentials();
                    if (!credentialsEntered) {
                        _showMessage("ÿ•ÿ±ÿ≥ÿßŸÑ ÿßŸÑÿ∑ÿ±ÿØ ŸÖŸÑÿ∫Ÿâ: ŸÑŸÖ Ÿäÿ™ŸÖ ÿ™ŸàŸÅŸäÿ± ÿ®ŸäÿßŸÜÿßÿ™ ÿßÿπÿ™ŸÖÿßÿØ Yalitec.", true);
                        return;
                    }
                }
            }

            if (order.status !== 'confirmed') {
                _showMessage("ÿßŸÑÿ∑ŸÑÿ® Ÿäÿ¨ÿ® ÿ£ŸÜ ŸäŸÉŸàŸÜ 'ŸÖÿ§ŸÉÿØ' ŸÇÿ®ŸÑ ÿßŸÑÿ•ÿ±ÿ≥ÿßŸÑ.", true);
                console.log('DEBUG: Order status is not confirmed, aborting dispatch.');
                return;
            }

            isLoading = true;
            renderApp(); // Show loading indicator

            const token = _getTokenFromPrefs();
            if (!token) {
                _showMessage('Authentication token not found. Please log in.', true);
                isLoading = false;
                renderApp();
                return;
            }

            try {
                const orderId = order._id;
                const fullName = order.fullName || 'N/A';
                const firstName = fullName.split(' ').at(0) || 'N/A';
                const familyName = fullName.split(' ').length > 1 ? fullName.split(' ').slice(1).join(' ') : 'N/A';
                const phoneNumber = order.phoneNumber || 'N/A';
                const address = order.address || 'N/A';
                const toCommuneName = order.commune || 'N/A';
                const toWilayaName = order.wilaya || 'N/A';

                let productList = 'ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™: ';
                if (order.products && Array.isArray(order.products) && order.products.length > 0) {
                    productList += order.products.map(p => {
                        if (!p) return 'ŸÖŸÜÿ™ÿ¨ ÿ∫Ÿäÿ± ŸÖÿπÿ±ŸàŸÅ';
                        const pName = p.name?.toString() || 'ŸÖŸÜÿ™ÿ¨ ÿ∫Ÿäÿ± ŸÖÿπÿ±ŸàŸÅ';
                        const pQuantity = parseInt(p.quantity) || 1;
                        const pColor = p.color?.toString() || '';
                        const pSize = p.size?.toString() || '';
                        let productDetails = `${pName} x${pQuantity}`;
                        if (pColor && pColor !== 'N/A') productDetails += ` (Color: ${pColor})`;
                        if (pSize && pSize !== 'N/A') productDetails += ` (Size: ${pSize})`;
                        return productDetails;
                    }).join(', ');
                } else {
                    productList += 'ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÖŸÜÿ™ÿ¨ÿßÿ™';
                }

                const parsedTotalPrice = parseFloat(order.totalPrice || '0.0') || 0.0;
                const price = parseInt(parsedTotalPrice.toFixed(0)); // Convert to integer

                const length = 30;
                const width = 20;
                const height = 10;
                const weight = 1;

                console.log('DEBUG PAYLOAD PREP: orderId:', orderId);
                console.log('DEBUG PAYLOAD PREP: fullName:', fullName);
                console.log('DEBUG PAYLOAD PREP: phoneNumber:', phoneNumber);
                console.log('DEBUG PAYLOAD PREP: address:', address);
                console.log('DEBUG PAYLOAD PREP: toCommuneName:', toCommuneName, 'toWilayaName:', toWilayaName);
                console.log('DEBUG PAYLOAD PREP: Product List String:', productList);
                console.log('DEBUG PAYLOAD PREP: Calculated Price (integer for Yalitec):', price);
                console.log('DEBUG PAYLOAD PREP: declared_value:', price);
                console.log('DEBUG PAYLOAD PREP: freeshipping:', order.deliveryFee === 0);
                console.log('DEBUG PAYLOAD PREP: _yalitecApiId:', _yalitecApiId);
                console.log('DEBUG PAYLOAD PREP: _yalitecApiToken (first 5 chars):', _yalitecApiToken ? _yalitecApiToken.substring(0, Math.min(5, _yalitecApiToken.length)) : 'N/A');

                const parcelData = [{
                    "order_id": orderId,
                    "from_wilaya_name": _shopOriginWilayaName,
                    "firstname": firstName,
                    "familyname": familyName,
                    "contact_phone": phoneNumber,
                    "address": address,
                    "to_commune_name": toCommuneName,
                    "to_wilaya_name": toWilayaName,
                    "product_list": productList,
                    "price": price,
                    "do_insurance": false,
                    "declared_value": price,
                    "height": height,
                    "width": width,
                    "length": length,
                    "weight": weight,
                    "freeshipping": order.deliveryFee === 0,
                    "is_stopdesk": false,
                    "has_exchange": false,
                }];

                console.log('DEBUG: Sending parcelData to Yalitec:', JSON.stringify(parcelData));

                const response = await fetch('https://api.yalitec.me/v1/parcels', {
                    method: 'POST',
                    headers: {
                        'X-API-ID': _yalitecApiId,
                        'X-API-TOKEN': _yalitecApiToken,
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`, // Your app's token for backend communication if needed
                    },
                    body: JSON.stringify(parcelData),
                });

                const responseBody = await response.text();
                console.log('DEBUG: Yalitec API Response Status:', response.status);
                console.log('DEBUG: Yalitec API Response Body:', responseBody);

                let decodedResponse;
                try {
                    decodedResponse = JSON.parse(responseBody);
                } catch (e) {
                    console.error('Error decoding JSON response from Yalitec:', e);
                    _showMessage(`‚ùå ŸÅÿ¥ŸÑ ÿ•ÿ±ÿ≥ÿßŸÑ ÿßŸÑÿ∑ÿ±ÿØ: ÿßÿ≥ÿ™ÿ¨ÿßÿ®ÿ© ÿ∫Ÿäÿ± ÿµÿßŸÑÿ≠ÿ© ŸÖŸÜ Yalitec. ÿßŸÑÿ≠ÿßŸÑÿ©: ${response.status}`, true);
                    return;
                }

                const orderResponse = decodedResponse?.[orderId];

                if (response.ok) {
                    if (orderResponse && orderResponse.success === true) {
                        _showMessage(`‚úÖ ÿ™ŸÖ ÿ•ÿ±ÿ≥ÿßŸÑ ÿßŸÑÿ∑ÿ±ÿØ ÿ®ŸÜÿ¨ÿßÿ≠! ÿ±ŸÇŸÖ ÿßŸÑÿ™ÿ™ÿ®ÿπ: ${orderResponse.tracking}`, false);
                        // Update order status to 'dispatched' locally
                        const index = _allOrders.findIndex(o => o._id === orderId);
                        if (index !== -1) {
                            _allOrders[index].status = 'dispatched';
                            console.log(`DEBUG: Locally updated order ${orderId} to status dispatched after successful Yalitec dispatch.`);
                        } else {
                            console.log(`DEBUG: Order ${orderId} not found in local _allOrders for dispatch status update. Refetching all orders.`);
                            fetchOrders(); // Fallback to refetch all
                        }
                        _applyAllFilters();
                    } else {
                        const yalitecError = orderResponse?.message || 'ÿÆÿ∑ÿ£ ÿ∫Ÿäÿ± ŸÖÿπÿ±ŸàŸÅ ŸÖŸÜ Yalitec.';
                        _showMessage(`‚ùå ŸÅÿ¥ŸÑ ÿ•ÿ±ÿ≥ÿßŸÑ ÿßŸÑÿ∑ÿ±ÿØ: ${yalitecError}`, true);
                        console.log('DEBUG: Yalitec API returned non-success:', yalitecError);
                    }
                } else if (response.status === 401) {
                    _showMessage('‚ùå Yalitec API authentication failed. Check your API ID and Token in settings.', true);
                    console.log('DEBUG: Yalitec API 401: Check API ID/Token.');
                } else {
                    _showMessage(`‚ùå ŸÅÿ¥ŸÑ ÿ•ÿ±ÿ≥ÿßŸÑ ÿßŸÑÿ∑ÿ±ÿØ. ÿßŸÑÿ≠ÿßŸÑÿ©: ${response.status}, ÿßŸÑÿßÿ≥ÿ™ÿ¨ÿßÿ®ÿ©: ${responseBody}`, true);
                    console.log(`DEBUG: Yalitec API failed with status ${response.status}: ${responseBody}`);
                }
            } catch (e) {
                _showMessage(`‚ùå ÿÆÿ∑ÿ£ ÿ£ÿ´ŸÜÿßÿ° ÿ•ÿ±ÿ≥ÿßŸÑ ÿßŸÑÿ∑ÿ±ÿØ: ${e.message}`, true);
                console.error('DEBUG: Exception during Yalitec dispatch:', e);
            } finally {
                isLoading = false;
                renderApp();
            }
        }

        /**
         * Handles editing an order's details, including assigning an agent.
         * @param {object} order - The order object to edit.
         */
        async function _editOrder(order) {
            currentEditingOrderId = order._id;
            editFullNameInput.value = order.fullName || '';
            editPhoneNumberInput.value = order.phoneNumber || '';
            editWilayaInput.value = order.wilaya || '';
            editCommuneInput.value = order.commune || '';
            editNotesInput.value = _orderNotes[order._id] || order.notes || '';

            // Populate assigned agent dropdown
            editAssignedToSelect.innerHTML = '<option value="">None</option>';
            _availableAgents.forEach(agent => {
                const option = document.createElement('option');
                option.value = agent.id;
                option.textContent = agent.name;
                editAssignedToSelect.appendChild(option);
            });
            editAssignedToSelect.value = order.assignedTo?._id || '';

            if (_currentUserRole === "admin") {
                assignedAgentDropdownContainer.classList.remove('hidden');
            } else {
                assignedAgentDropdownContainer.classList.add('hidden');
            }

            editOrderModal.style.display = 'flex';

            return new Promise(resolve => {
                const saveHandler = async () => {
                    const updatedData = {
                        fullName: editFullNameInput.value,
                        phoneNumber: editPhoneNumberInput.value,
                        wilaya: editWilayaInput.value,
                        commune: editCommuneInput.value,
                        notes: editNotesInput.value,
                        assignedTo: editAssignedToSelect.value || null, // Send null if 'None' is selected
                    };

                    const token = _getTokenFromPrefs();
                    if (!token) {
                        _showMessage('Authentication token not found. Please log in.', true);
                        resolve(false);
                        return;
                    }

                    try {
                        const response = await fetch(`https://sheeka.onrender.com/orders/${currentEditingOrderId}`, {
                            method: 'PATCH',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${token}`,
                            },
                            body: JSON.stringify(updatedData),
                        });

                        if (response.ok) {
                            _showMessage('Order details updated successfully!', false);
                            const backendUpdatedOrder = (await response.json()).order;
                            _updateLocalOrderAndFilter(backendUpdatedOrder);
                            editOrderModal.style.display = 'none';
                            resolve(true);
                        } else if (response.status === 401) {
                            _handleUnauthorizedAccess();
                            editOrderModal.style.display = 'none';
                            resolve(false);
                        } else {
                            const errorBody = await response.json();
                            _showMessage(`Failed to update order: ${errorBody.message || response.status}`, true);
                            resolve(false);
                        }
                    } catch (e) {
                        _showMessage(`Error updating order. Check your connection: ${e.message}`, true);
                        resolve(false);
                    }
                };

                const cancelHandler = () => {
                    editOrderModal.style.display = 'none';
                    resolve(false);
                };

                saveEditBtn.onclick = saveHandler;
                cancelEditBtn.onclick = cancelHandler;
            });
        }

        /**
         * Handles deleting an order after user confirmation.
         * @param {string} orderId - The ID of the order to delete.
         */
        async function _deleteOrder(orderId) {
            currentDeletingOrderId = orderId;
            confirmDeleteModal.style.display = 'flex'; // Show confirmation modal

            return new Promise(resolve => {
                const confirmHandler = async () => {
                    const token = _getTokenFromPrefs();
                    if (!token) {
                        _showMessage('Authentication token not found. Please log in.', true);
                        confirmDeleteModal.style.display = 'none';
                        resolve(false);
                        return;
                    }

                    try {
                        const response = await fetch(`https://sheeka.onrender.com/orders/${orderId}`, {
                            method: 'DELETE',
                            headers: {
                                'Authorization': `Bearer ${token}`,
                            },
                        });

                        if (response.ok) {
                            _showMessage('Order deleted successfully!', false);
                            _allOrders = _allOrders.filter(order => order._id !== orderId);
                            delete _orderNotes[orderId];
                            _applyAllFilters();
                            confirmDeleteModal.style.display = 'none';
                            resolve(true);
                        } else if (response.status === 401) {
                            _handleUnauthorizedAccess();
                            confirmDeleteModal.style.display = 'none';
                            resolve(false);
                        } else {
                            const errorBody = await response.json();
                            _showMessage(`Failed to delete order: ${errorBody.message || response.status}`, true);
                            confirmDeleteModal.style.display = 'none';
                            resolve(false);
                        }
                    } catch (e) {
                        _showMessage(`Error deleting order. Check your connection: ${e.message}`, true);
                        confirmDeleteModal.style.display = 'none';
                        resolve(false);
                    }
                };

                const cancelHandler = () => {
                    confirmDeleteModal.style.display = 'none';
                    resolve(false);
                };

                confirmDeleteBtn.onclick = confirmHandler;
                cancelDeleteBtn.onclick = cancelHandler;
            });
        }

        /**
         * Helper to update the local order list and re-apply all filters after backend operations.
         * @param {object} updatedOrder - The updated order object from the backend.
         */
        function _updateLocalOrderAndFilter(updatedOrder) {
            console.log(`DEBUG: _updateLocalOrderAndFilter called for order ${updatedOrder._id} with status ${updatedOrder.status}`);
            const index = _allOrders.findIndex(order => order._id === updatedOrder._id);
            if (index !== -1) {
                _allOrders[index] = updatedOrder;
                // Re-sort the entire list to maintain newest-first order
                _allOrders.sort((a, b) => {
                    const dateA = new Date(a.createdAt || '1970-01-01T00:00:00Z');
                    const dateB = new Date(b.createdAt || '1970-01-01T00:00:00Z');
                    return dateB.getTime() - dateA.getTime();
                });
                console.log(`DEBUG: Local _allOrders updated for ${updatedOrder._id} to status ${updatedOrder.status}`);
                _applyAllFilters();
            } else {
                console.log(`DEBUG: Order ${updatedOrder._id} not found in local _allOrders. Refetching all orders.`);
                fetchOrders(); // If not found, refetch all to ensure consistency
            }
        }

        /**
         * Generates a PDF document of the currently filtered orders and allows sharing it.
         */
        async function _generateFilteredOrdersPdf() {
            // Ensure jsPDF is loaded
            if (typeof window.jspdf === 'undefined' || typeof window.jspdf.jsPDF === 'undefined') {
                _showMessage('PDF generation library not loaded. Please try again or check your internet connection.', true);
                return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            const now = new Date();
            const formattedDate = new Intl.DateTimeFormat('en-US', {
                year: 'numeric', month: '2-digit', day: '2-digit',
                hour: '2-digit', minute: '2-digit', hour12: false
            }).format(now);

            doc.setFontSize(28);
            doc.text('OrderWise', doc.internal.pageSize.width / 2, 20, { align: 'center' });
            doc.setFontSize(22);
            doc.text('Orders Report', doc.internal.pageSize.width / 2, 30, { align: 'center' });
            doc.setFontSize(12);
            doc.setTextColor(100); // Grey color
            doc.text(`Generated On: ${formattedDate}`, doc.internal.pageSize.width / 2, 38, { align: 'center' });
            doc.setTextColor(0); // Black color

            if (_filteredOrders.length === 0) {
                doc.setFontSize(14);
                doc.text('No orders matching current filters to generate report.', doc.internal.pageSize.width / 2, 80, { align: 'center' });
            } else {
                const tableColumn = ['Name', 'Phone Number', 'Price', 'Order ID', 'Assigned To', 'Status'];
                const tableRows = _filteredOrders.map(order => {
                    const assignedAgentName = order.assignedTo?.name || 'Unassigned';
                    return [
                        order.fullName || 'N/A',
                        order.phoneNumber || 'N/A',
                        `DZD${order.totalPrice || '0.00'}`,
                        order._id || 'N/A',
                        assignedAgentName,
                        order.status || 'N/A',
                    ];
                });

                doc.autoTable({
                    head: [tableColumn],
                    body: tableRows,
                    startY: 60,
                    theme: 'grid',
                    headStyles: { fillColor: [200, 200, 200], textColor: [0, 0, 0], fontStyle: 'bold' },
                    styles: { cellPadding: 8, fontSize: 10, textColor: [0, 0, 0] },
                    columnStyles: {
                        0: { cellWidth: 'auto' },
                        1: { cellWidth: 'auto' },
                        2: { cellWidth: 'auto' },
                        3: { cellWidth: 'auto' },
                        4: { cellWidth: 'auto' },
                        5: { cellWidth: 'auto' },
                    },
                });
            }

            // Footer
            const pageHeight = doc.internal.pageSize.height;
            doc.line(20, pageHeight - 40, doc.internal.pageSize.width - 20, pageHeight - 40); // Horizontal line
            doc.setFontSize(12);
            doc.text('_________________________', doc.internal.pageSize.width - 60, pageHeight - 30, { align: 'right' });
            doc.setFontSize(10);
            doc.text('Authorized Signature', doc.internal.pageSize.width - 60, pageHeight - 25, { align: 'right' });
            doc.text('_________________________', doc.internal.pageSize.width - 60, pageHeight - 15, { align: 'right' });
            doc.setFontSize(10);
            doc.text('Printed Name', doc.internal.pageSize.width - 60, pageHeight - 10, { align: 'right' });


            try {
                // For web, we can open in a new tab or trigger a download
                doc.save('orders_report.pdf');
                _showMessage('PDF generated successfully!', false);
            } catch (e) {
                console.error('Error generating PDF:', e);
                _showMessage(`Failed to generate PDF: ${e.message}`, true);
            }
        }

        /**
         * Generates and displays a report of order statistics per assigned agent.
         */
        function _generateAgentStatsReport() {
            let agentStats = {};

            // Initialize stats for all available agents
            _availableAgents.forEach(agent => {
                agentStats[agent.id] = {
                    agentName: agent.name,
                    pending: 0,
                    confirmed: 0,
                    cancelled: 0,
                    tentative: 0,
                    dispatched: 0,
                    totalAssigned: 0,
                };
            });

            // Filter orders by date range before processing for agents
            let ordersForReport = [..._allOrders];
            const now = new Date();

            const todayUtcStart = new Date(Date.UTC(now.getFullYear(), now.getMonth(), now.getDate()));
            const thisWeekUtcStart = new Date(Date.UTC(now.getFullYear(), now.getMonth(), now.getDate() - (now.getDay() === 0 ? 6 : now.getDay() - 1)));
            const thisMonthUtcStart = new Date(Date.UTC(now.getFullYear(), now.getMonth(), 1));

            ordersForReport = ordersForReport.filter(order => {
                let createdAt;
                try {
                    const createdAtString = order.createdAt?.toString();
                    if (createdAtString && createdAtString.length > 0) {
                        createdAt = new Date(createdAtString);
                    } else {
                        createdAt = new Date(0);
                    }
                } catch (e) {
                    createdAt = new Date(0);
                    console.error(`Error parsing createdAt date: ${e} for order: ${order._id || 'unknown_id'}. Treating as UTC epoch 0.`);
                }

                let matchesDateRange = true;
                if (_currentDateFilter === 'today') {
                    matchesDateRange = createdAt.getTime() >= todayUtcStart.getTime() &&
                                       createdAt.getTime() < new Date(todayUtcStart.getTime() + 24 * 60 * 60 * 1000).getTime();
                } else if (_currentDateFilter === 'thisWeek') {
                    matchesDateRange = createdAt.getTime() >= thisWeekUtcStart.getTime() &&
                                       createdAt.getTime() < new Date(thisWeekUtcStart.getTime() + 7 * 24 * 60 * 60 * 1000).getTime();
                } else if (_currentDateFilter === 'thisMonth') {
                    matchesDateRange = createdAt.getTime() >= thisMonthUtcStart.getTime() &&
                                       createdAt.getTime() < new Date(Date.UTC(now.getFullYear(), now.getMonth() + 1, 1)).getTime();
                } else if (_currentDateFilter === 'custom') {
                    if (_customStartDate && _customEndDate) {
                        const customStartUtc = new Date(Date.UTC(_customStartDate.getFullYear(), _customStartDate.getMonth(), _customStartDate.getDate()));
                        const customEndUtc = new Date(Date.UTC(_customEndDate.getFullYear(), _customEndDate.getMonth(), _customEndDate.getDate()));
                        matchesDateRange = (createdAt.getTime() >= customStartUtc.getTime() &&
                                            createdAt.getTime() < new Date(customEndUtc.getTime() + 24 * 60 * 60 * 1000).getTime());
                    } else {
                        matchesDateRange = false;
                    }
                }
                return matchesDateRange;
            });

            for (const order of ordersForReport) {
                if (order.assignedTo && order.assignedTo._id) {
                    const agentId = order.assignedTo._id.toString();
                    const agentName = order.assignedTo.name?.toString() || 'Unknown Agent';

                    if (!agentStats[agentId]) {
                        agentStats[agentId] = {
                            agentName: agentName,
                            pending: 0,
                            confirmed: 0,
                            cancelled: 0,
                            tentative: 0,
                            dispatched: 0,
                            totalAssigned: 0,
                        };
                    }

                    agentStats[agentId].totalAssigned++;

                    switch (order.status) {
                        case 'pending': agentStats[agentId].pending++; break;
                        case 'confirmed': agentStats[agentId].confirmed++; break;
                        case 'cancelled': agentStats[agentId].cancelled++; break;
                        case 'tentative': agentStats[agentId].tentative++; break;
                        case 'dispatched': agentStats[agentId].dispatched++; break;
                        default: break;
                    }
                }
            }

            let dateRangeText;
            if (_currentDateFilter === 'allTime') {
                dateRangeText = 'All Time';
            } else if (_currentDateFilter === 'today') {
                dateRangeText = `Today (${new Intl.DateTimeFormat('en-US').format(now)})`;
            } else if (_currentDateFilter === 'thisWeek') {
                const startOfWeek = new Date(now);
                startOfWeek.setDate(now.getDate() - (now.getDay() === 0 ? 6 : now.getDay() - 1));
                dateRangeText = `This Week (starting ${new Intl.DateTimeFormat('en-US').format(startOfWeek)})`;
            } else if (_currentDateFilter === 'thisMonth') {
                dateRangeText = `This Month (${new Intl.DateTimeFormat('en-US', { month: 'long' }).format(now)})`;
            } else if (_currentDateFilter === 'custom' && _customStartDate && _customEndDate) {
                dateRangeText = `Custom: ${new Intl.DateTimeFormat('en-US').format(_customStartDate)} to ${new Intl.DateTimeFormat('en-US').format(_customEndDate)}`;
            } else {
                dateRangeText = 'Current Filters';
            }

            agentReportTitle.textContent = `Agent Performance Report (${dateRangeText})`;
            agentReportContent.innerHTML = '';

            if (Object.keys(agentStats).length === 0) {
                agentReportContent.innerHTML = '<p class="text-gray-700">No agents found with assigned orders for the current filters.</p>';
            } else {
                for (const agentId in agentStats) {
                    const stats = agentStats[agentId];
                    const card = document.createElement('div');
                    card.className = 'bg-white p-4 rounded-lg shadow-md mb-4';
                    card.innerHTML = `
                        <h4 class="text-lg font-bold text-blue-800 mb-2">Agent: ${stats.agentName}</h4>
                        <div class="border-t border-gray-200 pt-2 mt-2">
                            <div class="flex justify-between py-1">
                                <span class="text-gray-700">Total Assigned:</span>
                                <span class="font-semibold text-blue-800">${stats.totalAssigned}</span>
                            </div>
                            <div class="flex justify-between py-1">
                                <span class="text-gray-700">Confirmed:</span>
                                <span class="font-semibold text-green-700">${stats.confirmed}</span>
                            </div>
                            <div class="flex justify-between py-1">
                                <span class="text-gray-700">Pending:</span>
                                <span class="font-semibold text-indigo-700">${stats.pending}</span>
                            </div>
                            <div class="flex justify-between py-1">
                                <span class="text-gray-700">Tentative:</span>
                                <span class="font-semibold text-orange-700">${stats.tentative}</span>
                            </div>
                            <div class="flex justify-between py-1">
                                <span class="text-gray-700">Dispatched:</span>
                                <span class="font-semibold text-blue-700">${stats.dispatched}</span>
                            </div>
                            <div class="flex justify-between py-1">
                                <span class="text-gray-700">Cancelled:</span>
                                <span class="font-semibold text-red-700">${stats.cancelled}</span>
                            </div>
                        </div>
                    `;
                    agentReportContent.appendChild(card);
                }
            }
            agentReportPage.classList.remove('hidden');
        }


        // --- Rendering Functions ---

        /**
         * Main function to render the entire UI based on current state.
         */
        function renderApp() {
            // Toggle loading indicator
            if (isLoading) {
                loadingIndicator.classList.remove('hidden');
                ordersListContainer.classList.add('hidden');
                noOrdersMessage.classList.add('hidden');
            } else {
                loadingIndicator.classList.add('hidden');
                if (_filteredOrders.length === 0) {
                    noOrdersMessage.classList.remove('hidden');
                    ordersListContainer.classList.add('hidden');
                    noOrdersMessage.textContent = `No ${_currentFilter === 'all' ? '' : _currentFilter} orders found for the current filters.`;
                } else {
                    noOrdersMessage.classList.add('hidden');
                    ordersListContainer.classList.remove('hidden');
                }
            }

            renderDateFilterButtons();
            renderStatusFilterButtons();
            renderOrderList();
        }

        /**
         * Renders the date filter buttons.
         */
        function renderDateFilterButtons() {
            dateFiltersContainer.innerHTML = ''; // Clear existing buttons

            const dateFilters = [
                { text: 'All Time', value: 'allTime' },
                { text: 'Today', value: 'today' },
                { text: 'This Week', value: 'thisWeek' },
                { text: 'This Month', value: 'thisMonth' },
            ];

            dateFilters.forEach(filter => {
                const button = document.createElement('button');
                button.textContent = filter.text;
                button.className = `px-4 py-2 rounded-lg font-semibold transition-colors duration-200 ${
                    _currentDateFilter === filter.value
                        ? 'bg-black text-white shadow-md'
                        : 'bg-gray-200 text-gray-800 border border-gray-300 hover:bg-gray-300'
                }`;
                button.onclick = () => {
                    _currentDateFilter = filter.value;
                    _customStartDate = null;
                    _customEndDate = null;
                    _applyAllFilters();
                };
                dateFiltersContainer.appendChild(button);
            });

            // Custom Range button
            const customButton = document.createElement('button');
            customButton.textContent = (_currentDateFilter === 'custom' && _customStartDate && _customEndDate)
                ? `Custom: ${_formatDate(_customStartDate.toISOString()).split(' ')[0]} to ${_formatDate(_customEndDate.toISOString()).split(' ')[0]}`
                : 'Custom Range';
            customButton.className = `px-4 py-2 rounded-lg font-semibold transition-colors duration-200 ${
                _currentDateFilter === 'custom'
                    ? 'bg-black text-white shadow-md'
                    : 'bg-gray-200 text-gray-800 border border-gray-300 hover:bg-gray-300'
            } text-sm whitespace-nowrap overflow-hidden text-ellipsis max-w-[150px]`; // Added max-width for smaller screens
            customButton.onclick = async () => {
                const datePickerOptions = {
                    mode: 'date', // Only date picker
                    // Add min/max date if needed
                };

                // Simulate date picker for start date
                const newStartDateInput = document.createElement('input');
                newStartDateInput.type = 'date';
                newStartDateInput.value = _customStartDate ? _customStartDate.toISOString().split('T')[0] : '';
                newStartDateInput.style.position = 'absolute'; // Position off-screen
                newStartDateInput.style.left = '-9999px';
                newStartDateInput.style.top = '-9999px';
                document.body.appendChild(newStartDateInput);

                newStartDateInput.onchange = async () => {
                    const newStartDate = newStartDateInput.value ? new Date(newStartDateInput.value + 'T00:00:00Z') : null;
                    document.body.removeChild(newStartDateInput);

                    if (newStartDate) {
                        const newEndDateInput = document.createElement('input');
                        newEndDateInput.type = 'date';
                        newEndDateInput.value = _customEndDate ? _customEndDate.toISOString().split('T')[0] : (newStartDate.toISOString().split('T')[0]);
                        newEndDateInput.min = newStartDate.toISOString().split('T')[0]; // End date cannot be before start date
                        newEndDateInput.style.position = 'absolute';
                        newEndDateInput.style.left = '-9999px';
                        newEndDateInput.style.top = '-9999px';
                        document.body.appendChild(newEndDateInput);

                        newEndDateInput.onchange = () => {
                            const newEndDate = newEndDateInput.value ? new Date(newEndDateInput.value + 'T00:00:00Z') : null;
                            document.body.removeChild(newEndDateInput);

                            if (newEndDate) {
                                _currentDateFilter = 'custom';
                                _customStartDate = newStartDate;
                                _customEndDate = newEndDate;
                                _applyAllFilters();
                            }
                        };
                        newEndDateInput.click(); // Trigger the date picker
                    }
                };
                newStartDateInput.click(); // Trigger the date picker
            };
            dateFiltersContainer.appendChild(customButton);

            if (_currentDateFilter === 'custom' || _customStartDate !== null || _customEndDate !== null) {
                const clearCustomButton = document.createElement('button');
                clearCustomButton.textContent = 'Clear Custom';
                clearCustomButton.className = 'px-4 py-2 rounded-lg font-semibold transition-colors duration-200 bg-red-600 text-white shadow-md hover:bg-red-700';
                clearCustomButton.onclick = () => {
                    _customStartDate = null;
                    _customEndDate = null;
                    _currentDateFilter = 'allTime';
                    _applyAllFilters();
                };
                dateFiltersContainer.appendChild(clearCustomButton);
            }
        }

        /**
         * Renders the status filter buttons.
         */
        function renderStatusFilterButtons() {
            statusFiltersContainer.innerHTML = ''; // Clear existing buttons

            const statusFilters = [
                { text: 'New', value: 'pending', count: _pendingOrdersCount, color: 'bg-black text-white' },
                { text: 'All', value: 'all', count: _allOrdersCount, color: 'bg-black text-white' },
                { text: 'Confirmed', value: 'confirmed', count: _confirmedOrdersCount, color: 'bg-green-600 text-white' },
                { text: 'Cancelled', value: 'cancelled', count: _cancelledOrdersCount, color: 'bg-red-600 text-white' },
                { text: 'Tentative', value: 'tentative', count: _tentativeOrdersCount, color: 'bg-orange-600 text-white' },
                { text: 'Dispatched', value: 'dispatched', count: _dispatchedOrdersCount, color: 'bg-blue-600 text-white' },
            ];

            statusFilters.forEach(filter => {
                const button = document.createElement('button');
                button.textContent = `${filter.text} (${filter.count})`;
                button.className = `px-4 py-2 rounded-lg font-semibold transition-colors duration-200 ${
                    _currentFilter === filter.value
                        ? filter.color + ' shadow-md'
                        : 'bg-gray-200 text-gray-800 border border-gray-300 hover:bg-gray-300'
                }`;
                button.onclick = () => {
                    _currentFilter = filter.value;
                    _applyAllFilters();
                };
                statusFiltersContainer.appendChild(button);
            });
        }

        /**
         * Renders the list of filtered orders.
         */
        function renderOrderList() {
            ordersListContainer.innerHTML = ''; // Clear existing cards

            _filteredOrders.forEach(order => {
                const orderCard = document.createElement('div');
                // Changed background to white and adjusted text colors for readability
                orderCard.className = 'bg-white rounded-xl shadow-lg p-4 mb-4 text-gray-900';
                orderCard.setAttribute('data-order-id', order._id); // For easy lookup

                const createdAt = new Date(order.createdAt || '1970-01-01T00:00:00Z');
                const formattedTime = _formatDate(createdAt.toISOString());
                const statusColorClass = _getStatusColorClass(order.status);
                const statusBgColorClass = _getStatusBgColorClass(order.status);

                let isExpanded = false; // Initial state for each card

                orderCard.innerHTML = `
                    <div class="flex justify-between items-center mb-3">
                        <div class="flex-1">
                            <p class="font-bold text-lg">üë§ ${order.fullName || 'N/A'}</p>
                            <p class="text-sm text-gray-600">üì± ${order.phoneNumber || 'N/A'}</p>
                        </div>
                        <div class="text-right">
                            <p class="text-xs text-gray-500">${formattedTime}</p>
                            <div class="mt-2 px-2 py-1 rounded-full text-xs font-semibold ${statusBgColorClass} ${statusColorClass.replace('text-', 'border-')}" style="border-width: 1px;">
                                üì¶ Status: ${order.status || 'N/A'}
                            </div>
                        </div>
                    </div>
                    <div class="flex justify-center">
                        <button class="expand-toggle-btn p-1 rounded-full hover:bg-gray-200 transition-colors duration-200">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-700" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
                            </svg>
                        </button>
                    </div>
                    <div class="expanded-content hidden">
                        <hr class="border-gray-300 my-4">
                        <p class="text-sm text-gray-700">üìç ${order.wilaya || 'N/A'} - ${order.commune || 'N/A'}</p>
                        ${order.assignedTo && order.assignedTo.name ? `<p class="text-sm text-teal-700 mt-2">ü§ù Assigned To: ${order.assignedTo.name}</p>` : ''}
                        <h4 class="font-bold text-base mt-4">üõçÔ∏è Products:</h4>
                        <ul class="list-disc list-inside ml-3 text-sm text-gray-800">
                            ${order.products && Array.isArray(order.products) && order.products.length > 0
                                ? order.products.map(p => `
                                    <li>
                                        ${p.name || 'N/A'}
                                        <ul class="list-none ml-4 text-gray-700">
                                            <li>Quantity: ${p.quantity || 'N/A'}</li>
                                            <li>Color: ${p.color || 'N/A'}</li>
                                            <li>Size: ${p.size || 'N/A'}</li>
                                        </ul>
                                    </li>
                                `).join('')
                                : '<li>No products listed.</li>'
                            }
                        </ul>
                        <p class="text-right font-bold text-lg text-teal-700 mt-4">Total Price: DZD${order.totalPrice || 'N/A'}</p>

                        <div class="mt-4">
                            <label for="notes-${order._id}" class="block text-sm font-medium text-gray-700 mb-1">Agent Notes</label>
                            <textarea id="notes-${order._id}" rows="2" class="w-full p-2 rounded-md bg-gray-100 text-gray-900 border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-400"
                                oninput="updateOrderNote('${order._id}', this.value)">${_orderNotes[order._id] || order.notes || ''}</textarea>
                        </div>

                        ${_currentFilter !== 'dispatched' ? `
                        <div class="flex flex-wrap justify-between items-center mt-4 space-y-2 sm:space-y-0">
                            <div class="flex space-x-2 w-full sm:w-auto">
                                <button onclick="_editOrder(${JSON.stringify(order).replace(/'/g, '&apos;')})" class="px-3 py-2 border border-gray-400 text-gray-800 rounded-md hover:bg-gray-200 transition-colors duration-200 flex items-center text-sm">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
                                    </svg>
                                    Edit
                                </button>
                                <button onclick="_deleteOrder('${order._id}')" class="px-3 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition-colors duration-200 flex items-center text-sm">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                    </svg>
                                    Delete
                                </button>
                            </div>
                            <div class="flex flex-wrap justify-end space-x-2 w-full sm:w-auto mt-2 sm:mt-0">
                                ${((order.status === 'pending' || order.status === 'tentative') && (_currentUserRole === 'admin' || (order.assignedTo?._id === _currentUserId && _currentUserRole === 'confirmation'))) ? `
                                <button onclick="updateStatus('${order._id}', 'confirmed')" class="px-3 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition-colors duration-200 text-sm">Confirm</button>
                                ` : ''}
                                ${order.status !== 'cancelled' && ((_currentUserRole === 'admin' || (order.assignedTo?._id === _currentUserId && _currentUserRole === 'confirmation'))) ? `
                                <button onclick="updateStatus('${order._id}', 'cancelled')" class="px-3 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition-colors duration-200 text-sm">Cancel</button>
                                ` : ''}
                                ${order.status !== 'tentative' && ((_currentUserRole === 'admin' || (order.assignedTo?._id === _currentUserId && _currentUserRole === 'confirmation'))) ? `
                                <button onclick="updateStatus('${order._id}', 'tentative')" class="px-3 py-2 bg-orange-600 text-white rounded-md hover:bg-orange-700 transition-colors duration-200 text-sm">Tentative</button>
                                ` : ''}
                                ${order.status === 'confirmed' && ((_currentUserRole === 'admin' || (order.assignedTo?._id === _currentUserId && _currentUserRole === 'confirmation'))) ? `
                                <button onclick="_dispatchOrder(${JSON.stringify(order).replace(/'/g, '&apos;')})" class="px-3 py-2 bg-blue-800 text-white rounded-md hover:bg-blue-900 transition-colors duration-200 text-sm">Dispatch</button>
                                ` : ''}
                            </div>
                        </div>
                        ` : ''}
                    </div>
                `;

                ordersListContainer.appendChild(orderCard);

                // Add event listener for expand/collapse button
                const toggleBtn = orderCard.querySelector('.expand-toggle-btn');
                const expandedContent = orderCard.querySelector('.expanded-content');
                toggleBtn.addEventListener('click', () => {
                    isExpanded = !isExpanded;
                    expandedContent.classList.toggle('hidden', !isExpanded);
                    toggleBtn.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-700" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="${isExpanded ? 'M5 15l7-7 7 7' : 'M19 9l-7 7-7-7'}" />
                        </svg>
                    `;
                });
            });
        }

        /**
         * Updates the local order note and saves to localStorage.
         * This function is called directly from the HTML `oninput` event.
         * @param {string} orderId - The ID of the order.
         * @param {string} value - The new note value.
         */
        function updateOrderNote(orderId, value) {
            _orderNotes[orderId] = value;
            localStorage.setItem('orderNotes', JSON.stringify(_orderNotes));
        }

        /**
         * Renders the order summary report page.
         */
        function renderOrderReportPage() {
            reportContent.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="bg-blue-50 p-4 rounded-lg flex items-center shadow-sm">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-blue-700 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0h.01M9 19H7a2 2 0 01-2-2v-6a2 2 0 012-2h2m3 0h.01M12 7v3m0 0l3-3m-3 3l-3-3m-3 3v6a2 2 0 002 2h2a2 2 0 002-2v-6a2 2 0 00-2-2z" />
                        </svg>
                        <div>
                            <p class="text-gray-700">Total Orders (within filter)</p>
                            <p class="text-2xl font-bold text-blue-800">${_allOrdersCount}</p>
                        </div>
                    </div>
                    <div class="bg-orange-50 p-4 rounded-lg flex items-center shadow-sm">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-orange-700 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        <div>
                            <p class="text-gray-700">Pending Orders</p>
                            <p class="text-2xl font-bold text-orange-800">${_pendingOrdersCount}</p>
                        </div>
                    </div>
                    <div class="bg-green-50 p-4 rounded-lg flex items-center shadow-sm">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-green-700 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        <div>
                            <p class="text-gray-700">Confirmed Orders</p>
                            <p class="text-2xl font-bold text-green-800">${_confirmedOrdersCount}</p>
                        </div>
                    </div>
                    <div class="bg-yellow-50 p-4 rounded-lg flex items-center shadow-sm">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-yellow-700 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M8.228 9.247a.75.75 0 01.968-.08l2.25 1.5A.75.75 0 0112 10.5v-1.5a.75.75 0 011.5 0v1.5a.75.75 0 01.293.597l2.25 1.5a.75.75 0 01-.08.968l-1.5 2.25A.75.75 0 0112 16.5v1.5a.75.75 0 01-1.5 0v-1.5a.75.75 0 01-.293-.597l-2.25-1.5a.75.75 0 01.08-.968l1.5-2.25z" />
                        </svg>
                        <div>
                            <p class="text-gray-700">Tentative Orders</p>
                            <p class="text-2xl font-bold text-yellow-800">${_tentativeOrdersCount}</p>
                        </div>
                    </div>
                    <div class="bg-red-50 p-4 rounded-lg flex items-center shadow-sm">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-red-700 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M10 14L2 6m0 0l8 8m-8-8h8m-8 0L2 14m14 4l-4-4m4 4l-4-4m4 4v-4m4 4h-4" />
                        </svg>
                        <div>
                            <p class="text-gray-700">Cancelled Orders</p>
                            <p class="text-2xl font-bold text-red-800">${_cancelledOrdersCount}</p>
                        </div>
                    </div>
                    <div class="bg-indigo-50 p-4 rounded-lg flex items-center shadow-sm">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-indigo-700 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4" />
                        </svg>
                        <div>
                            <p class="text-gray-700">Dispatched Orders</p>
                            <p class="text-2xl font-bold text-indigo-800">${_dispatchedOrdersCount}</p>
                        </div>
                    </div>
                </div>
            `;
            orderReportPage.classList.remove('hidden');
        }

        // --- Event Listeners ---

        document.addEventListener('DOMContentLoaded', async () => {
            _loadCurrentUserRole();
            _loadYalitecApiCredentials();
            // Load order notes from localStorage
            const storedNotes = localStorage.getItem('orderNotes');
            if (storedNotes) {
                _orderNotes = JSON.parse(storedNotes);
            }

            await fetchAdmins(); // Fetch admins first
            await fetchOrders(); // Then fetch orders
            _startPollingForNewOrders();

            searchInput.addEventListener('input', _applyAllFilters);

            document.getElementById('yalitec-settings-btn').addEventListener('click', _promptForYalitecCredentials);
            document.getElementById('generate-pdf-btn').addEventListener('click', _generateFilteredOrdersPdf);
            document.getElementById('view-report-btn').addEventListener('click', renderOrderReportPage);
            document.getElementById('close-report-btn').addEventListener('click', () => orderReportPage.classList.add('hidden'));
            document.getElementById('agent-report-btn').addEventListener('click', _generateAgentStatsReport);
            document.getElementById('close-agent-report-btn').addEventListener('click', () => agentReportPage.classList.add('hidden'));

            // Initial render
            renderApp();
        });

    </script>
</body>
</html>
