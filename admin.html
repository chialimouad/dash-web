<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts - Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Chart.js CDN for charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Lucide Icons CDN (for Add Product page) -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Quill.js CSS (for Add Product page) -->
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* Light gray background */
        }
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
            border-radius: 10px;
        }
        /* Hide the default date picker icon for custom styling */
        input[type="date"]::-webkit-calendar-picker-indicator {
            display: none;
        }
        input[type="date"] {
            -webkit-appearance: none;
            appearance: none;
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>') no-repeat right 10px center;
            background-size: 20px;
            padding-right: 40px; /* Space for the icon */
        }
        .sidebar-button {
            transition: background-color 200ms ease-in-out, color 200ms ease-in-out;
        }
        .sidebar-button:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
        .sidebar-button.selected {
            background-color: #4A148C; /* Darker Purple for selection */
        }
        .sidebar-button.selected .sidebar-icon,
        .sidebar-button.selected .sidebar-text {
            color: #FFC107; /* Accent color for selected items */
            font-weight: bold;
        }
        /* Modal styles */
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1000; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            max-width: 90%;
            max-height: 90%;
            overflow-y: auto;
        }
        @media (min-width: 640px) {
            .modal-content {
                max-width: 500px;
            }
        }

        /* Custom scrollbar for add product page */
        #product-form ::-webkit-scrollbar {
            width: 8px;
        }
        #product-form ::-webkit-scrollbar-track {
            background: #e0e0e0;
            border-radius: 10px;
        }
        #product-form ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        #product-form ::-webkit-scrollbar-thumb:hover {
            background: #555;
            border-radius: 10px;
        }
        /* Hide default number input arrows */
        #product-form input[type="number"]::-webkit-outer-spin-button,
        #product-form input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        #product-form input[type="number"] {
            -moz-appearance: textfield;
        }
        /* Quill editor styling adjustments */
        .ql-toolbar {
            border-top-left-radius: 0.5rem; /* rounded-lg */
            border-top-right-radius: 0.5rem; /* rounded-lg */
            border: 1px solid #d1d5db; /* border-gray-300 */
            background-color: #f9fafb; /* bg-gray-50 */
        }
        .ql-container {
            border-bottom-left-radius: 0.5rem; /* rounded-lg */
            border-bottom-right-radius: 0.5rem; /* rounded-lg */
            border: 1px solid #d1d5db; /* border-gray-300 */
            border-top: none; /* remove top border as toolbar has it */
            min-height: 12rem; /* h-48 */
            background-color: #f3f4f6; /* bg-gray-100 */
            color: #1f2937; /* text-gray-900 */
        }
        .ql-editor {
            min-height: 10rem; /* Adjust as needed */
            padding: 1rem; /* px-4 py-3 */
        }
        .ql-editor.ql-blank::before {
            color: #9ca3af; /* placeholder-gray-500 */
            font-style: normal; /* Override default italic for placeholder */
        }
    </style>
</head>
<body class="min-h-screen flex flex-col lg:flex-row">
    <!-- Sidebar / Drawer -->
    <nav id="sidebar" class="bg-gray-900 text-white w-full lg:w-72 flex-shrink-0 flex flex-col hidden lg:flex shadow-lg">
        <!-- Sidebar content will be rendered here by JS -->
    </nav>

    <div class="flex-1 flex flex-col">
        <!-- App Bar -->
        <header class="bg-gray-900 shadow-md p-4 flex justify-between items-center rounded-b-lg lg:hidden">
            <button id="menu-toggle" class="text-white text-2xl focus:outline-none">
                <i class="fas fa-bars"></i>
            </button>
            <h1 id="app-bar-title" class="text-white text-xl font-semibold">Admin Panel</h1>
            <div class="flex items-center space-x-2">
                <button id="notification-button-mobile" class="relative text-white text-2xl">
                    <i class="fas fa-bell"></i>
                    <span id="notification-badge-mobile" class="absolute -top-1 -right-1 bg-red-600 text-white text-xs font-bold rounded-full h-5 w-5 flex items-center justify-center hidden">0</span>
                </button>
                <button id="language-toggle-mobile" class="flex items-center space-x-2 bg-indigo-600 text-white px-3 py-1 rounded-lg shadow-md hover:bg-indigo-700 transition duration-300 text-sm">
                    <i class="fas fa-language"></i>
                    <span id="language-text-mobile">English</span>
                </button>
            </div>
        </header>

        <main class="flex-1 flex flex-col p-4">
            <!-- Filter Section (Only visible when Dashboard is selected) -->
            <section id="filter-section" class="bg-gray-50 p-6 rounded-xl shadow-md mb-6 hidden">
                <div class="flex justify-between items-center mb-4">
                    <h2 id="filter-orders-title" class="text-2xl font-bold text-gray-800">Filter Orders</h2>
                    <i class="fas fa-filter text-3xl text-gray-700"></i>
                </div>
                <div class="flex flex-wrap gap-3">
                    <button id="filter-today" class="filter-button bg-gray-200 text-gray-800 px-5 py-3 rounded-lg shadow-sm hover:bg-gray-300 transition duration-300 flex items-center space-x-2">
                        <i class="fas fa-calendar-day"></i>
                        <span class="filter-label">Today</span>
                    </button>
                    <button id="filter-month" class="filter-button bg-indigo-600 text-white px-5 py-3 rounded-lg shadow-md hover:bg-indigo-700 transition duration-300 flex items-center space-x-2">
                        <i class="fas fa-calendar-alt"></i>
                        <span class="filter-label">This Month</span>
                    </button>
                    <button id="filter-custom" class="filter-button bg-gray-200 text-gray-800 px-5 py-3 rounded-lg shadow-sm hover:bg-gray-300 transition duration-300 flex items-center space-x-2">
                        <i class="fas fa-calendar-days"></i>
                        <span class="filter-label">Custom Range</span>
                    </button>
                    <button id="filter-all" class="filter-button bg-gray-200 text-gray-800 px-5 py-3 rounded-lg shadow-sm hover:bg-gray-300 transition duration-300 flex items-center space-x-2">
                        <i class="fas fa-globe"></i>
                        <span class="filter-label">All Orders</span>
                    </button>
                </div>
                <div id="custom-date-range" class="mt-4 hidden flex-col sm:flex-row gap-4 items-center">
                    <div class="flex items-center space-x-2 w-full sm:w-auto">
                        <label for="start-date" class="text-gray-700 font-medium">From:</label>
                        <input type="date" id="start-date" class="p-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500 w-full sm:w-auto">
                    </div>
                    <div class="flex items-center space-x-2 w-full sm:w-auto">
                        <label for="end-date" class="text-gray-700 font-medium">To:</label>
                        <input type="date" id="end-date" class="p-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500 w-full sm:w-auto">
                    </div>
                    <p id="selected-date-range" class="text-sm text-gray-700 mt-2 sm:mt-0"></p>
                </div>
            </section>

            <hr id="filter-separator" class="border-gray-300 mb-6 hidden">

            <!-- Main Content Area (Dynamic) -->
            <section id="main-content-area" class="flex-1 flex flex-col">
                <!-- Content will be dynamically loaded here based on sidebar selection -->
                <div class="flex flex-col items-center justify-center flex-1 text-gray-800">
                    <i class="fas fa-tachometer-alt text-8xl text-indigo-600 mb-4"></i>
                    <h2 id="welcome-title" class="text-3xl font-bold text-center mb-2">Welcome to Sheeka Admin Panel</h2>
                    <p id="select-section-text" class="text-lg text-center text-gray-600">Select a section from the sidebar to manage your store.</p>
                </div>
            </section>
        </main>
    </div>

    <!-- Modals -->
    <div id="logout-modal" class="modal">
        <div class="modal-content bg-white p-6 rounded-lg shadow-xl text-center">
            <h3 id="confirm-logout-title" class="text-xl font-bold mb-4 text-gray-800">Confirm Logout</h3>
            <p id="are-you-sure-logout-text" class="mb-6 text-gray-700">Are you sure you want to log out?</p>
            <div class="flex justify-center space-x-4">
                <button id="cancel-logout" class="bg-gray-200 text-gray-800 px-5 py-2 rounded-lg hover:bg-gray-300 transition duration-300">Cancel</button>
                <button id="confirm-logout" class="bg-red-600 text-white px-5 py-2 rounded-lg hover:bg-red-700 transition duration-300">Logout</button>
            </div>
        </div>
    </div>

    <div id="new-orders-modal" class="modal">
        <div class="modal-content bg-white p-6 rounded-lg shadow-xl flex flex-col">
            <h3 id="new-orders-title" class="text-xl font-bold mb-4 text-gray-800">New Orders</h3>
            <div id="new-orders-list" class="flex-1 overflow-y-auto mb-4">
                <!-- New orders will be listed here -->
            </div>
            <div class="flex justify-end space-x-4 mt-auto">
                <button id="close-new-orders" class="bg-gray-200 text-gray-800 px-5 py-2 rounded-lg hover:bg-gray-300 transition duration-300">Close</button>
                <button id="mark-all-as-read" class="bg-red-600 text-white px-5 py-2 rounded-lg hover:bg-red-700 transition duration-300">Mark All as Read</button>
            </div>
        </div>
    </div>

    <!-- Color Selection Modal (for Add Product page) -->
    <div id="color-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-6 rounded-xl shadow-lg w-full max-w-md mx-4 space-y-6">
            <h3 id="choose-colors-title" class="text-xl font-bold text-gray-900"></h3>
            <div id="color-chips-container" class="flex flex-wrap gap-3">
                <!-- Color chips will be dynamically added here -->
            </div>
            <div>
                <label for="new-color-input" class="block text-gray-700 text-sm font-bold mb-2" id="label-add-new-color"></label>
                <input type="text" id="new-color-input" class="w-full px-4 py-3 rounded-lg border border-gray-300 bg-gray-100 text-gray-900 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-700 focus:border-transparent transition duration-200" placeholder="">
                <p id="error-new-color" class="text-red-500 text-xs italic mt-1 hidden"></p>
            </div>
            <div class="flex justify-end space-x-3">
                <button type="button" id="add-custom-color-button" class="flex items-center px-4 py-2 bg-blue-700 text-white rounded-lg shadow-md hover:bg-blue-800 focus:outline-none focus:ring-2 focus:ring-blue-600 transition duration-200">
                    <i data-lucide="plus-circle" class="w-5 h-5 mr-2"></i>
                    <span id="add-text"></span>
                </button>
                <button type="button" id="cancel-color-modal" class="px-4 py-2 text-gray-600 font-semibold rounded-lg hover:bg-gray-100 transition duration-200">
                    <span id="cancel-text"></span>
                </button>
                <button type="button" id="confirm-color-modal" class="px-4 py-2 bg-green-700 text-white rounded-lg shadow-md hover:bg-green-800 focus:outline-none focus:ring-2 focus:ring-green-600 transition duration-200">
                    <span id="confirm-text"></span>
                </button>
            </div>
        </div>
    </div>

    <!-- Message Box / Snackbar (for Add Product page) -->
    <div id="message-box" class="fixed bottom-4 right-4 bg-gray-800 text-white px-6 py-3 rounded-lg shadow-xl hidden transition-opacity duration-300 opacity-0 z-50">
        <span id="message-text"></span>
    </div>

    <!-- Quill.js JavaScript -->
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    <script>
        // Global state management
        const appState = {
            products: [], // Placeholder
            admins: [],
            stockInfos: [], // Placeholder
            totalOrders: 0,
            pendingOrders: 0,
            confirmedOrders: 0,
            tentativeOrders: 0,
            cancelledOrders: 0,
            isOrdersLoading: true,
            orderErrorMessage: null,
            selectedFilter: 'month', // 'today', 'month', 'custom', 'all'
            customStartDate: null,
            customEndDate: null,
            isEnglish: true, // Default language
            adminFilter: '',
            stockFilter: '',
            orderPieChartInstance: null, // To store Chart.js instance
            selectedSection: 'Dashboard', // Default selected section
            userRole: 'admin', // Default user role for demonstration, will be loaded from localStorage
            newOrders: [], // List of new orders for notifications
            orderSimulationTimer: null, // Timer for simulating new orders

            // Add Product specific state
            currentStep: 0,
            productData: {
                name: '',
                description: '', // This will now hold HTML content from Quill
                quantity: '',
                price: '',
                customOption: '',
                productType: null,
                variants: [{ colors: [], sizes: [], price: '', promoCode: '' }],
                images: [], // Array of File objects for product-level images
            },
            addProductIsLoading: false, // Renamed to avoid conflict with isOrdersLoading
            predefinedColors: ['Black', 'White', 'Red', 'Blue', 'Green', 'Yellow', 'Purple', 'Brown', 'Beige', 'Grey', 'Pink', 'Orange'],
            availableColors: [], // Mutable copy for custom colors, initialized on DOMContentLoaded
            currentVariantForColorSelection: null, // To track which variant's colors are being edited
            quill: null, // Quill instance
        };

        // Translations map
        const translations = {
            'en': {
                'adminPanelTitle': 'Admin Panel',
                'filterOrders': 'Filter Orders',
                'today': 'Today',
                'thisMonth': 'This Month',
                'customRange': 'Custom Range',
                'allOrders': 'All Orders',
                'selected': 'Selected',
                'orderSummary': 'Order Summary',
                'totalOrders': 'Total Orders',
                'pending': 'Pending',
                'confirmed': 'Confirmed',
                'tentative': 'Tentative',
                'cancelled': 'Cancelled',
                'orderDistribution': 'Order Distribution',
                'admins': 'Admins',
                'stockInfo': 'Stock Info',
                'searchHint': 'Search...',
                'noDataChart': 'No data available to show the chart.',
                'failedToLoadOrders': 'Failed to load orders:',
                'errorFetchingOrders': 'Error fetching orders:',
                'retry': 'Retry',
                'role': 'Role',
                'unknown': 'Unknown',
                'stockInformation': 'Stock Information Placeholder',
                'language': 'English',
                'From': 'From',
                'To': 'To',
                'confirmLogout': 'Confirm Logout',
                'areYouSureLogout': 'Are you sure you want to log out?',
                'cancel': 'Cancel',
                'logout': 'Logout',
                'newOrders': 'New Orders',
                'noNewOrders': 'No new orders at the moment.',
                'orderId': 'Order ID',
                'status': 'Status',
                'markAsProcessed': 'Mark as Processed',
                'close': 'Close',
                'markAllAsRead': 'Mark All as Read',
                'orderProcessed': 'Order marked as processed.',
                'welcomeAdminPanel': 'Welcome to Sheeka Admin Panel',
                'selectSectionSidebar': 'Select a section from the sidebar to manage your store.',
                'dashboard': 'Dashboard',
                'products': 'Products',
                'orders': 'Orders',
                'addProducts': 'Add Product',
                'promoPictures': 'Promo Pictures',
                'charges': 'Charges',
                'siteSettings': 'Site Settings',
                'fees': 'Fees',
                'emails': 'Emails',
                'pixels': 'Pixels',
                'documents': 'Documents',
                'manageCommercialDocuments': 'Manage Commercial Documents',
                'invoice': 'Invoice',
                'purchaseOrder': 'Purchase Order',
                'deliveryNote': 'Delivery Note',
                'returnNote': 'Return Note',
                // Add Product specific translations
                'add_new_product': 'Add New Product',
                'product_details': 'Product Details',
                'product_type': 'Product Type',
                'select_product_type': 'Select product type',
                'product_name': 'Product Name',
                'example_tshirt': 'Example: Casual T-Shirt',
                'detailed_description': 'Detailed Description',
                'provide_detailed_description': 'Provide a detailed description of the product here...',
                'total_quantity': 'Total Quantity',
                'example_100': 'Example: 100',
                'base_price': 'Base Price (DZD)',
                'example_1500_00': 'Example: 1500.00',
                'product_variants': 'Product Variants',
                'product_variants_colors_sizes_prices': 'Product Variants (Colors, Sizes, and Prices)',
                'please_select_product_type_first': 'Please select product type in the first step first.',
                'this_product_type_no_variants': 'This product type does not require variants.',
                'add_another_variant': 'Add another variant',
                'images_custom_options': 'Images and Custom Options',
                'custom_option_optional': 'Custom Option (Optional)',
                'example_gift_wrap': 'Example: Gift wrapping, engraving',
                'select_product_images': 'Select Product Images',
                'review_submit': 'Review and Submit',
                'review_details_before_submitting': 'Please review product details before submitting.',
                'submit_product': 'Submit Product',
                'variant': 'Variant',
                'price_for_variant_dzd': 'Price for Variant (DZD)',
                'example_1450_00': 'Example: 1450.00',
                'promo_code_optional': 'Promo Code (Optional)',
                'example_discount10': 'Example: DISCOUNT10',
                'selected_colors': 'Selected Colors',
                'choose_colors': 'Choose Colors',
                'sizes': 'Sizes',
                'add_new_color': 'Add New Color',
                'example_sky_blue': 'Example: Sky Blue',
                'add': 'Add',
                'cancel': 'Cancel',
                'confirm': 'Confirm',
                'color_already_exists': 'This color already exists.',
                'product_added_successfully': '✅ Product added successfully!',
                'failed_to_add_product': '❌ Failed to add product. Status: ',
                'an_error_occurred': '❌ An error occurred: ',
                'name_cannot_be_empty': 'Product name cannot be empty',
                'description_cannot_be_empty': 'Description cannot be empty',
                'quantity_cannot_be_empty': 'Please enter the quantity',
                'enter_valid_integer': 'Please enter a valid integer',
                'quantity_cannot_be_negative': 'Quantity cannot be negative',
                'price_cannot_be_empty': 'Price cannot be empty',
                'enter_valid_price': 'Enter a valid price',
                'price_must_be_greater_than_0': 'Price must be greater than 0',
                'variant_price_cannot_be_empty': 'Variant price cannot be empty',
                'enter_valid_variant_price': 'Enter a valid variant price',
                'variant_price_must_be_greater_than_0': 'Price must be greater than 0',
                'please_select_product_type': 'Please select product type',
                'please_correct_form_errors': '❌ Please fix the errors in the form.',
                'please_fill_all_required_fields': '❌ Please fill all required fields correctly.',
                'please_complete_current_step': '❌ Please complete the current step before proceeding.',
                'next': 'Next',
                'back': 'Back',
                'clothes': 'Clothes',
                'shoes': 'Shoes',
                'gadget': 'Gadget',
                'cosmetics': 'Cosmetics',
                'english': 'English',
                'arabic': 'Arabic',
                'response': 'Response',
            },
            'ar': {
                'adminPanelTitle': 'لوحة التحكم',
                'filterOrders': 'تصفية الطلبات',
                'today': 'اليوم',
                'thisMonth': 'هذا الشهر',
                'customRange': 'نطاق مخصص',
                'allOrders': 'جميع الطلبات',
                'selected': 'المحدد',
                'orderSummary': 'ملخص الطلبات',
                'totalOrders': 'إجمالي الطلبات',
                'pending': 'معلقة',
                'confirmed': 'مؤكدة',
                'tentative': 'مؤقتة',
                'cancelled': 'ملغاة',
                'orderDistribution': 'توزيع الطلبات',
                'admins': 'المسؤولون',
                'stockInfo': 'معلومات المخزون',
                'searchHint': 'بحث...',
                'noDataChart': 'لا توجد بيانات لعرض الرسم البياني.',
                'failedToLoadOrders': 'فشل تحميل الطلبات:',
                'errorFetchingOrders': 'خطأ في جلب الطلبات:',
                'retry': 'إعادة المحاولة',
                'role': 'الدور',
                'unknown': 'غير معروف',
                'stockInformation': 'معلومات المخزون',
                'language': 'العربية',
                'From': 'من',
                'To': 'إلى',
                'confirmLogout': 'تأكيد تسجيل الخروج',
                'areYouSureLogout': 'هل أنت متأكد أنك تريد تسجيل الخروج؟',
                'cancel': 'إلغاء',
                'logout': 'تسجيل الخروج',
                'newOrders': 'طلبات جديدة',
                'noNewOrders': 'لا توجد طلبات جديدة حاليًا.',
                'orderId': 'معرف الطلب',
                'status': 'الحالة',
                'markAsProcessed': 'وضع علامة كمُعالَج',
                'close': 'إغلاق',
                'markAllAsRead': 'تحديد الكل كمقروء',
                'orderProcessed': 'تم وضع علامة على الطلب كمُعالَج.',
                'welcomeAdminPanel': 'مرحباً بك في لوحة تحكم شيقة',
                'selectSectionSidebar': 'حدد قسمًا من الشريط الجانبي لإدارة متجرك.',
                'dashboard': 'لوحة القيادة',
                'products': 'المنتجات',
                'orders': 'الطلبات',
                'addProducts': 'إضافة منتج',
                'promoPictures': 'صور العروض الترويجية',
                'charges': 'الرسوم',
                'siteSettings': 'إعدادات الموقع',
                'fees': 'الرسوم',
                'emails': 'رسائل البريد الإلكتروني',
                'pixels': 'البكسلات',
                'documents': 'المستندات',
                'manageCommercialDocuments': 'إدارة المستندات التجارية',
                'invoice': 'فاتورة',
                'purchaseOrder': 'أمر الشراء',
                'deliveryNote': 'مذكرة التسليم',
                'returnNote': 'مذكرة الإرجاع',
                // Add Product specific translations
                'add_new_product': 'إضافة منتج جديد',
                'product_details': 'تفاصيل المنتج',
                'product_type': 'نوع المنتج',
                'select_product_type': 'اختر نوع المنتج',
                'product_name': 'اسم المنتج',
                'example_tshirt': 'مثال: تي شيرت كاجوال',
                'detailed_description': 'الوصف التفصيلي',
                'provide_detailed_description': 'قدم وصفاً تفصيلياً للمنتج هنا...',
                'total_quantity': 'الكمية الإجمالية',
                'example_100': 'مثال: 100',
                'base_price': 'السعر الأساسي (د.ج)',
                'example_1500_00': 'مثال: 1500.00',
                'product_variants': 'متغيرات المنتج',
                'product_variants_colors_sizes_prices': 'متغيرات المنتج (الألوان والأحجام والأسعار)',
                'please_select_product_type_first': 'الرجاء اختيار نوع المنتج في الخطوة الأولى أولاً.',
                'this_product_type_no_variants': 'هذا النوع من المنتجات لا يتطلب متغيرات.',
                'add_another_variant': 'إضافة متغير آخر',
                'images_custom_options': 'الصور والخيارات المخصصة',
                'custom_option_optional': 'خيار مخصص (اختياري)',
                'example_gift_wrap': 'مثال: تغليف الهدايا، نقش',
                'select_product_images': 'اختيار صور المنتج',
                'review_submit': 'مراجعة وإرسال',
                'review_details_before_submitting': 'يرجى مراجعة تفاصيل المنتج قبل الإرسال.',
                'submit_product': 'إرسال المنتج',
                'variant': 'المتغير',
                'price_for_variant_dzd': 'السعر للمتغير (د.ج)',
                'example_1450_00': 'مثال: 1450.00',
                'promo_code_optional': 'رمز العرض الترويجي (اختياري)',
                'example_discount10': 'مثال: خصم10',
                'selected_colors': 'الألوان المختارة',
                'choose_colors': 'اختر الألوان',
                'sizes': 'الأحجام',
                'add_new_color': 'إضافة لون جديد',
                'example_sky_blue': 'مثال: أزرق سماوي',
                'add': 'أضف',
                'cancel': 'إلغاء',
                'confirm': 'تأكيد',
                'color_already_exists': 'هذا اللون موجود بالفعل.',
                'product_added_successfully': '✅ تم إضافة المنتج بنجاح!',
                'failed_to_add_product': '❌ فشل إضافة المنتج. الحالة: ',
                'an_error_occurred': '❌ حدث خطأ: ',
                'name_cannot_be_empty': 'اسم المنتج لا يمكن أن يكون فارغاً',
                'description_cannot_be_empty': 'الوصف لا يمكن أن يكون فارغاً',
                'quantity_cannot_be_empty': 'الرجاء إدخال الكمية',
                'enter_valid_integer': 'الرجاء إدخال رقم صحيح',
                'quantity_cannot_be_negative': 'الكمية لا يمكن أن تكون سالبة',
                'price_cannot_be_empty': 'السعر لا يمكن أن يكون فارغاً',
                'enter_valid_price': 'أدخل سعراً صالحاً',
                'price_must_be_greater_than_0': 'السعر يجب أن يكون أكبر من 0',
                'variant_price_cannot_be_empty': 'السعر للمتغير لا يمكن أن يكون فارغاً',
                'enter_valid_variant_price': 'أدخل سعراً صالحاً للمتغير',
                'variant_price_must_be_greater_than_0': 'السعر يجب أن يكون أكبر من 0',
                'please_select_product_type': 'الرجاء اختيار نوع المنتج',
                'please_correct_form_errors': '❌ الرجاء إصلاح الأخطاء في النموذج.',
                'please_fill_all_required_fields': '❌ الرجاء ملء جميع الحقول المطلوبة بشكل صحيح.',
                'please_complete_current_step': '❌ الرجاء إكمال الخطوة الحالية قبل المتابعة.',
                'next': 'التالي',
                'back': 'العودة',
                'clothes': 'ملابس',
                'shoes': 'أحذية',
                'gadget': 'أدوات إلكترونية',
                'cosmetics': 'مستحضرات تجميل',
                'english': 'الإنجليزية',
                'arabic': 'العربية',
                'response': 'الاستجابة',
            },
        };

        // Helper to get translated string
        function getTranslatedString(key) {
            // Use appState.isEnglish to determine the current locale for translations
            const currentLocale = appState.isEnglish ? 'en' : 'ar';
            return translations[currentLocale][key] || key;
        }

        // Function to toggle language
        function toggleLanguage() {
            appState.isEnglish = !appState.isEnglish;
            renderApp(); // Re-render the entire app
            fetchOrders(); // Re-fetch orders to apply date formatting if needed
            updateLocalizedText(); // Update add product specific texts
            // Adjust text direction for Arabic
            if (!appState.isEnglish) {
                document.body.style.direction = 'rtl';
                document.documentElement.lang = 'ar';
            } else {
                document.body.style.direction = 'ltr';
                document.documentElement.lang = 'en';
            }
        }

        // --- API Fetching Functions ---

        async function fetchAdmins() {
            try {
                const response = await fetch('https://sheeka.onrender.com/auth/users');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                appState.admins = await response.json();
                renderSelectedSection(); // Re-render admins card if it's the current section
            } catch (e) {
                console.error('Error fetching admins:', e);
                if (appState.selectedSection === 'Admins') {
                    document.getElementById('main-content-area').innerHTML = `
                        <div class="flex flex-col items-center justify-center flex-1 text-red-500 p-4">
                            <i class="fas fa-exclamation-circle text-4xl mb-2"></i>
                            <p>Failed to load admins. Please try again.</p>
                        </div>
                    `;
                }
            }
        }

        async function fetchOrders() {
            appState.isOrdersLoading = true;
            appState.orderErrorMessage = null;
            if (appState.selectedSection === 'Dashboard') {
                renderOrderSummaryCard(); // Show loading state
                renderOrderPieChartCard(); // Show loading state
            }

            try {
                const response = await fetch('https://sheeka.onrender.com/orders');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const fetchedOrders = await response.json();
                processOrderData(fetchedOrders);
                appState.isOrdersLoading = false;
            } catch (e) {
                appState.orderErrorMessage = `${getTranslatedString('errorFetchingOrders')} ${e.message}`;
                appState.isOrdersLoading = false;
                console.error('Error fetching orders:', e);
            } finally {
                if (appState.selectedSection === 'Dashboard') {
                    renderOrderSummaryCard(); // Update with data or error
                    renderOrderPieChartCard(); // Update with data or error
                }
            }
        }

        // --- Order Processing and Filtering ---

        function processOrderData(ordersList) {
            let pending = 0;
            let confirmed = 0;
            let tentative = 0;
            let cancelled = 0;
            let filteredOrders = [];

            const nowUtc = new Date();
            // Normalize filter boundaries to start of day in UTC
            const todayUtcStart = new Date(Date.UTC(nowUtc.getUTCFullYear(), nowUtc.getUTCMonth(), nowUtc.getUTCDate()));
            const thisMonthUtcStart = new Date(Date.UTC(nowUtc.getUTCFullYear(), nowUtc.getUTCMonth(), 1));

            for (const order of ordersList) {
                let createdAt;
                try {
                    const createdAtString = order['createdAt']?.toString();
                    if (createdAtString) {
                        createdAt = new Date(createdAtString); // Date.parse handles ISO 8601
                        if (isNaN(createdAt.getTime())) { // Check for invalid date
                            throw new Error('Invalid date string');
                        }
                    } else {
                        createdAt = new Date(0); // Epoch 0 UTC
                        console.warn(`Warning: createdAt is not a valid string or is null for order: ${order['_id'] || 'unknown_id'}. Treating as UTC epoch 0.`);
                    }
                } catch (e) {
                    createdAt = new Date(0); // Epoch 0 UTC
                    console.error(`Error parsing createdAt date: ${e} for order: ${order['_id'] || 'unknown_id'}. Treating as UTC epoch 0.`);
                }

                let matchesFilter = false;
                switch (appState.selectedFilter) {
                    case 'today':
                        matchesFilter = createdAt.getUTCDate() === todayUtcStart.getUTCDate() &&
                                        createdAt.getUTCMonth() === todayUtcStart.getUTCMonth() &&
                                        createdAt.getUTCFullYear() === todayUtcStart.getUTCFullYear();
                        break;
                    case 'month':
                        matchesFilter = createdAt.getUTCMonth() === thisMonthUtcStart.getUTCMonth() &&
                                        createdAt.getUTCFullYear() === thisMonthUtcStart.getUTCFullYear();
                        break;
                    case 'custom':
                        if (appState.customStartDate && appState.customEndDate) {
                            const customStartUtc = new Date(Date.UTC(appState.customStartDate.getFullYear(), appState.customStartDate.getMonth(), appState.customStartDate.getDate()));
                            const customEndUtc = new Date(Date.UTC(appState.customEndDate.getFullYear(), appState.customEndDate.getMonth(), appState.customEndDate.getDate(), 23, 59, 59, 999));

                            matchesFilter = (createdAt.getTime() >= customStartUtc.getTime() && createdAt.getTime() <= customEndUtc.getTime());
                        }
                        break;
                    case 'all':
                        matchesFilter = true;
                        break;
                }

                if (matchesFilter) {
                    filteredOrders.push(order);
                    const status = (order['status'] || 'unknown').toLowerCase();
                    switch (status) {
                        case 'pending':
                            pending++;
                            break;
                        case 'confirmed':
                            confirmed++;
                            break;
                        case 'tentative':
                            tentative++;
                            break;
                        case 'cancelled':
                            cancelled++;
                            break;
                    }
                }
            }

            appState.totalOrders = filteredOrders.length;
            appState.pendingOrders = pending;
            appState.confirmedOrders = confirmed;
            appState.tentativeOrders = tentative;
            appState.cancelledOrders = cancelled;
        }

        // --- UI Rendering Functions ---

        function renderApp() {
            // Update language toggle button text in app bar
            document.getElementById('language-text-mobile').textContent = getTranslatedString('language');
            document.getElementById('app-bar-title').textContent = getTranslatedString('adminPanelTitle');

            // Update sidebar
            renderSidebar();

            // Update main content area
            renderSelectedSection();

            // Update modals
            document.getElementById('confirm-logout-title').textContent = getTranslatedString('confirmLogout');
            document.getElementById('are-you-sure-logout-text').textContent = getTranslatedString('areYouSureLogout');
            document.getElementById('cancel-logout').textContent = getTranslatedString('cancel');
            document.getElementById('confirm-logout').textContent = getTranslatedString('logout');

            document.getElementById('new-orders-title').textContent = getTranslatedString('newOrders');
            document.getElementById('close-new-orders').textContent = getTranslatedString('close');
            document.getElementById('mark-all-as-read').textContent = getTranslatedString('markAllAsRead');

            // Update filter section labels (if visible)
            const filterOrdersTitle = document.getElementById('filter-orders-title');
            if (filterOrdersTitle) filterOrdersTitle.textContent = getTranslatedString('filterOrders');
            const filterLabels = document.querySelectorAll('.filter-label');
            if (filterLabels[0]) filterLabels[0].textContent = getTranslatedString('today');
            if (filterLabels[1]) filterLabels[1].textContent = getTranslatedString('thisMonth');
            if (filterLabels[2]) filterLabels[2].textContent = getTranslatedString('customRange');
            if (filterLabels[3]) filterLabels[3].textContent = getTranslatedString('allOrders');

            const startDateLabel = document.querySelector('#custom-date-range label[for="start-date"]');
            if (startDateLabel) startDateLabel.textContent = getTranslatedString('From') + ':';
            const endDateLabel = document.querySelector('#custom-date-range label[for="end-date"]');
            if (endDateLabel) endDateLabel.textContent = getTranslatedString('To') + ':';

            updateFilterButtons();
            updateCustomDateRangeDisplay();
            updateNotificationBadge(); // Ensure badge is updated on language change
        }

        function isWideScreen() {
            return window.innerWidth >= 1024; // Tailwind's 'lg' breakpoint
        }

        function renderSidebar() {
            const sidebar = document.getElementById('sidebar');
            const appBar = document.querySelector('header'); // The app bar for mobile

            if (isWideScreen()) {
                sidebar.classList.remove('hidden');
                appBar.classList.add('hidden'); // Hide mobile app bar on wide screen
            } else {
                sidebar.classList.add('hidden');
                appBar.classList.remove('hidden'); // Show mobile app bar on small screen
            }

            sidebar.innerHTML = `
                <div class="p-6 flex items-center">
                    <i class="fas fa-bolt text-amber-400 text-3xl"></i>
                    <h2 class="text-white text-2xl font-bold ml-3 flex-1 overflow-hidden whitespace-nowrap text-ellipsis">${getTranslatedString('adminPanelTitle')}</h2>
                    <button id="notification-button-desktop" class="relative text-white text-2xl ml-auto">
                        <i class="fas fa-bell"></i>
                        <span id="notification-badge-desktop" class="absolute -top-1 -right-1 bg-red-600 text-white text-xs font-bold rounded-full h-5 w-5 flex items-center justify-center hidden">0</span>
                    </button>
                </div>
                <hr class="border-gray-700 my-2">
                <div class="flex-1 overflow-y-auto">
                    ${SidebarButton('dashboard', 'fas fa-tachometer-alt', getTranslatedString('dashboard'))}
                    ${(appState.userRole === "admin" || appState.userRole === "confirmation" || appState.userRole === "stockagent") ? SidebarButton('orders', 'fas fa-shopping-cart', getTranslatedString('orders')) : ''}
                    ${(appState.userRole === "admin" || appState.userRole === "confirmation" || appState.userRole === "stockagent") ? SidebarButton('products', 'fas fa-box-open', getTranslatedString('products')) : ''}
                    ${(appState.userRole === "admin") ? SidebarButton('admins', 'fas fa-user-shield', getTranslatedString('admins')) : ''}
                    ${(appState.userRole === "admin" || appState.userRole === "stockagent" || appState.userRole === "confirmation") ? SidebarButton('stock', 'fas fa-store', getTranslatedString('stockInfo')) : ''}
                    ${(appState.userRole === "admin") ? SidebarButton('addProduct', 'fas fa-plus-circle', getTranslatedString('addProducts')) : ''}
                    ${(appState.userRole === "admin") ? SidebarButton('promoPics', 'fas fa-image', getTranslatedString('promoPictures')) : ''}
                    ${(appState.userRole === "admin") ? SidebarButton('charges', 'fas fa-money-bill-wave', getTranslatedString('charges')) : ''}
                    ${(appState.userRole === "admin") ? SidebarButton('siteSettings', 'fas fa-cog', getTranslatedString('siteSettings')) : ''}
                    ${(appState.userRole === "admin") ? SidebarButton('fees', 'fas fa-truck', getTranslatedString('fees')) : ''}
                    ${(appState.userRole === "admin") ? SidebarButton('emails', 'fas fa-envelope', getTranslatedString('emails')) : ''}
                    ${(appState.userRole === "admin") ? SidebarButton('pixels', 'fas fa-chart-area', getTranslatedString('pixels')) : ''}
                    ${(appState.userRole === "admin" || appState.userRole === "confirmation") ? SidebarButton('documents', 'fas fa-file-alt', getTranslatedString('documents')) : ''}
                </div>
                <div class="p-4">
                    ${SidebarButton('logout', 'fas fa-sign-out-alt', getTranslatedString('logout'))}
                </div>
            `;

            // Attach event listeners for newly rendered sidebar buttons
            sidebar.querySelectorAll('.sidebar-button').forEach(button => {
                button.addEventListener('click', () => {
                    const sectionId = button.dataset.section;
                    if (sectionId === 'logout') {
                        _logout();
                    } else {
                        selectSection(sectionId);
                    }
                    // For mobile drawer, close it after selection
                    if (!isWideScreen() && sidebar.classList.contains('flex')) {
                        sidebar.classList.remove('flex');
                        sidebar.classList.add('hidden');
                    }
                });
            });

            // Attach notification button listener for desktop sidebar
            document.getElementById('notification-button-desktop').addEventListener('click', _showNewOrdersDialog);
            updateNotificationBadge();
        }

        function SidebarButton(sectionId, iconClass, text) {
            const isSelected = appState.selectedSection === sectionId ||
                               (sectionId === 'documents' && ['Factures', 'Bon de Commande', 'Bon de Livraison', 'Bon de Retour'].includes(appState.selectedSection));
            const selectedClass = isSelected ? 'selected' : '';

            return `
                <button data-section="${sectionId}" class="sidebar-button flex items-center w-full px-5 py-4 my-1 rounded-lg text-white text-lg hover:bg-gray-800 transition duration-200 ${selectedClass}">
                    <i class="sidebar-icon ${iconClass} text-xl"></i>
                    <span class="sidebar-text ml-4">${text}</span>
                </button>
            `;
        }

        function selectSection(section) {
            appState.selectedSection = section;
            renderSelectedSection();
            renderSidebar(); // Re-render sidebar to update active state
            if (section === 'orders') {
                _clearAllNotifications(); // Clear notifications when navigating to orders page
            }
        }

        function renderSelectedSection() {
            const mainContentArea = document.getElementById('main-content-area');
            const filterSection = document.getElementById('filter-section');
            const filterSeparator = document.getElementById('filter-separator');

            // Hide filter section and separator by default
            filterSection.classList.add('hidden');
            filterSeparator.classList.add('hidden');
            mainContentArea.innerHTML = ''; // Clear previous content

            // Update search hints (if search bars are present in the current section)
            const adminSearchInput = document.getElementById('admin-search');
            if (adminSearchInput) adminSearchInput.placeholder = getTranslatedString('searchHint');
            const stockSearchInput = document.getElementById('stock-search');
            if (stockSearchInput) stockSearchInput.placeholder = getTranslatedString('searchHint');

            // Reset add product form state when navigating away
            if (appState.selectedSection !== 'addProduct') {
                appState.currentStep = 0;
                if (appState.quill) {
                    appState.quill.setText('');
                }
                appState.productData = {
                    name: '',
                    description: '',
                    quantity: '',
                    price: '',
                    customOption: '',
                    productType: null,
                    variants: [{ colors: [], sizes: [], price: '', promoCode: '' }],
                    images: [],
                };
            }

            if (appState.selectedSection === 'Dashboard') {
                filterSection.classList.remove('hidden');
                filterSeparator.classList.remove('hidden');
                mainContentArea.innerHTML = `
                    <div id="dashboard-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 flex-1">
                        <div id="order-summary-card" class="dashboard-card bg-white p-6 rounded-xl shadow-lg flex flex-col">
                            <div class="flex items-center mb-4">
                                <i class="fas fa-list-alt text-3xl text-gray-800"></i>
                                <h3 class="text-2xl font-bold text-gray-800 ml-3">${getTranslatedString('orderSummary')}</h3>
                            </div>
                            <div id="order-summary-content" class="flex-1 flex items-center justify-center"></div>
                        </div>
                        <div id="order-distribution-card" class="dashboard-card bg-white p-6 rounded-xl shadow-lg flex flex-col">
                            <div class="flex items-center mb-4">
                                <i class="fas fa-chart-pie text-3xl text-gray-800"></i>
                                <h3 class="text-2xl font-bold text-gray-800 ml-3">${getTranslatedString('orderDistribution')}</h3>
                            </div>
                            <div id="order-distribution-content" class="flex-1 flex items-center justify-center">
                                <canvas id="orderPieChart"></canvas>
                            </div>
                        </div>
                    </div>
                `;
                renderOrderSummaryCard();
                renderOrderPieChartCard();
            } else if (appState.selectedSection === 'Admins') {
                mainContentArea.innerHTML = `
                    <div id="admins-card" class="dashboard-card bg-white p-6 rounded-xl shadow-lg flex flex-col flex-1">
                        <div class="flex items-center mb-4">
                            <i class="fas fa-user-shield text-3xl text-gray-800"></i>
                            <h3 class="text-2xl font-bold text-gray-800 ml-3">${getTranslatedString('admins')}</h3>
                        </div>
                        <div class="mb-4">
                            <input type="text" id="admin-search" placeholder="${getTranslatedString('searchHint')}" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 bg-gray-50 text-gray-800">
                        </div>
                        <hr class="border-gray-300 mb-4">
                        <div id="admins-content" class="flex-1 overflow-y-auto"></div>
                    </div>
                `;
                document.getElementById('admin-search').addEventListener('input', (e) => {
                    appState.adminFilter = e.target.value;
                    renderAdminsCard();
                });
                renderAdminsCard();
            } else if (appState.selectedSection === 'Stock') {
                mainContentArea.innerHTML = `
                    <div id="stock-info-card" class="dashboard-card bg-white p-6 rounded-xl shadow-lg flex flex-col flex-1">
                        <div class="flex items-center mb-4">
                            <i class="fas fa-store text-3xl text-gray-800"></i>
                            <h3 class="text-2xl font-bold text-gray-800 ml-3">${getTranslatedString('stockInfo')}</h3>
                        </div>
                        <div class="mb-4">
                            <input type="text" id="stock-search" placeholder="${getTranslatedString('searchHint')}" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 bg-gray-50 text-gray-800">
                        </div>
                        <hr class="border-gray-300 mb-4">
                        <div id="stock-info-content" class="flex-1 flex items-center justify-center text-gray-800 text-lg">
                            ${getTranslatedString('stockInformation')}
                        </div>
                    </div>
                `;
                document.getElementById('stock-search').addEventListener('input', (e) => {
                    appState.stockFilter = e.target.value;
                    // In a real app, this would trigger a re-render of filtered stock data
                    // For now, it just updates the filter state.
                });
            } else if (appState.selectedSection === 'addProduct') {
                mainContentArea.innerHTML = `
                    <div class="max-w-4xl w-full bg-white shadow-lg rounded-xl overflow-hidden mx-auto">
                        <!-- App Bar / Header (retained from original add product, but hidden as main app bar is used) -->
                        <header class="bg-black text-white p-4 flex justify-between items-center rounded-t-xl hidden">
                            <h1 id="app-title" class="text-2xl font-bold"></h1>
                            <div class="relative">
                                <button id="language-toggle" class="p-2 rounded-full hover:bg-gray-800 focus:outline-none focus:ring-2 focus:ring-gray-600">
                                    <i data-lucide="globe" class="w-6 h-6"></i>
                                </button>
                                <div id="language-dropdown" class="absolute right-0 mt-2 w-32 bg-white rounded-md shadow-lg py-1 z-10 hidden">
                                    <button class="block w-full text-left px-4 py-2 text-gray-800 hover:bg-gray-100 rounded-md" data-locale="en">
                                        <span id="lang-en-text"></span>
                                    </button>
                                    <button class="block w-full text-left px-4 py-2 text-gray-800 hover:bg-gray-100 rounded-md" data-locale="ar">
                                        <span id="lang-ar-text"></span>
                                    </button>
                                </div>
                            </div>
                        </header>

                        <!-- Main Content Area -->
                        <main class="p-6">
                            <form id="product-form" class="space-y-6">
                                <!-- Stepper Navigation -->
                                <div class="flex justify-between items-center mb-6">
                                    <div class="flex-1 text-center">
                                        <div id="step-0-indicator" class="flex flex-col items-center">
                                            <div class="w-10 h-10 rounded-full flex items-center justify-center border-2 border-blue-700 text-blue-700 font-bold text-lg transition-all duration-300">1</div>
                                            <span id="step-0-title" class="text-sm mt-1 text-gray-700 font-medium"></span>
                                        </div>
                                    </div>
                                    <div class="flex-1 text-center">
                                        <div id="step-1-indicator" class="flex flex-col items-center">
                                            <div class="w-10 h-10 rounded-full flex items-center justify-center border-2 border-gray-400 text-gray-400 font-bold text-lg transition-all duration-300">2</div>
                                            <span id="step-1-title" class="text-sm mt-1 text-gray-500"></span>
                                        </div>
                                    </div>
                                    <div class="flex-1 text-center">
                                        <div id="step-2-indicator" class="flex flex-col items-center">
                                            <div class="w-10 h-10 rounded-full flex items-center justify-center border-2 border-gray-400 text-gray-400 font-bold text-lg transition-all duration-300">3</div>
                                            <span id="step-2-title" class="text-sm mt-1 text-gray-500"></span>
                                        </div>
                                    </div>
                                    <div class="flex-1 text-center">
                                        <div id="step-3-indicator" class="flex flex-col items-center">
                                            <div class="w-10 h-10 rounded-full flex items-center justify-center border-2 border-gray-400 text-gray-400 font-bold text-lg transition-all duration-300">4</div>
                                            <span id="step-3-title" class="text-sm mt-1 text-gray-500"></span>
                                        </div>
                                    </div>
                                </div>

                                <!-- Step Content Container -->
                                <div id="step-content-container">
                                    <!-- Step 0: Product Details -->
                                    <div id="step-0-content" class="space-y-6">
                                        <div class="mb-4">
                                            <label for="product-type" class="block text-gray-700 text-sm font-bold mb-2" id="label-product-type"></label>
                                            <div class="relative">
                                                <select id="product-type" name="product_type" class="block w-full px-4 py-3 rounded-lg border border-gray-300 bg-gray-100 text-gray-900 focus:outline-none focus:ring-2 focus:ring-blue-700 focus:border-transparent transition duration-200">
                                                    <option value="" disabled selected id="select-product-type-placeholder"></option>
                                                    <option value="Clothes" id="option-clothes"></option>
                                                    <option value="Shoes" id="option-shoes"></option>
                                                    <option value="Gadget" id="option-gadget"></option>
                                                    <option value="Cosmetics" id="option-cosmetics"></option>
                                                </select>
                                                <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700">
                                                    <i data-lucide="chevron-down" class="w-5 h-5"></i>
                                                </div>
                                            </div>
                                            <p id="error-product-type" class="text-red-500 text-xs italic mt-1 hidden"></p>
                                        </div>

                                        <div>
                                            <label for="product-name" class="block text-gray-700 text-sm font-bold mb-2" id="label-product-name"></label>
                                            <div class="relative">
                                                <input type="text" id="product-name" name="name" class="w-full px-4 py-3 rounded-lg border border-gray-300 bg-gray-100 text-gray-900 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-700 focus:border-transparent transition duration-200" placeholder="" autocomplete="off">
                                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                                    <i data-lucide="shopping-bag" class="w-5 h-5 text-gray-700"></i>
                                                </div>
                                            </div>
                                            <p id="error-product-name" class="text-red-500 text-xs italic mt-1 hidden"></p>
                                        </div>

                                        <div>
                                            <label for="description-editor" class="block text-gray-700 text-sm font-bold mb-2" id="label-description"></label>
                                            <!-- Quill editor will be initialized here -->
                                            <div id="description-editor" class="h-48"></div>
                                            <p id="error-description" class="text-red-500 text-xs italic mt-1 hidden"></p>
                                        </div>

                                        <div>
                                            <label for="quantity" class="block text-gray-700 text-sm font-bold mb-2" id="label-quantity"></label>
                                            <div class="relative">
                                                <input type="number" id="quantity" name="quantity" class="w-full px-4 py-3 rounded-lg border border-gray-300 bg-gray-100 text-gray-900 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-700 focus:border-transparent transition duration-200" placeholder="" autocomplete="off">
                                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                                    <i data-lucide="hash" class="w-5 h-5 text-gray-700"></i>
                                                </div>
                                            </div>
                                            <p id="error-quantity" class="text-red-500 text-xs italic mt-1 hidden"></p>
                                        </div>

                                        <div>
                                            <label for="base-price" class="block text-gray-700 text-sm font-bold mb-2" id="label-base-price"></label>
                                            <div class="relative">
                                                <input type="number" step="0.01" id="base-price" name="price" class="w-full px-4 py-3 rounded-lg border border-gray-300 bg-gray-100 text-gray-900 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-700 focus:border-transparent transition duration-200" placeholder="" autocomplete="off">
                                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                                    <i data-lucide="dollar-sign" class="w-5 h-5 text-gray-700"></i>
                                                </div>
                                            </div>
                                            <p id="error-base-price" class="text-red-500 text-xs italic mt-1 hidden"></p>
                                        </div>
                                    </div>

                                    <!-- Step 1: Product Variants -->
                                    <div id="step-1-content" class="space-y-6 hidden">
                                        <h2 id="variants-title" class="text-xl font-bold text-gray-900"></h2>
                                        <p id="variants-info" class="text-red-500 text-base text-center py-5 hidden"></p>
                                        <div id="variants-container" class="space-y-4">
                                            <!-- Variant sections will be dynamically added here -->
                                        </div>
                                        <div class="flex justify-end">
                                            <button type="button" id="add-variant-button" class="flex items-center px-4 py-2 text-black font-bold rounded-full border border-gray-300 hover:bg-gray-100 transition duration-200">
                                                <i data-lucide="plus-circle" class="w-5 h-5 mr-2"></i>
                                                <span id="add-another-variant-text"></span>
                                            </button>
                                        </div>
                                    </div>

                                    <!-- Step 2: Images and Custom Options -->
                                    <div id="step-2-content" class="space-y-6 hidden">
                                        <div>
                                            <label for="custom-option" class="block text-gray-700 text-sm font-bold mb-2" id="label-custom-option"></label>
                                            <div class="relative">
                                                <input type="text" id="custom-option" name="custom_option" class="w-full px-4 py-3 rounded-lg border border-gray-300 bg-gray-100 text-gray-900 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-700 focus:border-transparent transition duration-200" placeholder="" autocomplete="off">
                                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                                    <i data-lucide="list-checks" class="w-5 h-5 text-gray-700"></i>
                                                </div>
                                            </div>
                                        </div>

                                        <button type="button" id="select-images-button" class="w-full flex items-center justify-center px-4 py-3 bg-black text-white rounded-xl shadow-md hover:bg-gray-800 focus:outline-none focus:ring-2 focus:ring-gray-600 transition duration-200">
                                            <i data-lucide="image" class="w-6 h-6 mr-3"></i>
                                            <span id="select-product-images-text" class="text-lg font-semibold"></span>
                                        </button>
                                        <input type="file" id="image-upload" multiple accept="image/*" class="hidden">

                                        <div id="image-preview-container" class="flex flex-wrap gap-4 mt-4">
                                            <!-- Image previews will be added here -->
                                        </div>
                                    </div>

                                    <!-- Step 3: Review and Submit -->
                                    <div id="step-3-content" class="space-y-6 hidden">
                                        <p id="review-details-text" class="text-base italic text-gray-700"></p>
                                        <button type="button" id="submit-product-button-final" class="w-full flex items-center justify-center px-4 py-4 bg-black text-white rounded-xl shadow-md hover:bg-gray-800 focus:outline-none focus:ring-2 focus:ring-gray-600 transition duration-200">
                                            <span id="submit-product-text-final" class="text-lg font-bold"></span>
                                            <div id="loading-spinner" class="hidden ml-2 w-6 h-6 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
                                        </button>
                                    </div>
                                </div>

                                <!-- Stepper Controls -->
                                <div class="flex justify-between mt-8 space-x-4">
                                    <button type="button" id="back-button" class="flex-1 px-6 py-3 rounded-xl border border-black text-black font-semibold hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-gray-400 transition duration-200 hidden">
                                        <span id="back-text"></span>
                                    </button>
                                    <button type="button" id="next-button" class="flex-1 px-6 py-3 rounded-xl bg-black text-white font-semibold hover:bg-gray-800 focus:outline-none focus:ring-2 focus:ring-gray-600 transition duration-200">
                                        <span id="next-text"></span>
                                    </button>
                                </div>
                            </form>
                        </main>
                    </div>
                `;
                // Initialize Lucide icons for the newly rendered content
                lucide.createIcons();
                // Initialize Quill editor for the description field
                appState.quill = new Quill('#description-editor', {
                    theme: 'snow',
                    placeholder: getTranslatedString('provide_detailed_description'),
                    modules: {
                        toolbar: [
                            [{ 'header': [1, 2, 3, false] }],
                            ['bold', 'italic', 'underline', 'strike'],
                            [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                            ['link', 'image'],
                            ['clean']
                        ]
                    }
                });
                // Set initial values from appState.productData
                document.getElementById('product-type').value = appState.productData.productType || '';
                document.getElementById('product-name').value = appState.productData.name;
                appState.quill.root.innerHTML = appState.productData.description;
                document.getElementById('quantity').value = appState.productData.quantity;
                document.getElementById('base-price').value = appState.productData.price;
                document.getElementById('custom-option').value = appState.productData.customOption;

                // Re-attach all event listeners for the Add Product form
                attachAddProductEventListeners();
                updateStepperUI(); // Update stepper UI for the add product form
                renderProductVariantsStep(); // Render variants for the add product form
                renderImagePreviews(); // Render image previews for the add product form
                updateLocalizedText(); // Ensure all texts are translated
            } else if (appState.selectedSection === 'documents') {
                mainContentArea.innerHTML = DocumentQuickAccessButtons();
                // Attach listeners for the dynamically created buttons
                mainContentArea.querySelectorAll('.document-access-button').forEach(button => {
                    button.addEventListener('click', () => {
                        selectSection(button.dataset.doctype);
                    });
                });
            } else if (['Factures', 'Bon de Commande', 'Bon de Livraison', 'Bon de Retour'].includes(appState.selectedSection)) {
                mainContentArea.innerHTML = `
                    <div class="dashboard-card bg-white p-6 rounded-xl shadow-lg flex flex-col flex-1">
                        <h3 class="text-2xl font-bold text-gray-800 mb-4">${getTranslatedString(appState.selectedSection.replace(/ /g, ''))} Management</h3>
                        <p class="text-gray-700">Content for managing ${getTranslatedString(appState.selectedSection.replace(/ /g, ''))}...</p>
                        <div class="mt-4 p-4 bg-gray-100 rounded-lg">
                            <p class="font-semibold">Selected Document Type:</p>
                            <p>${appState.selectedSection}</p>
                        </div>
                    </div>
                `;
            }
            else {
                // Generic content for other sections
                mainContentArea.innerHTML = `
                    <div class="dashboard-card bg-white p-6 rounded-xl shadow-lg flex flex-col flex-1">
                        <h3 class="text-2xl font-bold text-gray-800 mb-4">${getTranslatedString(appState.selectedSection)}</h3>
                        <p class="text-gray-700">Content for ${getTranslatedString(appState.selectedSection)} section goes here.</p>
                    </div>
                `;
            }
        }

        function updateFilterButtons() {
            document.querySelectorAll('.filter-button').forEach(button => {
                const filterId = button.id.replace('filter-', '');
                if (filterId === appState.selectedFilter) {
                    button.classList.remove('bg-gray-200', 'text-gray-800', 'hover:bg-gray-300');
                    button.classList.add('bg-indigo-600', 'text-white', 'hover:bg-indigo-700');
                } else {
                    button.classList.remove('bg-indigo-600', 'text-white', 'hover:bg-indigo-700');
                    button.classList.add('bg-gray-200', 'text-gray-800', 'hover:bg-gray-300');
                }
            });

            const customDateRangeDiv = document.getElementById('custom-date-range');
            if (customDateRangeDiv) { // Check if element exists (only on Dashboard)
                if (appState.selectedFilter === 'custom') {
                    customDateRangeDiv.classList.remove('hidden');
                } else {
                    customDateRangeDiv.classList.add('hidden');
                }
            }
        }

        function renderOrderSummaryCard() {
            const contentDiv = document.getElementById('order-summary-content');
            if (!contentDiv) return; // Exit if not on Dashboard

            if (appState.isOrdersLoading) {
                contentDiv.innerHTML = `
                    <div class="flex flex-col items-center justify-center">
                        <div class="animate-spin rounded-full h-12 w-12 border-4 border-indigo-500 border-t-transparent"></div>
                        <p class="mt-4 text-gray-600">Loading orders...</p>
                    </div>
                `;
            } else if (appState.orderErrorMessage) {
                contentDiv.innerHTML = `
                    <div class="flex flex-col items-center justify-center text-red-500 p-4 text-center">
                        <i class="fas fa-exclamation-triangle text-4xl mb-2"></i>
                        <p class="text-lg">${appState.orderErrorMessage}</p>
                        <button id="retry-orders-summary" class="mt-4 bg-blue-500 text-white px-4 py-2 rounded-lg shadow hover:bg-blue-600 transition duration-300">
                            <i class="fas fa-sync-alt mr-2"></i>${getTranslatedString('retry')}
                        </button>
                    </div>
                `;
                document.getElementById('retry-orders-summary').onclick = fetchOrders;
            } else {
                contentDiv.innerHTML = `
                    <div class="w-full">
                        ${buildStatusRow(getTranslatedString('totalOrders'), appState.totalOrders, 'teal-700', true)}
                        <hr class="my-4 border-gray-200">
                        ${buildStatusRow(getTranslatedString('pending'), appState.pendingOrders, 'indigo-600', false)}
                        <hr class="my-4 border-gray-200">
                        ${buildStatusRow(getTranslatedString('confirmed'), appState.confirmedOrders, 'green-600', false)}
                        <hr class="my-4 border-gray-200">
                        ${buildStatusRow(getTranslatedString('tentative'), appState.tentativeOrders, 'orange-600', false)}
                        <hr class="my-4 border-gray-200">
                        ${buildStatusRow(getTranslatedString('cancelled'), appState.cancelledOrders, 'red-600', false)}
                    </div>
                `;
            }
        }

        function buildStatusRow(label, count, colorClass, isTotal) {
            const textColor = `text-${colorClass}`;
            const fontWeight = isTotal ? 'font-semibold' : 'font-medium';
            const fontSize = isTotal ? 'text-lg' : 'text-base';
            const countFontSize = isTotal ? 'text-lg' : 'text-base';

            return `
                <div class="flex items-center py-2">
                    <div class="w-4 h-4 rounded-md bg-${colorClass}"></div>
                    <span class="ml-3 flex-1 ${fontSize} ${fontWeight} text-gray-800">${label}</span>
                    <span class="${countFontSize} font-bold ${textColor}">${count}</span>
                </div>
            `;
        }

        const statusColors = {
            'Pending': 'rgb(67, 56, 202)', // indigo-600
            'Confirmed': 'rgb(22, 163, 74)', // green-600
            'Tentative': 'rgb(234, 88, 12)', // orange-600
            'Cancelled': 'rgb(220, 38, 38)', // red-600
            'Unknown': 'rgb(156, 163, 175)', // gray-400
        };

        function renderOrderPieChartCard() {
            const contentDiv = document.getElementById('order-distribution-content');
            const canvas = document.getElementById('orderPieChart');

            if (!contentDiv || !canvas) return; // Exit if not on Dashboard

            if (appState.isOrdersLoading) {
                contentDiv.innerHTML = `
                    <div class="flex flex-col items-center justify-center">
                        <div class="animate-spin rounded-full h-12 w-12 border-4 border-indigo-500 border-t-transparent"></div>
                        <p class="mt-4 text-gray-600">Loading chart data...</p>
                    </div>
                `;
                if (appState.orderPieChartInstance) {
                    appState.orderPieChartInstance.destroy();
                    appState.orderPieChartInstance = null;
                }
                return;
            } else if (appState.orderErrorMessage) {
                contentDiv.innerHTML = `
                    <div class="flex flex-col items-center justify-center text-red-500 p-4 text-center">
                        <i class="fas fa-exclamation-triangle text-4xl mb-2"></i>
                        <p class="text-lg">${appState.orderErrorMessage}</p>
                        <button id="retry-orders-chart" class="mt-4 bg-blue-500 text-white px-4 py-2 rounded-lg shadow hover:bg-blue-600 transition duration-300">
                            <i class="fas fa-sync-alt mr-2"></i>${getTranslatedString('retry')}
                        </button>
                    </div>
                `;
                document.getElementById('retry-orders-chart').onclick = fetchOrders;
                if (appState.orderPieChartInstance) {
                    appState.orderPieChartInstance.destroy();
                    appState.orderPieChartInstance = null;
                }
                return;
            }

            const dataMap = {};
            if (appState.pendingOrders > 0) dataMap[getTranslatedString('pending')] = appState.pendingOrders;
            if (appState.confirmedOrders > 0) dataMap[getTranslatedString('confirmed')] = appState.confirmedOrders;
            if (appState.tentativeOrders > 0) dataMap[getTranslatedString('tentative')] = appState.tentativeOrders;
            if (appState.cancelledOrders > 0) dataMap[getTranslatedString('cancelled')] = appState.cancelledOrders;

            if (appState.totalOrders === 0 || Object.keys(dataMap).length === 0) {
                contentDiv.innerHTML = `
                    <div class="bg-gray-100 p-8 rounded-xl shadow-inner text-center">
                        <i class="fas fa-info-circle text-4xl text-gray-500 mb-3"></i>
                        <p class="text-lg text-gray-700">${getTranslatedString('noDataChart')}</p>
                    </div>
                `;
                if (appState.orderPieChartInstance) {
                    appState.orderPieChartInstance.destroy();
                    appState.orderPieChartInstance = null;
                }
                return;
            }

            // Ensure canvas is visible if it was hidden by an error/empty message
            if (contentDiv.querySelector('canvas') === null) {
                contentDiv.innerHTML = '<canvas id="orderPieChart"></canvas>';
            }
            const ctx = document.getElementById('orderPieChart').getContext('2d');

            const labels = Object.keys(dataMap);
            const data = Object.values(dataMap);
            const colors = labels.map(label => {
                // Map translated label back to original key for color lookup
                const originalKey = Object.keys(translations['en']).find(key => translations['en'][key] === label || translations['ar'][key] === label);
                if (originalKey) {
                    // Normalize key to match statusColors (e.g., "pending" -> "Pending")
                    const capitalizedKey = originalKey.charAt(0).toUpperCase() + originalKey.slice(1);
                    return statusColors[capitalizedKey] || statusColors['Unknown'];
                }
                return statusColors['Unknown']; // Fallback
            });

            if (appState.orderPieChartInstance) {
                appState.orderPieChartInstance.data.labels = labels;
                appState.orderPieChartInstance.data.datasets[0].data = data;
                appState.orderPieChartInstance.data.datasets[0].backgroundColor = colors;
                appState.orderPieChartInstance.options.plugins.title.text = `${getTranslatedString('totalOrders')}: ${appState.totalOrders}`;
                appState.orderPieChartInstance.update();
            } else {
                appState.orderPieChartInstance = new Chart(ctx, {
                    type: 'doughnut', // Use doughnut for the ring effect
                    data: {
                        labels: labels,
                        datasets: [{
                            data: data,
                            backgroundColor: colors,
                            borderColor: '#ffffff',
                            borderWidth: 2,
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        cutout: '70%', // Controls the size of the inner hole for doughnut chart
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    font: {
                                        size: 14,
                                        weight: '500',
                                    },
                                    color: '#333',
                                    usePointStyle: true, // Use circle for legend items
                                },
                            },
                            title: {
                                display: true,
                                text: `${getTranslatedString('totalOrders')}: ${appState.totalOrders}`,
                                font: {
                                    size: 18,
                                    weight: 'bold',
                                },
                                color: '#1a202c', // Dark gray
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        let label = context.label || '';
                                        if (label) {
                                            label += ': ';
                                        }
                                        if (context.parsed !== null) {
                                            label += new Intl.NumberFormat('en-US', { style: 'decimal' }).format(context.parsed);
                                            const total = context.dataset.data.reduce((sum, val) => sum + val, 0);
                                            const percentage = (context.parsed / total * 100).toFixed(1);
                                            label += ` (${percentage}%)`;
                                        }
                                        return label;
                                    }
                                }
                            }
                        }
                    }
                });
            }
        }

        function renderAdminsCard() {
            const contentDiv = document.getElementById('admins-content');
            if (!contentDiv) return; // Exit if not on Admins section

            const filteredAdmins = appState.admins.filter(admin => {
                const name = admin.name ? admin.name.toLowerCase() : '';
                const role = admin.role ? admin.role.toLowerCase() : '';
                const filter = appState.adminFilter.toLowerCase();
                return name.includes(filter) || role.includes(filter);
            });

            if (appState.admins.length === 0) {
                contentDiv.innerHTML = `
                    <div class="flex flex-col items-center justify-center h-full text-gray-600">
                        <div class="animate-spin rounded-full h-12 w-12 border-4 border-indigo-500 border-t-transparent"></div>
                        <p class="mt-4">Loading admins...</p>
                    </div>
                `;
                return;
            }

            contentDiv.innerHTML = filteredAdmins.map(admin => `
                <div class="bg-white p-3 rounded-lg shadow-sm mb-3 flex items-center">
                    <div class="w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center mr-3">
                        <i class="fas fa-user text-blue-600"></i>
                    </div>
                    <div>
                        <h4 class="font-semibold text-gray-900">${admin.name || getTranslatedString('unknown')}</h4>
                        <p class="text-sm text-gray-600">${getTranslatedString('role')}: ${admin.role || getTranslatedString('unknown')}</p>
                    </div>
                </div>
            `).join('');

            if (filteredAdmins.length === 0 && appState.adminFilter !== '') {
                contentDiv.innerHTML = `
                    <div class="flex flex-col items-center justify-center h-full text-gray-600">
                        <i class="fas fa-info-circle text-4xl mb-3"></i>
                        <p>No admins found matching your search.</p>
                    </div>
                `;
            }
        }

        function updateCustomDateRangeDisplay() {
            const selectedDateRangeText = document.getElementById('selected-date-range');
            if (selectedDateRangeText) { // Check if element exists (only on Dashboard)
                if (appState.selectedFilter === 'custom' && appState.customStartDate && appState.customEndDate) {
                    const startDateFormatted = new Intl.DateTimeFormat(appState.isEnglish ? 'en-US' : 'ar-EG', { month: 'short', day: 'numeric', year: 'numeric' }).format(appState.customStartDate);
                    const endDateFormatted = new Intl.DateTimeFormat(appState.isEnglish ? 'en-US' : 'ar-EG', { month: 'short', day: 'numeric', year: 'numeric' }).format(appState.customEndDate);
                    selectedDateRangeText.textContent = `${getTranslatedString('selected')}: ${startDateFormatted} - ${endDateFormatted}`;
                    selectedDateRangeText.classList.remove('hidden');
                } else {
                    selectedDateRangeText.classList.add('hidden');
                }
            }
        }

        function updateNotificationBadge() {
            const count = appState.newOrders.length;
            const mobileBadge = document.getElementById('notification-badge-mobile');
            const desktopBadge = document.getElementById('notification-badge-desktop');

            if (mobileBadge) {
                if (count > 0) {
                    mobileBadge.textContent = count.toString();
                    mobileBadge.classList.remove('hidden');
                } else {
                    mobileBadge.classList.add('hidden');
                }
            }
            if (desktopBadge) {
                if (count > 0) {
                    desktopBadge.textContent = count.toString();
                    desktopBadge.classList.remove('hidden');
                } else {
                    desktopBadge.classList.add('hidden');
                }
            }
        }

        function DocumentQuickAccessButtons() {
            return `
                <div class="dashboard-card bg-white p-6 rounded-xl shadow-lg flex flex-col flex-1 items-center justify-center text-gray-800">
                    <h3 class="text-2xl font-bold mb-6 text-center">${getTranslatedString('manageCommercialDocuments')}</h3>
                    <div class="flex flex-wrap justify-center gap-6">
                        ${buildQuickAccessButton('Factures', 'fas fa-receipt', getTranslatedString('invoice'))}
                        ${buildQuickAccessButton('Bon de Commande', 'fas fa-file-invoice', getTranslatedString('purchaseOrder'))}
                        ${buildQuickAccessButton('Bon de Livraison', 'fas fa-truck-loading', getTranslatedString('deliveryNote'))}
                        ${buildQuickAccessButton('Bon de Retour', 'fas fa-undo-alt', getTranslatedString('returnNote'))}
                    </div>
                </div>
            `;
        }

        function buildQuickAccessButton(documentTypeKey, iconClass, label) {
            return `
                <button class="document-access-button bg-white p-6 rounded-xl shadow-md hover:shadow-lg transition duration-300 flex flex-col items-center justify-center w-44 h-40 text-gray-800" data-doctype="${documentTypeKey}">
                    <i class="${iconClass} text-5xl text-indigo-600 mb-3"></i>
                    <span class="text-lg font-semibold text-center">${label}</span>
                </button>
            `;
        }

        // --- Modals and Notification Logic ---

        async function _loadUserRole() {
            // Simulate loading user role from localStorage
            appState.userRole = localStorage.getItem('userRole') || 'admin'; // Default to 'admin'
            // For demonstration, uncomment to set a specific role:
            // appState.userRole = 'confirmation';
            // appState.userRole = 'stockagent';
            renderApp(); // Re-render after loading role
        }

        function _simulateNewOrders() {
            if (appState.orderSimulationTimer) {
                clearInterval(appState.orderSimulationTimer);
            }

            appState.orderSimulationTimer = setInterval(() => {
                if (appState.newOrders.length < 5) { // Simulate up to 5 new orders
                    const newOrderId = `ORD${Math.floor(Math.random() * 1000000).toString().padStart(6, '0')}`;
                    appState.newOrders.push({ id: newOrderId, status: getTranslatedString('pending') });
                    updateNotificationBadge();
                } else {
                    clearInterval(appState.orderSimulationTimer);
                }
            }, 10000); // Add a new order every 10 seconds
        }

        function _logout() {
            const logoutModal = document.getElementById('logout-modal');
            logoutModal.style.display = 'flex';

            document.getElementById('cancel-logout').onclick = () => {
                logoutModal.style.display = 'none';
            };

            document.getElementById('confirm-logout').onclick = () => {
                localStorage.removeItem('userRole'); // Clear simulated role
                window.location.reload(); // Reload to simulate logout and redirect to login
            };
        }

        function _showNewOrdersDialog() {
            const newOrdersModal = document.getElementById('new-orders-modal');
            const newOrdersListDiv = document.getElementById('new-orders-list');

            newOrdersListDiv.innerHTML = ''; // Clear previous list

            if (appState.newOrders.length === 0) {
                newOrdersListDiv.innerHTML = `<p class="text-center text-gray-700">${getTranslatedString('noNewOrders')}</p>`;
            } else {
                appState.newOrders.forEach(order => {
                    const orderItem = document.createElement('div');
                    orderItem.className = 'bg-gray-50 p-3 rounded-lg shadow-sm mb-2 flex items-center justify-between';
                    orderItem.innerHTML = `
                        <div class="flex items-center">
                            <i class="fas fa-receipt text-indigo-600 mr-3"></i>
                            <div>
                                <h4 class="font-semibold text-gray-900">${getTranslatedString('orderId')}: ${order.id}</h4>
                                <p class="text-sm text-gray-600">${getTranslatedString('status')}: ${order.status}</p>
                            </div>
                        </div>
                        <button class="mark-as-processed-button bg-green-500 text-white px-3 py-1 rounded-md hover:bg-green-600 transition duration-300 text-sm" data-order-id="${order.id}">
                            <i class="fas fa-check-circle"></i> ${getTranslatedString('markAsProcessed')}
                        </button>
                    `;
                    newOrdersListDiv.appendChild(orderItem);
                });

                newOrdersListDiv.querySelectorAll('.mark-as-processed-button').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const orderId = e.currentTarget.dataset.orderId;
                        _removeOrderFromNotifications(orderId);
                        // Re-render dialog content after removing an order
                        _showNewOrdersDialog();
                    });
                });
            }

            newOrdersModal.style.display = 'flex';

            document.getElementById('close-new-orders').onclick = () => {
                newOrdersModal.style.display = 'none';
            };

            document.getElementById('mark-all-as-read').onclick = () => {
                _clearAllNotifications();
                newOrdersModal.style.display = 'none';
            };
        }

        function _clearAllNotifications() {
            appState.newOrders = [];
            updateNotificationBadge();
            // Optionally, show a toast/snackbar message
            console.log("All notifications cleared.");
        }

        function _removeOrderFromNotifications(orderId) {
            appState.newOrders = appState.newOrders.filter(order => order.id !== orderId);
            updateNotificationBadge();
            // Show a temporary message (like Flutter's SnackBar)
            const message = `${getTranslatedString('orderProcessed').replace('Order', 'Order ID')} ${orderId}.`;
            const toast = document.createElement('div');
            toast.className = 'fixed bottom-4 left-1/2 -translate-x-1/2 bg-gray-800 text-white px-4 py-2 rounded-lg shadow-lg opacity-0 transition-opacity duration-300';
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => {
                toast.classList.add('opacity-100');
            }, 10);
            setTimeout(() => {
                toast.classList.remove('opacity-100');
                toast.addEventListener('transitionend', () => toast.remove());
            }, 3000);
        }

        // --- Add Product Specific Functions ---

        /**
         * Displays a message box (snackbar equivalent).
         * @param {string} message The message to display.
         * @param {string} type 'success', 'error', 'info'.
         */
        function showMessage(message, type = 'info') {
            const messageBox = document.getElementById('message-box');
            const messageText = document.getElementById('message-text');

            messageText.textContent = message;
            messageBox.classList.remove('hidden', 'opacity-0', 'bg-red-500', 'bg-green-500', 'bg-gray-800'); // Remove all previous type classes
            messageBox.classList.add('opacity-100');

            if (type === 'success') {
                messageBox.classList.add('bg-green-500');
            } else if (type === 'error') {
                messageBox.classList.add('bg-red-500');
            } else {
                messageBox.classList.add('bg-gray-800');
            }

            setTimeout(() => {
                messageBox.classList.remove('opacity-100');
                messageBox.classList.add('opacity-0');
                setTimeout(() => messageBox.classList.add('hidden'), 300); // Hide after transition
            }, 3000);
        }

        /**
         * Helper to convert color name string to a CSS color value.
         * @param {string} colorName
         * @returns {string} CSS color string.
         */
        function _colorNameToCss(colorName) {
            switch (colorName.toLowerCase()) {
                case 'black': return '#000000';
                case 'white': return '#FFFFFF';
                case 'red': return '#EF4444'; // Tailwind red-500
                case 'blue': return '#3B82F6'; // Tailwind blue-500
                case 'green': return '#22C55E'; // Tailwind green-500
                case 'yellow': return '#FACC15'; // Tailwind yellow-400
                case 'purple': return '#A855F7'; // Tailwind purple-500
                case 'brown': return '#8B5F2A'; // A shade of brown
                case 'beige': return '#F5F5DC'; // Beige
                case 'grey': return '#6B7280'; // Tailwind gray-500
                case 'pink': return '#EC4899'; // Tailwind pink-500
                case 'orange': return '#F97316'; // Tailwind orange-500
                case 'sky blue': return '#0EA5E9'; // Tailwind sky-500
                case 'turquoise': return '#14B8A6'; // Tailwind teal-500
                default: return '#64748B'; // Tailwind slate-500 (fallback)
            }
        }

        /**
         * Calculates luminance for text color decision.
         * @param {string} hexColor Hex color string (e.g., #RRGGBB).
         * @returns {number} Luminance value between 0 and 1.
         */
        function getLuminance(hexColor) {
            const r = parseInt(hexColor.substring(1, 3), 16) / 255;
            const g = parseInt(hexColor.substring(3, 5), 16) / 255;
            const b = parseInt(hexColor.substring(5, 7), 16) / 255;

            const RsRGB = r <= 0.03928 ? r / 12.92 : Math.pow((r + 0.055) / 1.055, 2.4);
            const GsRGB = g <= 0.03928 ? g / 12.92 : Math.pow((g + 0.055) / 1.055, 2.4);
            const BsRGB = b <= 0.03928 ? b / 12.92 : Math.pow((b + 0.055) / 1.055, 2.4);

            return 0.2126 * RsRGB + 0.7152 * GsRGB + 0.0722 * BsRGB;
        }

        /**
         * Determines appropriate text color (black/white) based on background color luminance.
         * @param {string} hexColor Hex color string.
         * @returns {string} 'text-black' or 'text-white' Tailwind class.
         */
        function getTextColorClass(hexColor) {
            return getLuminance(hexColor) > 0.5 ? 'text-black' : 'text-white';
        }

        /**
         * Helper to get available sizes based on product type.
         * @returns {string[]} Array of size strings.
         */
        function getAvailableSizes() {
            if (appState.productData.productType === 'Clothes') {
                return ['XS', 'S', 'M', 'L', 'XL', 'XXL'];
            } else if (appState.productData.productType === 'Shoes') {
                return ['36', '37', '38', '39', '40', '41', '42', '43', '44', '45'];
            }
            return [];
        }

        /**
         * Helper to convert product type string to localized string.
         * @param {string} type
         * @returns {string} Localized product type.
         */
        function _productTypeToLocalized(type) {
            return getTranslatedString(type.toLowerCase());
        }

        /**
         * Updates all text content based on the current locale.
         */
        function updateLocalizedText() {
            // Elements that are always present in the main admin panel
            document.getElementById('language-text-mobile').textContent = getTranslatedString('language');
            document.getElementById('app-bar-title').textContent = getTranslatedString('adminPanelTitle');
            document.getElementById('confirm-logout-title').textContent = getTranslatedString('confirmLogout');
            document.getElementById('are-you-sure-logout-text').textContent = getTranslatedString('areYouSureLogout');
            document.getElementById('cancel-logout').textContent = getTranslatedString('cancel');
            document.getElementById('confirm-logout').textContent = getTranslatedString('logout');
            document.getElementById('new-orders-title').textContent = getTranslatedString('newOrders');
            document.getElementById('close-new-orders').textContent = getTranslatedString('close');
            document.getElementById('mark-all-as-read').textContent = getTranslatedString('markAllAsRead');

            const filterOrdersTitle = document.getElementById('filter-orders-title');
            if (filterOrdersTitle) filterOrdersTitle.textContent = getTranslatedString('filterOrders');
            const filterLabels = document.querySelectorAll('.filter-label');
            if (filterLabels[0]) filterLabels[0].textContent = getTranslatedString('today');
            if (filterLabels[1]) filterLabels[1].textContent = getTranslatedString('thisMonth');
            if (filterLabels[2]) filterLabels[2].textContent = getTranslatedString('customRange');
            if (filterLabels[3]) filterLabels[3].textContent = getTranslatedString('allOrders');

            const startDateLabel = document.querySelector('#custom-date-range label[for="start-date"]');
            if (startDateLabel) startDateLabel.textContent = getTranslatedString('From') + ':';
            const endDateLabel = document.querySelector('#custom-date-range label[for="end-date"]');
            if (endDateLabel) endDateLabel.textContent = getTranslatedString('To') + ':';


            // Add Product specific elements (only update if they exist in the DOM)
            const appTitle = document.getElementById('app-title');
            const langEnText = document.getElementById('lang-en-text');
            const langArText = document.getElementById('lang-ar-text');

            if (appTitle) appTitle.textContent = getTranslatedString('add_new_product');
            if (langEnText) langEnText.textContent = getTranslatedString('english');
            if (langArText) langArText.textContent = getTranslatedString('arabic');

            // Stepper titles
            const stepTitles = [0, 1, 2, 3].map(i => document.getElementById(`step-${i}-title`));
            if (stepTitles[0]) stepTitles[0].textContent = getTranslatedString('product_details');
            if (stepTitles[1]) stepTitles[1].textContent = getTranslatedString('product_variants');
            if (stepTitles[2]) stepTitles[2].textContent = getTranslatedString('images_custom_options');
            if (stepTitles[3]) stepTitles[3].textContent = getTranslatedString('review_submit');

            // Step 0 labels and placeholders
            const labelProductType = document.getElementById('label-product-type');
            const selectProductTypePlaceholder = document.getElementById('select-product-type-placeholder');
            const optionClothes = document.getElementById('option-clothes');
            const optionShoes = document.getElementById('option-shoes');
            const optionGadget = document.getElementById('option-gadget');
            const optionCosmetics = document.getElementById('option-cosmetics');
            const labelProductName = document.getElementById('label-product-name');
            const productNameInput = document.getElementById('product-name');
            const labelDescription = document.getElementById('label-description');
            const quantityInput = document.getElementById('quantity');
            const labelQuantity = document.getElementById('label-quantity');
            const basePriceInput = document.getElementById('base-price');
            const labelBasePrice = document.getElementById('label-base-price');

            if (labelProductType) labelProductType.textContent = getTranslatedString('product_type');
            if (selectProductTypePlaceholder) selectProductTypePlaceholder.textContent = getTranslatedString('select_product_type');
            if (optionClothes) optionClothes.textContent = getTranslatedString('clothes');
            if (optionShoes) optionShoes.textContent = getTranslatedString('shoes');
            if (optionGadget) optionGadget.textContent = getTranslatedString('gadget');
            if (optionCosmetics) optionCosmetics.textContent = getTranslatedString('cosmetics');

            if (labelProductName) labelProductName.textContent = getTranslatedString('product_name');
            if (productNameInput) productNameInput.placeholder = getTranslatedString('example_tshirt');

            if (labelDescription) labelDescription.textContent = getTranslatedString('detailed_description');
            // Quill placeholder is set during initialization and doesn't update dynamically via API.
            if (appState.quill) {
                // This is a workaround as Quill's placeholder is not directly exposed for dynamic update.
                const quillPlaceholder = document.querySelector('#description-editor .ql-editor.ql-blank::before');
                if (quillPlaceholder) {
                    quillPlaceholder.dataset.placeholder = getTranslatedString('provide_detailed_description');
                }
            }


            if (labelQuantity) labelQuantity.textContent = getTranslatedString('total_quantity');
            if (quantityInput) quantityInput.placeholder = getTranslatedString('example_100');

            if (labelBasePrice) labelBasePrice.textContent = getTranslatedString('base_price');
            if (basePriceInput) basePriceInput.placeholder = getTranslatedString('example_1500_00');

            // Step 1 titles and buttons
            const variantsTitle = document.getElementById('variants-title');
            const addAnotherVariantText = document.getElementById('add-another-variant-text');
            const variantsInfo = document.getElementById('variants-info');

            if (variantsTitle) variantsTitle.textContent = getTranslatedString('product_variants_colors_sizes_prices');
            if (addAnotherVariantText) addAnotherVariantText.textContent = getTranslatedString('add_another_variant');
            if (variantsInfo) {
                variantsInfo.textContent = appState.productData.productType === null
                    ? getTranslatedString('please_select_product_type_first')
                    : getTranslatedString('this_product_type_no_variants');
            }


            // Step 2 labels and buttons
            const labelCustomOption = document.getElementById('label-custom-option');
            const customOptionInput = document.getElementById('custom-option');
            const selectProductImagesText = document.getElementById('select-product-images-text');

            if (labelCustomOption) labelCustomOption.textContent = getTranslatedString('custom_option_optional');
            if (customOptionInput) customOptionInput.placeholder = getTranslatedString('example_gift_wrap');
            if (selectProductImagesText) selectProductImagesText.textContent = getTranslatedString('select_product_images');

            // Step 3 text and buttons
            const reviewDetailsText = document.getElementById('review-details-text');
            const submitProductTextFinal = document.getElementById('submit-product-text-final');

            if (reviewDetailsText) reviewDetailsText.textContent = getTranslatedString('review_details_before_submitting');
            if (submitProductTextFinal) submitProductTextFinal.textContent = getTranslatedString('submit_product');

            // Stepper controls
            const nextText = document.getElementById('next-text');
            const backText = document.getElementById('back-text');

            if (nextText) nextText.textContent = getTranslatedString('next');
            if (backText) backText.textContent = getTranslatedString('back');

            // Color modal
            const chooseColorsTitle = document.getElementById('choose-colors-title');
            const labelAddNewColor = document.getElementById('label-add-new-color');
            const newColorInput = document.getElementById('new-color-input');
            const addText = document.getElementById('add-text');
            const cancelText = document.getElementById('cancel-text');
            const confirmText = document.getElementById('confirm-text');

            if (chooseColorsTitle) chooseColorsTitle.textContent = getTranslatedString('choose_colors');
            if (labelAddNewColor) labelAddNewColor.textContent = getTranslatedString('add_new_color');
            if (newColorInput) newColorInput.placeholder = getTranslatedString('example_sky_blue');
            if (addText) addText.textContent = getTranslatedString('add');
            if (cancelText) cancelText.textContent = getTranslatedString('cancel');
            if (confirmText) confirmText.textContent = getTranslatedString('confirm');


            // Re-render dynamic parts to apply new locale
            // These functions will check if the elements exist before rendering
            renderProductVariantsStep(); // To update variant labels
            updateStepperUI(); // To update stepper titles
            renderImagePreviews(); // To update image previews (if any text there)
        }

        /**
         * Clears all form fields and resets state for Add Product.
         */
        function clearAddProductForm() {
            appState.productData = {
                name: '',
                description: '',
                quantity: '',
                price: '',
                customOption: '',
                productType: null,
                variants: [{ colors: [], sizes: [], price: '', promoCode: '' }],
                images: [],
            };
            appState.currentStep = 0;
            appState.addProductIsLoading = false;
            appState.availableColors = [...appState.predefinedColors]; // Reset custom colors

            // Get elements after they are rendered in the DOM
            const productNameInput = document.getElementById('product-name');
            const quantityInput = document.getElementById('quantity');
            const basePriceInput = document.getElementById('base-price');
            const customOptionInput = document.getElementById('custom-option');
            const productTypeSelect = document.getElementById('product-type');
            const imagePreviewContainer = document.getElementById('image-preview-container');
            const variantsContainer = document.getElementById('variants-container');

            if (productNameInput) productNameInput.value = '';
            if (appState.quill) appState.quill.setText(''); // Clear Quill editor
            if (quantityInput) quantityInput.value = '';
            if (basePriceInput) basePriceInput.value = '';
            if (customOptionInput) customOptionInput.value = '';
            if (productTypeSelect) productTypeSelect.value = ''; // Reset dropdown

            if (imagePreviewContainer) imagePreviewContainer.innerHTML = '';
            if (variantsContainer) variantsContainer.innerHTML = ''; // Clear variant sections
            renderProductVariantsStep(); // Re-render initial variant

            updateStepperUI();
            hideAllErrors();
            updateLocalizedText(); // Reapply texts after clearing
        }

        /**
         * Hides all error messages for Add Product form.
         */
        function hideAllErrors() {
            document.querySelectorAll('[id^="error-"]').forEach(el => el.classList.add('hidden'));
        }

        /**
         * Displays an error message for a specific input field in Add Product form.
         * @param {string} fieldId The ID of the input field (e.g., 'product-name').
         * @param {string} message The error message.
         */
        function showError(fieldId, message) {
            const errorElement = document.getElementById(`error-${fieldId}`);
            if (errorElement) {
                errorElement.textContent = message;
                errorElement.classList.remove('hidden');
            }
        }

        /**
         * Hides an error message for a specific input field in Add Product form.
         * @param {string} fieldId The ID of the input field.
         */
        function hideError(fieldId) {
            const errorElement = document.getElementById(`error-${fieldId}`);
            if (errorElement) {
                errorElement.classList.add('hidden');
            }
        }

        // --- Validation Functions (for Add Product page) ---

        /**
         * Validates Step 0 (Product Details).
         * @returns {boolean} True if valid, false otherwise.
         */
        function validateStep0() {
            let isValid = true;
            hideError('product-type');
            hideError('product-name');
            hideError('description');
            hideError('quantity');
            hideError('base-price');

            if (!appState.productData.productType) {
                showError('product-type', getTranslatedString('please_select_product_type'));
                isValid = false;
            }
            // Validate Quill editor content
            if (appState.quill && appState.quill.getText().trim().length <= 0) {
                showError('description', getTranslatedString('description_cannot_be_empty'));
                isValid = false;
            }
            if (!appState.productData.name.trim()) {
                showError('product-name', getTranslatedString('name_cannot_be_empty'));
                isValid = false;
            }
            const quantity = parseInt(appState.productData.quantity);
            if (isNaN(quantity) || appState.productData.quantity === '') {
                showError('quantity', getTranslatedString('quantity_cannot_be_empty'));
                isValid = false;
            } else if (!Number.isInteger(quantity)) {
                showError('quantity', getTranslatedString('enter_valid_integer'));
                isValid = false;
            } else if (quantity < 0) {
                showError('quantity', getTranslatedString('quantity_cannot_be_negative'));
                isValid = false;
            }
            const price = parseFloat(appState.productData.price);
            if (isNaN(price) || appState.productData.price === '') {
                showError('base-price', getTranslatedString('price_cannot_be_empty'));
                isValid = false;
            } else if (price <= 0) {
                showError('base-price', getTranslatedString('price_must_be_greater_than_0'));
                isValid = false;
            }
            return isValid;
        }

        /**
         * Validates Step 1 (Product Variants).
         * @returns {boolean} True if valid, false otherwise.
         */
        function validateStep1() {
            let isValid = true;
            // Clear previous variant errors
            document.querySelectorAll('[id^="error-variant-price-"]').forEach(el => el.classList.add('hidden'));

            if (appState.productData.productType === 'Clothes' || appState.productData.productType === 'Shoes') {
                if (appState.productData.variants.length === 0) {
                    showMessage(getTranslatedString('please_fill_all_required_fields'), 'error');
                    return false;
                }
                appState.productData.variants.forEach((variant, index) => {
                    const price = parseFloat(variant.price);
                    if (isNaN(price) || variant.price === '') {
                        showError(`variant-price-${index}`, getTranslatedString('variant_price_cannot_be_empty'));
                        isValid = false;
                    } else if (price <= 0) {
                        showError(`variant-price-${index}`, getTranslatedString('variant_price_must_be_greater_than_0'));
                        isValid = false;
                    }
                });
            }
            return isValid;
        }

        /**
         * Validates all steps before final submission.
         * @returns {boolean} True if all steps are valid, false otherwise.
         */
        function validateAllSteps() {
            let allValid = true;
            if (!validateStep0()) {
                allValid = false;
                appState.currentStep = 0; // Go back to step 0 if invalid
                updateStepperUI();
                showMessage(getTranslatedString('please_correct_form_errors'), 'error');
                return false;
            }
            if ((appState.productData.productType === 'Clothes' || appState.productData.productType === 'Shoes') && !validateStep1()) {
                allValid = false;
                appState.currentStep = 1; // Go back to step 1 if invalid
                updateStepperUI();
                showMessage(getTranslatedString('please_correct_form_errors'), 'error');
                return false;
            }
            // Step 2 has no mandatory fields other than image selection, which is optional.
            return allValid;
        }

        // --- Stepper UI and Logic (for Add Product page) ---

        /**
         * Updates the stepper UI (active step, completed steps, content visibility).
         */
        function updateStepperUI() {
            const stepIndicators = [0, 1, 2, 3].map(i => document.getElementById(`step-${i}-indicator`));
            const stepTitles = [0, 1, 2, 3].map(i => document.getElementById(`step-${i}-title`));
            const stepContents = [0, 1, 2, 3].map(i => document.getElementById(`step-${i}-content`));
            const backButton = document.getElementById('back-button');
            const nextButton = document.getElementById('next-button');
            const submitProductButtonFinal = document.getElementById('submit-product-button-final');

            if (!stepIndicators[0] || !stepTitles[0] || !stepContents[0] || !backButton || !nextButton || !submitProductButtonFinal) return; // Exit if elements not yet rendered

            stepIndicators.forEach((indicator, index) => {
                const circle = indicator.children[0];
                const title = indicator.children[1];

                // Reset classes
                circle.classList.remove('border-blue-700', 'text-blue-700', 'bg-blue-700', 'text-white', 'border-green-700', 'text-green-700');
                circle.classList.add('border-gray-400', 'text-gray-400');
                title.classList.remove('text-gray-900', 'font-bold');
                title.classList.add('text-gray-500');

                if (index === appState.currentStep) {
                    circle.classList.remove('border-gray-400', 'text-gray-400');
                    circle.classList.add('border-blue-700', 'text-blue-700');
                    title.classList.add('text-gray-900', 'font-bold');
                } else if (index < appState.currentStep) {
                    circle.classList.remove('border-gray-400', 'text-gray-400');
                    circle.classList.add('bg-green-700', 'text-white', 'border-green-700');
                    title.classList.add('text-gray-900');
                }

                // Hide all step contents first
                stepContents[index].classList.add('hidden');
            });

            // Show current step content
            stepContents[appState.currentStep].classList.remove('hidden');

            // Update button visibility and text
            if (appState.currentStep === 0) {
                backButton.classList.add('hidden');
            } else {
                backButton.classList.remove('hidden');
            }

            if (appState.currentStep === 3) { // Last step
                nextButton.classList.add('hidden');
                submitProductButtonFinal.classList.remove('hidden');
            } else {
                nextButton.classList.remove('hidden');
                submitProductButtonFinal.classList.add('hidden');
            }

            // Re-render variant section if current step is 1
            if (appState.currentStep === 1) {
                renderProductVariantsStep();
            }
        }

        /**
         * Handles moving to the next step.
         */
        function onStepContinue() {
            let isValid = true;
            if (appState.currentStep === 0) {
                isValid = validateStep0();
            } else if (appState.currentStep === 1) {
                isValid = validateStep1();
            }
            // Step 2 has no mandatory validation to proceed to step 3.

            if (!isValid) {
                showMessage(getTranslatedString('please_fill_all_required_fields'), 'error');
                return;
            }

            const isLastStep = appState.currentStep === 3;
            if (isLastStep) {
                addProduct(); // Call addProduct on the last step
            } else {
                appState.currentStep++;
                updateStepperUI();
            }
        }

        /**
         * Handles moving to the previous step.
         */
        function onStepCancel() {
            if (appState.currentStep > 0) {
                appState.currentStep--;
                updateStepperUI();
            }
        }

        /**
         * Handles tapping on a step indicator.
         * @param {number} step The index of the tapped step.
         */
        function onStepTapped(step) {
            if (step > appState.currentStep) {
                // Validate steps being skipped over
                let isValid = true;
                for (let i = appState.currentStep; i < step; i++) {
                    if (i === 0) {
                        if (!validateStep0()) { isValid = false; break; }
                    } else if (i === 1) {
                        if (!validateStep1()) { isValid = false; break; }
                    }
                }

                if (!isValid) {
                    showMessage(getTranslatedString('please_complete_current_step'), 'error');
                    return;
                }
            }
            appState.currentStep = step;
            updateStepperUI();
        }

        // --- Dynamic Content Rendering (for Add Product page) ---

        /**
         * Renders a single product variant section.
         * @param {Object} variant The variant data object.
         * @param {number} index The index of the variant in the array.
         */
        function renderVariantSection(variant, index) {
            const variantDiv = document.createElement('div');
            variantDiv.id = `variant-${index}`;
            variantDiv.className = 'bg-white p-6 rounded-xl shadow-md border border-gray-200 space-y-4';
            variantDiv.innerHTML = `
                <div class="flex justify-between items-center">
                    <h3 class="text-lg font-semibold text-gray-900">${getTranslatedString('variant')} ${index + 1}</h3>
                    ${appState.productData.variants.length > 1 ? `
                        <button type="button" class="text-red-500 hover:text-red-700 transition duration-200" data-variant-index="${index}" data-action="delete-variant">
                            <i data-lucide="trash-2" class="w-5 h-5"></i>
                        </button>
                    ` : ''}
                </div>
                <div>
                    <label for="variant-price-${index}" class="block text-gray-700 text-sm font-bold mb-2">${getTranslatedString('price_for_variant_dzd')}</label>
                    <div class="relative">
                        <input type="number" step="0.01" id="variant-price-${index}" name="variant_price_${index}" class="w-full px-4 py-3 rounded-lg border border-gray-300 bg-gray-100 text-gray-900 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-700 focus:border-transparent transition duration-200" placeholder="${getTranslatedString('example_1450_00')}" value="${variant.price}" autocomplete="off">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <i data-lucide="dollar-sign" class="w-5 h-5 text-gray-700"></i>
                        </div>
                    </div>
                    <p id="error-variant-price-${index}" class="text-red-500 text-xs italic mt-1 hidden"></p>
                </div>
                <div>
                    <label for="variant-promo-${index}" class="block text-gray-700 text-sm font-bold mb-2">${getTranslatedString('promo_code_optional')}</label>
                    <div class="relative">
                        <input type="text" id="variant-promo-${index}" name="variant_promo_${index}" class="w-full px-4 py-3 rounded-lg border border-gray-300 bg-gray-100 text-gray-900 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-700 focus:border-transparent transition duration-200" placeholder="${getTranslatedString('example_discount10')}" value="${variant.promoCode}" autocomplete="off">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <i data-lucide="percent" class="w-5 h-5 text-gray-700"></i>
                        </div>
                    </div>
                </div>
                <div>
                    <label class="block text-gray-700 text-sm font-bold mb-2">${getTranslatedString('selected_colors')}</label>
                    <div class="flex flex-wrap gap-2 p-3 rounded-lg border border-gray-300 bg-gray-100 min-h-[40px]" id="variant-${index}-colors-display">
                        ${variant.colors.map(colorName => {
                            const bgColor = _colorNameToCss(colorName);
                            const textColorClass = getTextColorClass(bgColor);
                            return `
                                <div class="flex items-center px-3 py-1 rounded-full text-sm ${textColorClass}" style="background-color: ${bgColor};">
                                    <span>${colorName}</span>
                                    <button type="button" class="ml-2 text-current hover:opacity-75" data-color="${colorName}" data-variant-index="${index}" data-action="remove-color">
                                        <i data-lucide="x" class="w-4 h-4"></i>
                                    </button>
                                </div>
                            `;
                        }).join('')}
                    </div>
                    <div class="flex justify-end mt-3">
                        <button type="button" class="flex items-center px-4 py-2 bg-blue-700 text-white rounded-lg shadow-md hover:bg-blue-800 focus:outline-none focus:ring-2 focus:ring-blue-600 transition duration-200" data-variant-index="${index}" data-action="select-colors">
                            <i data-lucide="palette" class="w-5 h-5 mr-2"></i>
                            <span>${getTranslatedString('choose_colors')}</span>
                        </button>
                    </div>
                </div>
                <div>
                    <label class="block text-gray-700 text-sm font-bold mb-2">${getTranslatedString('sizes')}</label>
                    <div class="flex flex-wrap gap-2 p-3 rounded-lg border border-gray-300 bg-gray-100">
                        ${getAvailableSizes().map(size => `
                            <button type="button" class="px-4 py-2 rounded-lg text-sm font-medium transition duration-200
                                ${variant.sizes.includes(size) ? 'bg-blue-700 text-white shadow-sm' : 'bg-gray-300 text-gray-900 hover:bg-gray-400'}
                            " data-size="${size}" data-variant-index="${index}" data-action="toggle-size">
                                ${size}
                            </button>
                        `).join('')}
                    </div>
                </div>
            `;
            // Re-create Lucide icons for newly added elements
            setTimeout(() => lucide.createIcons(), 0);
            return variantDiv;
        }

        /**
         * Renders the product variants section (Step 1).
         */
        function renderProductVariantsStep() {
            const variantsContainer = document.getElementById('variants-container');
            const addVariantButton = document.getElementById('add-variant-button');
            const variantsInfo = document.getElementById('variants-info');

            if (!variantsContainer || !addVariantButton || !variantsInfo) return; // Exit if elements not yet rendered

            variantsContainer.innerHTML = ''; // Clear existing variants

            if (appState.productData.productType === null || (appState.productData.productType !== 'Clothes' && appState.productData.productType !== 'Shoes')) {
                variantsInfo.textContent = appState.productData.productType === null
                    ? getTranslatedString('please_select_product_type_first')
                    : getTranslatedString('this_product_type_no_variants');
                variantsInfo.classList.remove('hidden');
                addVariantButton.classList.add('hidden');
            } else {
                variantsInfo.classList.add('hidden');
                addVariantButton.classList.remove('hidden');

                appState.productData.variants.forEach((variant, index) => {
                    const variantSection = renderVariantSection(variant, index);
                    variantsContainer.appendChild(variantSection);
                });
            }

            // Attach event listeners for dynamically created elements
            attachVariantEventListeners();
        }

        /**
         * Attaches event listeners to dynamically created variant elements.
         */
        function attachVariantEventListeners() {
            const variantsContainer = document.getElementById('variants-container');
            if (!variantsContainer) return; // Exit if not on the variants step

            // Price and Promo Code inputs
            variantsContainer.querySelectorAll('input[id^="variant-price-"]').forEach(input => {
                input.oninput = (e) => {
                    const index = parseInt(e.target.id.split('-')[2]);
                    appState.productData.variants[index].price = e.target.value;
                    hideError(`variant-price-${index}`); // Hide error on input
                };
            });
            variantsContainer.querySelectorAll('input[id^="variant-promo-"]').forEach(input => {
                input.oninput = (e) => {
                    const index = parseInt(e.target.id.split('-')[2]);
                    appState.productData.variants[index].promoCode = e.target.value;
                };
            });

            // Delete variant buttons
            variantsContainer.querySelectorAll('button[data-action="delete-variant"]').forEach(button => {
                button.onclick = (e) => {
                    const index = parseInt(e.currentTarget.dataset.variantIndex);
                    appState.productData.variants.splice(index, 1);
                    if (appState.productData.variants.length === 0) {
                        appState.productData.variants.push({ colors: [], sizes: [], price: '', promoCode: '' }); // Ensure at least one
                    }
                    renderProductVariantsStep(); // Re-render all variants
                };
            });

            // Color selection buttons
            variantsContainer.querySelectorAll('button[data-action="select-colors"]').forEach(button => {
                button.onclick = (e) => {
                    const index = parseInt(e.currentTarget.dataset.variantIndex);
                    appState.currentVariantForColorSelection = appState.productData.variants[index];
                    showColorSelectionModal(appState.currentVariantForColorSelection.colors);
                };
            });

            // Remove color chips
            variantsContainer.querySelectorAll('[id^="variant-"][id$="-colors-display"] button[data-action="remove-color"]').forEach(button => {
                button.onclick = (e) => {
                    const colorToRemove = e.currentTarget.dataset.color;
                    const index = parseInt(e.currentTarget.dataset.variantIndex);
                    appState.productData.variants[index].colors = appState.productData.variants[index].colors.filter(c => c !== colorToRemove);
                    renderProductVariantsStep(); // Re-render to update chips
                };
            });

            // Size selection buttons
            variantsContainer.querySelectorAll('button[data-action="toggle-size"]').forEach(button => {
                button.onclick = (e) => {
                    const size = e.currentTarget.dataset.size;
                    const index = parseInt(e.currentTarget.dataset.variantIndex);
                    const variant = appState.productData.variants[index];
                    const isSelected = variant.sizes.includes(size);

                    if (!isSelected) { // If not selected, add it
                        variant.sizes.push(size);
                    } else { // If selected, remove it
                        variant.sizes = variant.sizes.filter(s => s !== size);
                    }
                    renderProductVariantsStep(); // Re-render to update chip styles
                };
            });
        }

        /**
         * Renders image previews.
         */
        function renderImagePreviews() {
            const imagePreviewContainer = document.getElementById('image-preview-container');
            if (!imagePreviewContainer) return; // Exit if element not yet rendered

            imagePreviewContainer.innerHTML = '';
            appState.productData.images.forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const imgDiv = document.createElement('div');
                    imgDiv.className = 'relative w-28 h-28 rounded-lg overflow-hidden shadow-md';
                    imgDiv.innerHTML = `
                        <img src="${e.target.result}" alt="Product Image" class="w-full h-full object-cover">
                        <button type="button" class="absolute top-1 right-1 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs hover:bg-red-600 transition duration-200" data-index="${index}">
                            <i data-lucide="x" class="w-4 h-4"></i>
                        </button>
                    `;
                    imagePreviewContainer.appendChild(imgDiv);

                    // Attach delete listener
                    imgDiv.querySelector('button').onclick = (deleteEvent) => {
                        const imgIndex = parseInt(deleteEvent.currentTarget.dataset.index);
                        appState.productData.images.splice(imgIndex, 1);
                        renderImagePreviews(); // Re-render to update indices
                    };
                    lucide.createIcons(); // Re-create icons for new elements
                };
                reader.readAsDataURL(file);
            });
        }

        /**
         * Shows the color selection modal.
         * @param {string[]} currentSelectedColors Colors currently selected for the variant.
         */
        function showColorSelectionModal(currentSelectedColors) {
            const colorModal = document.getElementById('color-modal');
            const colorChipsContainer = document.getElementById('color-chips-container');
            const newColorInput = document.getElementById('new-color-input');
            const addCustomColorButton = document.getElementById('add-custom-color-button');
            const cancelColorModalButton = document.getElementById('cancel-color-modal');
            const confirmColorModalButton = document.getElementById('confirm-color-modal');
            const errorNewColor = document.getElementById('error-new-color');

            if (!colorModal || !colorChipsContainer || !newColorInput || !addCustomColorButton || !cancelColorModalButton || !confirmColorModalButton || !errorNewColor) return; // Exit if elements not yet rendered

            let tempSelectedColors = [...currentSelectedColors]; // Working copy for the modal

            function renderColorChipsInModal() {
                colorChipsContainer.innerHTML = '';
                appState.availableColors.forEach(colorName => {
                    const isSelected = tempSelectedColors.includes(colorName);
                    const bgColor = _colorNameToCss(colorName);
                    const textColorClass = getTextColorClass(bgColor);
                    const chipDiv = document.createElement('button');
                    chipDiv.type = 'button';
                    chipDiv.className = `w-12 h-12 rounded-lg flex items-center justify-center border-2 transition duration-200 ${textColorClass} ${isSelected ? 'border-blue-700' : 'border-gray-400'}`;
                    chipDiv.style.backgroundColor = bgColor;
                    chipDiv.dataset.color = colorName;
                    chipDiv.innerHTML = isSelected ? `<i data-lucide="check" class="w-8 h-8"></i>` : '';

                    if (colorName.toLowerCase() === 'white') {
                        chipDiv.classList.remove('text-white');
                        chipDiv.classList.add('text-black');
                    }

                    chipDiv.onclick = () => {
                        if (tempSelectedColors.includes(colorName)) {
                            tempSelectedColors = tempSelectedColors.filter(c => c !== colorName);
                        } else {
                            tempSelectedColors.push(colorName);
                        }
                        renderColorChipsInModal(); // Re-render to update selection
                    };
                    colorChipsContainer.appendChild(chipDiv);
                });
                lucide.createIcons(); // Re-create icons for new elements
            }

            renderColorChipsInModal();
            colorModal.classList.remove('hidden');
            newColorInput.value = ''; // Clear input
            errorNewColor.classList.add('hidden'); // Hide error

            // Event listeners for modal buttons
            addCustomColorButton.onclick = () => {
                const newColor = newColorInput.value.trim();
                if (newColor && !appState.availableColors.includes(newColor)) {
                    appState.availableColors.push(newColor);
                    newColorInput.value = '';
                    errorNewColor.classList.add('hidden');
                    renderColorChipsInModal(); // Re-render chips to include new color
                } else if (newColor) {
                    errorNewColor.textContent = getTranslatedString('color_already_exists');
                    errorNewColor.classList.remove('hidden');
                }
            };

            cancelColorModalButton.onclick = () => {
                colorModal.classList.add('hidden');
            };

            confirmColorModalButton.onclick = () => {
                if (appState.currentVariantForColorSelection) {
                    appState.currentVariantForColorSelection.colors = tempSelectedColors;
                    renderProductVariantsStep(); // Re-render main form to show updated colors
                }
                colorModal.classList.add('hidden');
            };
        }


        // --- Event Listeners ---

        document.addEventListener('DOMContentLoaded', () => {
            _loadUserRole(); // Load user role first
            _simulateNewOrders(); // Start simulating new orders

            // Initialize availableColors with predefined colors
            appState.availableColors = [...appState.predefinedColors];

            // Initial render
            renderApp();
            fetchAdmins();
            fetchOrders();

            // Language Toggle (for mobile app bar)
            document.getElementById('language-toggle-mobile').addEventListener('click', toggleLanguage);

            // Menu Toggle for mobile sidebar
            document.getElementById('menu-toggle').addEventListener('click', () => {
                const sidebar = document.getElementById('sidebar');
                sidebar.classList.toggle('hidden');
                sidebar.classList.toggle('flex');
            });

            // Notification Button for mobile app bar
            document.getElementById('notification-button-mobile').addEventListener('click', _showNewOrdersDialog);

            // Filter Buttons (only relevant for Dashboard, so attach after rendering Dashboard)
            document.body.addEventListener('click', (e) => {
                if (e.target.closest('.filter-button')) {
                    const button = e.target.closest('.filter-button');
                    const filterId = button.id.replace('filter-', '');
                    appState.selectedFilter = filterId;
                    appState.customStartDate = null;
                    appState.customEndDate = null;
                    updateFilterButtons();
                    fetchOrders();
                }
            });

            // Custom Date Range Inputs (only relevant for Dashboard)
            document.body.addEventListener('change', (e) => {
                if (e.target.id === 'start-date') {
                    appState.customStartDate = new Date(e.target.value + 'T00:00:00Z'); // Ensure UTC start of day
                    if (appState.customEndDate && appState.customStartDate.getTime() > appState.customEndDate.getTime()) {
                        appState.customEndDate = appState.customStartDate; // Adjust end date if it's before start date
                        document.getElementById('end-date').value = e.target.value;
                    }
                    updateCustomDateRangeDisplay();
                    if (appState.customStartDate && appState.customEndDate) {
                        fetchOrders();
                    }
                } else if (e.target.id === 'end-date') {
                    appState.customEndDate = new Date(e.target.value + 'T23:59:59.999Z'); // Ensure UTC end of day
                    if (appState.customStartDate && appState.customEndDate.getTime() < appState.customStartDate.getTime()) {
                        appState.customStartDate = appState.customEndDate; // Adjust start date if it's after end date
                        document.getElementById('start-date').value = e.target.value;
                    }
                    updateCustomDateRangeDisplay();
                    if (appState.customStartDate && appState.customEndDate) {
                        fetchOrders();
                    }
                }
            });
        });

        // Function to attach event listeners specific to the Add Product form
        function attachAddProductEventListeners() {
            // Stepper navigation buttons
            const nextButton = document.getElementById('next-button');
            const backButton = document.getElementById('back-button');
            const submitProductButtonFinal = document.getElementById('submit-product-button-final');

            if (nextButton) nextButton.addEventListener('click', onStepContinue);
            if (backButton) backButton.addEventListener('click', onStepCancel);

            // Stepper indicator clicks
            const stepIndicators = [0, 1, 2, 3].map(i => document.getElementById(`step-${i}-indicator`));
            stepIndicators.forEach((indicator, index) => {
                if (indicator) indicator.addEventListener('click', () => onStepTapped(index));
            });

            // Step 0 Inputs
            const productTypeSelect = document.getElementById('product-type');
            const productNameInput = document.getElementById('product-name');
            const quantityInput = document.getElementById('quantity');
            const basePriceInput = document.getElementById('base-price');

            if (productTypeSelect) productTypeSelect.addEventListener('change', (e) => {
                appState.productData.productType = e.target.value;
                hideError('product-type');
                // Reset variants when product type changes
                appState.productData.variants = [{ colors: [], sizes: [], price: '', promoCode: '' }];
                renderProductVariantsStep(); // Re-render to reflect changes in variant section
            });
            if (productNameInput) productNameInput.addEventListener('input', (e) => { appState.productData.name = e.target.value; hideError('product-name'); });

            // Description content is now handled by Quill.js, listen for changes
            if (appState.quill) {
                appState.quill.on('text-change', () => {
                    appState.productData.description = appState.quill.root.innerHTML;
                    hideError('description'); // Hide error when user starts typing
                });
            }

            if (quantityInput) quantityInput.addEventListener('input', (e) => { appState.productData.quantity = e.target.value; hideError('quantity'); });
            if (basePriceInput) basePriceInput.addEventListener('input', (e) => { appState.productData.price = e.target.value; hideError('base-price'); });

            // Step 1 - Add Variant Button
            const addVariantButton = document.getElementById('add-variant-button');
            if (addVariantButton) addVariantButton.addEventListener('click', () => {
                appState.productData.variants.push({ colors: [], sizes: [], price: '', promoCode: '' });
                renderProductVariantsStep();
            });

            // Step 2 Inputs and Image Upload
            const customOptionInput = document.getElementById('custom-option');
            const selectImagesButton = document.getElementById('select-images-button');
            const imageUploadInput = document.getElementById('image-upload');

            if (customOptionInput) customOptionInput.addEventListener('input', (e) => { appState.productData.customOption = e.target.value; });

            if (selectImagesButton) selectImagesButton.addEventListener('click', () => {
                if (imageUploadInput) imageUploadInput.click(); // Trigger file input click
            });

            if (imageUploadInput) imageUploadInput.addEventListener('change', (e) => {
                const files = Array.from(e.target.files);
                files.forEach(file => {
                    if (file.type.startsWith('image/')) {
                        appState.productData.images.push(file);
                    }
                });
                renderImagePreviews();
                e.target.value = ''; // Clear the input so same file can be selected again
            });

            // Final Submit Button (on Step 3)
            if (submitProductButtonFinal) submitProductButtonFinal.addEventListener('click', addProduct);

            // Language Toggle for the add product header (if it exists, though it's hidden now)
            const languageToggle = document.getElementById('language-toggle');
            const languageDropdown = document.getElementById('language-dropdown');
            if (languageToggle) {
                languageToggle.addEventListener('click', () => {
                    if (languageDropdown) languageDropdown.classList.toggle('hidden');
                });
            }
            if (languageDropdown) {
                languageDropdown.querySelectorAll('button').forEach(button => {
                    button.addEventListener('click', (e) => {
                        // This logic is already handled by the main toggleLanguage function
                        // but ensure dropdown closes
                        if (languageDropdown) languageDropdown.classList.add('hidden');
                    });
                });
            }
        }

        // --- API Call (for Add Product page) ---

        /**
         * Handles the product submission to the backend.
         */
        async function addProduct() {
            // Update productData.description from Quill editor before validation/submission
            if (appState.quill) {
                appState.productData.description = appState.quill.root.innerHTML;
            }

            if (!validateAllSteps()) {
                return; // Stop if validation fails
            }

            appState.addProductIsLoading = true;
            const loadingSpinner = document.getElementById('loading-spinner');
            const submitProductButtonFinal = document.getElementById('submit-product-button-final');

            if (loadingSpinner) loadingSpinner.classList.remove('hidden');
            if (submitProductButtonFinal) submitProductButtonFinal.disabled = true; // Disable button during submission

            const formData = new FormData();
            formData.append('name', appState.productData.name);
            formData.append('description', appState.productData.description); // Send HTML content
            formData.append('quantity', appState.productData.quantity);
            formData.append('price', appState.productData.price);
            formData.append('custom_option', appState.productData.customOption);
            formData.append('product_type', appState.productData.productType || '');

            // Only add variants if product type is 'Clothes' or 'Shoes'
            if (appState.productData.productType === 'Clothes' || appState.productData.productType === 'Shoes') {
                formData.append('variants', JSON.stringify(appState.productData.variants.map(v => ({
                    colors: v.colors,
                    sizes: v.sizes,
                    price: parseFloat(v.price), // Ensure price is number
                    promo_code: v.promoCode || null // Handle empty promo code
                }))));
            } else {
                formData.append('variants', JSON.stringify([]));
            }

            appState.productData.images.forEach((imageFile) => {
                formData.append('images', imageFile);
            });

            try {
                const response = await fetch('https://sheeka.onrender.com/products', {
                    method: 'POST',
                    body: formData,
                });

                if (response.ok) {
                    showMessage(getTranslatedString('product_added_successfully'), 'success');
                    clearAddProductForm(); // Clear form after successful submission
                } else {
                    const errorBody = await response.text();
                    showMessage(`${getTranslatedString('failed_to_add_product')}${response.status}, ${getTranslatedString('response')}: ${errorBody}`, 'error');
                }
            } catch (e) {
                showMessage(`${getTranslatedString('an_error_occurred')}${e.message}`, 'error');
            } finally {
                appState.addProductIsLoading = false;
                if (loadingSpinner) loadingSpinner.classList.add('hidden');
                if (submitProductButtonFinal) submitProductButtonFinal.disabled = false; // Re-enable button
            }
        }

        // Handle window resize for responsive layout (sidebar/appbar visibility)
        window.addEventListener('resize', () => {
            renderSidebar();
            renderSelectedSection(); // Re-render content to adjust grid layout if needed
        });
    </script>
</body>
</html>
