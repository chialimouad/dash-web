<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add New Product Dashboard</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons CDN -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Google Fonts - Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Quill.js CSS -->
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* Light gray background */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 2rem;
        }
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #e0e0e0;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
            border-radius: 10px;
        }
        /* Hide default number input arrows */
        input[type="number"]::-webkit-outer-spin-button,
        input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type="number"] {
            -moz-appearance: textfield;
        }
        /* Quill editor styling adjustments */
        .ql-toolbar {
            border-top-left-radius: 0.5rem; /* rounded-lg */
            border-top-right-radius: 0.5rem; /* rounded-lg */
            border: 1px solid #d1d5db; /* border-gray-300 */
            background-color: #f9fafb; /* bg-gray-50 */
        }
        .ql-container {
            border-bottom-left-radius: 0.5rem; /* rounded-lg */
            border-bottom-right-radius: 0.5rem; /* rounded-lg */
            border: 1px solid #d1d5db; /* border-gray-300 */
            border-top: none; /* remove top border as toolbar has it */
            min-height: 12rem; /* h-48 */
            background-color: #f3f4f6; /* bg-gray-100 */
            color: #1f2937; /* text-gray-900 */
        }
        .ql-editor {
            min-height: 10rem; /* Adjust as needed */
            padding: 1rem; /* px-4 py-3 */
        }
        .ql-editor.ql-blank::before {
            color: #9ca3af; /* placeholder-gray-500 */
            font-style: normal; /* Override default italic for placeholder */
        }
        /* Custom style for the color input */
        #new-color-picker {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            width: 48px; /* w-12 */
            height: 48px; /* h-12 */
            background-color: transparent;
            border: none;
            cursor: pointer;
            padding: 0;
            border-radius: 0.5rem; /* rounded-lg */
            border: 2px solid #d1d5db; /* border-gray-300 */
        }
        #new-color-picker::-webkit-color-swatch-wrapper {
            padding: 0;
        }
        #new-color-picker::-webkit-color-swatch {
            border: none;
            border-radius: 0.375rem; /* rounded-md */
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center py-8 px-4">
    <div id="main-container" class="max-w-4xl w-full bg-white shadow-lg rounded-xl overflow-hidden">
        <!-- App Bar / Header -->
        <header class="bg-black text-white p-4 flex justify-between items-center rounded-t-xl">
            <h1 id="app-title" class="text-2xl font-bold"></h1>
            <div class="relative">
                <button id="language-toggle" class="p-2 rounded-full hover:bg-gray-800 focus:outline-none focus:ring-2 focus:ring-gray-600">
                    <i data-lucide="globe" class="w-6 h-6"></i>
                </button>
                <div id="language-dropdown" class="absolute right-0 mt-2 w-32 bg-white rounded-md shadow-lg py-1 z-10 hidden">
                    <button class="block w-full text-left px-4 py-2 text-gray-800 hover:bg-gray-100 rounded-md" data-locale="en">
                        <span id="lang-en-text"></span>
                    </button>
                    <button class="block w-full text-left px-4 py-2 text-gray-800 hover:bg-gray-100 rounded-md" data-locale="ar">
                        <span id="lang-ar-text"></span>
                    </button>
                </div>
            </div>
        </header>

        <!-- Main Content Area -->
        <main class="p-6">
            <form id="product-form" class="space-y-6">
                <!-- Stepper Navigation -->
                <div class="flex justify-between items-center mb-6">
                    <div class="flex-1 text-center">
                        <div id="step-0-indicator" class="flex flex-col items-center">
                            <div class="w-10 h-10 rounded-full flex items-center justify-center border-2 border-blue-700 text-blue-700 font-bold text-lg transition-all duration-300">1</div>
                            <span id="step-0-title" class="text-sm mt-1 text-gray-700 font-medium"></span>
                        </div>
                    </div>
                    <div class="flex-1 text-center">
                        <div id="step-1-indicator" class="flex flex-col items-center">
                            <div class="w-10 h-10 rounded-full flex items-center justify-center border-2 border-gray-400 text-gray-400 font-bold text-lg transition-all duration-300">2</div>
                            <span id="step-1-title" class="text-sm mt-1 text-gray-500"></span>
                        </div>
                    </div>
                    <div class="flex-1 text-center">
                        <div id="step-2-indicator" class="flex flex-col items-center">
                            <div class="w-10 h-10 rounded-full flex items-center justify-center border-2 border-gray-400 text-gray-400 font-bold text-lg transition-all duration-300">3</div>
                            <span id="step-2-title" class="text-sm mt-1 text-gray-500"></span>
                        </div>
                    </div>
                    <div class="flex-1 text-center">
                        <div id="step-3-indicator" class="flex flex-col items-center">
                            <div class="w-10 h-10 rounded-full flex items-center justify-center border-2 border-gray-400 text-gray-400 font-bold text-lg transition-all duration-300">4</div>
                            <span id="step-3-title" class="text-sm mt-1 text-gray-500"></span>
                        </div>
                    </div>
                </div>


                <!-- Step Content Container -->
                <div id="step-content-container">
                    <!-- Step 0: Product Details -->
                    <div id="step-0-content" class="space-y-6">
                        <div class="mb-4">
                            <label for="product-type" class="block text-gray-700 text-sm font-bold mb-2" id="label-product-type"></label>
                            <div class="relative">
                                <select id="product-type" name="product_type" class="block w-full px-4 py-3 rounded-lg border border-gray-300 bg-gray-100 text-gray-900 focus:outline-none focus:ring-2 focus:ring-blue-700 focus:border-transparent transition duration-200">
                                    <option value="" disabled selected id="select-product-type-placeholder"></option>
                                    <option value="Clothes" id="option-clothes"></option>
                                    <option value="Shoes" id="option-shoes"></option>
                                    <option value="Gadget" id="option-gadget"></option>
                                    <option value="Cosmetics" id="option-cosmetics"></option>
                                </select>
                                <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700">
                                    <i data-lucide="chevron-down" class="w-5 h-5"></i>
                                </div>
                            </div>
                            <p id="error-product-type" class="text-red-500 text-xs italic mt-1 hidden"></p>
                        </div>

                        <div>
                            <label for="product-name" class="block text-gray-700 text-sm font-bold mb-2" id="label-product-name"></label>
                            <div class="relative">
                                <input type="text" id="product-name" name="name" class="w-full px-4 py-3 rounded-lg border border-gray-300 bg-gray-100 text-gray-900 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-700 focus:border-transparent transition duration-200" placeholder="" autocomplete="off">
                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                    <i data-lucide="shopping-bag" class="w-5 h-5 text-gray-700"></i>
                                </div>
                            </div>
                            <p id="error-product-name" class="text-red-500 text-xs italic mt-1 hidden"></p>
                        </div>

                        <div>
                            <label for="description-editor" class="block text-gray-700 text-sm font-bold mb-2" id="label-description"></label>
                            <!-- Quill editor will be initialized here -->
                            <div id="description-editor" class="h-48"></div>
                            <p id="error-description" class="text-red-500 text-xs italic mt-1 hidden"></p>
                        </div>

                        <div>
                            <label for="quantity" class="block text-gray-700 text-sm font-bold mb-2" id="label-quantity"></label>
                            <div class="relative">
                                <input type="number" id="quantity" name="quantity" class="w-full px-4 py-3 rounded-lg border border-gray-300 bg-gray-100 text-gray-900 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-700 focus:border-transparent transition duration-200" placeholder="" autocomplete="off">
                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                    <i data-lucide="hash" class="w-5 h-5 text-gray-700"></i>
                                </div>
                            </div>
                            <p id="error-quantity" class="text-red-500 text-xs italic mt-1 hidden"></p>
                        </div>

                        <div>
                            <label for="base-price" class="block text-gray-700 text-sm font-bold mb-2" id="label-base-price"></label>
                            <div class="relative">
                                <input type="number" step="0.01" id="base-price" name="price" class="w-full px-4 py-3 rounded-lg border border-gray-300 bg-gray-100 text-gray-900 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-700 focus:border-transparent transition duration-200" placeholder="" autocomplete="off">
                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                    <i data-lucide="dollar-sign" class="w-5 h-5 text-gray-700"></i>
                                </div>
                            </div>
                            <p id="error-base-price" class="text-red-500 text-xs italic mt-1 hidden"></p>
                        </div>
                    </div>

                    <!-- Step 1: Product Variants -->
                    <div id="step-1-content" class="space-y-6 hidden">
                        <h2 id="variants-title" class="text-xl font-bold text-gray-900"></h2>
                        <p id="variants-info" class="text-red-500 text-base text-center py-5 hidden"></p>
                        <div id="variants-container" class="space-y-4">
                            <!-- Variant sections will be dynamically added here -->
                        </div>
                        <div class="flex justify-end">
                            <button type="button" id="add-variant-button" class="flex items-center px-4 py-2 text-black font-bold rounded-full border border-gray-300 hover:bg-gray-100 transition duration-200">
                                <i data-lucide="plus-circle" class="w-5 h-5 mr-2"></i>
                                <span id="add-another-variant-text"></span>
                            </button>
                        </div>
                    </div>

                    <!-- Step 2: Images and Custom Options -->
                    <div id="step-2-content" class="space-y-6 hidden">
                        <div>
                            <label for="custom-option" class="block text-gray-700 text-sm font-bold mb-2" id="label-custom-option"></label>
                            <div class="relative">
                                <input type="text" id="custom-option" name="custom_option" class="w-full px-4 py-3 rounded-lg border border-gray-300 bg-gray-100 text-gray-900 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-700 focus:border-transparent transition duration-200" placeholder="" autocomplete="off">
                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                    <i data-lucide="list-checks" class="w-5 h-5 text-gray-700"></i>
                                </div>
                            </div>
                        </div>

                        <button type="button" id="select-images-button" class="w-full flex items-center justify-center px-4 py-3 bg-black text-white rounded-xl shadow-md hover:bg-gray-800 focus:outline-none focus:ring-2 focus:ring-gray-600 transition duration-200">
                            <i data-lucide="image" class="w-6 h-6 mr-3"></i>
                            <span id="select-product-images-text" class="text-lg font-semibold"></span>
                        </button>
                        <input type="file" id="image-upload" multiple accept="image/*" class="hidden">

                        <div id="image-preview-container" class="flex flex-wrap gap-4 mt-4">
                            <!-- Image previews will be added here -->
                        </div>
                    </div>

                    <!-- Step 3: Review and Submit -->
                    <div id="step-3-content" class="space-y-6 hidden">
                        <p id="review-details-text" class="text-base italic text-gray-700"></p>
                        <button type="button" id="submit-product-button-final" class="w-full flex items-center justify-center px-4 py-4 bg-black text-white rounded-xl shadow-md hover:bg-gray-800 focus:outline-none focus:ring-2 focus:ring-gray-600 transition duration-200">
                            <span id="submit-product-text-final" class="text-lg font-bold"></span>
                            <div id="loading-spinner" class="hidden ml-2 w-6 h-6 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
                        </button>
                    </div>
                </div>

                <!-- Stepper Controls -->
                <div class="flex justify-between mt-8 space-x-4">
                    <button type="button" id="back-button" class="flex-1 px-6 py-3 rounded-xl border border-black text-black font-semibold hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-gray-400 transition duration-200 hidden">
                        <span id="back-text"></span>
                    </button>
                    <button type="button" id="next-button" class="flex-1 px-6 py-3 rounded-xl bg-black text-white font-semibold hover:bg-gray-800 focus:outline-none focus:ring-2 focus:ring-gray-600 transition duration-200">
                        <span id="next-text"></span>
                    </button>
                </div>
            </form>
        </main>
    </div>

    <!-- Access Denied Message -->
    <div id="access-denied" class="hidden text-center p-8">
        <i class="fas fa-exclamation-triangle text-5xl text-red-500 mb-4"></i>
        <h2 class="text-2xl font-bold text-gray-800">Access Denied</h2>
        <p class="text-gray-600 mt-2">You do not have permission to view this page. Please contact an administrator.</p>
    </div>

    <!-- Color Selection Modal -->
    <div id="color-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-6 rounded-xl shadow-lg w-full max-w-md mx-4 space-y-6">
            <h3 id="choose-colors-title" class="text-xl font-bold text-gray-900"></h3>
            <div id="color-chips-container" class="flex flex-wrap gap-3">
                <!-- Color chips will be dynamically added here -->
            </div>
            <div>
                <label for="new-color-input" class="block text-gray-700 text-sm font-bold mb-2" id="label-add-new-color"></label>
                <div class="flex items-center gap-3">
                    <input type="text" id="new-color-input" class="flex-grow px-4 py-3 rounded-lg border border-gray-300 bg-gray-100 text-gray-900 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-700 focus:border-transparent transition duration-200" placeholder="">
                    <input type="color" id="new-color-picker" value="#ffffff">
                </div>
                <p id="error-new-color" class="text-red-500 text-xs italic mt-1 hidden"></p>
            </div>
            <div class="flex justify-end space-x-3">
                <button type="button" id="add-custom-color-button" class="flex items-center px-4 py-2 bg-blue-700 text-white rounded-lg shadow-md hover:bg-blue-800 focus:outline-none focus:ring-2 focus:ring-blue-600 transition duration-200">
                    <i data-lucide="plus-circle" class="w-5 h-5 mr-2"></i>
                    <span id="add-text"></span>
                </button>
                <button type="button" id="cancel-color-modal" class="px-4 py-2 text-gray-600 font-semibold rounded-lg hover:bg-gray-100 transition duration-200">
                    <span id="cancel-text"></span>
                </button>
                <button type="button" id="confirm-color-modal" class="px-4 py-2 bg-green-700 text-white rounded-lg shadow-md hover:bg-green-800 focus:outline-none focus:ring-2 focus:ring-green-600 transition duration-200">
                    <span id="confirm-text"></span>
                </button>
            </div>
        </div>
    </div>


    <!-- Message Box / Snackbar -->
    <div id="message-box" class="fixed bottom-4 right-4 bg-gray-800 text-white px-6 py-3 rounded-lg shadow-xl hidden transition-opacity duration-300 opacity-0 z-50">
        <span id="message-text"></span>
    </div>

    <!-- Quill.js JavaScript -->
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    <script>
        // --- Localization ---
        const AppStrings = {
            _en: {
                'add_new_product': 'Add New Product',
                'product_details': 'Product Details',
                'product_type': 'Product Type',
                'select_product_type': 'Select product type',
                'product_name': 'Product Name',
                'example_tshirt': 'Example: Casual T-Shirt',
                'detailed_description': 'Detailed Description',
                'provide_detailed_description': 'Provide a detailed description of the product here...',
                'total_quantity': 'Total Quantity',
                'example_100': 'Example: 100',
                'base_price': 'Base Price (DZD)',
                'example_1500_00': 'Example: 1500.00',
                'product_variants': 'Product Variants',
                'product_variants_colors_sizes_prices': 'Product Variants (Colors, Sizes, and Prices)',
                'please_select_product_type_first': 'Please select product type in the first step first.',
                'this_product_type_no_variants': 'This product type does not require variants.',
                'add_another_variant': 'Add another variant',
                'images_custom_options': 'Images and Custom Options',
                'custom_option_optional': 'Custom Option (Optional)',
                'example_gift_wrap': 'Example: Gift wrapping, engraving',
                'select_product_images': 'Select Product Images',
                'review_submit': 'Review and Submit',
                'review_details_before_submitting': 'Please review product details before submitting.',
                'submit_product': 'Submit Product',
                'variant': 'Variant',
                'price_for_variant_dzd': 'Price for Variant (DZD)',
                'example_1450_00': 'Example: 1450.00',
                'promo_code_optional': 'Promo Code (Optional)',
                'example_discount10': 'Example: DISCOUNT10',
                'selected_colors': 'Selected Colors',
                'choose_colors': 'Choose Colors',
                'sizes': 'Sizes',
                'add_new_color': 'Add New Color (Name or Hex)',
                'example_sky_blue': 'Example: Sky Blue or #87CEEB',
                'add': 'Add',
                'cancel': 'Cancel',
                'confirm': 'Confirm',
                'color_already_exists': 'This color already exists.',
                'product_added_successfully': '✅ Product added successfully!',
                'failed_to_add_product': '❌ Failed to add product. Status: ',
                'an_error_occurred': '❌ An error occurred: ',
                'name_cannot_be_empty': 'Product name cannot be empty',
                'description_cannot_be_empty': 'Description cannot be empty',
                'quantity_cannot_be_empty': 'Please enter the quantity',
                'enter_valid_integer': 'Please enter a valid integer',
                'quantity_cannot_be_negative': 'Quantity cannot be negative',
                'price_cannot_be_empty': 'Price cannot be empty',
                'enter_valid_price': 'Enter a valid price',
                'price_must_be_greater_than_0': 'Price must be greater than 0',
                'variant_price_cannot_be_empty': 'Variant price cannot be empty',
                'enter_valid_variant_price': 'Enter a valid variant price',
                'variant_price_must_be_greater_than_0': 'Price must be greater than 0',
                'please_select_product_type': 'Please select product type',
                'please_correct_form_errors': '❌ Please fix the errors in the form.',
                'please_fill_all_required_fields': '❌ Please fill all required fields correctly.',
                'please_complete_current_step': '❌ Please complete the current step before proceeding.',
                'next': 'Next',
                'back': 'Back',
                'clothes': 'Clothes',
                'shoes': 'Shoes',
                'gadget': 'Gadget',
                'cosmetics': 'Cosmetics',
                'english': 'English',
                'arabic': 'Arabic',
                'response': 'Response',
                'go_back_to_admin_panel': 'Go Back to Admin Panel',
            },
            _ar: {
                'add_new_product': 'إضافة منتج جديد',
                'product_details': 'تفاصيل المنتج',
                'product_type': 'نوع المنتج',
                'select_product_type': 'اختر نوع المنتج',
                'product_name': 'اسم المنتج',
                'example_tshirt': 'مثال: تي شيرت كاجوال',
                'detailed_description': 'الوصف التفصيلي',
                'provide_detailed_description': 'قدم وصفاً تفصيلياً للمنتج هنا...',
                'total_quantity': 'الكمية الإجمالية',
                'example_100': 'مثال: 100',
                'base_price': 'السعر الأساسي (د.ج)',
                'example_1500_00': 'مثال: 1500.00',
                'product_variants': 'متغيرات المنتج',
                'product_variants_colors_sizes_prices': 'متغيرات المنتج (الألوان والأحجام والأسعار)',
                'please_select_product_type_first': 'الرجاء اختيار نوع المنتج في الخطوة الأولى أولاً.',
                'this_product_type_no_variants': 'هذا النوع من المنتجات لا يتطلب متغيرات.',
                'add_another_variant': 'إضافة متغير آخر',
                'images_custom_options': 'الصور والخيارات المخصصة',
                'custom_option_optional': 'خيار مخصص (اختياري)',
                'example_gift_wrap': 'مثال: تغليف الهدايا، نقش',
                'select_product_images': 'اختيار صور المنتج',
                'review_submit': 'مراجعة وإرسال',
                'review_details_before_submitting': 'يرجى مراجعة تفاصيل المنتج قبل الإرسال.',
                'submit_product': 'إرسال المنتج',
                'variant': 'المتغير',
                'price_for_variant_dzd': 'السعر للمتغير (د.ج)',
                'example_1450_00': 'مثال: 1450.00',
                'promo_code_optional': 'رمز العرض الترويجي (اختياري)',
                'example_discount10': 'مثال: خصم10',
                'selected_colors': 'الألوان المختارة',
                'choose_colors': 'اختر الألوان',
                'sizes': 'الأحجام',
                'add_new_color': 'إضافة لون جديد (اسم أو رمز سداسي)',
                'example_sky_blue': 'مثال: أزرق سماوي أو #87CEEB',
                'add': 'أضف',
                'cancel': 'إلغاء',
                'confirm': 'تأكيد',
                'color_already_exists': 'هذا اللون موجود بالفعل.',
                'product_added_successfully': '✅ تم إضافة المنتج بنجاح!',
                'failed_to_add_product': '❌ فشل إضافة المنتج. الحالة: ',
                'an_error_occurred': '❌ حدث خطأ: ',
                'name_cannot_be_empty': 'اسم المنتج لا يمكن أن يكون فارغاً',
                'description_cannot_be_empty': 'الوصف لا يمكن أن يكون فارغاً',
                'quantity_cannot_be_empty': 'الرجاء إدخال الكمية',
                'enter_valid_integer': 'الرجاء إدخال رقم صحيح',
                'quantity_cannot_be_negative': 'الكمية لا يمكن أن تكون سالبة',
                'price_cannot_be_empty': 'السعر لا يمكن أن يكون فارغاً',
                'enter_valid_price': 'أدخل سعراً صالحاً',
                'price_must_be_greater_than_0': 'السعر يجب أن يكون أكبر من 0',
                'variant_price_cannot_be_empty': 'السعر للمتغير لا يمكن أن يكون فارغاً',
                'enter_valid_variant_price': 'أدخل سعراً صالحاً للمتغير',
                'variant_price_must_be_greater_than_0': 'السعر يجب أن يكون أكبر من 0',
                'please_select_product_type': 'الرجاء اختيار نوع المنتج',
                'please_correct_form_errors': '❌ الرجاء إصلاح الأخطاء في النموذج.',
                'please_fill_all_required_fields': '❌ الرجاء ملء جميع الحقول المطلوبة بشكل صحيح.',
                'please_complete_current_step': '❌ الرجاء إكمال الخطوة الحالية قبل المتابعة.',
                'next': 'التالي',
                'back': 'العودة',
                'clothes': 'ملابس',
                'shoes': 'أحذية',
                'gadget': 'أدوات إلكترونية',
                'cosmetics': 'مستحضرات تجميل',
                'english': 'الإنجليزية',
                'arabic': 'العربية',
                'response': 'الاستجابة',
                'go_back_to_admin_panel': 'العودة إلى لوحة التحكم',
            },
            get: function(key) {
                const localeMap = this[`_${currentLocale}`];
                return localeMap[key] || key;
            }
        };

        // --- Global State ---
        let currentLocale = 'en'; // Default to English
        let currentStep = 0;
        let productData = {
            name: '',
            description: '', // This will now hold HTML content from Quill
            quantity: '',
            price: '',
            customOption: '',
            productType: null,
            variants: [{ colors: [], sizes: [], price: '', promoCode: '' }],
            images: [], // Array of File objects for product-level images
        };
        let isLoading = false;

        const predefinedColors = [
            'Black', 'White', 'Red', 'Blue', 'Green', 'Yellow', 'Purple', 'Brown', 'Beige', 'Grey', 'Pink', 'Orange'
        ];
        let availableColors = [...predefinedColors]; // Mutable copy for custom colors

        // --- DOM Elements ---
        const appTitle = document.getElementById('app-title');
        const languageToggle = document.getElementById('language-toggle');
        const languageDropdown = document.getElementById('language-dropdown');
        const langEnText = document.getElementById('lang-en-text');
        const langArText = document.getElementById('lang-ar-text');

        const stepIndicators = [0, 1, 2, 3].map(i => document.getElementById(`step-${i}-indicator`));
        const stepTitles = [0, 1, 2, 3].map(i => document.getElementById(`step-${i}-title`));
        const stepContents = [0, 1, 2, 3].map(i => document.getElementById(`step-${i}-content`));

        // Step 0 elements
        const productTypeSelect = document.getElementById('product-type');
        const productNameInput = document.getElementById('product-name');
        const descriptionEditorDiv = document.getElementById('description-editor'); // The div for Quill
        const quantityInput = document.getElementById('quantity');
        const basePriceInput = document.getElementById('base-price');

        // Step 1 elements
        const variantsContainer = document.getElementById('variants-container');
        const addVariantButton = document.getElementById('add-variant-button');
        const variantsInfo = document.getElementById('variants-info');

        // Step 2 elements
        const customOptionInput = document.getElementById('custom-option');
        const selectImagesButton = document.getElementById('select-images-button');
        const imageUploadInput = document.getElementById('image-upload');
        const imagePreviewContainer = document.getElementById('image-preview-container');

        // Step 3 elements
        const submitProductButtonFinal = document.getElementById('submit-product-button-final');
        const loadingSpinner = document.getElementById('loading-spinner');

        // Stepper controls
        const backButton = document.getElementById('back-button');
        const nextButton = document.getElementById('next-button');

        // Message box
        const messageBox = document.getElementById('message-box');
        const messageText = document.getElementById('message-text');

        // Color Modal elements
        const colorModal = document.getElementById('color-modal');
        const colorChipsContainer = document.getElementById('color-chips-container');
        const newColorInput = document.getElementById('new-color-input');
        const newColorPicker = document.getElementById('new-color-picker');
        const addCustomColorButton = document.getElementById('add-custom-color-button');
        const cancelColorModalButton = document.getElementById('cancel-color-modal');
        const confirmColorModalButton = document.getElementById('confirm-color-modal');
        const errorNewColor = document.getElementById('error-new-color');

        let currentVariantForColorSelection = null; // To track which variant's colors are being edited
        let quill; // Declare Quill instance globally

        // --- Utility Functions ---

        /**
         * Displays a message box (snackbar equivalent).
         * @param {string} message The message to display.
         * @param {string} type 'success', 'error', 'info'.
         */
        function showMessage(message, type = 'info') {
            messageText.textContent = message;
            messageBox.classList.remove('hidden', 'opacity-0', 'bg-red-500', 'bg-green-500', 'bg-gray-800'); // Remove all previous type classes
            messageBox.classList.add('opacity-100');

            if (type === 'success') {
                messageBox.classList.add('bg-green-500');
            } else if (type === 'error') {
                messageBox.classList.add('bg-red-500');
            } else {
                messageBox.classList.add('bg-gray-800');
            }

            setTimeout(() => {
                messageBox.classList.remove('opacity-100');
                messageBox.classList.add('opacity-0');
                setTimeout(() => messageBox.classList.add('hidden'), 300); // Hide after transition
            }, 3000);
        }

        /**
         * Helper to convert color name string to a CSS color value.
         * Now handles hex codes directly.
         * @param {string} colorNameOrHex
         * @returns {string} CSS color string.
         */
        function _colorNameToCss(colorNameOrHex) {
            if (colorNameOrHex.startsWith('#')) {
                return colorNameOrHex;
            }
            switch (colorNameOrHex.toLowerCase()) {
                case 'black': return '#000000';
                case 'white': return '#FFFFFF';
                case 'red': return '#EF4444'; // Tailwind red-500
                case 'blue': return '#3B82F6'; // Tailwind blue-500
                case 'green': return '#22C55E'; // Tailwind green-500
                case 'yellow': return '#FACC15'; // Tailwind yellow-400
                case 'purple': return '#A855F7'; // Tailwind purple-500
                case 'brown': return '#8B5F2A'; // A shade of brown
                case 'beige': return '#F5F5DC'; // Beige
                case 'grey': return '#6B7280'; // Tailwind gray-500
                case 'pink': return '#EC4899'; // Tailwind pink-500
                case 'orange': return '#F97316'; // Tailwind orange-500
                case 'sky blue': return '#0EA5E9'; // Tailwind sky-500
                case 'turquoise': return '#14B8A6'; // Tailwind teal-500
                default: return '#64748B'; // Tailwind slate-500 (fallback for unknown names)
            }
        }

        /**
         * Calculates luminance for text color decision.
         * @param {string} hexColor Hex color string (e.g., #RRGGBB).
         * @returns {number} Luminance value between 0 and 1.
         */
        function getLuminance(hexColor) {
            // Ensure hexColor is a valid 7-character hex string
            if (!/^#[0-9a-fA-F]{6}$/.test(hexColor)) return 0;

            const r = parseInt(hexColor.substring(1, 3), 16) / 255;
            const g = parseInt(hexColor.substring(3, 5), 16) / 255;
            const b = parseInt(hexColor.substring(5, 7), 16) / 255;

            const RsRGB = r <= 0.03928 ? r / 12.92 : Math.pow((r + 0.055) / 1.055, 2.4);
            const GsRGB = g <= 0.03928 ? g / 12.92 : Math.pow((g + 0.055) / 1.055, 2.4);
            const BsRGB = b <= 0.03928 ? b / 12.92 : Math.pow((b + 0.055) / 1.055, 2.4);

            return 0.2126 * RsRGB + 0.7152 * GsRGB + 0.0722 * BsRGB;
        }

        /**
         * Determines appropriate text color (black/white) based on background color luminance.
         * @param {string} hexColor Hex color string.
         * @returns {string} 'text-black' or 'text-white' Tailwind class.
         */
        function getTextColorClass(hexColor) {
            return getLuminance(hexColor) > 0.5 ? 'text-black' : 'text-white';
        }

        /**
         * Helper to get available sizes based on product type.
         * @returns {string[]} Array of size strings.
         */
        function getAvailableSizes() {
            if (productData.productType === 'Clothes') {
                return ['XS', 'S', 'M', 'L', 'XL', 'XXL'];
            } else if (productData.productType === 'Shoes') {
                return ['36', '37', '38', '39', '40', '41', '42', '43', '44', '45'];
            }
            return [];
        }

        /**
         * Helper to convert product type string to localized string.
         * @param {string} type
         * @returns {string} Localized product type.
         */
        function _productTypeToLocalized(type) {
            return AppStrings.get(type.toLowerCase());
        }

        /**
         * Updates all text content based on the current locale.
         */
        function updateLocalizedText() {
            appTitle.textContent = AppStrings.get('add_new_product');
            langEnText.textContent = AppStrings.get('english');
            langArText.textContent = AppStrings.get('arabic');

            // Stepper titles
            stepTitles[0].textContent = AppStrings.get('product_details');
            stepTitles[1].textContent = AppStrings.get('product_variants');
            stepTitles[2].textContent = AppStrings.get('images_custom_options');
            stepTitles[3].textContent = AppStrings.get('review_submit');

            // Step 0 labels and placeholders
            document.getElementById('label-product-type').textContent = AppStrings.get('product_type');
            document.getElementById('select-product-type-placeholder').textContent = AppStrings.get('select_product_type');
            document.getElementById('option-clothes').textContent = AppStrings.get('clothes');
            document.getElementById('option-shoes').textContent = AppStrings.get('shoes');
            document.getElementById('option-gadget').textContent = AppStrings.get('gadget');
            document.getElementById('option-cosmetics').textContent = AppStrings.get('cosmetics');

            document.getElementById('label-product-name').textContent = AppStrings.get('product_name');
            productNameInput.placeholder = AppStrings.get('example_tshirt');

            document.getElementById('label-description').textContent = AppStrings.get('detailed_description');
            // Quill placeholder is set during initialization and doesn't update dynamically via API.
            if (quill) {
                quill.root.dataset.placeholder = AppStrings.get('provide_detailed_description');
            }

            document.getElementById('label-quantity').textContent = AppStrings.get('total_quantity');
            quantityInput.placeholder = AppStrings.get('example_100');

            document.getElementById('label-base-price').textContent = AppStrings.get('base_price');
            basePriceInput.placeholder = AppStrings.get('example_1500_00');

            // Step 1 titles and buttons
            document.getElementById('variants-title').textContent = AppStrings.get('product_variants_colors_sizes_prices');
            document.getElementById('add-another-variant-text').textContent = AppStrings.get('add_another_variant');

            // Step 2 labels and buttons
            document.getElementById('label-custom-option').textContent = AppStrings.get('custom_option_optional');
            customOptionInput.placeholder = AppStrings.get('example_gift_wrap');
            document.getElementById('select-product-images-text').textContent = AppStrings.get('select_product_images');

            // Step 3 text and buttons
            document.getElementById('review-details-text').textContent = AppStrings.get('review_details_before_submitting');
            document.getElementById('submit-product-text-final').textContent = AppStrings.get('submit_product');

            // Stepper controls
            document.getElementById('next-text').textContent = AppStrings.get('next');
            document.getElementById('back-text').textContent = AppStrings.get('back');

            // Color modal
            document.getElementById('choose-colors-title').textContent = AppStrings.get('choose_colors');
            document.getElementById('label-add-new-color').textContent = AppStrings.get('add_new_color');
            newColorInput.placeholder = AppStrings.get('example_sky_blue');
            document.getElementById('add-text').textContent = AppStrings.get('add');
            document.getElementById('cancel-text').textContent = AppStrings.get('cancel');
            document.getElementById('confirm-text').textContent = AppStrings.get('confirm');

            // Re-render dynamic parts to apply new locale
            renderProductVariantsStep(); // To update variant labels
            updateStepperUI(); // To update stepper titles
        }

        /**
         * Clears all form fields and resets state.
         */
        function clearForm() {
            productData = {
                name: '',
                description: '',
                quantity: '',
                price: '',
                customOption: '',
                productType: null,
                variants: [{ colors: [], sizes: [], price: '', promoCode: '' }],
                images: [],
            };
            currentStep = 0;
            isLoading = false;
            availableColors = [...predefinedColors]; // Reset custom colors

            productNameInput.value = '';
            quill.setText(''); // Clear Quill editor
            quantityInput.value = '';
            basePriceInput.value = '';
            customOptionInput.value = '';
            productTypeSelect.value = ''; // Reset dropdown

            // Clear image previews
            imagePreviewContainer.innerHTML = '';
            // Clear variant sections
            variantsContainer.innerHTML = '';
            renderProductVariantsStep(); // Re-render initial variant

            updateStepperUI();
            hideAllErrors();
            updateLocalizedText(); // Reapply texts after clearing
        }

        /**
         * Hides all error messages.
         */
        function hideAllErrors() {
            document.querySelectorAll('[id^="error-"]').forEach(el => el.classList.add('hidden'));
        }

        /**
         * Displays an error message for a specific input field.
         * @param {string} fieldId The ID of the input field (e.g., 'product-name').
         * @param {string} message The error message.
         */
        function showError(fieldId, message) {
            const errorElement = document.getElementById(`error-${fieldId}`);
            if (errorElement) {
                errorElement.textContent = message;
                errorElement.classList.remove('hidden');
            }
        }

        /**
         * Hides an error message for a specific input field.
         * @param {string} fieldId The ID of the input field.
         */
        function hideError(fieldId) {
            const errorElement = document.getElementById(`error-${fieldId}`);
            if (errorElement) {
                errorElement.classList.add('hidden');
            }
        }

        // --- Validation Functions ---

        /**
         * Validates Step 0 (Product Details).
         * @returns {boolean} True if valid, false otherwise.
         */
        function validateStep0() {
            let isValid = true;
            hideError('product-type');
            hideError('product-name');
            hideError('description');
            hideError('quantity');
            hideError('base-price');

            if (!productData.productType) {
                showError('product-type', AppStrings.get('please_select_product_type'));
                isValid = false;
            }
            // Validate Quill editor content
            // Quill's getText() returns a newline for empty content, so check length > 1
            if (quill.getText().trim().length <= 0) {
                showError('description', AppStrings.get('description_cannot_be_empty'));
                isValid = false;
            }
            if (!productData.name.trim()) {
                showError('product-name', AppStrings.get('name_cannot_be_empty'));
                isValid = false;
            }
            const quantity = parseInt(productData.quantity);
            if (isNaN(quantity) || productData.quantity === '') {
                showError('quantity', AppStrings.get('quantity_cannot_be_empty'));
                isValid = false;
            } else if (!Number.isInteger(quantity)) {
                showError('quantity', AppStrings.get('enter_valid_integer'));
                isValid = false;
            } else if (quantity < 0) {
                showError('quantity', AppStrings.get('quantity_cannot_be_negative'));
                isValid = false;
            }
            const price = parseFloat(productData.price);
            if (isNaN(price) || productData.price === '') {
                showError('base-price', AppStrings.get('price_cannot_be_empty'));
                isValid = false;
            } else if (price <= 0) {
                showError('base-price', AppStrings.get('price_must_be_greater_than_0'));
                isValid = false;
            }
            return isValid;
        }

        /**
         * Validates Step 1 (Product Variants).
         * @returns {boolean} True if valid, false otherwise.
         */
        function validateStep1() {
            let isValid = true;
            // Clear previous variant errors
            document.querySelectorAll('[id^="error-variant-price-"]').forEach(el => el.classList.add('hidden'));

            if (productData.productType === 'Clothes' || productData.productType === 'Shoes') {
                if (productData.variants.length === 0) {
                    showMessage(AppStrings.get('please_fill_all_required_fields'), 'error');
                    return false;
                }
                productData.variants.forEach((variant, index) => {
                    const price = parseFloat(variant.price);
                    if (isNaN(price) || variant.price === '') {
                        showError(`variant-price-${index}`, AppStrings.get('variant_price_cannot_be_empty'));
                        isValid = false;
                    } else if (price <= 0) {
                        showError(`variant-price-${index}`, AppStrings.get('variant_price_must_be_greater_than_0'));
                        isValid = false;
                    }
                });
            }
            return isValid;
        }

        /**
         * Validates all steps before final submission.
         * @returns {boolean} True if all steps are valid, false otherwise.
         */
        function validateAllSteps() {
            let allValid = true;
            if (!validateStep0()) {
                allValid = false;
                currentStep = 0; // Go back to step 0 if invalid
                updateStepperUI();
                showMessage(AppStrings.get('please_correct_form_errors'), 'error');
                return false;
            }
            if ((productData.productType === 'Clothes' || productData.productType === 'Shoes') && !validateStep1()) {
                allValid = false;
                currentStep = 1; // Go back to step 1 if invalid
                updateStepperUI();
                showMessage(AppStrings.get('please_correct_form_errors'), 'error');
                return false;
            }
            // Step 2 has no mandatory fields other than image selection, which is optional.
            return allValid;
        }

        // --- Stepper UI and Logic ---

        /**
         * Updates the stepper UI (active step, completed steps, content visibility).
         */
        function updateStepperUI() {
            stepIndicators.forEach((indicator, index) => {
                const circle = indicator.children[0];
                const title = indicator.children[1];

                // Reset classes
                circle.classList.remove('border-blue-700', 'text-blue-700', 'bg-blue-700', 'text-white', 'border-green-700', 'text-green-700');
                circle.classList.add('border-gray-400', 'text-gray-400');
                title.classList.remove('text-gray-900', 'font-bold');
                title.classList.add('text-gray-500');

                if (index === currentStep) {
                    circle.classList.remove('border-gray-400', 'text-gray-400');
                    circle.classList.add('border-blue-700', 'text-blue-700');
                    title.classList.add('text-gray-900', 'font-bold');
                } else if (index < currentStep) {
                    circle.classList.remove('border-gray-400', 'text-gray-400');
                    circle.classList.add('bg-green-700', 'text-white', 'border-green-700');
                    title.classList.add('text-gray-900');
                }

                // Hide all step contents first
                stepContents[index].classList.add('hidden');
            });

            // Show current step content
            stepContents[currentStep].classList.remove('hidden');

            // Update button visibility and text
            if (currentStep === 0) {
                backButton.classList.add('hidden');
            } else {
                backButton.classList.remove('hidden');
            }

            if (currentStep === 3) { // Last step
                nextButton.classList.add('hidden');
                submitProductButtonFinal.classList.remove('hidden');
            } else {
                nextButton.classList.remove('hidden');
                submitProductButtonFinal.classList.add('hidden');
            }

            // Re-render variant section if current step is 1
            if (currentStep === 1) {
                renderProductVariantsStep();
            }
        }

        /**
         * Handles moving to the next step.
         */
        function onStepContinue() {
            let isValid = true;
            if (currentStep === 0) {
                isValid = validateStep0();
            } else if (currentStep === 1) {
                isValid = validateStep1();
            }
            // Step 2 has no mandatory validation to proceed to step 3.

            if (!isValid) {
                showMessage(AppStrings.get('please_fill_all_required_fields'), 'error');
                return;
            }

            const isLastStep = currentStep === 3;
            if (isLastStep) {
                addProduct(); // Call addProduct on the last step
            } else {
                currentStep++;
                updateStepperUI();
            }
        }

        /**
         * Handles moving to the previous step.
         */
        function onStepCancel() {
            if (currentStep > 0) {
                currentStep--;
                updateStepperUI();
            }
        }

        /**
         * Handles tapping on a step indicator.
         * @param {number} step The index of the tapped step.
         */
        function onStepTapped(step) {
            if (step > currentStep) {
                // Validate steps being skipped over
                let isValid = true;
                for (let i = currentStep; i < step; i++) {
                    if (i === 0) {
                        if (!validateStep0()) { isValid = false; break; }
                    } else if (i === 1) {
                        if (!validateStep1()) { isValid = false; break; }
                    }
                }

                if (!isValid) {
                    showMessage(AppStrings.get('please_complete_current_step'), 'error');
                    return;
                }
            }
            currentStep = step;
            updateStepperUI();
        }

        // --- Dynamic Content Rendering ---

        /**
         * Renders a single product variant section.
         * @param {Object} variant The variant data object.
         * @param {number} index The index of the variant in the array.
         */
        function renderVariantSection(variant, index) {
            const variantDiv = document.createElement('div');
            variantDiv.id = `variant-${index}`;
            variantDiv.className = 'bg-white p-6 rounded-xl shadow-md border border-gray-200 space-y-4';
            variantDiv.innerHTML = `
                <div class="flex justify-between items-center">
                    <h3 class="text-lg font-semibold text-gray-900">${AppStrings.get('variant')} ${index + 1}</h3>
                    ${productData.variants.length > 1 ? `
                        <button type="button" class="text-red-500 hover:text-red-700 transition duration-200" data-variant-index="${index}" data-action="delete-variant">
                            <i data-lucide="trash-2" class="w-5 h-5"></i>
                        </button>
                    ` : ''}
                </div>
                <div>
                    <label for="variant-price-${index}" class="block text-gray-700 text-sm font-bold mb-2">${AppStrings.get('price_for_variant_dzd')}</label>
                    <div class="relative">
                        <input type="number" step="0.01" id="variant-price-${index}" name="variant_price_${index}" class="w-full px-4 py-3 rounded-lg border border-gray-300 bg-gray-100 text-gray-900 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-700 focus:border-transparent transition duration-200" placeholder="${AppStrings.get('example_1450_00')}" value="${variant.price}" autocomplete="off">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <i data-lucide="dollar-sign" class="w-5 h-5 text-gray-700"></i>
                        </div>
                    </div>
                    <p id="error-variant-price-${index}" class="text-red-500 text-xs italic mt-1 hidden"></p>
                </div>
                <div>
                    <label for="variant-promo-${index}" class="block text-gray-700 text-sm font-bold mb-2">${AppStrings.get('promo_code_optional')}</label>
                    <div class="relative">
                        <input type="text" id="variant-promo-${index}" name="variant_promo_${index}" class="w-full px-4 py-3 rounded-lg border border-gray-300 bg-gray-100 text-gray-900 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-700 focus:border-transparent transition duration-200" placeholder="${AppStrings.get('example_discount10')}" value="${variant.promoCode}" autocomplete="off">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <i data-lucide="percent" class="w-5 h-5 text-gray-700"></i>
                        </div>
                    </div>
                </div>
                <div>
                    <label class="block text-gray-700 text-sm font-bold mb-2">${AppStrings.get('selected_colors')}</label>
                    <div class="flex flex-wrap gap-2 p-3 rounded-lg border border-gray-300 bg-gray-100 min-h-[40px]" id="variant-${index}-colors-display">
                        ${variant.colors.map(colorNameOrHex => {
                            const bgColor = _colorNameToCss(colorNameOrHex);
                            const textColorClass = getTextColorClass(bgColor);
                            return `
                                <div class="flex items-center px-3 py-1 rounded-full text-sm ${textColorClass}" style="background-color: ${bgColor};">
                                    <span>${colorNameOrHex}</span>
                                    <button type="button" class="ml-2 text-current hover:opacity-75" data-color="${colorNameOrHex}" data-variant-index="${index}" data-action="remove-color">
                                        <i data-lucide="x" class="w-4 h-4"></i>
                                    </button>
                                </div>
                            `;
                        }).join('')}
                    </div>
                    <div class="flex justify-end mt-3">
                        <button type="button" class="flex items-center px-4 py-2 bg-blue-700 text-white rounded-lg shadow-md hover:bg-blue-800 focus:outline-none focus:ring-2 focus:ring-blue-600 transition duration-200" data-variant-index="${index}" data-action="select-colors">
                            <i data-lucide="palette" class="w-5 h-5 mr-2"></i>
                            <span>${AppStrings.get('choose_colors')}</span>
                        </button>
                    </div>
                </div>
                <div>
                    <label class="block text-gray-700 text-sm font-bold mb-2">${AppStrings.get('sizes')}</label>
                    <div class="flex flex-wrap gap-2 p-3 rounded-lg border border-gray-300 bg-gray-100">
                        ${getAvailableSizes().map(size => `
                            <button type="button" class="px-4 py-2 rounded-lg text-sm font-medium transition duration-200
                                ${variant.sizes.includes(size) ? 'bg-blue-700 text-white shadow-sm' : 'bg-gray-300 text-gray-900 hover:bg-gray-400'}
                            " data-size="${size}" data-variant-index="${index}" data-action="toggle-size">
                                ${size}
                            </button>
                        `).join('')}
                    </div>
                </div>
            `;
            // Re-create Lucide icons for newly added elements
            setTimeout(() => lucide.createIcons(), 0);
            return variantDiv;
        }

        /**
         * Renders the product variants section (Step 1).
         */
        function renderProductVariantsStep() {
            variantsContainer.innerHTML = ''; // Clear existing variants

            if (productData.productType === null || (productData.productType !== 'Clothes' && productData.productType !== 'Shoes')) {
                variantsInfo.textContent = productData.productType === null
                    ? AppStrings.get('please_select_product_type_first')
                    : AppStrings.get('this_product_type_no_variants');
                variantsInfo.classList.remove('hidden');
                addVariantButton.classList.add('hidden');
            } else {
                variantsInfo.classList.add('hidden');
                addVariantButton.classList.remove('hidden');

                productData.variants.forEach((variant, index) => {
                    const variantSection = renderVariantSection(variant, index);
                    variantsContainer.appendChild(variantSection);
                });
            }

            // Attach event listeners for dynamically created elements
            attachVariantEventListeners();
        }

        /**
         * Attaches event listeners to dynamically created variant elements.
         */
        function attachVariantEventListeners() {
            // Price and Promo Code inputs
            variantsContainer.querySelectorAll('input[id^="variant-price-"]').forEach(input => {
                input.oninput = (e) => {
                    const index = parseInt(e.target.id.split('-')[2]);
                    productData.variants[index].price = e.target.value;
                    hideError(`variant-price-${index}`); // Hide error on input
                };
            });
            variantsContainer.querySelectorAll('input[id^="variant-promo-"]').forEach(input => {
                input.oninput = (e) => {
                    const index = parseInt(e.target.id.split('-')[2]);
                    productData.variants[index].promoCode = e.target.value;
                };
            });

            // Delete variant buttons
            variantsContainer.querySelectorAll('button[data-action="delete-variant"]').forEach(button => {
                button.onclick = (e) => {
                    const index = parseInt(e.currentTarget.dataset.variantIndex);
                    productData.variants.splice(index, 1);
                    if (productData.variants.length === 0) {
                        productData.variants.push({ colors: [], sizes: [], price: '', promoCode: '' }); // Ensure at least one
                    }
                    renderProductVariantsStep(); // Re-render all variants
                };
            });

            // Color selection buttons
            variantsContainer.querySelectorAll('button[data-action="select-colors"]').forEach(button => {
                button.onclick = (e) => {
                    const index = parseInt(e.currentTarget.dataset.variantIndex);
                    currentVariantForColorSelection = productData.variants[index];
                    showColorSelectionModal(currentVariantForColorSelection.colors);
                };
            });

            // Remove color chips
            variantsContainer.querySelectorAll('[id^="variant-"][id$="-colors-display"] button[data-action="remove-color"]').forEach(button => {
                button.onclick = (e) => {
                    const colorToRemove = e.currentTarget.dataset.color;
                    const index = parseInt(e.currentTarget.dataset.variantIndex);
                    productData.variants[index].colors = productData.variants[index].colors.filter(c => c !== colorToRemove);
                    renderProductVariantsStep(); // Re-render to update chips
                };
            });

            // Size selection buttons
            variantsContainer.querySelectorAll('button[data-action="toggle-size"]').forEach(button => {
                button.onclick = (e) => {
                    const size = e.currentTarget.dataset.size;
                    const index = parseInt(e.currentTarget.dataset.variantIndex);
                    const variant = productData.variants[index];
                    const isSelected = variant.sizes.includes(size);

                    if (!isSelected) { // If not selected, add it
                        variant.sizes.push(size);
                    } else { // If selected, remove it
                        variant.sizes = variant.sizes.filter(s => s !== size);
                    }
                    renderProductVariantsStep(); // Re-render to update chip styles
                };
            });
        }

        /**
         * Renders image previews.
         */
        function renderImagePreviews() {
            imagePreviewContainer.innerHTML = '';
            productData.images.forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const imgDiv = document.createElement('div');
                    imgDiv.className = 'relative w-28 h-28 rounded-lg overflow-hidden shadow-md';
                    imgDiv.innerHTML = `
                        <img src="${e.target.result}" alt="Product Image" class="w-full h-full object-cover">
                        <button type="button" class="absolute top-1 right-1 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs hover:bg-red-600 transition duration-200" data-index="${index}">
                            <i data-lucide="x" class="w-4 h-4"></i>
                        </button>
                    `;
                    imagePreviewContainer.appendChild(imgDiv);

                    // Attach delete listener
                    imgDiv.querySelector('button').onclick = (deleteEvent) => {
                        const imgIndex = parseInt(deleteEvent.currentTarget.dataset.index);
                        productData.images.splice(imgIndex, 1);
                        renderImagePreviews(); // Re-render to update indices
                    };
                    lucide.createIcons(); // Re-create icons for new elements
                };
                reader.readAsDataURL(file);
            });
        }

        /**
         * Shows the color selection modal.
         * @param {string[]} currentSelectedColors Colors currently selected for the variant.
         */
        function showColorSelectionModal(currentSelectedColors) {
            colorModal.classList.remove('hidden');
            let tempSelectedColors = [...currentSelectedColors]; // Working copy for the modal

            function renderColorChipsInModal() {
                colorChipsContainer.innerHTML = '';
                availableColors.forEach(colorNameOrHex => {
                    const isSelected = tempSelectedColors.includes(colorNameOrHex);
                    const bgColor = _colorNameToCss(colorNameOrHex);
                    const textColorClass = getTextColorClass(bgColor);
                    const chipDiv = document.createElement('button');
                    chipDiv.type = 'button';
                    chipDiv.className = `w-12 h-12 rounded-lg flex items-center justify-center border-2 transition duration-200 ${textColorClass} ${isSelected ? 'border-blue-700' : 'border-gray-400'}`;
                    chipDiv.style.backgroundColor = bgColor;
                    chipDiv.dataset.color = colorNameOrHex;
                    chipDiv.innerHTML = isSelected ? `<i data-lucide="check" class="w-8 h-8"></i>` : '';

                    if (bgColor.toLowerCase() === '#ffffff') {
                        chipDiv.classList.remove('text-white');
                        chipDiv.classList.add('text-black');
                    }

                    chipDiv.onclick = () => {
                        if (tempSelectedColors.includes(colorNameOrHex)) {
                            tempSelectedColors = tempSelectedColors.filter(c => c !== colorNameOrHex);
                        } else {
                            tempSelectedColors.push(colorNameOrHex);
                        }
                        renderColorChipsInModal(); // Re-render to update selection
                    };
                    colorChipsContainer.appendChild(chipDiv);
                });
                lucide.createIcons(); // Re-create icons for new elements
            }

            renderColorChipsInModal();
            newColorInput.value = ''; // Clear input
            errorNewColor.classList.add('hidden'); // Hide error

            // Event listeners for modal buttons
            addCustomColorButton.onclick = () => {
                // Prioritize the color picker value if it's not white
                let newColor = newColorPicker.value !== '#ffffff' ? newColorPicker.value.toUpperCase() : newColorInput.value.trim();
                
                if (!newColor) return; // Do nothing if both are empty

                // If it's a hex code, ensure it's uppercase
                if (newColor.startsWith('#')) {
                    newColor = newColor.toUpperCase();
                }

                if (newColor && !availableColors.find(c => c.toLowerCase() === newColor.toLowerCase())) {
                    availableColors.push(newColor);
                    newColorInput.value = '';
                    newColorPicker.value = '#ffffff';
                    errorNewColor.classList.add('hidden');
                    renderColorChipsInModal(); // Re-render chips to include new color
                } else if (newColor) {
                    errorNewColor.textContent = AppStrings.get('color_already_exists');
                    errorNewColor.classList.remove('hidden');
                }
            };

            cancelColorModalButton.onclick = () => {
                colorModal.classList.add('hidden');
            };

            confirmColorModalButton.onclick = () => {
                if (currentVariantForColorSelection) {
                    currentVariantForColorSelection.colors = tempSelectedColors;
                    renderProductVariantsStep(); // Re-render main form to show updated colors
                }
                colorModal.classList.add('hidden');
            };
        }


        // --- API Call ---

        /**
         * Handles the product submission to the backend.
         */
        async function addProduct() {
            // Update productData.description from Quill editor before validation/submission
            productData.description = quill.root.innerHTML;

            if (!validateAllSteps()) {
                return; // Stop if validation fails
            }

            isLoading = true;
            loadingSpinner.classList.remove('hidden');
            submitProductButtonFinal.disabled = true; // Disable button during submission

            const formData = new FormData();
            formData.append('name', productData.name);
            formData.append('description', productData.description); // Send HTML content
            formData.append('quantity', productData.quantity);
            formData.append('price', productData.price);
            formData.append('custom_option', productData.customOption);
            formData.append('product_type', productData.productType || '');

            // Only add variants if product type is 'Clothes' or 'Shoes'
            if (productData.productType === 'Clothes' || productData.productType === 'Shoes') {
                formData.append('variants', JSON.stringify(productData.variants.map(v => ({
                    colors: v.colors,
                    sizes: v.sizes,
                    price: parseFloat(v.price), // Ensure price is number
                    promo_code: v.promoCode || null // Handle empty promo code
                }))));
            } else {
                formData.append('variants', JSON.stringify([]));
            }

            productData.images.forEach((imageFile) => {
                formData.append('images', imageFile);
            });

            try {
                const response = await fetch('https://sheeka.onrender.com/products', {
                    method: 'POST',
                    body: formData,
                });

                if (response.ok) {
                    showMessage(AppStrings.get('product_added_successfully'), 'success');
                    clearForm(); // Clear form after successful submission
                } else {
                    const errorBody = await response.text();
                    showMessage(`${AppStrings.get('failed_to_add_product')}${response.status}, ${AppStrings.get('response')}: ${errorBody}`, 'error');
                }
            } catch (e) {
                showMessage(`${AppStrings.get('an_error_occurred')}${e.message}`, 'error');
            } finally {
                isLoading = false;
                loadingSpinner.classList.add('hidden');
                submitProductButtonFinal.disabled = false; // Re-enable button
            }
        }

        // --- Initial Render ---
        document.addEventListener('DOMContentLoaded', () => {
            // --- Role Check ---
            const userRole = localStorage.getItem('role');
            const mainContainer = document.getElementById('main-container');
            const accessDeniedMessage = document.getElementById('access-denied');
            
            if (userRole !== 'admin') {
                mainContainer.style.display = 'none';
                accessDeniedMessage.classList.remove('hidden');
                return; // Stop further execution for non-admins
            }

            // Initialize Quill editor
            quill = new Quill('#description-editor', {
                theme: 'snow',
                placeholder: AppStrings.get('provide_detailed_description'),
                modules: {
                    toolbar: [
                        [{ 'header': [1, 2, 3, false] }],
                        ['bold', 'italic', 'underline', 'strike'],
                        [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                        ['link', 'image'],
                        ['clean']
                    ]
                }
            });

            // Listen for changes in Quill editor to update productData
            quill.on('text-change', () => {
                productData.description = quill.root.innerHTML;
                hideError('description'); // Hide error when user starts typing
            });

            // --- Event Listeners ---
            languageToggle.addEventListener('click', () => {
                languageDropdown.classList.toggle('hidden');
            });

            languageDropdown.querySelectorAll('button').forEach(button => {
                button.addEventListener('click', (e) => {
                    currentLocale = e.target.dataset.locale || e.target.closest('button').dataset.locale;
                    updateLocalizedText();
                    languageDropdown.classList.add('hidden');
                    // Adjust text direction for Arabic
                    if (currentLocale === 'ar') {
                        document.body.style.direction = 'rtl';
                        document.documentElement.lang = 'ar';
                    } else {
                        document.body.style.direction = 'ltr';
                        document.documentElement.lang = 'en';
                    }
                });
            });

            // Stepper navigation buttons
            nextButton.addEventListener('click', onStepContinue);
            backButton.addEventListener('click', onStepCancel);

            // Stepper indicator clicks
            stepIndicators.forEach((indicator, index) => {
                indicator.addEventListener('click', () => onStepTapped(index));
            });

            // Step 0 Inputs
            productTypeSelect.addEventListener('change', (e) => {
                productData.productType = e.target.value;
                hideError('product-type');
                // Reset variants when product type changes
                productData.variants = [{ colors: [], sizes: [], price: '', promoCode: '' }];
                renderProductVariantsStep(); // Re-render to reflect changes in variant section
            });
            productNameInput.addEventListener('input', (e) => { productData.name = e.target.value; hideError('product-name'); });
            quantityInput.addEventListener('input', (e) => { productData.quantity = e.target.value; hideError('quantity'); });
            basePriceInput.addEventListener('input', (e) => { productData.price = e.target.value; hideError('base-price'); });

            // Step 1 - Add Variant Button
            addVariantButton.addEventListener('click', () => {
                productData.variants.push({ colors: [], sizes: [], price: '', promoCode: '' });
                renderProductVariantsStep();
            });

            // Step 2 Inputs and Image Upload
            customOptionInput.addEventListener('input', (e) => { productData.customOption = e.target.value; });

            selectImagesButton.addEventListener('click', () => {
                imageUploadInput.click(); // Trigger file input click
            });

            imageUploadInput.addEventListener('change', (e) => {
                const files = Array.from(e.target.files);
                files.forEach(file => {
                    if (file.type.startsWith('image/')) {
                        productData.images.push(file);
                    }
                });
                renderImagePreviews();
                e.target.value = ''; // Clear the input so same file can be selected again
            });

            // Final Submit Button (on Step 3)
            submitProductButtonFinal.addEventListener('click', addProduct);

            updateLocalizedText();
            updateStepperUI(); // Initial stepper setup
            renderProductVariantsStep(); // Initial variant rendering
            lucide.createIcons(); // Initial icon render
        });
    </script>
</body>
</html>
