<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ERP Dashboard</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts - Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5; /* A lighter, more professional gray */
        }

        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #a8a8a8; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #888; }

        /* --- Modern Sidebar Styles --- */
        .sidebar {
            position: fixed;
            top: 0;
            left: 0;
            z-index: 40;
            width: 260px; /* Slightly wider */
            background-color: #0c1e35; /* Deep corporate blue */
            color: #aeb9c4; /* Softer text color */
            height: 100vh;
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease-in-out;
            transform: translateX(-100%);
        }

        @media (min-width: 768px) {
            .sidebar {
                transform: translateX(0);
            }
        }

        .sidebar.open {
            transform: translateX(0);
        }

        .sidebar-header {
            padding: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            border-bottom: 1px solid #1a2e47;
        }

        .sidebar-header .logo-icon {
            background-color: #007bff;
            color: white;
            padding: 0.6rem;
            border-radius: 0.5rem;
            font-size: 1.25rem;
        }

        .sidebar-header h2 {
            font-size: 1.25rem;
            font-weight: 700;
            color: white;
        }

        .sidebar nav {
            flex-grow: 1;
            padding: 1rem;
            overflow-y: auto;
        }
        
        .nav-category {
            font-size: 0.75rem;
            font-weight: 600;
            color: #5a6e82;
            text-transform: uppercase;
            padding: 0.5rem 0.75rem;
            margin-top: 1rem;
        }

        .sidebar-button {
            display: flex;
            align-items: center;
            width: 100%;
            padding: 0.85rem 1rem;
            border-radius: 0.5rem;
            background-color: transparent;
            font-weight: 500;
            transition: background-color 0.2s ease, color 0.2s ease;
            position: relative;
            margin-top: 0.25rem;
        }

        .sidebar-button:hover {
            background-color: #1a2e47;
            color: white;
        }

        .sidebar-button.active {
            background: linear-gradient(90deg, #007bff, #0056b3);
            color: white;
            font-weight: 600;
            box-shadow: 0 4px 10px rgba(0, 123, 255, 0.3);
        }
        
        .sidebar-footer {
            padding: 1rem;
            margin-top: auto;
            border-top: 1px solid #1a2e47;
        }
        
        .user-profile {
            display: flex;
            align-items: center;
            padding: 0.5rem;
            border-radius: 0.5rem;
            background-color: #1a2e47;
        }
        .user-profile img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 0.75rem;
            border: 2px solid #007bff;
        }
        .user-profile div {
            line-height: 1.2;
        }
        .user-profile .username {
            font-weight: 600;
            color: white;
        }
        .user-profile .role {
            font-size: 0.8rem;
            color: #aeb9c4;
        }


        /* --- Main Content & Widgets --- */
        .main-content {
            transition: margin-left 0.3s ease-in-out;
        }
        @media (min-width: 768px) {
            .main-content {
                margin-left: 260px;
            }
        }

        .widget {
            background-color: #ffffff;
            border-radius: 0.75rem;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            display: flex;
            flex-direction: column;
        }
        .widget:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.08);
        }

        .widget-header {
            padding: 1rem 1.25rem;
            border-bottom: 1px solid #eef2f7;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .widget-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #333;
        }
        .widget-icon {
            color: #007bff;
            font-size: 1.25rem;
        }

        .widget-content {
            padding: 1.25rem;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        
        .widget-content.p-0 {
            padding: 0;
        }
        
        .widget-table-container {
            max-height: 300px; /* Or any other height */
            overflow-y: auto;
        }

        /* KPI Widget Styles */
        .kpi-widget .value {
            font-size: 2.25rem;
            font-weight: 800;
            color: #1a2e47;
        }
        .kpi-widget .label {
            font-size: 1rem;
            font-weight: 500;
            color: #5a6e82;
        }
        .kpi-widget .icon-bg {
            font-size: 1.75rem;
            padding: 1rem;
            border-radius: 50%;
        }

        /* Table Widget Styles */
        .table-widget table {
            width: 100%;
            border-collapse: collapse;
        }
        .table-widget th, .table-widget td {
            padding: 0.85rem 1.25rem;
            text-align: left;
            border-bottom: 1px solid #eef2f7;
        }
        .table-widget th {
            font-size: 0.85rem;
            font-weight: 600;
            color: #5a6e82;
            text-transform: uppercase;
            position: sticky;
            top: 0;
            background-color: white;
        }
        .table-widget td {
            font-size: 0.95rem;
            color: #333;
        }
        .table-widget tbody tr:hover {
            background-color: #f8f9fa;
        }
        
        /* Ranked List Widget Styles */
        .ranked-list-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.75rem 0;
            border-bottom: 1px solid #eef2f7;
        }
        .ranked-list-item:last-child {
            border-bottom: none;
        }
        .ranked-list-item .name {
            font-weight: 500;
            color: #333;
        }
        .ranked-list-item .value {
            font-weight: 600;
            color: #007bff;
        }


        /* Filter Bar Styles */
        .filter-bar {
            background-color: #ffffff;
            padding: 0.75rem 1.25rem;
            border-radius: 0.75rem;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
        }
        .filter-button {
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 500;
            transition: all 0.2s ease;
            border: 1px solid transparent;
        }
        .filter-button.active {
            background-color: #007bff;
            color: white;
            box-shadow: 0 2px 5px rgba(0,123,255,0.2);
        }
        .filter-button:not(.active) {
            background-color: #eef2f7;
            color: #5a6e82;
        }
        .filter-button:not(.active):hover {
            background-color: #dde3ea;
        }

    </style>
</head>
<body class="min-h-screen">
    <!-- Sidebar -->
    <aside id="sidebar" class="sidebar">
        <div class="sidebar-header">
            <div class="logo-icon"><i class="fas fa-shield-alt"></i></div>
            <h2>Admin ERP</h2>
        </div>
        <nav>
            <div class="nav-category">Main</div>
            <button id="dashboard-nav-btn" class="sidebar-button active">
                <i class="fas fa-tachometer-alt fa-fw mr-3 w-5 text-center"></i>
                <span>Dashboard</span>
            </button>
            <button id="orders-button" class="sidebar-button">
                <i class="fas fa-clipboard-list fa-fw mr-3 w-5 text-center"></i>
                <span>Orders</span>
            </button>
            <button id="facture-nav-btn" class="sidebar-button">
                <i class="fas fa-file-invoice fa-fw mr-3 w-5 text-center"></i>
                <span>Facture</span>
            </button>
            
            <div class="nav-category">Management</div>
            <button id="add-product-nav-btn" class="sidebar-button">
                <i class="fas fa-plus-circle fa-fw mr-3 w-5 text-center"></i>
                <span>Add Product</span>
            </button>
            <button id="all-products-nav-btn" class="sidebar-button">
                <i class="fas fa-boxes fa-fw mr-3 w-5 text-center"></i>
                <span>All Products</span>
            </button>
            <button id="stock-nav-btn" class="sidebar-button">
                <i class="fas fa-warehouse fa-fw mr-3 w-5 text-center"></i>
                <span>Stock</span>
            </button>
            
            <div class="nav-category">Configuration</div>
            <button id="admins-nav-btn" class="sidebar-button">
                <i class="fas fa-user-shield fa-fw mr-3 w-5 text-center"></i>
                <span>Admins</span>
            </button>
            <button id="pixels-nav-btn" class="sidebar-button">
                <i class="fas fa-image fa-fw mr-3 w-5 text-center"></i>
                <span>Pixels</span>
            </button>
            <button id="fees-delivery-nav-btn" class="sidebar-button">
                <i class="fas fa-dollar-sign fa-fw mr-3 w-5 text-center"></i>
                <span>Fees Delivery</span>
            </button>
            <button id="site-config-nav-btn" class="sidebar-button">
                <i class="fas fa-cog fa-fw mr-3 w-5 text-center"></i>
                <span>Site Config</span>
            </button>
        </nav>
        <div class="sidebar-footer">
            <div class="user-profile">
                <img src="https://placehold.co/100x100/007bff/FFFFFF?text=A" alt="Admin" onerror="this.onerror=null;this.src='https://placehold.co/100x100/cccccc/FFFFFF?text=A';">
                <div>
                    <div class="username">Admin User</div>
                    <div class="role">Superadmin</div>
                </div>
            </div>
             <button id="logout-button" class="sidebar-button mt-4 hover:bg-red-500/20 hover:text-red-400">
                <i class="fas fa-sign-out-alt fa-fw mr-3 w-5 text-center"></i>
                <span id="logout-text">Logout</span>
            </button>
        </div>
    </aside>

    <!-- Main Content Area -->
    <div class="main-content flex-1 flex flex-col">
        <!-- Overlay for mobile when sidebar is open -->
        <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-30 hidden md:hidden"></div>
        
        <!-- App Bar -->
        <header class="bg-white/80 backdrop-blur-lg sticky top-0 z-20 shadow-sm p-4 flex justify-between items-center">
            <div class="flex items-center gap-4">
                <button id="menu-toggle" class="md:hidden text-gray-600 hover:text-gray-800 focus:outline-none">
                    <i class="fas fa-bars text-2xl"></i>
                </button>
                <h1 class="text-2xl font-bold text-gray-800">Sales Dashboard</h1>
            </div>
            <div class="flex items-center gap-4 md:gap-6">
                 <div class="text-right hidden sm:block">
                     <div id="live-clock" class="font-semibold text-gray-700"></div>
                     <div id="live-location" class="text-xs text-gray-500"></div>
                 </div>
                 <button id="language-toggle" class="text-gray-600 hover:text-blue-600 transition-colors">
                    <i class="fas fa-language text-xl"></i>
                </button>
                <button class="text-gray-600 hover:text-blue-600 transition-colors">
                    <i class="fas fa-bell text-xl"></i>
                </button>
            </div>
        </header>

        <main class="flex-1 flex flex-col p-4 md:p-6">
            <!-- Filter Bar -->
            <section class="filter-bar mb-6">
                <div class="flex flex-wrap items-center gap-3">
                    <span class="font-semibold text-gray-700">Date Range:</span>
                    <button id="filter-today" class="filter-button">Today</button>
                    <button id="filter-month" class="filter-button active">This Month</button>
                    <button id="filter-custom" class="filter-button">Custom</button>
                    <button id="filter-all" class="filter-button">All</button>
                    <div id="custom-date-range" class="hidden flex-wrap items-center gap-3 ml-4">
                        <input type="date" id="start-date" class="p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500 text-sm">
                        <input type="date" id="end-date" class="p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500 text-sm">
                    </div>
                </div>
            </section>

            <!-- KPI Widgets -->
            <section id="kpi-grid" class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-4 gap-6 mb-6">
                <!-- KPI Widgets will be rendered here by JS -->
            </section>

            <!-- Main Dashboard Grid -->
            <section id="dashboard-grid" class="grid grid-cols-1 lg:grid-cols-4 gap-6 flex-1">
                <!-- Sales Trend Chart (Line Chart) -->
                <div id="sales-trend-card" class="widget lg:col-span-4">
                    <div class="widget-header">
                        <h3 class="widget-title">Sales Trend</h3>
                        <i class="fas fa-chart-line widget-icon"></i>
                    </div>
                    <div class="widget-content">
                        <canvas id="salesTrendChart"></canvas>
                    </div>
                </div>

                <!-- Order Distribution Chart -->
                <div id="order-distribution-card" class="widget lg:col-span-2 xl:col-span-1">
                    <div class="widget-header">
                        <h3 class="widget-title">Order Distribution</h3>
                        <i class="fas fa-chart-pie widget-icon"></i>
                    </div>
                    <div class="widget-content">
                        <canvas id="orderPieChart"></canvas>
                    </div>
                </div>

                <!-- Delivery Status Chart -->
                <div id="delivery-status-card" class="widget lg:col-span-2 xl:col-span-1">
                    <div class="widget-header">
                        <h3 class="widget-title">Delivery & Returns</h3>
                        <i class="fas fa-truck-fast widget-icon"></i>
                    </div>
                    <div class="widget-content">
                        <canvas id="deliveryPieChart"></canvas>
                    </div>
                </div>

                 <!-- Top Wilayas -->
                <div id="top-wilayas-card" class="widget lg:col-span-2 xl:col-span-1">
                    <div class="widget-header">
                        <h3 class="widget-title">Top Wilayas</h3>
                        <i class="fas fa-map-pin widget-icon"></i>
                    </div>
                    <div id="top-wilayas-content" class="widget-content">
                        <!-- Top Wilayas list will be rendered here -->
                    </div>
                </div>

                <!-- Top Products -->
                <div id="top-products-card" class="widget lg:col-span-2 xl:col-span-1">
                    <div class="widget-header">
                        <h3 class="widget-title">Top Products</h3>
                        <i class="fas fa-star widget-icon"></i>
                    </div>
                    <div id="top-products-content" class="widget-content">
                        <!-- Top Products list will be rendered here -->
                    </div>
                </div>

                <!-- Stock Info Table -->
                <div id="stock-info-card" class="widget lg:col-span-4">
                    <div class="widget-header">
                        <h3 class="widget-title">Stock Information</h3>
                        <div class="flex items-center gap-2">
                             <input type="text" id="stock-search" placeholder="Search products..." class="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 bg-gray-50 text-sm">
                             <i class="fas fa-box-open widget-icon"></i>
                        </div>
                    </div>
                    <div id="stock-info-content" class="widget-content p-0">
                        <!-- Stock Table will be rendered here -->
                    </div>
                </div>
            </section>
        </main>
    </div>

    <script>
        // --- Global State & Translations ---
        const appState = {
            allOrders: [],
            stockInfos: [],
            isStockLoading: true,
            stockErrorMessage: null,
            totalOrders: 0,
            pendingOrders: 0,
            confirmedOrders: 0,
            tentativeOrders: 0,
            cancelledOrders: 0,
            dispatchedOrders: 0,
            deliveredOrders: 0,
            returnedOrders: 0,
            topWilayas: [],
            topProducts: [],
            isOrdersLoading: true,
            orderErrorMessage: null,
            selectedFilter: 'month',
            customStartDate: null,
            customEndDate: null,
            isEnglish: true,
            stockFilter: '',
            orderPieChartInstance: null,
            deliveryPieChartInstance: null,
            salesTrendChartInstance: null,
            activeSidebarButton: 'dashboard-nav-btn',
            liveDate: new Date('2025-07-26T17:49:00+01:00')
        };

        const translations = {
            'en': {
                'dashboard': 'Dashboard', 'orders': 'Orders', 'facture': 'Facture',
                'addProduct': 'Add Product', 'allProducts': 'All Products', 'stock': 'Stock',
                'admins': 'Admins', 'pixels': 'Pixels', 'feesDelivery': 'Fees Delivery', 'siteConfig': 'Site Config',
                'logout': 'Logout', 'today': 'Today', 'thisMonth': 'This Month', 'customRange': 'Custom', 'allOrders': 'All',
                'salesDashboard': 'Sales Dashboard', 'totalOrders': 'Total Orders', 'pendingOrders': 'Pending Orders',
                'confirmedOrders': 'Confirmed Orders', 'cancelledOrders': 'Cancelled Orders', 'salesTrend': 'Sales Trend',
                'orderDistribution': 'Order Distribution', 'stockInfo': 'Stock Information', 'searchProducts': 'Search products...',
                'loading': 'Loading...', 'error': 'Error', 'retry': 'Retry', 'noData': 'No data available for this period.',
                'product': 'Product', 'quantity': 'Quantity', 'dateAdded': 'Date Added',
                'pending': 'Pending', 'confirmed': 'Confirmed', 'tentative': 'Tentative', 'cancelled': 'Cancelled',
                'dispatched': 'Dispatched', 'delivered': 'Delivered', 'returned': 'Returned',
                'deliveryReturns': 'Delivery & Returns', 'topWilayas': 'Top Wilayas', 'topProducts': 'Top Products',
                'unitsSold': 'units sold',
                'noStockFound': 'No stock items found matching your search.',
                'location': 'Ghazaouet, Algeria'
            },
            'ar': {
                'dashboard': 'لوحة القيادة', 'orders': 'الطلبات', 'facture': 'فاتورة',
                'addProduct': 'إضافة منتج', 'allProducts': 'جميع المنتجات', 'stock': 'المخزون',
                'admins': 'المسؤولون', 'pixels': 'البكسلات', 'feesDelivery': 'رسوم التوصيل', 'siteConfig': 'إعدادات الموقع',
                'logout': 'تسجيل الخروج', 'today': 'اليوم', 'thisMonth': 'هذا الشهر', 'customRange': 'مخصص', 'allOrders': 'الكل',
                'salesDashboard': 'لوحة قيادة المبيعات', 'totalOrders': 'إجمالي الطلبات', 'pendingOrders': 'طلبات معلقة',
                'confirmedOrders': 'طلبات مؤكدة', 'cancelledOrders': 'طلبات ملغاة', 'salesTrend': 'اتجاه المبيعات',
                'orderDistribution': 'توزيع الطلبات', 'stockInfo': 'معلومات المخزون', 'searchProducts': 'ابحث عن المنتجات...',
                'loading': 'جار التحميل...', 'error': 'خطأ', 'retry': 'إعادة المحاولة', 'noData': 'لا توجد بيانات متاحة لهذه الفترة.',
                'product': 'المنتج', 'quantity': 'الكمية', 'dateAdded': 'تاريخ الإضافة',
                'pending': 'معلقة', 'confirmed': 'مؤكدة', 'tentative': 'مؤقتة', 'cancelled': 'ملغاة',
                'dispatched': 'تم إرسالها', 'delivered': 'تم توصيلها', 'returned': 'مرتجعة',
                'deliveryReturns': 'التوصيل والمرتجعات', 'topWilayas': 'أفضل الولايات', 'topProducts': 'أفضل المنتجات',
                'unitsSold': 'وحدة مباعة',
                'noStockFound': 'لم يتم العثور على عناصر مخزون مطابقة لبحثك.',
                'location': 'غزوات، الجزائر'
            }
        };
        
        // --- Helper & Core Functions ---
        function getTranslatedString(key) {
            return translations[appState.isEnglish ? 'en' : 'ar'][key] || key;
        }

        async function fetchOrders() {
            appState.isOrdersLoading = true;
            appState.orderErrorMessage = null;
            renderAllComponents();

            try {
                const response = await fetch('https://sheeka.onrender.com/orders');
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || `HTTP error! status: ${response.status}`);
                }
                appState.allOrders = await response.json();
                processAndFilterOrders();
            } catch (e) {
                appState.orderErrorMessage = e.message;
                console.error('Error fetching orders:', e);
            } finally {
                appState.isOrdersLoading = false;
                renderAllComponents();
            }
        }
        
        async function fetchStockInfo() {
            appState.isStockLoading = true;
            appState.stockErrorMessage = null;
            renderStockInfoCard();

            try {
                const response = await fetch('https://sheeka.onrender.com/products');
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || `HTTP error! status: ${response.status}`);
                }
                appState.stockInfos = await response.json();
            } catch (e) {
                appState.stockErrorMessage = e.message;
                console.error('Error fetching stock info:', e);
            } finally {
                appState.isStockLoading = false;
                renderStockInfoCard();
            }
        }

        function processAndFilterOrders() {
            let pending = 0, confirmed = 0, tentative = 0, cancelled = 0;
            let dispatched = 0, delivered = 0, returned = 0;
            const wilayaCounts = {};
            const productCounts = {};
            
            const now = appState.liveDate;
            const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const thisMonthStart = new Date(now.getFullYear(), now.getMonth(), 1);

            const filteredOrders = appState.allOrders.filter(order => {
                let createdAt;
                try {
                    createdAt = new Date(order.createdAt);
                    if (isNaN(createdAt.getTime())) throw new Error('Invalid date');
                } catch { return false; }

                switch (appState.selectedFilter) {
                    case 'today':
                        return createdAt >= todayStart && createdAt < new Date(todayStart.getTime() + 24 * 60 * 60 * 1000);
                    case 'month':
                        return createdAt >= thisMonthStart;
                    case 'custom':
                        if (appState.customStartDate && appState.customEndDate) {
                            const start = new Date(appState.customStartDate);
                            start.setHours(0,0,0,0);
                            const end = new Date(appState.customEndDate);
                            end.setHours(23,59,59,999);
                            return createdAt >= start && createdAt <= end;
                        }
                        return false;
                    case 'all':
                    default:
                        return true;
                }
            });

            filteredOrders.forEach(order => {
                const status = (order.status || 'unknown').toLowerCase();
                if (status === 'pending') pending++;
                else if (status === 'confirmed') confirmed++;
                else if (status === 'tentative') tentative++;
                else if (status === 'cancelled') cancelled++;
                else if (status === 'dispatched') dispatched++;
                else if (status === 'delivered') delivered++;
                else if (status === 'returned') returned++;

                // Aggregate data for top lists
                if(order.wilaya) {
                    wilayaCounts[order.wilaya] = (wilayaCounts[order.wilaya] || 0) + 1;
                }
                order.products.forEach(p => {
                    if(p.name) {
                        productCounts[p.name] = (productCounts[p.name] || 0) + p.quantity;
                    }
                });
            });
            
            appState.totalOrders = filteredOrders.length;
            appState.pendingOrders = pending;
            appState.confirmedOrders = confirmed;
            appState.tentativeOrders = tentative;
            appState.cancelledOrders = cancelled;
            appState.dispatchedOrders = dispatched;
            appState.deliveredOrders = delivered;
            appState.returnedOrders = returned;
            
            // Calculate top 5s
            appState.topWilayas = Object.entries(wilayaCounts).sort(([,a],[,b]) => b-a).slice(0, 5);
            appState.topProducts = Object.entries(productCounts).sort(([,a],[,b]) => b-a).slice(0, 5);
            
            generateSalesTrendData(filteredOrders);
        }
        
        function generateSalesTrendData(orders) {
            const salesData = {};
            orders.forEach(order => {
                const orderTotal = order.products.reduce((sum, p) => sum + (p.price * p.quantity), 0);
                const orderDate = new Date(order.createdAt);
                const dayKey = orderDate.toISOString().split('T')[0];
                if (!salesData[dayKey]) salesData[dayKey] = 0;
                salesData[dayKey] += orderTotal;
            });
            const sortedKeys = Object.keys(salesData).sort();
            appState.salesTrendLabels = sortedKeys;
            appState.salesTrendData = sortedKeys.map(key => salesData[key]);
        }

        // --- UI Rendering Functions ---

        function renderAllComponents() {
            updateUIText();
            renderKpiWidgets();
            renderOrderPieChartCard();
            renderDeliveryPieChart();
            renderSalesTrendChart();
            renderStockInfoCard();
            renderTopWilayasCard();
            renderTopProductsCard();
        }

        function updateUIText() {
            document.querySelector('header h1').textContent = getTranslatedString('salesDashboard');
            document.getElementById('live-location').textContent = getTranslatedString('location');
            document.querySelector('#delivery-status-card .widget-title').textContent = getTranslatedString('deliveryReturns');
            document.querySelector('#top-wilayas-card .widget-title').textContent = getTranslatedString('topWilayas');
            document.querySelector('#top-products-card .widget-title').textContent = getTranslatedString('topProducts');
        }
        
        function renderLoadingSpinner(size = 'h-10 w-10') {
            return `<div class="flex items-center justify-center h-full w-full p-8"><div class="animate-spin rounded-full ${size} border-4 border-blue-200 border-t-blue-600"></div></div>`;
        }
        
        function renderErrorMessage(message, retryFunction = 'fetchOrders') {
            return `<div class="flex flex-col items-center justify-center h-full text-red-500 p-4 text-center"><i class="fas fa-exclamation-triangle text-3xl mb-2"></i><p class="font-semibold">${getTranslatedString('error')}</p><p class="text-sm">${message}</p><button onclick="${retryFunction}()" class="mt-4 bg-blue-500 text-white px-4 py-2 rounded-lg shadow hover:bg-blue-600 transition duration-300 text-sm"><i class="fas fa-sync-alt mr-2"></i>${getTranslatedString('retry')}</button></div>`;
        }

        function createKpiWidget(label, value, iconClass, colorClass) {
            const isLoading = appState.isOrdersLoading;
            const hasError = !!appState.orderErrorMessage;
            let content;

            if (hasError) {
                content = `<div class="text-red-500 text-center"><i class="fas fa-exclamation-circle"></i></div>`;
            } else if (isLoading) {
                content = `<div class="h-10 w-10 bg-gray-200 rounded-full animate-pulse"></div>`;
            } else {
                content = `<div class="value">${value}</div>`;
            }

            return `<div class="widget kpi-widget p-4"><div class="flex items-center justify-between"><div><div class="label">${label}</div>${content}</div><div class="icon-bg bg-${colorClass}-100 text-${colorClass}-600"><i class="fas ${iconClass}"></i></div></div></div>`;
        }

        function renderKpiWidgets() {
            const grid = document.getElementById('kpi-grid');
            grid.innerHTML = 
                createKpiWidget(getTranslatedString('totalOrders'), appState.totalOrders, 'fa-box', 'blue') +
                createKpiWidget(getTranslatedString('pendingOrders'), appState.pendingOrders, 'fa-clock', 'yellow') +
                createKpiWidget(getTranslatedString('confirmedOrders'), appState.confirmedOrders, 'fa-check-circle', 'green') +
                createKpiWidget(getTranslatedString('cancelledOrders'), appState.cancelledOrders, 'fa-times-circle', 'red');
        }

        function renderOrderPieChartCard() {
            const contentDiv = document.querySelector('#order-distribution-card .widget-content');
            if (appState.isOrdersLoading) { contentDiv.innerHTML = renderLoadingSpinner(); return; }
            if (appState.orderErrorMessage) { contentDiv.innerHTML = renderErrorMessage(appState.orderErrorMessage, 'fetchOrders'); return; }

            const dataMap = {};
            if (appState.pendingOrders > 0) dataMap[getTranslatedString('pending')] = appState.pendingOrders;
            if (appState.confirmedOrders > 0) dataMap[getTranslatedString('confirmed')] = appState.confirmedOrders;
            if (appState.tentativeOrders > 0) dataMap[getTranslatedString('tentative')] = appState.tentativeOrders;
            if (appState.cancelledOrders > 0) dataMap[getTranslatedString('cancelled')] = appState.cancelledOrders;

            if (appState.totalOrders === 0 || Object.keys(dataMap).length === 0) {
                contentDiv.innerHTML = `<div class="text-center text-gray-500 p-4">${getTranslatedString('noData')}</div>`;
                if (appState.orderPieChartInstance) { appState.orderPieChartInstance.destroy(); appState.orderPieChartInstance = null; }
                return;
            }

            let canvas = document.getElementById('orderPieChart');
            if (!canvas) {
                contentDiv.innerHTML = '<canvas id="orderPieChart"></canvas>';
                canvas = document.getElementById('orderPieChart');
            }
            const ctx = canvas.getContext('2d');
            
            const labels = Object.keys(dataMap);
            const data = Object.values(dataMap);
            const colors = ['#f59e0b', '#10b981', '#f97316', '#ef4444'];

            if (appState.orderPieChartInstance) {
                appState.orderPieChartInstance.data.labels = labels;
                appState.orderPieChartInstance.data.datasets[0].data = data;
                appState.orderPieChartInstance.update();
            } else {
                appState.orderPieChartInstance = new Chart(ctx, {
                    type: 'doughnut',
                    data: { labels, datasets: [{ data, backgroundColor: colors, borderColor: '#ffffff', borderWidth: 4 }] },
                    options: { responsive: true, maintainAspectRatio: false, cutout: '70%', plugins: { legend: { position: 'bottom', labels: { usePointStyle: true, boxWidth: 8, padding: 20 } } } }
                });
            }
        }

        function renderDeliveryPieChart() {
            const contentDiv = document.querySelector('#delivery-status-card .widget-content');
            if (appState.isOrdersLoading) { contentDiv.innerHTML = renderLoadingSpinner(); return; }
            if (appState.orderErrorMessage) { contentDiv.innerHTML = renderErrorMessage(appState.orderErrorMessage, 'fetchOrders'); return; }

            const dataMap = {};
            if (appState.dispatchedOrders > 0) dataMap[getTranslatedString('dispatched')] = appState.dispatchedOrders;
            if (appState.deliveredOrders > 0) dataMap[getTranslatedString('delivered')] = appState.deliveredOrders;
            if (appState.returnedOrders > 0) dataMap[getTranslatedString('returned')] = appState.returnedOrders;

            const totalDeliveryStatusOrders = appState.dispatchedOrders + appState.deliveredOrders + appState.returnedOrders;

            if (totalDeliveryStatusOrders === 0) {
                contentDiv.innerHTML = `<div class="text-center text-gray-500 p-4">${getTranslatedString('noData')}</div>`;
                if (appState.deliveryPieChartInstance) { appState.deliveryPieChartInstance.destroy(); appState.deliveryPieChartInstance = null; }
                return;
            }

            let canvas = document.getElementById('deliveryPieChart');
            if (!canvas) {
                contentDiv.innerHTML = '<canvas id="deliveryPieChart"></canvas>';
                canvas = document.getElementById('deliveryPieChart');
            }
            const ctx = canvas.getContext('2d');
            
            const labels = Object.keys(dataMap);
            const data = Object.values(dataMap);
            const colors = ['#3b82f6', '#8b5cf6', '#db2777']; // blue, violet, pink

            if (appState.deliveryPieChartInstance) {
                appState.deliveryPieChartInstance.data.labels = labels;
                appState.deliveryPieChartInstance.data.datasets[0].data = data;
                appState.deliveryPieChartInstance.update();
            } else {
                appState.deliveryPieChartInstance = new Chart(ctx, {
                    type: 'doughnut',
                    data: { labels, datasets: [{ data, backgroundColor: colors, borderColor: '#ffffff', borderWidth: 4 }] },
                    options: { responsive: true, maintainAspectRatio: false, cutout: '70%', plugins: { legend: { position: 'bottom', labels: { usePointStyle: true, boxWidth: 8, padding: 20 } } } }
                });
            }
        }

        function renderSalesTrendChart() {
            const contentDiv = document.querySelector('#sales-trend-card .widget-content');
            if (appState.isOrdersLoading) { contentDiv.innerHTML = renderLoadingSpinner(); return; }
            if (appState.orderErrorMessage) { contentDiv.innerHTML = renderErrorMessage(appState.orderErrorMessage, 'fetchOrders'); return; }
            
            if (!appState.salesTrendData || appState.salesTrendData.length === 0) {
                 contentDiv.innerHTML = `<div class="text-center text-gray-500 p-4">${getTranslatedString('noData')}</div>`;
                 if (appState.salesTrendChartInstance) { appState.salesTrendChartInstance.destroy(); appState.salesTrendChartInstance = null; }
                 return;
            }

            let canvas = document.getElementById('salesTrendChart');
            if (!canvas) {
                contentDiv.innerHTML = '<canvas id="salesTrendChart"></canvas>';
                canvas = document.getElementById('salesTrendChart');
            }
            const ctx = canvas.getContext('2d');

            if (appState.salesTrendChartInstance) {
                appState.salesTrendChartInstance.data.labels = appState.salesTrendLabels;
                appState.salesTrendChartInstance.data.datasets[0].data = appState.salesTrendData;
                appState.salesTrendChartInstance.update();
            } else {
                appState.salesTrendChartInstance = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: appState.salesTrendLabels,
                        datasets: [{
                            label: 'Sales', data: appState.salesTrendData, fill: true,
                            backgroundColor: 'rgba(0, 123, 255, 0.1)', borderColor: '#007bff',
                            tension: 0.4, pointBackgroundColor: '#007bff', pointBorderColor: '#fff',
                            pointHoverRadius: 7, pointHoverBackgroundColor: '#fff', pointHoverBorderColor: '#007bff',
                        }]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        scales: { 
                            x: { type: 'time', time: { unit: 'day', tooltipFormat: 'MMM dd, yyyy' } },
                            y: { beginAtZero: true } 
                        },
                        plugins: { legend: { display: false } }
                    }
                });
            }
        }

        function renderStockInfoCard() {
            const contentDiv = document.getElementById('stock-info-content');
            if (appState.isStockLoading) { contentDiv.innerHTML = renderLoadingSpinner(); return; }
            if (appState.stockErrorMessage) { contentDiv.innerHTML = renderErrorMessage(appState.stockErrorMessage, 'fetchStockInfo'); return; }

            const filteredStock = appState.stockInfos.filter(item => 
                item.name.toLowerCase().includes(appState.stockFilter.toLowerCase())
            );

            if (filteredStock.length === 0) { 
                contentDiv.innerHTML = `<div class="p-4 text-center text-gray-500">${getTranslatedString(appState.stockFilter ? 'noStockFound' : 'noData')}</div>`; 
                return; 
            }
            
            const locale = appState.isEnglish ? 'en-US' : 'ar-EG';

            contentDiv.innerHTML = `<div class="widget-table-container"><div class="table-widget"><table><thead><tr><th>${getTranslatedString('product')}</th><th>${getTranslatedString('quantity')}</th><th>${getTranslatedString('dateAdded')}</th></tr></thead><tbody>${filteredStock.map(item => `<tr><td class="font-medium">${item.name}</td><td>${item.quantity}</td><td class="text-gray-500">${new Date(item.createdAt).toLocaleDateString(locale, { year: 'numeric', month: 'long', day: 'numeric' })}</td></tr>`).join('')}</tbody></table></div></div>`;
        }

        function renderTopWilayasCard() {
            const contentDiv = document.getElementById('top-wilayas-content');
            if (appState.isOrdersLoading) { contentDiv.innerHTML = renderLoadingSpinner('h-8 w-8'); return; }
            if (appState.orderErrorMessage) { contentDiv.innerHTML = renderErrorMessage(appState.orderErrorMessage, 'fetchOrders'); return; }
            
            if (appState.topWilayas.length === 0) {
                contentDiv.innerHTML = `<div class="text-center text-gray-500 p-4">${getTranslatedString('noData')}</div>`;
                return;
            }

            contentDiv.innerHTML = `<div>${appState.topWilayas.map(([name, count]) => `
                <div class="ranked-list-item">
                    <span class="name">${name}</span>
                    <span class="value">${count} ${getTranslatedString('orders')}</span>
                </div>
            `).join('')}</div>`;
        }

        function renderTopProductsCard() {
            const contentDiv = document.getElementById('top-products-content');
            if (appState.isOrdersLoading) { contentDiv.innerHTML = renderLoadingSpinner('h-8 w-8'); return; }
            if (appState.orderErrorMessage) { contentDiv.innerHTML = renderErrorMessage(appState.orderErrorMessage, 'fetchOrders'); return; }

            if (appState.topProducts.length === 0) {
                contentDiv.innerHTML = `<div class="text-center text-gray-500 p-4">${getTranslatedString('noData')}</div>`;
                return;
            }

            contentDiv.innerHTML = `<div>${appState.topProducts.map(([name, count]) => `
                <div class="ranked-list-item">
                    <span class="name truncate pr-2" title="${name}">${name}</span>
                    <span class="value">${count} <span class="text-sm font-normal text-gray-500">${getTranslatedString('unitsSold')}</span></span>
                </div>
            `).join('')}</div>`;
        }
        
        function startClock() {
            const clockElement = document.getElementById('live-clock');
            if(!clockElement) return;
            
            const update = () => {
                appState.liveDate.setSeconds(appState.liveDate.getSeconds() + 1);
                const locale = appState.isEnglish ? 'en-US' : 'ar-EG';
                const options = { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: true };
                clockElement.textContent = new Intl.DateTimeFormat(locale, options).format(appState.liveDate);
            };
            update();
            setInterval(update, 1000);
        }

        // --- Event Listeners Setup ---
        document.addEventListener('DOMContentLoaded', () => {
            fetchOrders();
            fetchStockInfo();
            startClock();
            
            const menuToggle = document.getElementById('menu-toggle');
            const sidebar = document.getElementById('sidebar');
            const sidebarOverlay = document.getElementById('sidebar-overlay');
            menuToggle.addEventListener('click', () => { sidebar.classList.toggle('open'); sidebarOverlay.classList.toggle('hidden'); });
            sidebarOverlay.addEventListener('click', () => { sidebar.classList.remove('open'); sidebarOverlay.classList.add('hidden'); });

            document.getElementById('language-toggle').addEventListener('click', () => {
                appState.isEnglish = !appState.isEnglish;
                renderAllComponents();
            });

            document.querySelectorAll('.filter-button').forEach(button => {
                button.addEventListener('click', (e) => {
                    document.querySelectorAll('.filter-button').forEach(btn => btn.classList.remove('active'));
                    e.currentTarget.classList.add('active');
                    appState.selectedFilter = e.currentTarget.id.replace('filter-', '');
                    
                    const customDateRangeDiv = document.getElementById('custom-date-range');
                    if (appState.selectedFilter === 'custom') {
                        customDateRangeDiv.classList.remove('hidden');
                        if(appState.customStartDate && appState.customEndDate) {
                           processAndFilterOrders();
                           renderAllComponents();
                        }
                    } else {
                        customDateRangeDiv.classList.add('hidden');
                        processAndFilterOrders();
                        renderAllComponents();
                    }
                });
            });
            
            const startDateInput = document.getElementById('start-date');
            const endDateInput = document.getElementById('end-date');
            [startDateInput, endDateInput].forEach(input => {
                input.addEventListener('change', () => {
                    appState.customStartDate = startDateInput.value;
                    appState.customEndDate = endDateInput.value;
                    if (startDateInput.value && endDateInput.value) {
                        processAndFilterOrders();
                        renderAllComponents();
                    }
                });
            });

            document.getElementById('stock-search').addEventListener('input', (e) => {
                appState.stockFilter = e.target.value;
                renderStockInfoCard();
            });

            // Add navigation listeners
            document.getElementById('dashboard-nav-btn').addEventListener('click', () => window.location.href = 'admin-panel.html');
            document.getElementById('orders-button').addEventListener('click', () => window.location.href = 'orders-management-web.html');
            document.getElementById('facture-nav-btn').addEventListener('click', () => window.location.href = 'facture.html');
            document.getElementById('add-product-nav-btn').addEventListener('click', () => window.location.href = 'addproduct.html');
            document.getElementById('all-products-nav-btn').addEventListener('click', () => window.location.href = 'products.html');
            document.getElementById('stock-nav-btn').addEventListener('click', () => window.location.href = 'stock.html');
            document.getElementById('admins-nav-btn').addEventListener('click', () => window.location.href = 'admins.html');
            document.getElementById('pixels-nav-btn').addEventListener('click', () => window.location.href = 'pixels.html');
            document.getElementById('fees-delivery-nav-btn').addEventListener('click', () => window.location.href = 'fees.html');
            document.getElementById('site-config-nav-btn').addEventListener('click', () => window.location.href = 'siteconfig.html');
            document.getElementById('logout-button').addEventListener('click', () => {
                console.log('Logout clicked');
                // In a real app, you would clear tokens and redirect
                window.location.href = 'index.html';
            });
        });

    </script>
</body>
</html>
