<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Products Management</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts - Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* Light gray background */
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        /* Modal overlay styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 0.75rem; /* rounded-xl */
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1); /* shadow-lg */
            max-width: 90%;
            max-height: 90%;
            overflow-y: auto;
            transform: translateY(-20px);
            transition: transform 0.3s ease;
        }
        .modal-overlay.show .modal-content {
            transform: translateY(0);
        }

        /* Snackbar styles */
        #snackbar {
            visibility: hidden; /* Hidden by default. */
            min-width: 250px; /* Set a default minimum width */
            background-color: #333; /* Black background color */
            color: #fff; /* White text color */
            text-align: center; /* Centered text */
            border-radius: 8px; /* Rounded borders */
            padding: 16px; /* Padding */
            position: fixed; /* Sit on top of the screen */
            z-index: 1001; /* Add a z-index if needed */
            left: 50%; /* Center the snackbar */
            bottom: 30px; /* 30px from the bottom */
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.5s, visibility 0.5s;
        }

        #snackbar.show {
            visibility: visible; /* Show the snackbar */
            opacity: 1; /* Fade in */
        }
    </style>
</head>
<body class="flex flex-col">
    <!-- App Bar -->
    <header class="bg-white shadow-sm p-4 flex justify-between items-center sticky top-0 z-10">
        <h1 class="text-2xl font-bold text-gray-800">Products Management</h1>
        <div id="admin-actions" class="flex space-x-2">
            <!-- Create Collection Button (admin only) -->
        </div>
    </header>

    <!-- Main Content Area -->
    <main class="flex-1 p-4 overflow-y-auto">
        <!-- Collections Section -->
        <section class="mb-8">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Collections</h2>
            <div id="collections-content" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                <!-- Collections will be loaded here -->
            </div>
        </section>

        <hr class="border-gray-300 my-8">

        <!-- All Products Section -->
        <section>
            <h2 class="text-2xl font-bold text-gray-800 mb-4">All Products</h2>
            <div id="products-content" class="space-y-4">
                <!-- Products will be loaded here -->
            </div>
        </section>
    </main>

    <!-- Modals -->
    <div id="create-collection-modal" class="modal-overlay">
        <div class="modal-content w-full md:w-3/4 lg:w-1/2">
            <h3 class="text-xl font-bold text-gray-800 mb-4">Create New Collection</h3>
            <div class="space-y-4">
                <input type="text" id="collection-name-input" placeholder="Collection Name" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                <input type="text" id="collection-thumbnail-input" placeholder="Thumbnail Image URL (Optional)" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                <h4 class="text-lg font-semibold text-gray-800 mt-4 mb-2">Select Products:</h4>
                <div id="product-selection-list" class="max-h-60 overflow-y-auto border border-gray-200 rounded-lg p-2">
                    <!-- Product checkboxes will be loaded here -->
                </div>
            </div>
            <div class="flex justify-end space-x-4 mt-6">
                <button id="cancel-create-collection" class="px-6 py-3 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition duration-300">Cancel</button>
                <button id="save-create-collection" class="px-6 py-3 bg-black text-white rounded-lg hover:bg-gray-800 transition duration-300">Create Collection</button>
            </div>
        </div>
    </div>

    <div id="edit-product-modal" class="modal-overlay">
        <div class="modal-content w-full md:w-3/4 lg:w-1/2">
            <h3 class="text-xl font-bold text-gray-800 mb-4">Edit Product</h3>
            <div class="space-y-4">
                <input type="text" id="edit-product-id" class="hidden">
                <input type="text" id="edit-product-name" placeholder="Product Name" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                <textarea id="edit-product-description" placeholder="Description" rows="3" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500"></textarea>
                <input type="number" id="edit-product-price" placeholder="Price" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                <input type="number" id="edit-product-quantity" placeholder="Quantity" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
            </div>
            <div class="flex justify-end space-x-4 mt-6">
                <button id="cancel-edit-product" class="px-6 py-3 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition duration-300">Cancel</button>
                <button id="save-edit-product" class="px-6 py-3 bg-black text-white rounded-lg hover:bg-gray-800 transition duration-300">Save Changes</button>
            </div>
        </div>
    </div>

    <div id="edit-collection-modal" class="modal-overlay">
        <div class="modal-content w-full md:w-3/4 lg:w-1/2">
            <h3 class="text-xl font-bold text-gray-800 mb-4">Edit Collection</h3>
            <div class="space-y-4">
                <input type="text" id="edit-collection-id" class="hidden">
                <input type="text" id="edit-collection-name" placeholder="Collection Name" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                <input type="text" id="edit-collection-thumbnail" placeholder="Thumbnail Image URL (Optional)" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                <h4 class="text-lg font-semibold text-gray-800 mt-4 mb-2">Select Products:</h4>
                <div id="edit-collection-product-selection-list" class="max-h-60 overflow-y-auto border border-gray-200 rounded-lg p-2">
                    <!-- Product checkboxes for editing will be loaded here -->
                </div>
            </div>
            <div class="flex justify-end space-x-4 mt-6">
                <button id="cancel-edit-collection" class="px-6 py-3 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition duration-300">Cancel</button>
                <button id="save-edit-collection" class="px-6 py-3 bg-black text-white rounded-lg hover:bg-gray-800 transition duration-300">Save Changes</button>
            </div>
        </div>
    </div>

    <div id="confirm-dialog-modal" class="modal-overlay">
        <div class="modal-content w-full max-w-sm">
            <h3 id="confirm-dialog-title" class="text-xl font-bold text-gray-800 mb-4">Confirm Action</h3>
            <p id="confirm-dialog-message" class="text-gray-700 mb-6">Are you sure you want to proceed?</p>
            <div class="flex justify-end space-x-4">
                <button id="confirm-dialog-cancel" class="px-6 py-3 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition duration-300">Cancel</button>
                <button id="confirm-dialog-confirm" class="px-6 py-3 bg-red-600 text-white rounded-lg hover:bg-red-700 transition duration-300">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Snackbar -->
    <div id="snackbar"></div>

    <script>
        // Global state management
        const appState = {
            products: [],
            collections: [],
            isLoadingProducts: true,
            isLoadingCollections: true,
            userRole: 'guest', // Default to 'guest'
            selectedProductIdsForCollection: new Set(), // For create collection dialog
            selectedProductIdsForEditCollection: new Set(), // For edit collection dialog
            currentEditProduct: null, // Stores product being edited
            currentEditCollection: null, // Stores collection being edited
        };

        // --- Helper Functions ---

        // Loads the user role from localStorage
        function loadUserRole() {
            appState.userRole = localStorage.getItem('role') || 'guest';
            renderAdminActions(); // Render admin actions based on role
        }

        // Helper function to build absolute image URLs
        function buildAbsoluteImageUrl(relativePath) {
            if (!relativePath || relativePath.trim() === '') {
                return 'https://placehold.co/150x150/EEEEEE/333333?text=No+Image';
            }
            if (relativePath.startsWith('http://') || relativePath.startsWith('https://')) {
                return relativePath;
            }
            return `https://sheeka.onrender.com${relativePath}`;
        }

        // Displays a snackbar message
        let snackbarTimeout;
        function showMessage(message, isError = false) {
            const snackbar = document.getElementById('snackbar');
            snackbar.textContent = message;
            snackbar.style.backgroundColor = isError ? '#dc2626' : '#1f2937'; // red-600 or dark gray
            snackbar.classList.add('show');

            clearTimeout(snackbarTimeout);
            snackbarTimeout = setTimeout(() => {
                snackbar.classList.remove('show');
            }, 3000);
        }

        // Generic modal handler
        function showModal(modalId) {
            document.getElementById(modalId).classList.add('show');
        }

        function hideModal(modalId) {
            document.getElementById(modalId).classList.remove('show');
        }

        // --- API Fetching Functions ---

        async function fetchProducts() {
            appState.isLoadingProducts = true;
            renderProducts(); // Show loading state
            try {
                const response = await fetch('https://sheeka.onrender.com/products');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                appState.products = await response.json();
            } catch (e) {
                console.error('Error fetching products:', e);
                showMessage(`Error fetching products: ${e.message}`, true);
                appState.products = []; // Clear products on error
            } finally {
                appState.isLoadingProducts = false;
                renderProducts(); // Render with data or error message
            }
        }

        async function fetchCollections() {
            appState.isLoadingCollections = true;
            renderCollections(); // Show loading state
            try {
                const response = await fetch('https://sheeka.onrender.com/products/collections');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                appState.collections = Array.isArray(data) ? data : []; // Ensure it's an array
            } catch (e) {
                console.error('Error fetching collections:', e);
                showMessage(`Error fetching collections: ${e.message}`, true);
                appState.collections = []; // Clear collections on error
            } finally {
                appState.isLoadingCollections = false;
                renderCollections(); // Render with data or error message
            }
        }

        async function postCollectionData(name, thumbnailUrl, productIds) {
            const url = "https://sheeka.onrender.com/products/collections";

            let finalThumbnailUrl = thumbnailUrl;
            if ((finalThumbnailUrl === null || finalThumbnailUrl.trim() === '') && productIds.length > 0) {
                const firstSelectedProduct = appState.products.find(p => p._id === productIds[0]);
                if (firstSelectedProduct && firstSelectedProduct.images && firstSelectedProduct.images.length > 0) {
                    finalThumbnailUrl = buildAbsoluteImageUrl(firstSelectedProduct.images[0]);
                }
            }

            const body = {
                name: name,
                thumbnailUrl: finalThumbnailUrl,
                productIds: productIds,
            };

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(body),
                });

                if (response.ok) {
                    showMessage("Collection created successfully!", false);
                    fetchCollections(); // Refresh collections
                } else {
                    const errorBody = await response.json();
                    showMessage(`Failed to create collection: ${errorBody.error || response.status}`, true);
                }
            } catch (e) {
                showMessage(`Error creating collection: ${e.message}`, true);
            }
        }

        async function removeProduct(productId, index) {
            const confirmed = await showConfirmDialog("Delete Product", "Are you sure you want to remove this product?");
            if (confirmed) {
                try {
                    const response = await fetch(`https://sheeka.onrender.com/products/${productId}`, {
                        method: 'DELETE',
                    });
                    if (response.ok) {
                        appState.products.splice(index, 1); // Remove from state
                        renderProducts(); // Re-render
                        showMessage('Product deleted successfully!', false);
                    } else {
                        const errorBody = await response.json();
                        showMessage(`Failed to delete product: ${errorBody.message || response.status}`, true);
                    }
                } catch (e) {
                    showMessage(`Error deleting product: ${e.message}`, true);
                }
            }
        }

        async function deleteCollection(collectionId, index) {
            const confirmed = await showConfirmDialog("Delete Collection", "Are you sure you want to delete this collection? This action cannot be undone.");
            if (confirmed) {
                try {
                    const response = await fetch(`https://sheeka.onrender.com/products/collections/${collectionId}`, {
                        method: 'DELETE',
                    });
                    if (response.ok) {
                        appState.collections.splice(index, 1); // Remove from state
                        renderCollections(); // Re-render
                        showMessage('Collection deleted successfully!', false);
                    } else {
                        const errorBody = await response.json();
                        showMessage(`Failed to delete collection: ${errorBody.message || response.status}`, true);
                    }
                } catch (e) {
                    showMessage(`Error deleting collection: ${e.message}`, true);
                }
            }
        }

        async function updateProduct(productId, name, description, price, quantity, index) {
            try {
                const response = await fetch(`https://sheeka.onrender.com/products/${productId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name: name,
                        description: description,
                        price: parseFloat(price),
                        quantity: parseInt(quantity),
                    }),
                });

                if (response.ok) {
                    const updatedProduct = await response.json();
                    appState.products[index] = updatedProduct.product; // Update UI
                    renderProducts();
                    showMessage('Product updated successfully!', false);
                } else {
                    const errorBody = await response.json();
                    showMessage(`Failed to update product: ${errorBody.message || response.status}`, true);
                }
            } catch (e) {
                showMessage(`Error updating product: ${e.message}`, true);
            }
        }

        async function updateCollection(collectionId, name, thumbnailUrl, productIds, index) {
            const url = `https://sheeka.onrender.com/products/collections/${collectionId}`;

            let finalThumbnailUrl = thumbnailUrl;
            if ((finalThumbnailUrl === null || finalThumbnailUrl.trim() === '') && productIds.length > 0) {
                const firstSelectedProduct = appState.products.find(p => p._id === productIds[0]);
                if (firstSelectedProduct && firstSelectedProduct.images && firstSelectedProduct.images.length > 0) {
                    finalThumbnailUrl = buildAbsoluteImageUrl(firstSelectedProduct.images[0]);
                }
            }

            const body = {
                name: name,
                thumbnailUrl: finalThumbnailUrl,
                productIds: productIds,
            };

            try {
                const response = await fetch(url, {
                    method: 'PUT',
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(body),
                });

                if (response.ok) {
                    const updatedCollection = await response.json();
                    appState.collections[index] = updatedCollection.collection; // Update UI
                    renderCollections();
                    showMessage('Collection updated successfully!', false);
                } else {
                    const errorBody = await response.json();
                    showMessage(`Failed to update collection: ${errorBody.message || response.status}`, true);
                }
            } catch (e) {
                showMessage(`Error updating collection: ${e.message}`, true);
            }
        }

        // --- UI Rendering Functions ---

        function renderAdminActions() {
            const adminActionsDiv = document.getElementById('admin-actions');
            adminActionsDiv.innerHTML = ''; // Clear previous content

            if (appState.userRole === "admin") {
                const createCollectionBtn = document.createElement('button');
                createCollectionBtn.id = 'create-collection-btn';
                createCollectionBtn.className = 'px-4 py-2 bg-black text-white rounded-lg shadow hover:bg-gray-800 transition duration-300 flex items-center space-x-2';
                createCollectionBtn.innerHTML = '<i class="fas fa-add mr-2"></i><span>Create Collection</span>';
                createCollectionBtn.onclick = showCreateCollectionDialog;
                adminActionsDiv.appendChild(createCollectionBtn);
            }
        }

        function renderCollections() {
            const collectionsContent = document.getElementById('collections-content');
            collectionsContent.innerHTML = ''; // Clear previous content

            if (appState.isLoadingCollections) {
                collectionsContent.innerHTML = `
                    <div class="col-span-full flex flex-col items-center justify-center p-8">
                        <div class="animate-spin rounded-full h-12 w-12 border-4 border-gray-800 border-t-transparent"></div>
                        <p class="mt-4 text-gray-600">Loading collections...</p>
                    </div>
                `;
                return;
            }

            if (appState.collections.length === 0) {
                collectionsContent.innerHTML = `
                    <div class="col-span-full flex flex-col items-center justify-center p-8 text-gray-600">
                        <i class="fas fa-box-open text-6xl mb-4 text-gray-400"></i>
                        <p class="text-lg font-medium">No collections found.</p>
                        <p class="text-sm text-gray-500">Create new collections to organize your products.</p>
                    </div>
                `;
                return;
            }

            appState.collections.forEach((collection, index) => {
                const collectionName = collection.name || 'Untitled Collection';
                const thumbnailUrl = collection.thumbnailUrl || '';
                const productCount = (collection.productIds && Array.isArray(collection.productIds)) ? collection.productIds.length : 0;
                const imageUrl = buildAbsoluteImageUrl(thumbnailUrl);

                const collectionCard = document.createElement('div');
                collectionCard.className = 'bg-white rounded-xl shadow-lg overflow-hidden flex flex-col';
                collectionCard.innerHTML = `
                    <div class="relative w-full h-40 bg-gray-100 flex items-center justify-center overflow-hidden rounded-t-xl">
                        <img src="${imageUrl}" alt="${collectionName}" class="w-full h-full object-cover" onerror="this.onerror=null;this.src='https://placehold.co/150x150/EEEEEE/333333?text=No+Image';this.classList.add('p-4');">
                    </div>
                    <div class="p-4 flex-1 flex flex-col justify-between">
                        <h3 class="text-lg font-bold text-gray-800 mb-2">${collectionName}</h3>
                        <p class="text-sm text-gray-600 mb-4">${productCount} Products</p>
                        <div class="flex justify-end space-x-2">
                            ${(appState.userRole === "admin" || appState.userRole === "stockagent") ? `
                                <button class="edit-collection-btn px-3 py-1 bg-gray-100 text-gray-700 rounded-md hover:bg-gray-200 transition duration-300 text-sm" data-index="${index}">
                                    <i class="fas fa-edit"></i> Edit
                                </button>
                            ` : ''}
                            ${appState.userRole === "admin" ? `
                                <button class="delete-collection-btn px-3 py-1 bg-red-100 text-red-700 rounded-md hover:bg-red-200 transition duration-300 text-sm" data-index="${index}">
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                            ` : ''}
                        </div>
                    </div>
                `;
                collectionsContent.appendChild(collectionCard);
            });

            // Attach event listeners after rendering
            collectionsContent.querySelectorAll('.edit-collection-btn').forEach(button => {
                button.onclick = (e) => {
                    const index = parseInt(e.currentTarget.dataset.index);
                    showEditCollectionDialog(appState.collections[index], index);
                };
            });
            collectionsContent.querySelectorAll('.delete-collection-btn').forEach(button => {
                button.onclick = (e) => {
                    const index = parseInt(e.currentTarget.dataset.index);
                    deleteCollection(appState.collections[index]._id, index);
                };
            });
        }

        function renderProducts() {
            const productsContent = document.getElementById('products-content');
            productsContent.innerHTML = ''; // Clear previous content

            if (appState.isLoadingProducts) {
                productsContent.innerHTML = `
                    <div class="flex flex-col items-center justify-center p-8">
                        <div class="animate-spin rounded-full h-12 w-12 border-4 border-gray-800 border-t-transparent"></div>
                        <p class="mt-4 text-gray-600">Loading products...</p>
                    </div>
                `;
                return;
            }

            if (appState.products.length === 0) {
                productsContent.innerHTML = `
                    <div class="flex flex-col items-center justify-center p-8 text-gray-600">
                        <i class="fas fa-box text-6xl mb-4 text-gray-400"></i>
                        <p class="text-lg font-medium">No products found.</p>
                        <p class="text-sm text-gray-500">Add new products to populate your inventory.</p>
                    </div>
                `;
                return;
            }

            appState.products.forEach((product, index) => {
                const imageUrl = buildAbsoluteImageUrl(product.images && product.images.length > 0 ? product.images[0] : null);
                const variantsData = product.variants || [];

                const productCard = document.createElement('div');
                productCard.className = 'bg-white rounded-xl shadow-lg overflow-hidden';
                productCard.innerHTML = `
                    <details class="group">
                        <summary class="flex items-center p-4 cursor-pointer">
                            <div class="flex-shrink-0 w-20 h-20 rounded-lg overflow-hidden mr-4 border border-gray-200">
                                <img src="${imageUrl}" alt="${product.name}" class="w-full h-full object-cover" onerror="this.onerror=null;this.src='https://placehold.co/70x70/EEEEEE/333333?text=N/A'; this.classList.add('p-2');">
                            </div>
                            <div class="flex-1">
                                <h3 class="text-lg font-bold text-gray-800">${product.name || 'N/A'}</h3>
                                <p class="text-sm text-gray-600">Price: $${product.price?.toFixed(2) ?? 'N/A'} | Stock: ${product.quantity ?? 'N/A'}</p>
                            </div>
                            <div class="flex-shrink-0 ml-4 space-x-2">
                                ${(appState.userRole === "admin" || appState.userRole === "stockagent") ? `
                                    <button class="edit-product-btn px-3 py-1 bg-gray-100 text-gray-700 rounded-md hover:bg-gray-200 transition duration-300 text-sm" data-index="${index}">
                                        <i class="fas fa-edit"></i> Edit
                                    </button>
                                ` : ''}
                                ${appState.userRole === "admin" ? `
                                    <button class="delete-product-btn px-3 py-1 bg-red-100 text-red-700 rounded-md hover:bg-red-200 transition duration-300 text-sm" data-index="${index}">
                                        <i class="fas fa-trash"></i> Delete
                                    </button>
                                ` : ''}
                            </div>
                            <i class="fas fa-chevron-down ml-4 text-gray-500 group-open:rotate-180 transition-transform"></i>
                        </summary>
                        <div class="p-4 pt-0 border-t border-gray-200 bg-gray-50">
                            <p class="text-gray-700 mb-2"><strong>Description:</strong> ${product.description || 'No description available.'}</p>
                            ${product.custom_option ? `<p class="text-gray-700 mb-2"><strong>Custom Option:</strong> ${product.custom_option}</p>` : ''}
                            ${variantsData.length > 0 ? `
                                <p class="text-gray-700 font-semibold mb-1">Variants:</p>
                                <ul class="list-disc list-inside text-gray-700">
                                    ${variantsData.map((variant, vIndex) => `
                                        <li>Variant ${vIndex + 1}: Colors - ${(variant.colors || []).join(', ')} | Sizes - ${(variant.sizes || []).join(', ')}</li>
                                    `).join('')}
                                </ul>
                            ` : product.variants ? `<p class="text-gray-600 italic">No variants specified.</p>` : ''}
                        </div>
                    </details>
                `;
                productsContent.appendChild(productCard);
            });

            // Attach event listeners after rendering
            productsContent.querySelectorAll('.edit-product-btn').forEach(button => {
                button.onclick = (e) => {
                    const index = parseInt(e.currentTarget.dataset.index);
                    showEditProductDialog(appState.products[index], index);
                };
            });
            productsContent.querySelectorAll('.delete-product-btn').forEach(button => {
                button.onclick = (e) => {
                    const index = parseInt(e.currentTarget.dataset.index);
                    removeProduct(appState.products[index]._id, index);
                };
            });
        }

        // --- Dialog Functions ---

        function showCreateCollectionDialog() {
            document.getElementById('collection-name-input').value = '';
            document.getElementById('collection-thumbnail-input').value = '';
            appState.selectedProductIdsForCollection.clear();
            renderProductSelectionList('product-selection-list', appState.selectedProductIdsForCollection);
            showModal('create-collection-modal');
        }

        function showEditProductDialog(product, index) {
            appState.currentEditProduct = { ...product, originalIndex: index }; // Store product and its original index
            document.getElementById('edit-product-id').value = product._id;
            document.getElementById('edit-product-name').value = product.name || '';
            document.getElementById('edit-product-description').value = product.description || '';
            document.getElementById('edit-product-price').value = product.price?.toString() || '';
            document.getElementById('edit-product-quantity').value = product.quantity?.toString() || '';
            showModal('edit-product-modal');
        }

        function showEditCollectionDialog(collection, index) {
            appState.currentEditCollection = { ...collection, originalIndex: index };
            document.getElementById('edit-collection-id').value = collection._id;
            document.getElementById('edit-collection-name').value = collection.name || '';
            document.getElementById('edit-collection-thumbnail').value = collection.thumbnailUrl || '';

            // Populate selected product IDs for editing
            appState.selectedProductIdsForEditCollection.clear();
            if (collection.productIds && Array.isArray(collection.productIds)) {
                collection.productIds.forEach(id => {
                    // Handle cases where productIds might be full objects or just IDs
                    const productId = typeof id === 'object' && id !== null && id._id ? id._id : id;
                    if (productId) {
                        appState.selectedProductIdsForEditCollection.add(productId.toString());
                    }
                });
            }
            renderProductSelectionList('edit-collection-product-selection-list', appState.selectedProductIdsForEditCollection);
            showModal('edit-collection-modal');
        }

        function renderProductSelectionList(containerId, selectedIdsSet) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';

            if (appState.products.length === 0) {
                container.innerHTML = `<p class="text-gray-600 text-center p-4">No products available to add to a collection.</p>`;
                return;
            }

            appState.products.forEach(product => {
                const isChecked = selectedIdsSet.has(product._id);
                const checkboxDiv = document.createElement('div');
                checkboxDiv.className = 'flex items-center p-2 hover:bg-gray-50 rounded-md';
                checkboxDiv.innerHTML = `
                    <input type="checkbox" id="product-${product._id}-${containerId}" class="form-checkbox h-5 w-5 text-black rounded focus:ring-black" ${isChecked ? 'checked' : ''}>
                    <label for="product-${product._id}-${containerId}" class="ml-2 text-gray-800 flex-1 cursor-pointer">
                        ${product.name || 'Unknown Product'} - $${product.price?.toFixed(2) ?? 'N/A'}
                    </label>
                `;
                const checkbox = checkboxDiv.querySelector('input[type="checkbox"]');
                checkbox.addEventListener('change', (e) => {
                    if (e.target.checked) {
                        selectedIdsSet.add(product._id);
                    } else {
                        selectedIdsSet.delete(product._id);
                    }
                });
                container.appendChild(checkboxDiv);
            });
        }

        // Generic confirmation dialog
        function showConfirmDialog(title, message) {
            return new Promise((resolve) => {
                const modal = document.getElementById('confirm-dialog-modal');
                document.getElementById('confirm-dialog-title').textContent = title;
                document.getElementById('confirm-dialog-message').textContent = message;

                const confirmBtn = document.getElementById('confirm-dialog-confirm');
                const cancelBtn = document.getElementById('confirm-dialog-cancel');

                const handleConfirm = () => {
                    hideModal('confirm-dialog-modal');
                    confirmBtn.removeEventListener('click', handleConfirm);
                    cancelBtn.removeEventListener('click', handleCancel);
                    resolve(true);
                };

                const handleCancel = () => {
                    hideModal('confirm-dialog-modal');
                    confirmBtn.removeEventListener('click', handleConfirm);
                    cancelBtn.removeEventListener('click', handleCancel);
                    resolve(false);
                };

                confirmBtn.addEventListener('click', handleConfirm);
                cancelBtn.addEventListener('click', handleCancel);

                showModal('confirm-dialog-modal');
            });
        }

        // --- Event Listeners and Initial Load ---

        document.addEventListener('DOMContentLoaded', () => {
            loadUserRole();
            fetchProducts();
            fetchCollections();

            // Create Collection Modal Buttons
            document.getElementById('cancel-create-collection').addEventListener('click', () => hideModal('create-collection-modal'));
            document.getElementById('save-create-collection').addEventListener('click', () => {
                const name = document.getElementById('collection-name-input').value.trim();
                const thumbnailUrl = document.getElementById('collection-thumbnail-input').value.trim();
                const productIds = Array.from(appState.selectedProductIdsForCollection);

                if (name === '') {
                    showMessage('Collection name cannot be empty.', true);
                    return;
                }
                hideModal('create-collection-modal');
                postCollectionData(name, thumbnailUrl, productIds);
            });

            // Edit Product Modal Buttons
            document.getElementById('cancel-edit-product').addEventListener('click', () => hideModal('edit-product-modal'));
            document.getElementById('save-edit-product').addEventListener('click', () => {
                const productId = document.getElementById('edit-product-id').value;
                const name = document.getElementById('edit-product-name').value.trim();
                const description = document.getElementById('edit-product-description').value.trim();
                const price = document.getElementById('edit-product-price').value.trim();
                const quantity = document.getElementById('edit-product-quantity').value.trim();
                const index = appState.currentEditProduct.originalIndex; // Get original index

                if (name === '' || price === '' || quantity === '') {
                    showMessage('Name, Price, and Quantity cannot be empty.', true);
                    return;
                }
                if (isNaN(parseFloat(price)) || isNaN(parseInt(quantity))) {
                    showMessage('Price must be a number and Quantity must be an integer.', true);
                    return;
                }

                hideModal('edit-product-modal');
                updateProduct(productId, name, description, price, quantity, index);
            });

            // Edit Collection Modal Buttons
            document.getElementById('cancel-edit-collection').addEventListener('click', () => hideModal('edit-collection-modal'));
            document.getElementById('save-edit-collection').addEventListener('click', () => {
                const collectionId = document.getElementById('edit-collection-id').value;
                const name = document.getElementById('edit-collection-name').value.trim();
                const thumbnailUrl = document.getElementById('edit-collection-thumbnail').value.trim();
                const productIds = Array.from(appState.selectedProductIdsForEditCollection);
                const index = appState.currentEditCollection.originalIndex;

                if (name === '') {
                    showMessage('Collection name cannot be empty.', true);
                    return;
                }
                hideModal('edit-collection-modal');
                updateCollection(collectionId, name, thumbnailUrl, productIds, index);
            });
        });
    </script>
</body>
</html>
